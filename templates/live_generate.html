<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Report Builder</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
    }
    .editor, .preview {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    .editor { border-right: 1px solid #ccc; }
    details {
      border: 1px solid #aaa;
      border-radius: 6px;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background-color: #f9f9f9;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
      padding: 0.5rem;
      background-color: #eee;
      border-radius: 4px;
      user-select: none;
    }
    input, textarea, select {
      width: 100%;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    label { display: block; margin-bottom: 0.5rem; }
    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
    }
    pre {
      background: #f0f0f0;
      padding: 1rem;
      overflow-x: auto;
    }
    .severity-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      margin-left: 0.5rem;
    }
    .sev-green { background-color: green; }
    .sev-yellow { background-color: gold; color: black; }
    .sev-orange { background-color: orange; }
    .sev-red { background-color: red; }
    .checklist-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      border: 1px solid #ccc;
      padding: 0.25rem;
      border-radius: 5px;
      background: #fff;
    }
    .checklist-label { flex: 1; }
    #imagePreview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
    }
  </style>
  <script src="https://unpkg.com/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>
</head>
<body>
  <div class="editor">
    <h2>📝 Edit Report</h2>

    <details open>
      <summary>📍 Incident Details</summary>
      <button onclick="autofillGPS()">📍 Auto-Fill Location</button>
      <label>Location:
        <input type="text" id="location" />
      </label>
      <label>Coordinates (lat,lng):
        <input type="text" id="coordinates" placeholder="30.2672,-97.7431" />
      </label>
      <label>Hazards:
        <input type="text" id="hazards" />
      </label>
      <label>Severity:
        <input type="number" id="severity" min="1" max="10" />
        <span id="severityBadge" class="severity-badge"></span>
      </label>
      <label>Notes:
        <textarea id="notes" rows="3"></textarea>
      </label>
    </details>

    <details open>
      <summary>✅ Checklist</summary>
      <label>Checklist Items (comma separated):
        <input type="text" id="checklist" />
      </label>
      <div id="checklistDisplay"></div>
    </details>

    <details open>
      <summary>🖼️ Hazard Images</summary>
      <label>Image URL:
        <input type="text" id="image_url" />
      </label>
      <label>Upload Image:
        <input type="file" id="image_file" accept="image/*" />
      </label>
      <img id="imagePreview" src="" alt="Image preview" />
    </details>

    <button onclick="saveAndSyncReport()">💾 Save & Sync</button>
  </div>

  <div class="preview">
    <h2>📄 Live JSON Preview</h2>
    <pre id="jsonPreview"></pre>
    <h2>📄 PDF Preview</h2>
    <iframe id="pdfFrame" title="Live PDF" width="100%" height="400px"></iframe>
  </div>

  <script>
    const inputs = ["location", "coordinates", "hazards", "severity", "notes", "image_url", "checklist"];
    const teamMembers = ["Unassigned", "Fire Chief", "Medic", "Safety Officer", "Search & Rescue"];

    function getSeverityClass(sev) {
      if (sev >= 8) return "sev-red";
      if (sev >= 5) return "sev-orange";
      if (sev >= 3) return "sev-yellow";
      return "sev-green";
    }

    function updateSeverityBadge() {
      const val = parseFloat(document.getElementById("severity").value);
      const badge = document.getElementById("severityBadge");
      if (!isNaN(val)) {
        badge.textContent = "SEV-" + val.toFixed(1);
        badge.className = "severity-badge " + getSeverityClass(val);
      } else {
        badge.textContent = "";
        badge.className = "severity-badge";
      }
    }

    function renderChecklist() {
      const raw = document.getElementById("checklist").value;
      const items = raw.split(",").map(c => c.trim()).filter(Boolean);
      const container = document.getElementById("checklistDisplay");
      container.innerHTML = "";

      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "checklist-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";

        const label = document.createElement("div");
        label.className = "checklist-label";
        label.textContent = item;

        const select = document.createElement("select");
        teamMembers.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(select);
        container.appendChild(div);
      });
    }

    function updateImagePreview() {
      const fileInput = document.getElementById("image_file");
      const urlInput = document.getElementById("image_url");
      const preview = document.getElementById("imagePreview");

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        preview.src = URL.createObjectURL(file);
      } else {
        preview.src = urlInput.value;
      }
    }

    function collectFormData() {
      const checklistNodes = document.querySelectorAll(".checklist-item");
      const checklistData = Array.from(checklistNodes).map(div => ({
        item: div.querySelector(".checklist-label").textContent,
        completed: div.querySelector("input[type='checkbox']").checked,
        assigned_to: div.querySelector("select").value
      }));

      const imageFile = document.getElementById("image_file").files[0];
      const imageURL = document.getElementById("image_url").value;

      return {
        id: crypto.randomUUID(),
        timestamp: new Date().toISOString(),
        location: document.getElementById("location").value,
        coordinates: document.getElementById("coordinates").value.split(",").map(Number),
        hazards: document.getElementById("hazards").value.split(",").map(h => h.trim()),
        severity: parseFloat(document.getElementById("severity").value),
        notes: document.getElementById("notes").value,
        image_url: imageFile ? "offline_blob://" + imageFile.name : imageURL,
        checklist: checklistData
      };
    }

    function renderPreview() {
      const data = collectFormData();
      document.getElementById("jsonPreview").textContent = JSON.stringify(data, null, 2);
    }

    async function saveAndSyncReport() {
      const data = collectFormData();
      const imageFile = document.getElementById("image_file").files[0];

      if (imageFile) {
        await idbKeyval.set(data.id, imageFile);
        data.image_blob_id = data.id;
      }

      let queue = await idbKeyval.get("sync_queue") || [];
      queue.push(data);
      await idbKeyval.set("sync_queue", queue);

      alert("✅ Report saved locally and queued for sync!");
      renderPreview();
    }

    async function syncQueue() {
      const queue = await idbKeyval.get("sync_queue") || [];
      const remaining = [];

      for (const report of queue) {
        const formData = new FormData();
        formData.append("json", JSON.stringify(report));
        if (report.image_blob_id) {
          const blob = await idbKeyval.get(report.image_blob_id);
          if (blob) formData.append("file", blob, "image.jpg");
        }

        try {
          const res = await fetch("/generate-report", {
            method: "POST",
            body: formData
          });
          if (!res.ok) throw new Error("Failed to upload");
        } catch {
          remaining.push(report);
        }
      }

      await idbKeyval.set("sync_queue", remaining);
    }

    async function autofillGPS() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const coords = `${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`;
        document.getElementById("coordinates").value = coords;
        document.getElementById("location").value = `Lat: ${pos.coords.latitude.toFixed(5)}, Lng: ${pos.coords.longitude.toFixed(5)}`;
        renderPreview();
      }, err => {
        alert("Failed to get GPS location.");
        console.error(err);
      });
    }

    window.addEventListener("online", syncQueue);

    window.onload = () => {
      document.getElementById("location").value = "Austin, TX";
      document.getElementById("coordinates").value = "30.2672,-97.7431";
      document.getElementById("hazards").value = "fire, collapsed structure";
      document.getElementById("severity").value = "8.5";
      document.getElementById("notes").value = "Smoke observed, no visible injuries";
      document.getElementById("image_url").value = "https://via.placeholder.com/300";
      document.getElementById("checklist").value = "Clear debris, Search for victims";
      updateSeverityBadge();
      renderChecklist();
      updateImagePreview();
      renderPreview();
    };

    inputs.forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        if (id === "checklist") renderChecklist();
        if (id === "image_url") updateImagePreview();
        if (id === "severity") updateSeverityBadge();
        renderPreview();
      });
    });

    document.getElementById("image_file").addEventListener("change", () => {
      updateImagePreview();
      renderPreview();
    });
  </script>
</body>
</html>