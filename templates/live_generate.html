<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced Live Report Builder</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Offline Recovery System -->
  <script src="/static/js/offline-recovery.js"></script>
  <script src="https://unpkg.com/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>

  <style>
    /* Template-specific styles */
    .main-content {
      display: flex;
      gap: 2rem;
      margin-top: 2rem;
    }

    .editor, .preview {
      flex: 1;
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .editor {
      border-right: 1px solid #e5e7eb;
    }

    /* Enhanced Map Container */
    #mapContainer {
      position: relative;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    #map {
      height: 400px;
      position: relative;
      z-index: 1;
    }
    
    /* Map Controls Overlay */
    .map-controls-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .map-control-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .map-control-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Coordinate Format Panel */
    .coordinate-panel {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .coordinate-panel h4 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .coordinate-formats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .coordinate-format {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      backdrop-filter: blur(10px);
    }
    
    .coordinate-label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
      font-weight: bold;
    }
    
    .coordinate-value {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .coordinate-value:hover {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      padding: 2px 4px;
    }
    
    /* Emergency Resources Panel */
    .emergency-panel {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease;
    }
    
    .emergency-panel h4 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .resource-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .resource-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .resource-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .resource-type {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
    }
    
    .resource-distance {
      font-weight: bold;
      font-size: 1rem;
    }
    
    .resource-name {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 0.25rem;
    }
    
    /* Map Analysis Panel */
    .map-analysis-panel {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    .map-analysis-panel.visible {
      display: block;
    }
    
    .analysis-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 0.75rem;
    }
    
    .analysis-metric {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    
    .metric-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    
    /* Enhanced GPS Controls */
    .gps-controls-enhanced {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .gps-btn-enhanced {
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .gps-btn-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .gps-btn-enhanced:hover::before {
      left: 100%;
    }
    
    .gps-btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .gps-btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }
    
    .gps-btn-secondary {
      background: linear-gradient(135deg, #10b981, #047857);
      color: white;
    }
    
    .gps-btn-tertiary {
      background: linear-gradient(135deg, #6b7280, #374151);
      color: white;
    }
    
    /* Location Search Enhancement */
    .location-search-container {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .location-search {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .location-search:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .search-suggestion {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s ease;
    }
    
    .search-suggestion:hover {
      background: #f9fafb;
    }
    
    .search-suggestion:last-child {
      border-bottom: none;
    }
    
    /* Form styling consistent with base template */
    details {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background-color: #f9fafb;
    }
    
    summary {
      font-weight: bold;
      cursor: pointer;
      padding: 0.5rem;
      background-color: #f3f4f6;
      border-radius: 6px;
      user-select: none;
    }
    
    input, textarea, select {
      width: 100%;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      transition: border-color 0.2s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    label { 
      display: block; 
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }
    
    button {
      margin-top: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    pre {
      background: #f8fafc;
      padding: 1rem;
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    
    .severity-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      margin-left: 0.5rem;
    }
    
    .sev-green { background-color: #16a34a; }
    .sev-yellow { background-color: #eab308; color: black; }
    .sev-orange { background-color: #ea580c; }
    .sev-red { background-color: #dc2626; }
    
    .checklist-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      border: 1px solid #d1d5db;
      padding: 0.5rem;
      border-radius: 6px;
      background: #fff;
      margin-bottom: 0.5rem;
    }
    
    .checklist-label { flex: 1; }
    
    #imagePreview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    
    #syncStatus {
      background: #1f2937;
      color: white;
      padding: 0.75rem;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .coordinate-formats,
      .resource-grid,
      .analysis-metrics {
        grid-template-columns: 1fr;
      }
      
      .gps-controls-enhanced {
        grid-template-columns: 1fr;
      }
      
      #map {
        height: 300px;
      }
    }

    /* Dark theme support */
    [data-theme="dark"] .editor,
    [data-theme="dark"] .preview {
      background: #1f2937;
      color: #f9fafb;
    }

    [data-theme="dark"] details {
      background-color: #374151;
      border-color: #4b5563;
    }

    [data-theme="dark"] summary {
      background-color: #4b5563;
    }

    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select {
      background: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }

    [data-theme="dark"] pre {
      background: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }

    [data-theme="dark"] .checklist-item {
      background: #374151;
      border-color: #4b5563;
    }

    [data-theme="dark"] .search-suggestions {
      background: #374151;
      border-color: #4b5563;
    }

    [data-theme="dark"] .search-suggestion:hover {
      background: #4b5563;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">🗺️</div>
      <div>
        <h1 class="title">Enhanced Live Report Builder</h1>
        <p class="subtitle">AI-Powered Field Reporting with Real-time Maps</p>
      </div>
      <div class="controls">
        <button id="toggleThemeBtn" aria-label="Toggle dark/light theme">🌓 Toggle Theme</button>
        <button id="contrastToggleBtn" aria-label="Toggle high contrast mode">♿ High Contrast</button>
        <div class="status-bar">
          <div class="status-indicator status-offline">
            <div class="status-dot"></div>
            Offline Ready
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Sync Status Bar -->
    <div id="syncStatus">
      🔄 Sync Status: <span id="connectionStatus">Checking...</span>
      <span id="queueStatus" class="offline-indicator" style="display: none;">Queue: 0 reports</span>
    </div>

    <div class="main-content">
      <div class="editor">
        <h2>📝 Enhanced Report Builder</h2>

        <div class="sync-queue-info" id="syncInfo">
          <strong>📊 Sync Queue:</strong> <span id="queueCount">0</span> reports pending
          <button onclick="forceSyncQueue()" style="margin-left: 1rem; padding: 0.25rem 0.5rem;">🔄 Force Sync</button>
        </div>

        <!-- Enhanced GPS & Location Section -->
        <details open>
          <summary>🗺️ Enhanced Location & Mapping</summary>
          
          <!-- Location Search with Auto-complete -->
          <div class="location-search-container">
            <input type="text" 
                   class="location-search" 
                   id="location" 
                   placeholder="🔍 Search for location or enter manually..."
                   autocomplete="off" />
            <div class="search-suggestions" id="searchSuggestions"></div>
          </div>

          <!-- Enhanced GPS Controls -->
          <div class="gps-controls-enhanced">
            <button onclick="captureHighAccuracyGPS()" class="gps-btn-enhanced gps-btn-primary">
              📍 High-Accuracy GPS
            </button>
            <button onclick="captureQuickGPS()" class="gps-btn-enhanced gps-btn-secondary">
              ⚡ Quick GPS
            </button>
            <button onclick="useManualLocation()" class="gps-btn-enhanced gps-btn-tertiary">
              ✏️ Manual Entry
            </button>
          </div>

          <!-- Enhanced Interactive Map -->
          <div id="mapContainer">
            <div id="map"></div>
            <div class="map-controls-overlay">
              <button class="map-control-btn" onclick="toggleMapLayers()" title="Toggle Layers">🗂️</button>
              <button class="map-control-btn" onclick="measureDistance()" title="Measure Distance">📏</button>
              <button class="map-control-btn" onclick="addIncidentMarker()" title="Add Incident Marker">📍</button>
              <button class="map-control-btn" onclick="toggleSatelliteView()" title="Satellite View">🛰️</button>
              <button class="map-control-btn" onclick="findNearbyResources()" title="Find Resources">🚑</button>
            </div>
          </div>

          <!-- Coordinate Formats Panel -->
          <div class="coordinate-panel">
            <h4>📐 Coordinate Formats</h4>
            <div class="coordinate-formats">
              <div class="coordinate-format">
                <div class="coordinate-label">Decimal Degrees</div>
                <div class="coordinate-value" id="coordDD" onclick="copyCoordinate('DD')">---.------°, ---.------°</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">DMS (Degrees Minutes Seconds)</div>
                <div class="coordinate-value" id="coordDMS" onclick="copyCoordinate('DMS')">--°--'--"N, --°--'--"W</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">UTM (Universal Transverse Mercator)</div>
                <div class="coordinate-value" id="coordUTM" onclick="copyCoordinate('UTM')">-- --- -------E -------N</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">MGRS (Military Grid Reference)</div>
                <div class="coordinate-value" id="coordMGRS" onclick="copyCoordinate('MGRS')">-- --- ----- -----</div>
              </div>
            </div>
          </div>

          <!-- Emergency Resources Panel -->
          <div class="emergency-panel" id="emergencyPanel">
            <h4>🚨 Nearby Emergency Resources</h4>
            <div class="resource-grid" id="resourceGrid">
              <div class="resource-item">
                <div class="resource-type">🚑 Hospitals</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">🚒 Fire Stations</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">👮 Police Stations</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">⛑️ Emergency Services</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
            </div>
          </div>

          <!-- Map Analysis Panel -->
          <div class="map-analysis-panel" id="mapAnalysisPanel">
            <h4>📊 Location Risk Analysis</h4>
            <div class="analysis-metrics">
              <div class="analysis-metric">
                <div class="metric-value" id="populationDensity">--</div>
                <div class="metric-label">Population Density</div>
              </div>
              <div class="analysis-metric">
                <div class="metric-value" id="riskScore">--</div>
                <div class="metric-label">Risk Score</div>
              </div>
              <div class="analysis-metric">
                <div class="metric-value" id="responseTime">--</div>
                <div class="metric-label">Est. Response Time</div>
              </div>
            </div>
          </div>

          <!-- Hidden coordinate input for compatibility -->
          <input type="hidden" id="coordinates" />
          
          <label>Hazards:
            <input type="text" id="hazards" />
          </label>
          
          <label>Severity:
            <input type="number" id="severity" min="1" max="10" />
            <span id="severityBadge" class="severity-badge"></span>
          </label>
          
          <label>Notes:
            <textarea id="notes" rows="3"></textarea>
          </label>
        </details>

        <details open>
          <summary>✅ Checklist</summary>
          <label>Checklist Items (comma separated):
            <input type="text" id="checklist" />
          </label>
          <div id="checklistDisplay"></div>
        </details>

        <details open>
          <summary>📸 Hazard Images</summary>
          <input type="file" id="image_upload" accept="image/*" />
          <label>Image URL (optional):
            <input type="text" id="image_url" />
          </label>
          <img id="imagePreview" src="" alt="Image preview" style="display: none;" />
        </details>

        <button onclick="saveAndSyncReport()">💾 Save & Sync Report</button>
        <button onclick="saveOfflineReport()">📴 Save Offline Only</button>
      </div>

      <div class="preview">
        <h2>📄 Live JSON Preview</h2>
        <pre id="jsonPreview"></pre>
        <h2>📄 Map Preview</h2>
        <div id="mapPreview" style="height: 300px; border: 1px solid #ccc; margin-bottom: 1rem; border-radius: 8px;"></div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>🔒 Privacy-First | ⚙️ Works Offline | ⚡ AI-Powered</p>
  </footer>

  <!-- Base scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Core functionality scripts -->
  <script>
    // Theme toggle (from base template)
    const themeBtn = document.getElementById('toggleThemeBtn');
    themeBtn.addEventListener('click', () => {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

    // High contrast toggle (from base template)
    const contrastBtn = document.getElementById("contrastToggleBtn");
    contrastBtn.addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute('data-contrast');
      const next = current === 'high' ? 'normal' : 'high';
      html.setAttribute('data-contrast', next);
      localStorage.setItem('contrast', next);
    });

    const savedContrast = localStorage.getItem('contrast');
    if (savedContrast) document.documentElement.setAttribute('data-contrast', savedContrast);

    // Enhanced mapping variables
    let map, marker, mapPreview, mapPreviewMarker;
    let currentLayers = {};
    let measurementMode = false;
    let measurementLine = null;
    let satelliteView = false;
    let incidentMarkers = [];
    let resourceMarkers = [];
    
    // Location and coordinate data
    let currentPosition = null;
    let lastKnownCoordinates = { lat: 30.2672, lng: -97.7431 }; // Austin, TX default
    
    // Search and resources
    let searchTimeout = null;
    let nearbyResources = [];
    
    // Form data tracking
    const inputs = ["location", "coordinates", "hazards", "severity", "notes", "image_url", "checklist"];
    const teamMembers = ["Unassigned", "Fire Chief", "Medic", "Safety Officer", "Search & Rescue"];

    // Enhanced GPS Functions
    async function captureHighAccuracyGPS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '📍 Acquiring...';
      
      try {
        const position = await getCurrentPosition({
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 0
        });
        
        await processGpsPosition(position, 'High-Accuracy GPS');
        showToast('🎯 High-accuracy GPS captured!');
      } catch (error) {
        handleGpsError(error);
      } finally {
        btn.disabled = false;
        btn.textContent = '📍 High-Accuracy GPS';
      }
    }

    async function captureQuickGPS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '⚡ Locating...';
      
      try {
        const position = await getCurrentPosition({
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 300000
        });
        
        await processGpsPosition(position, 'Quick GPS');
        showToast('⚡ Quick GPS captured!');
      } catch (error) {
        handleGpsError(error);
      } finally {
        btn.disabled = false;
        btn.textContent = '⚡ Quick GPS';
      }
    }

    function useManualLocation() {
      document.getElementById('location').readOnly = false;
      document.getElementById('location').focus();
      showToast('✏️ Manual entry mode enabled');
    }

    function getCurrentPosition(options) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported'));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });
    }

    async function processGpsPosition(position, source) {
      const { latitude, longitude, accuracy } = position.coords;
      currentPosition = position;
      lastKnownCoordinates = { lat: latitude, lng: longitude };
      
      // Update map markers
      updateMapMarkers(latitude, longitude);
      
      // Update coordinate displays
      updateCoordinateFormats(latitude, longitude);
      
      // Reverse geocode for address
      try {
        const address = await reverseGeocode(latitude, longitude);
        document.getElementById('location').value = address;
      } catch (error) {
        document.getElementById('location').value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      }
      
      // Update hidden coordinates field
      document.getElementById('coordinates').value = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
      
      // Find nearby resources
      await findNearbyResources();
      
      // Update location analysis
      updateLocationAnalysis(latitude, longitude, accuracy);
      
      renderPreview();
    }

    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
          { headers: { 'User-Agent': 'DisasterResponseApp/1.0' } }
        );
        
        if (response.ok) {
          const data = await response.json();
          return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      } catch (error) {
        console.warn('Reverse geocoding failed:', error);
      }
      
      return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    }

    function handleGpsError(error) {
      let message = 'GPS unavailable';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = '❌ Location access denied';
          break;
        case error.POSITION_UNAVAILABLE:
          message = '❌ GPS unavailable';
          break;
        case error.TIMEOUT:
          message = '⏱️ GPS timeout';
          break;
      }
      
      showToast(message, 'error');
      
      setTimeout(() => {
        if (confirm('GPS failed. Would you like to enter location manually?')) {
          useManualLocation();
        }
      }, 1000);
    }

    // Enhanced Map Functions
    function initMap() {
      // Main map
      map = L.map('map').setView([lastKnownCoordinates.lat, lastKnownCoordinates.lng], 13);
      
      // Add base layer
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });
      osmLayer.addTo(map);
      
      // Add satellite layer (initially hidden)
      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
      });
      
      currentLayers = {
        osm: osmLayer,
        satellite: satelliteLayer
      };
      
      // Add draggable marker
      marker = L.marker([lastKnownCoordinates.lat, lastKnownCoordinates.lng], { 
        draggable: true,
        title: 'Incident Location (drag to adjust)'
      }).addTo(map);
      
      marker.on('dragend', () => {
        const pos = marker.getLatLng();
        lastKnownCoordinates = { lat: pos.lat, lng: pos.lng };
        updateCoordinateFormats(pos.lat, pos.lng);
        document.getElementById('coordinates').value = `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`;
        findNearbyResources();
        updateLocationAnalysis(pos.lat, pos.lng);
        renderPreview();
      });
      
      // Preview map
      mapPreview = L.map('mapPreview').setView([lastKnownCoordinates.lat, lastKnownCoordinates.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPreview);
      mapPreviewMarker = L.marker([lastKnownCoordinates.lat, lastKnownCoordinates.lng]).addTo(mapPreview);
    }

    function updateMapMarkers(lat, lng) {
      // Update main map
      if (marker) {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 15);
      }
      
      // Update preview map
      if (mapPreviewMarker) {
        mapPreviewMarker.setLatLng([lat, lng]);
        mapPreview.setView([lat, lng], 15);
      }
    }

    function updateCoordinateFormats(lat, lng) {
      // Decimal Degrees
      document.getElementById('coordDD').textContent = `${lat.toFixed(6)}°, ${lng.toFixed(6)}°`;
      
      // DMS (Degrees Minutes Seconds)
      const dmsLat = convertToDMS(lat, 'lat');
      const dmsLng = convertToDMS(lng, 'lng');
      document.getElementById('coordDMS').textContent = `${dmsLat}, ${dmsLng}`;
      
      // UTM (simplified approximation)
      const utm = convertToUTM(lat, lng);
      document.getElementById('coordUTM').textContent = utm;
      
      // MGRS (simplified approximation)
      const mgrs = convertToMGRS(lat, lng);
      document.getElementById('coordMGRS').textContent = mgrs;
    }

    function convertToDMS(decimal, type) {
      const absolute = Math.abs(decimal);
      const degrees = Math.floor(absolute);
      const minutesNotTruncated = (absolute - degrees) * 60;
      const minutes = Math.floor(minutesNotTruncated);
      const seconds = Math.floor((minutesNotTruncated - minutes) * 60);
      
      const direction = type === 'lat' ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
      return `${degrees}°${minutes}'${seconds}"${direction}`;
    }

    function convertToUTM(lat, lng) {
      // Simplified UTM conversion (approximation)
      const zone = Math.floor((lng + 180) / 6) + 1;
      const easting = Math.round(500000 + (lng * 111319.9));
      const northing = Math.round(lat * 110540);
      return `${zone}N ${easting}E ${northing}N`;
    }

    function convertToMGRS(lat, lng) {
      // Simplified MGRS conversion (approximation)
      const zone = Math.floor((lng + 180) / 6) + 1;
      const gridSquare = String.fromCharCode(65 + Math.floor(lat / 8));
      const easting = Math.round((lng % 6) * 18520).toString().padStart(5, '0');
      const northing = Math.round((lat % 8) * 13775).toString().padStart(5, '0');
      return `${zone}N ${gridSquare}A ${easting} ${northing}`;
    }

    function copyCoordinate(format) {
      const element = document.getElementById(`coord${format}`);
      const text = element.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast(`📋 ${format} coordinates copied!`);
        // Visual feedback
        element.style.background = 'rgba(255, 255, 255, 0.4)';
        setTimeout(() => {
          element.style.background = 'rgba(255, 255, 255, 0.1)';
        }, 300);
      }).catch(() => {
        showToast('Copy failed - please select and copy manually', 'error');
      });
    }

    // Map Control Functions
    function toggleMapLayers() {
      // Cycle through available map layers
      const layerOptions = document.createElement('div');
      layerOptions.style.cssText = `
        position: absolute;
        top: 45px;
        right: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        min-width: 150px;
      `;
      
      const layers = [
        { name: 'Street Map', key: 'osm' },
        { name: 'Satellite', key: 'satellite' },
        { name: 'Terrain', key: 'terrain' }
      ];
      
      layers.forEach(layer => {
        const option = document.createElement('div');
        option.style.cssText = `
          padding: 0.75rem;
          cursor: pointer;
          border-bottom: 1px solid #f3f4f6;
        `;
        option.textContent = layer.name;
        option.onclick = () => {
          switchMapLayer(layer.key);
          document.body.removeChild(layerOptions);
        };
        layerOptions.appendChild(option);
      });
      
      document.body.appendChild(layerOptions);
      
      // Remove on click outside
      setTimeout(() => {
        document.addEventListener('click', function removeOptions() {
          if (document.body.contains(layerOptions)) {
            document.body.removeChild(layerOptions);
          }
          document.removeEventListener('click', removeOptions);
        });
      }, 100);
    }

    function switchMapLayer(layerKey) {
      // Remove current layers
      Object.values(currentLayers).forEach(layer => {
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      
      // Add new layer
      if (layerKey === 'satellite') {
        currentLayers.satellite.addTo(map);
      } else if (layerKey === 'terrain') {
        // Add terrain layer if not exists
        if (!currentLayers.terrain) {
          currentLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenTopoMap contributors'
          });
        }
        currentLayers.terrain.addTo(map);
      } else {
        currentLayers.osm.addTo(map);
      }
      
      showToast(`🗺️ Switched to ${layerKey} view`);
    }

    function measureDistance() {
      if (measurementMode) {
        // Exit measurement mode
        measurementMode = false;
        if (measurementLine) {
          map.removeLayer(measurementLine);
          measurementLine = null;
        }
        showToast('📏 Measurement mode disabled');
        return;
      }
      
      measurementMode = true;
      showToast('📏 Click two points to measure distance');
      
      let firstPoint = null;
      const measureClick = (e) => {
        if (!firstPoint) {
          firstPoint = e.latlng;
          L.marker(firstPoint, {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNCIgZmlsbD0iIzNiODJmNiIvPgo8L3N2Zz4=',
              iconSize: [12, 12],
              iconAnchor: [6, 6]
            })
          }).addTo(map);
        } else {
          const secondPoint = e.latlng;
          const distance = firstPoint.distanceTo(secondPoint);
          
          measurementLine = L.polyline([firstPoint, secondPoint], {
            color: '#3b82f6',
            weight: 3,
            dashArray: '5, 10'
          }).addTo(map);
          
          L.marker(secondPoint, {
            icon: L.icon({
              iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNCIgZmlsbD0iIzNiODJmNiIvPgo8L3N2Zz4=',
              iconSize: [12, 12],
              iconAnchor: [6, 6]
            })
          }).addTo(map);
          
          const midPoint = L.latLng(
            (firstPoint.lat + secondPoint.lat) / 2,
            (firstPoint.lng + secondPoint.lng) / 2
          );
          
          L.popup()
            .setLatLng(midPoint)
            .setContent(`<strong>Distance:</strong> ${(distance / 1000).toFixed(2)} km<br><small>${distance.toFixed(0)} meters</small>`)
            .openOn(map);
          
          measurementMode = false;
          map.off('click', measureClick);
          showToast(`📏 Distance: ${(distance / 1000).toFixed(2)} km`);
        }
      };
      
      map.on('click', measureClick);
    }

    function addIncidentMarker() {
      const incidentTypes = [
        { name: '🔥 Fire', color: '#ef4444' },
        { name: '💥 Explosion', color: '#f97316' },
        { name: '🌊 Flood', color: '#3b82f6' },
        { name: '🏗️ Collapse', color: '#6b7280' },
        { name: '☣️ Hazmat', color: '#8b5cf6' },
        { name: '🚑 Medical', color: '#10b981' }
      ];
      
      const popup = L.popup()
        .setLatLng(map.getCenter())
        .setContent(`
          <div style="min-width: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">Add Incident Marker</h4>
            ${incidentTypes.map(type => `
              <button onclick="createIncidentMarker('${type.name}', '${type.color}')" 
                      style="display: block; width: 100%; margin: 0.25rem 0; padding: 0.5rem; border: none; background: ${type.color}; color: white; border-radius: 4px; cursor: pointer;">
                ${type.name}
              </button>
            `).join('')}
          </div>
        `)
        .openOn(map);
    }

    function createIncidentMarker(type, color) {
      const center = map.getCenter();
      const incidentMarker = L.marker(center, {
        icon: L.icon({
          iconUrl: `data:image/svg+xml;base64,${btoa(`
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="white" stroke-width="2"/>
              <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${type.split(' ')[0]}</text>
            </svg>
          `)}`,
          iconSize: [24, 24],
          iconAnchor: [12, 24]
        }),
        title: type
      }).addTo(map);
      
      incidentMarkers.push(incidentMarker);
      map.closePopup();
      showToast(`Added ${type} marker`);
    }

    function toggleSatelliteView() {
      satelliteView = !satelliteView;
      switchMapLayer(satelliteView ? 'satellite' : 'osm');
    }

    // Enhanced Resource Finding
    async function findNearbyResources() {
      if (!lastKnownCoordinates.lat || !lastKnownCoordinates.lng) return;
      
      const { lat, lng } = lastKnownCoordinates;
      
      // Clear existing resource markers
      resourceMarkers.forEach(marker => map.removeLayer(marker));
      resourceMarkers = [];
      
      // Show loading state
      const resourceTypes = ['🚑 Hospitals', '🚒 Fire Stations', '👮 Police Stations', '⛑️ Emergency Services'];
      resourceTypes.forEach((type, index) => {
        const item = document.querySelectorAll('.resource-item')[index];
        if (item) {
          item.querySelector('.resource-distance').textContent = 'Searching...';
          item.querySelector('.resource-name').textContent = '--';
        }
      });
      
      try {
        // Search for different types of emergency resources
        const resourceSearches = [
          searchNearbyPOI(lat, lng, 'hospital'),
          searchNearbyPOI(lat, lng, 'fire_station'),
          searchNearbyPOI(lat, lng, 'police'),
          searchNearbyPOI(lat, lng, 'emergency')
        ];
        
        const results = await Promise.allSettled(resourceSearches);
        
        results.forEach((result, index) => {
          const item = document.querySelectorAll('.resource-item')[index];
          if (result.status === 'fulfilled' && result.value && item) {
            const resource = result.value;
            const distance = calculateDistance(lat, lng, resource.lat, resource.lon);
            
            item.querySelector('.resource-distance').textContent = `${distance.toFixed(1)} km`;
            item.querySelector('.resource-name').textContent = resource.name;
            
            // Add marker to map
            const resourceMarker = L.marker([resource.lat, resource.lon], {
              icon: L.icon({
                iconUrl: `data:image/svg+xml;base64,${btoa(`
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" fill="#ef4444" stroke="white" stroke-width="2"/>
                    <text x="10" y="13" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${['🏥', '🚒', '👮', '⛑️'][index]}</text>
                  </svg>
                `)}`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              }),
              title: `${resource.name} (${distance.toFixed(1)} km)`
            }).addTo(map);
            
            resourceMarkers.push(resourceMarker);
            
            // Make resource item clickable
            item.onclick = () => {
              map.setView([resource.lat, resource.lon], 16);
              resourceMarker.openPopup();
            };
          } else if (item) {
            item.querySelector('.resource-distance').textContent = 'Not found';
            item.querySelector('.resource-name').textContent = 'No nearby resources';
          }
        });
        
        // Update location analysis
        updateLocationAnalysis(lat, lng);
        
      } catch (error) {
        console.error('Resource search failed:', error);
        showToast('⚠️ Resource search failed', 'error');
      }
    }

    async function searchNearbyPOI(lat, lng, type) {
      // Using Overpass API for OpenStreetMap data
      const query = `
        [out:json][timeout:10];
        (
          node["amenity"="${type}"](around:10000,${lat},${lng});
          way["amenity"="${type}"](around:10000,${lat},${lng});
          relation["amenity"="${type}"](around:10000,${lat},${lng});
        );
        out center meta;
      `;
      
      try {
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: `data=${encodeURIComponent(query)}`
        });
        
        if (!response.ok) throw new Error('Overpass API error');
        
        const data = await response.json();
        
        if (data.elements && data.elements.length > 0) {
          // Find closest result
          let closest = null;
          let minDistance = Infinity;
          
          data.elements.forEach(element => {
            const elementLat = element.lat || element.center?.lat;
            const elementLon = element.lon || element.center?.lon;
            
            if (elementLat && elementLon) {
              const distance = calculateDistance(lat, lng, elementLat, elementLon);
              if (distance < minDistance) {
                minDistance = distance;
                closest = {
                  name: element.tags?.name || `${type.replace('_', ' ')} facility`,
                  lat: elementLat,
                  lon: elementLon,
                  distance: distance
                };
              }
            }
          });
          
          return closest;
        }
        
        return null;
      } catch (error) {
        console.error(`Search for ${type} failed:`, error);
        return null;
      }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateLocationAnalysis(lat, lng, accuracy = null) {
      const panel = document.getElementById('mapAnalysisPanel');
      panel.classList.add('visible');
      
      // Population density estimation (simplified)
      const populationDensity = estimatePopulationDensity(lat, lng);
      document.getElementById('populationDensity').textContent = populationDensity;
      
      // Risk score calculation
      const riskScore = calculateRiskScore(lat, lng, accuracy);
      document.getElementById('riskScore').textContent = riskScore;
      
      // Response time estimation
      const responseTime = estimateResponseTime(resourceMarkers.length);
      document.getElementById('responseTime').textContent = responseTime;
    }

    function estimatePopulationDensity(lat, lng) {
      // Simplified population density estimation
      // In a real application, this would query actual demographic data
      const urbanCenters = [
        { lat: 30.2672, lng: -97.7431, density: 'High' }, // Austin
        { lat: 29.7604, lng: -95.3698, density: 'Very High' }, // Houston
        { lat: 32.7767, lng: -96.7970, density: 'High' } // Dallas
      ];
      
      let closestDensity = 'Low';
      let minDistance = Infinity;
      
      urbanCenters.forEach(center => {
        const distance = calculateDistance(lat, lng, center.lat, center.lng);
        if (distance < minDistance) {
          minDistance = distance;
          if (distance < 50) closestDensity = center.density;
          else if (distance < 100) closestDensity = 'Medium';
        }
      });
      
      return closestDensity;
    }

    function calculateRiskScore(lat, lng, accuracy) {
      let score = 1;
      
      // Factor in GPS accuracy
      if (accuracy && accuracy > 100) score += 1;
      else if (accuracy && accuracy > 50) score += 0.5;
      
      // Factor in resource availability
      const resourceCount = resourceMarkers.length;
      if (resourceCount === 0) score += 2;
      else if (resourceCount < 2) score += 1;
      
      // Factor in population density
      const density = document.getElementById('populationDensity').textContent;
      if (density === 'Very High') score += 1;
      else if (density === 'High') score += 0.5;
      
      return `${Math.min(10, score).toFixed(1)}/10`;
    }

    function estimateResponseTime(resourceCount) {
      if (resourceCount >= 3) return '5-10 min';
      else if (resourceCount >= 1) return '10-15 min';
      else return '15+ min';
    }

    // Location Search Functions
    function setupLocationSearch() {
      const searchInput = document.getElementById('location');
      const suggestionsDiv = document.getElementById('searchSuggestions');
      
      searchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (query.length < 3) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        searchTimeout = setTimeout(async () => {
          await searchLocations(query);
        }, 500);
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.style.display = 'none';
        }
      });
    }

    async function searchLocations(query) {
      const suggestionsDiv = document.getElementById('searchSuggestions');
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
          { headers: { 'User-Agent': 'DisasterResponseApp/1.0' } }
        );
        
        if (!response.ok) throw new Error('Search failed');
        
        const results = await response.json();
        
        if (results.length > 0) {
          suggestionsDiv.innerHTML = results.map(result => `
            <div class="search-suggestion" onclick="selectLocation(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
              <strong>${result.display_name.split(',')[0]}</strong><br>
              <small>${result.display_name}</small>
            </div>
          `).join('');
          
          suggestionsDiv.style.display = 'block';
        } else {
          suggestionsDiv.innerHTML = '<div class="search-suggestion">No results found</div>';
          suggestionsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Location search failed:', error);
        suggestionsDiv.innerHTML = '<div class="search-suggestion">Search failed - try again</div>';
        suggestionsDiv.style.display = 'block';
      }
    }

    function selectLocation(lat, lng, name) {
      document.getElementById('location').value = name;
      document.getElementById('searchSuggestions').style.display = 'none';
      
      lastKnownCoordinates = { lat: parseFloat(lat), lng: parseFloat(lng) };
      updateMapMarkers(lat, lng);
      updateCoordinateFormats(lat, lng);
      document.getElementById('coordinates').value = `${lat},${lng}`;
      
      findNearbyResources();
      updateLocationAnalysis(lat, lng);
      renderPreview();
      
      showToast(`📍 Location set: ${name.split(',')[0]}`);
    }

    // Utility Functions
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      const colors = {
        info: '#3b82f6',
        success: '#10b981',
        warning: '#f59e0b',
        error: '#ef4444'
      };
      
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 300px;
      `;
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast && toast.parentNode) {
          toast.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }
      }, duration);
    }

    // Form Management Functions
    function getSeverityClass(sev) {
      if (sev >= 8) return "sev-red";
      if (sev >= 5) return "sev-orange";
      if (sev >= 3) return "sev-yellow";
      return "sev-green";
    }

    function updateSeverityBadge() {
      const val = parseFloat(document.getElementById("severity").value);
      const badge = document.getElementById("severityBadge");
      if (!isNaN(val)) {
        badge.textContent = "SEV-" + val.toFixed(1);
        badge.className = "severity-badge " + getSeverityClass(val);
      } else {
        badge.textContent = "";
        badge.className = "severity-badge";
      }
    }

    function renderChecklist() {
      const raw = document.getElementById("checklist").value;
      const items = raw.split(",").map(c => c.trim()).filter(Boolean);
      const container = document.getElementById("checklistDisplay");
      container.innerHTML = "";

      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "checklist-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";

        const label = document.createElement("div");
        label.className = "checklist-label";
        label.textContent = item;

        const select = document.createElement("select");
        teamMembers.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(select);
        container.appendChild(div);
      });
    }

    function updateImagePreview() {
      const fileInput = document.getElementById("image_upload");
      const urlInput = document.getElementById("image_url");
      const preview = document.getElementById("imagePreview");

      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
      } else if (urlInput.value) {
        preview.src = urlInput.value;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }

    function collectFormData() {
      const checklistNodes = document.querySelectorAll(".checklist-item");
      const checklistData = Array.from(checklistNodes).map(div => ({
        item: div.querySelector(".checklist-label").textContent,
        completed: div.querySelector("input[type='checkbox']").checked,
        assigned_to: div.querySelector("select").value
      }));

      const reportId = crypto.randomUUID();
      let imageRef = null;

      const fileInput = document.getElementById("image_upload");
      if (fileInput.files && fileInput.files[0]) {
        imageRef = `upload://${fileInput.files[0].name}`;
      } else if (document.getElementById("image_url").value) {
        imageRef = document.getElementById("image_url").value;
      }

      return {
        id: reportId,
        timestamp: new Date().toISOString(),
        location: document.getElementById("location").value,
        coordinates: document.getElementById("coordinates").value.split(",").map(Number),
        coordinate_formats: {
          decimal_degrees: document.getElementById("coordDD").textContent,
          dms: document.getElementById("coordDMS").textContent,
          utm: document.getElementById("coordUTM").textContent,
          mgrs: document.getElementById("coordMGRS").textContent
        },
        hazards: document.getElementById("hazards").value.split(",").map(h => h.trim()),
        severity: parseFloat(document.getElementById("severity").value),
        notes: document.getElementById("notes").value,
        image_url: imageRef,
        checklist: checklistData,
        nearby_resources: nearbyResources,
        location_analysis: {
          population_density: document.getElementById("populationDensity")?.textContent || 'Unknown',
          risk_score: document.getElementById("riskScore")?.textContent || 'Unknown',
          estimated_response_time: document.getElementById("responseTime")?.textContent || 'Unknown'
        },
        gps_data: currentPosition ? {
          accuracy: currentPosition.coords.accuracy,
          timestamp: new Date(currentPosition.timestamp).toISOString(),
          altitude: currentPosition.coords.altitude,
          heading: currentPosition.coords.heading,
          speed: currentPosition.coords.speed
        } : null
      };
    }

    function renderPreview() {
      const data = collectFormData();
      document.getElementById("jsonPreview").textContent = JSON.stringify(data, null, 2);
    }

    // Save Functions (simplified for demo)
    async function saveOfflineReport() {
      try {
        const data = collectFormData();
        
        // Save to IndexedDB or localStorage
        let queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
        queue.push(data);
        localStorage.setItem("sync_queue", JSON.stringify(queue));
        
        showToast("📴 Report saved offline! Will sync when connected.", 'success');
        updateQueueDisplay();
        renderPreview();
      } catch (error) {
        console.error('Save offline failed:', error);
        showToast('❌ Failed to save report offline. Please try again.', 'error');
      }
    }

    async function saveAndSyncReport() {
      if (!navigator.onLine) {
        await saveOfflineReport();
        return;
      }
      
      try {
        const data = collectFormData();
        
        // In a real application, this would send to your server
        console.log('Syncing report:', data);
        showToast('✅ Report uploaded successfully!', 'success');
        
      } catch (error) {
        console.error('Save and sync failed:', error);
        await saveOfflineReport();
      }
    }

    async function forceSyncQueue() {
      const queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
      if (queue.length === 0) {
        showToast("✅ No reports to sync!", 'success');
        return;
      }
      
      if (!navigator.onLine) {
        showToast("❌ Cannot sync while offline!", 'error');
        return;
      }
      
      // In a real application, this would sync with your server
      localStorage.removeItem("sync_queue");
      updateQueueDisplay();
      showToast("✅ All reports synced successfully!", 'success');
    }

    function updateConnectionStatus() {
      const statusSpan = document.getElementById('connectionStatus');
      const queueSpan = document.getElementById('queueStatus');
      
      if (navigator.onLine) {
        statusSpan.innerHTML = '<span style="color: #10b981;">🟢 Online</span>';
      } else {
        statusSpan.innerHTML = '<span style="color: #ef4444;">🔴 Offline</span>';
      }
      
      updateQueueDisplay();
    }

    function updateQueueDisplay() {
      const queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
      const queueCount = document.getElementById('queueCount');
      const queueStatus = document.getElementById('queueStatus');
      
      queueCount.textContent = queue.length;
      
      if (queue.length > 0) {
        queueStatus.style.display = 'inline';
        queueStatus.textContent = `Queue: ${queue.length} reports`;
      } else {
        queueStatus.style.display = 'none';
      }
    }

    // Event Listeners
    window.addEventListener("online", updateConnectionStatus);
    window.addEventListener("offline", updateConnectionStatus);

    // Initialize on load
    window.onload = () => {
      // Set default values
      document.getElementById("location").value = "Austin, TX";
      document.getElementById("coordinates").value = "30.2672,-97.7431";
      document.getElementById("hazards").value = "fire, collapsed structure";
      document.getElementById("severity").value = "8.5";
      document.getElementById("notes").value = "Smoke observed, no visible injuries";
      document.getElementById("image_url").value = "https://via.placeholder.com/300";
      document.getElementById("checklist").value = "Clear debris, Search for victims";
      
      // Initialize components
      updateSeverityBadge();
      renderChecklist();
      updateImagePreview();
      updateCoordinateFormats(30.2672, -97.7431);
      renderPreview();
      initMap();
      updateConnectionStatus();
      updateQueueDisplay();
      setupLocationSearch();
      
      // Initial resource search
      setTimeout(() => {
        findNearbyResources();
      }, 2000);
      
      // Auto-sync every 30 seconds when online
      setInterval(() => {
        if (navigator.onLine) {
          // Auto-sync logic would go here
        }
      }, 30000);
    };

    // Event listeners for form inputs
    inputs.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("input", () => {
          if (id === "checklist") renderChecklist();
          if (id === "image_url") updateImagePreview();
          if (id === "severity") updateSeverityBadge();
          if (id === "coordinates") {
            const [lat, lng] = document.getElementById("coordinates").value.split(",").map(Number);
            if (!isNaN(lat) && !isNaN(lng)) {
              lastKnownCoordinates = { lat, lng };
              updateMapMarkers(lat, lng);
              updateCoordinateFormats(lat, lng);
              findNearbyResources();
            }
          }
          renderPreview();
        });
      }
    });

    // Image upload handler
    document.getElementById('image_upload').addEventListener('change', updateImagePreview);

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      
      .map-control-btn {
        transition: all 0.3s ease;
      }
      
      .map-control-btn:active {
        transform: scale(0.95);
      }
      
      .coordinate-value:active {
        transform: scale(0.98);
      }
      
      .resource-item:active {
        transform: scale(0.98);
      }
    `;
    document.head.appendChild(style);

    console.log('🗺️ Enhanced Live Report Builder loaded');
    console.log('📍 GPS controls: High-accuracy, Quick GPS, Manual entry');
    console.log('🗂️ Map controls: Layer toggle, Distance measurement, Incident markers');
    console.log('🚑 Emergency resources: Automatic proximity detection');
    console.log('📐 Coordinate formats: DD, DMS, UTM, MGRS');
  </script>
</body>
</html>