<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced Live Report Builder</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Load dependencies FIRST -->
  <script src="https://unpkg.com/idb-keyval@6/dist/idb-keyval-iife.min.js"></script>
  
  <!-- Then load your custom scripts -->
  <script src="/static/js/offline-recovery.js"></script>

  <style>
    /* Enhanced template-specific styles */
    .main-content {
      display: flex;
      gap: 2rem;
      margin-top: 2rem;
    }

    .editor, .preview {
      flex: 1;
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      padding: 2rem;
      box-shadow: var(--shadow-xl);
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      border: 1px solid var(--border-color);
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
    }

    .editor {
      border-right: 2px solid var(--border-color);
    }

    /* Enhanced Map Container */
    #mapContainer {
      position: relative;
      border: 3px solid var(--border-color);
      border-radius: var(--border-radius-xl);
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: var(--gradient-primary);
      box-shadow: var(--shadow-lg);
      transition: all var(--transition-normal);
    }
    
    #mapContainer:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }
    
    #map {
      height: 450px;
      position: relative;
      z-index: 1;
    }
    
    /* Map Controls Overlay */
    .map-controls-overlay {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .map-control-btn {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-md);
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: var(--shadow-lg);
      transition: all var(--transition-normal);
      backdrop-filter: var(--blur-lg);
      -webkit-backdrop-filter: var(--blur-lg);
      color: var(--text-primary);
    }
    
    .map-control-btn:hover {
      background: var(--info-blue);
      color: white;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
    }
    
    /* Enhanced Coordinate Panel */
    .coordinate-panel {
      background: linear-gradient(135deg, var(--safe-green) 0%, #059669 100%);
      color: white;
      border-radius: var(--border-radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .coordinate-panel h4 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
    }
    
    .coordinate-formats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .coordinate-format {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius-md);
      padding: 1rem;
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      transition: all var(--transition-normal);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .coordinate-format:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .coordinate-label {
      font-size: 0.875rem;
      opacity: 0.95;
      margin-bottom: 0.5rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .coordinate-value {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all var(--transition-fast);
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .coordinate-value:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.02);
    }
    
    /* Enhanced Emergency Resources Panel */
    .emergency-panel {
      background: linear-gradient(135deg, var(--emergency-red) 0%, #dc2626 100%);
      color: white;
      border-radius: var(--border-radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-xl);
      animation: slideIn 0.4s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .emergency-panel h4 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
    }
    
    .resource-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .resource-item {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius-md);
      padding: 1rem;
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      transition: all var(--transition-normal);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .resource-item:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .resource-type {
      font-size: 0.875rem;
      opacity: 0.95;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .resource-distance {
      font-weight: bold;
      font-size: 1.125rem;
      margin-bottom: 0.25rem;
    }
    
    .resource-name {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 0.5rem;
    }
    
    /* Enhanced Map Analysis Panel */
    .map-analysis-panel {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-radius: var(--border-radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      display: none;
      animation: slideIn 0.4s ease;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .map-analysis-panel.visible {
      display: block;
    }
    
    .analysis-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .analysis-metric {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius-md);
      padding: 1rem;
      text-align: center;
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all var(--transition-normal);
    }
    
    .analysis-metric:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }
    
    .metric-value {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .metric-label {
      font-size: 0.875rem;
      opacity: 0.95;
      font-weight: 600;
    }
    
    /* Enhanced GPS Controls */
    .gps-controls-enhanced {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .gps-btn-enhanced {
      padding: 1rem;
      border: none;
      border-radius: var(--border-radius-md);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .gps-btn-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }
    
    .gps-btn-enhanced:hover::before {
      left: 100%;
    }
    
    .gps-btn-enhanced:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }
    
    .gps-btn-primary {
      background: linear-gradient(135deg, var(--info-blue), #1d4ed8);
      color: white;
    }
    
    .gps-btn-primary:hover {
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
    }
    
    .gps-btn-secondary {
      background: linear-gradient(135deg, var(--safe-green), #047857);
      color: white;
    }
    
    .gps-btn-secondary:hover {
      box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
    }
    
    .gps-btn-tertiary {
      background: linear-gradient(135deg, var(--neutral-gray), #374151);
      color: white;
    }
    
    .gps-btn-tertiary:hover {
      box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
    }
    
    /* Enhanced Location Search */
    .location-search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }
    
    .location-search {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-md);
      font-size: 1rem;
      transition: all var(--transition-normal);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
    }
    
    .location-search:focus {
      border-color: var(--info-blue);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      outline: none;
      transform: translateY(-1px);
    }
    
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-xl);
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      backdrop-filter: var(--blur-lg);
      -webkit-backdrop-filter: var(--blur-lg);
    }
    
    .search-suggestion {
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: all var(--transition-fast);
      color: var(--text-primary);
    }
    
    .search-suggestion:hover {
      background: rgba(37, 99, 235, 0.1);
      transform: translateX(5px);
    }
    
    .search-suggestion:last-child {
      border-bottom: none;
    }
    
    /* Enhanced Form Elements */
    details {
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
      transition: all var(--transition-normal);
    }
    
    details:hover {
      border-color: var(--info-blue);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    summary {
      font-weight: 700;
      cursor: pointer;
      padding: 0.75rem;
      background: rgba(37, 99, 235, 0.1);
      border-radius: var(--border-radius-md);
      user-select: none;
      transition: all var(--transition-normal);
      color: var(--info-blue);
      font-size: 1.1rem;
    }
    
    summary:hover {
      background: rgba(37, 99, 235, 0.2);
      transform: translateX(5px);
    }
    
    input, textarea, select {
      width: 100%;
      margin-top: 0.75rem;
      margin-bottom: 1rem;
      padding: 1rem;
      font-size: 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-md);
      transition: all var(--transition-normal);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--info-blue);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      transform: translateY(-1px);
    }
    
    label { 
      display: block; 
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    button {
      margin-top: 1rem;
      padding: 1rem 2rem;
      background: var(--gradient-emergency);
      color: white;
      border: none;
      border-radius: var(--border-radius-md);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-normal);
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      box-shadow: var(--shadow-lg);
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
    }
    
    pre {
      background: var(--card-bg);
      padding: 1.5rem;
      overflow-x: auto;
      border-radius: var(--border-radius-md);
      border: 2px solid var(--border-color);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      font-size: 0.875rem;
      line-height: 1.6;
    }
    
    .severity-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      color: white;
      font-weight: bold;
      margin-left: 0.75rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .sev-green { background: var(--safe-green); }
    .sev-yellow { background: var(--warning-yellow); color: black; }
    .sev-orange { background: var(--urgent-orange); }
    .sev-red { background: var(--emergency-red); }
    
    .checklist-item {
      display: flex;
      gap: 1rem;
      align-items: center;
      border: 2px solid var(--border-color);
      padding: 1rem;
      border-radius: var(--border-radius-md);
      background: var(--card-bg);
      margin-bottom: 0.75rem;
      transition: all var(--transition-normal);
    }
    
    .checklist-item:hover {
      border-color: var(--info-blue);
      transform: translateX(5px);
    }
    
    .checklist-label { 
      flex: 1; 
      font-weight: 500;
    }
    
    #imagePreview {
      max-width: 100%;
      max-height: 250px;
      margin-top: 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow);
    }
    
    #syncStatus {
      background: var(--gradient-primary);
      color: white;
      padding: 1rem;
      text-align: center;
      border-radius: var(--border-radius-md);
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: var(--shadow);
    }
    
    .sync-queue-info {
      background: rgba(37, 99, 235, 0.1);
      border: 2px solid var(--info-blue);
      border-radius: var(--border-radius-md);
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: var(--info-blue);
      font-weight: 600;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .coordinate-formats,
      .resource-grid,
      .analysis-metrics {
        grid-template-columns: 1fr;
      }
      
      .gps-controls-enhanced {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      #map {
        height: 350px;
      }
      
      .editor, .preview {
        padding: 1.5rem;
      }
    }

    /* Dark theme adjustments */
    [data-theme="dark"] .editor,
    [data-theme="dark"] .preview {
      background: var(--card-bg);
      color: var(--text-primary);
    }

    [data-theme="dark"] details {
      background: rgba(31, 41, 55, 0.8);
      border-color: var(--border-color);
    }

    [data-theme="dark"] summary {
      background: rgba(37, 99, 235, 0.2);
    }

    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select {
      background: rgba(17, 24, 39, 0.9);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] pre {
      background: var(--card-bg);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .checklist-item {
      background: var(--card-bg);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .search-suggestions {
      background: var(--card-bg);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .search-suggestion:hover {
      background: rgba(37, 99, 235, 0.2);
    }

    [data-theme="dark"] .location-search {
      background: rgba(17, 24, 39, 0.9);
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">üó∫Ô∏è</div>
      <div>
        <h1 class="title">Enhanced Live Report Builder</h1>
        <p class="subtitle">AI-Powered Field Reporting with Real-time Maps</p>
      </div>
      <div class="controls">
        <button id="toggleThemeBtn" aria-label="Toggle dark/light theme">üåì Toggle Theme</button>
        <button id="contrastToggleBtn" aria-label="Toggle high contrast mode">‚ôø High Contrast</button>
        <div class="status-bar">
          <div class="status-indicator status-offline">
            <div class="status-dot"></div>
            Offline Ready
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Sync Status Bar -->
    <div id="syncStatus">
      üîÑ Sync Status: <span id="connectionStatus">Checking...</span>
      <span id="queueStatus" class="offline-indicator" style="display: none;">Queue: 0 reports</span>
    </div>

    <div class="main-content">
      <div class="editor">
        <h2>üìù Enhanced Report Builder</h2>

        <div class="sync-queue-info" id="syncInfo">
          <strong>üìä Sync Queue:</strong> <span id="queueCount">0</span> reports pending
          <button onclick="forceSyncQueue()" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;">üîÑ Force Sync</button>
        </div>

        <!-- Enhanced GPS & Location Section -->
        <details open>
          <summary>üó∫Ô∏è Enhanced Location & Mapping</summary>
          
          <!-- Location Search with Auto-complete -->
          <div class="location-search-container">
            <input type="text" 
                   class="location-search" 
                   id="location" 
                   placeholder="üîç Search for location or enter manually..."
                   autocomplete="off" />
            <div class="search-suggestions" id="searchSuggestions"></div>
          </div>

          <!-- Enhanced GPS Controls -->
          <div class="gps-controls-enhanced">
            <button onclick="captureHighAccuracyGPS()" class="gps-btn-enhanced gps-btn-primary">
              üìç High-Accuracy GPS
            </button>
            <button onclick="captureQuickGPS()" class="gps-btn-enhanced gps-btn-secondary">
              ‚ö° Quick GPS
            </button>
            <button onclick="useManualLocation()" class="gps-btn-enhanced gps-btn-tertiary">
              ‚úèÔ∏è Manual Entry
            </button>
          </div>

          <!-- Enhanced Interactive Map -->
          <div id="mapContainer">
            <div id="map"></div>
            <div class="map-controls-overlay">
              <button class="map-control-btn" onclick="toggleMapLayers()" title="Toggle Layers">üóÇÔ∏è</button>
              <button class="map-control-btn" onclick="measureDistance()" title="Measure Distance">üìè</button>
              <button class="map-control-btn" onclick="addIncidentMarker()" title="Add Incident Marker">üìç</button>
              <button class="map-control-btn" onclick="toggleSatelliteView()" title="Satellite View">üõ∞Ô∏è</button>
              <button class="map-control-btn" onclick="findNearbyResources()" title="Find Resources">üöë</button>
            </div>
          </div>

          <!-- Coordinate Formats Panel -->
          <div class="coordinate-panel">
            <h4>üìê Coordinate Formats</h4>
            <div class="coordinate-formats">
              <div class="coordinate-format">
                <div class="coordinate-label">Decimal Degrees</div>
                <div class="coordinate-value" id="coordDD" onclick="copyCoordinate('DD')">---.------¬∞, ---.------¬∞</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">DMS (Degrees Minutes Seconds)</div>
                <div class="coordinate-value" id="coordDMS" onclick="copyCoordinate('DMS')">--¬∞--'--"N, --¬∞--'--"W</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">UTM (Universal Transverse Mercator)</div>
                <div class="coordinate-value" id="coordUTM" onclick="copyCoordinate('UTM')">-- --- -------E -------N</div>
              </div>
              <div class="coordinate-format">
                <div class="coordinate-label">MGRS (Military Grid Reference)</div>
                <div class="coordinate-value" id="coordMGRS" onclick="copyCoordinate('MGRS')">-- --- ----- -----</div>
              </div>
            </div>
          </div>

          <!-- Emergency Resources Panel -->
          <div class="emergency-panel" id="emergencyPanel">
            <h4>üö® Nearby Emergency Resources</h4>
            <div class="resource-grid" id="resourceGrid">
              <div class="resource-item">
                <div class="resource-type">üöë Hospitals</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">üöí Fire Stations</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">üëÆ Police Stations</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
              <div class="resource-item">
                <div class="resource-type">‚õëÔ∏è Emergency Services</div>
                <div class="resource-distance">Searching...</div>
                <div class="resource-name">--</div>
              </div>
            </div>
          </div>

          <!-- Map Analysis Panel -->
          <div class="map-analysis-panel" id="mapAnalysisPanel">
            <h4>üìä Location Risk Analysis</h4>
            <div class="analysis-metrics">
              <div class="analysis-metric">
                <div class="metric-value" id="populationDensity">--</div>
                <div class="metric-label">Population Density</div>
              </div>
              <div class="analysis-metric">
                <div class="metric-value" id="riskScore">--</div>
                <div class="metric-label">Risk Score</div>
              </div>
              <div class="analysis-metric">
                <div class="metric-value" id="responseTime">--</div>
                <div class="metric-label">Est. Response Time</div>
              </div>
            </div>
          </div>

          <!-- Hidden coordinate input for compatibility -->
          <input type="hidden" id="coordinates" />
          
          <label>Hazards:
            <input type="text" id="hazards" />
          </label>
          
          <label>Severity:
            <input type="number" id="severity" min="1" max="10" />
            <span id="severityBadge" class="severity-badge"></span>
          </label>
          
          <label>Notes:
            <textarea id="notes" rows="4"></textarea>
          </label>
        </details>

        <details open>
          <summary>‚úÖ Checklist</summary>
          <label>Checklist Items (comma separated):
            <input type="text" id="checklist" />
          </label>
          <div id="checklistDisplay"></div>
        </details>

        <details open>
          <summary>üì∏ Hazard Images</summary>
          <input type="file" id="image_upload" accept="image/*" />
          <label>Image URL (optional):
            <input type="text" id="image_url" />
          </label>
          <img id="imagePreview" src="" alt="Image preview" style="display: none;" />
        </details>

        <button onclick="saveAndSyncReport()">üíæ Save & Sync Report</button>
        <button onclick="saveOfflineReport()">üì¥ Save Offline Only</button>
      </div>

      <div class="preview">
        <h2>üìÑ Live JSON Preview</h2>
        <pre id="jsonPreview"></pre>
        <h2>üìÑ Map Preview</h2>
        <div id="mapPreview" style="height: 300px; border: 2px solid var(--border-color); margin-bottom: 1rem; border-radius: var(--border-radius-md); background: var(--light-bg);"></div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>üîí Privacy-First | ‚öôÔ∏è Works Offline | ‚ö° AI-Powered</p>
  </footer>

  <!-- Load Leaflet after the DOM -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Error handling and dependency checking
    window.addEventListener('error', function(e) {
      console.error('Script error:', e.error);
      console.error('At:', e.filename, 'line:', e.lineno);
    });

    // Check if required dependencies are loaded
    function checkDependencies() {
      const issues = [];
      
      if (typeof idbKeyval === 'undefined') {
        issues.push('idb-keyval library not loaded');
      }
      
      if (typeof L === 'undefined') {
        issues.push('Leaflet library not loaded');
      }
      
      if (issues.length > 0) {
        console.error('‚ùå Missing dependencies:', issues);
        showToast('‚ö†Ô∏è Some features may not work - dependencies failed to load', 'warning');
        return false;
      }
      
      console.log('‚úÖ All dependencies loaded successfully');
      return true;
    }

    // Add missing functions for offline recovery compatibility
    async function getImageBlob(reportId) {
      try {
        // Placeholder implementation - expand based on your needs
        return { blob: null };
      } catch (error) {
        console.error('getImageBlob error:', error);
        return { blob: null };
      }
    }

    async function deleteImageBlob(reportId) {
      try {
        // Placeholder implementation - expand based on your needs
        return true;
      } catch (error) {
        console.error('deleteImageBlob error:', error);
        return false;
      }
    }

    // Theme toggle functionality
    const themeBtn = document.getElementById('toggleThemeBtn');
    if (themeBtn) {
      themeBtn.addEventListener('click', () => {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        showToast(`üé® Switched to ${next} theme`, 'success');
      });
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // High contrast toggle
    const contrastBtn = document.getElementById("contrastToggleBtn");
    if (contrastBtn) {
      contrastBtn.addEventListener("click", () => {
        const html = document.documentElement;
        const current = html.getAttribute('data-contrast');
        const next = current === 'high' ? 'normal' : 'high';
        html.setAttribute('data-contrast', next);
        localStorage.setItem('contrast', next);
        showToast(`‚ôø ${next === 'high' ? 'Enabled' : 'Disabled'} high contrast`, 'info');
      });
    }

    // Load saved contrast setting
    const savedContrast = localStorage.getItem('contrast');
    if (savedContrast) {
      document.documentElement.setAttribute('data-contrast', savedContrast);
    }

    // Enhanced mapping variables
    let map, marker, mapPreview, mapPreviewMarker;
    let currentLayers = {};
    let measurementMode = false;
    let measurementLine = null;
    let satelliteView = false;
    let incidentMarkers = [];
    let resourceMarkers = [];
    
    // Location and coordinate data
    let currentPosition = null;
    let lastKnownCoordinates = { lat: 30.2672, lng: -97.7431 }; // Austin, TX default
    
    // Search and resources
    let searchTimeout = null;
    let nearbyResources = [];
    
    // Form data tracking
    const inputs = ["location", "coordinates", "hazards", "severity", "notes", "image_url", "checklist"];
    const teamMembers = ["Unassigned", "Fire Chief", "Medic", "Safety Officer", "Search & Rescue"];

    // Enhanced GPS Functions
    async function captureHighAccuracyGPS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'üìç Acquiring...';
      
      try {
        const position = await getCurrentPosition({
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 0
        });
        
        await processGpsPosition(position, 'High-Accuracy GPS');
        showToast('üéØ High-accuracy GPS captured!', 'success');
      } catch (error) {
        handleGpsError(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìç High-Accuracy GPS';
      }
    }

    async function captureQuickGPS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚ö° Locating...';
      
      try {
        const position = await getCurrentPosition({
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 300000
        });
        
        await processGpsPosition(position, 'Quick GPS');
        showToast('‚ö° Quick GPS captured!', 'success');
      } catch (error) {
        handleGpsError(error);
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ö° Quick GPS';
      }
    }

    function useManualLocation() {
      document.getElementById('location').readOnly = false;
      document.getElementById('location').focus();
      showToast('‚úèÔ∏è Manual entry mode enabled', 'info');
    }

    function getCurrentPosition(options) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported'));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });
    }

    async function processGpsPosition(position, source) {
      const { latitude, longitude, accuracy } = position.coords;
      currentPosition = position;
      lastKnownCoordinates = { lat: latitude, lng: longitude };
      
      // Update map markers
      updateMapMarkers(latitude, longitude);
      
      // Update coordinate displays
      updateCoordinateFormats(latitude, longitude);
      
      // Reverse geocode for address
      try {
        const address = await reverseGeocode(latitude, longitude);
        document.getElementById('location').value = address;
      } catch (error) {
        document.getElementById('location').value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      }
      
      // Update hidden coordinates field
      document.getElementById('coordinates').value = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
      
      // Find nearby resources
      await findNearbyResources();
      
      // Update location analysis
      updateLocationAnalysis(latitude, longitude, accuracy);
      
      renderPreview();
    }

    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
          { headers: { 'User-Agent': 'DisasterResponseApp/1.0' } }
        );
        
        if (response.ok) {
          const data = await response.json();
          return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      } catch (error) {
        console.warn('Reverse geocoding failed:', error);
      }
      
      return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    }

    function handleGpsError(error) {
      let message = 'GPS unavailable';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = '‚ùå Location access denied';
          break;
        case error.POSITION_UNAVAILABLE:
          message = '‚ùå GPS unavailable';
          break;
        case error.TIMEOUT:
          message = '‚è±Ô∏è GPS timeout';
          break;
      }
      
      showToast(message, 'error');
      
      setTimeout(() => {
        if (confirm('GPS failed. Would you like to enter location manually?')) {
          useManualLocation();
        }
      }, 1000);
    }

    // Enhanced Map Functions
    function initMap() {
      if (typeof L === 'undefined') {
        console.error('Leaflet not loaded, cannot initialize map');
        return;
      }

      try {
        // Main map
        map = L.map('map').setView([lastKnownCoordinates.lat, lastKnownCoordinates.lng], 13);
        
        // Add base layer
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        });
        osmLayer.addTo(map);
        
        // Add satellite layer (initially hidden)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: '&copy; Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
        });
        
        currentLayers = {
          osm: osmLayer,
          satellite: satelliteLayer
        };
        
        // Add draggable marker
        marker = L.marker([lastKnownCoordinates.lat, lastKnownCoordinates.lng], { 
          draggable: true,
          title: 'Incident Location (drag to adjust)'
        }).addTo(map);
        
        marker.on('dragend', () => {
          const pos = marker.getLatLng();
          lastKnownCoordinates = { lat: pos.lat, lng: pos.lng };
          updateCoordinateFormats(pos.lat, pos.lng);
          document.getElementById('coordinates').value = `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`;
          findNearbyResources();
          updateLocationAnalysis(pos.lat, pos.lng);
          renderPreview();
        });
        
        // Preview map
        mapPreview = L.map('mapPreview').setView([lastKnownCoordinates.lat, lastKnownCoordinates.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPreview);
        mapPreviewMarker = L.marker([lastKnownCoordinates.lat, lastKnownCoordinates.lng]).addTo(mapPreview);
        
        console.log('‚úÖ Maps initialized successfully');
      } catch (error) {
        console.error('‚ùå Map initialization failed:', error);
        showToast('‚ö†Ô∏è Map initialization failed', 'error');
      }
    }

    function updateMapMarkers(lat, lng) {
      try {
        // Update main map
        if (marker) {
          marker.setLatLng([lat, lng]);
          map.setView([lat, lng], 15);
        }
        
        // Update preview map
        if (mapPreviewMarker) {
          mapPreviewMarker.setLatLng([lat, lng]);
          mapPreview.setView([lat, lng], 15);
        }
      } catch (error) {
        console.error('Error updating map markers:', error);
      }
    }

    function updateCoordinateFormats(lat, lng) {
      try {
        // Decimal Degrees
        document.getElementById('coordDD').textContent = `${lat.toFixed(6)}¬∞, ${lng.toFixed(6)}¬∞`;
        
        // DMS (Degrees Minutes Seconds)
        const dmsLat = convertToDMS(lat, 'lat');
        const dmsLng = convertToDMS(lng, 'lng');
        document.getElementById('coordDMS').textContent = `${dmsLat}, ${dmsLng}`;
        
        // UTM (simplified approximation)
        const utm = convertToUTM(lat, lng);
        document.getElementById('coordUTM').textContent = utm;
        
        // MGRS (simplified approximation)
        const mgrs = convertToMGRS(lat, lng);
        document.getElementById('coordMGRS').textContent = mgrs;
      } catch (error) {
        console.error('Error updating coordinate formats:', error);
      }
    }

    function convertToDMS(decimal, type) {
      const absolute = Math.abs(decimal);
      const degrees = Math.floor(absolute);
      const minutesNotTruncated = (absolute - degrees) * 60;
      const minutes = Math.floor(minutesNotTruncated);
      const seconds = Math.floor((minutesNotTruncated - minutes) * 60);
      
      const direction = type === 'lat' ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
      return `${degrees}¬∞${minutes}'${seconds}"${direction}`;
    }

    function convertToUTM(lat, lng) {
      // Simplified UTM conversion (approximation)
      const zone = Math.floor((lng + 180) / 6) + 1;
      const easting = Math.round(500000 + (lng * 111319.9));
      const northing = Math.round(lat * 110540);
      return `${zone}N ${easting}E ${northing}N`;
    }

    function convertToMGRS(lat, lng) {
      // Simplified MGRS conversion (approximation)
      const zone = Math.floor((lng + 180) / 6) + 1;
      const gridSquare = String.fromCharCode(65 + Math.floor(lat / 8));
      const easting = Math.round((lng % 6) * 18520).toString().padStart(5, '0');
      const northing = Math.round((lat % 8) * 13775).toString().padStart(5, '0');
      return `${zone}N ${gridSquare}A ${easting} ${northing}`;
    }

    function copyCoordinate(format) {
      try {
        const element = document.getElementById(`coord${format}`);
        const text = element.textContent;
        
        navigator.clipboard.writeText(text).then(() => {
          showToast(`üìã ${format} coordinates copied!`, 'success');
          // Visual feedback
          element.style.background = 'rgba(255, 255, 255, 0.4)';
          setTimeout(() => {
            element.style.background = 'rgba(255, 255, 255, 0.15)';
          }, 300);
        }).catch(() => {
          showToast('Copy failed - please select and copy manually', 'error');
        });
      } catch (error) {
        console.error('Copy coordinate error:', error);
        showToast('Copy failed', 'error');
      }
    }

    // Map Control Functions
    function toggleMapLayers() {
      if (!map) return;
      
      try {
        // Create layer selection popup
        const layerOptions = document.createElement('div');
        layerOptions.style.cssText = `
          position: absolute;
          top: 50px;
          right: 15px;
          background: var(--card-bg);
          border: 2px solid var(--border-color);
          border-radius: var(--border-radius-md);
          box-shadow: var(--shadow-xl);
          z-index: 1001;
          min-width: 180px;
          backdrop-filter: var(--blur-lg);
          -webkit-backdrop-filter: var(--blur-lg);
        `;
        
        const layers = [
          { name: 'Street Map', key: 'osm' },
          { name: 'Satellite', key: 'satellite' },
          { name: 'Terrain', key: 'terrain' }
        ];
        
        layers.forEach(layer => {
          const option = document.createElement('div');
          option.style.cssText = `
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            transition: all var(--transition-fast);
          `;
          option.textContent = layer.name;
          option.onmouseover = () => {
            option.style.background = 'rgba(37, 99, 235, 0.1)';
            option.style.transform = 'translateX(5px)';
          };
          option.onmouseout = () => {
            option.style.background = 'transparent';
            option.style.transform = 'translateX(0)';
          };
          option.onclick = () => {
            switchMapLayer(layer.key);
            document.body.removeChild(layerOptions);
          };
          layerOptions.appendChild(option);
        });
        
        document.body.appendChild(layerOptions);
        
        // Remove on click outside
        setTimeout(() => {
          document.addEventListener('click', function removeOptions() {
            if (document.body.contains(layerOptions)) {
              document.body.removeChild(layerOptions);
            }
            document.removeEventListener('click', removeOptions);
          });
        }, 100);
      } catch (error) {
        console.error('Error toggling map layers:', error);
      }
    }

    function switchMapLayer(layerKey) {
      if (!map || !currentLayers) return;
      
      try {
        // Remove current layers
        Object.values(currentLayers).forEach(layer => {
          if (map.hasLayer(layer)) {
            map.removeLayer(layer);
          }
        });
        
        // Add new layer
        if (layerKey === 'satellite') {
          currentLayers.satellite.addTo(map);
        } else if (layerKey === 'terrain') {
          // Add terrain layer if not exists
          if (!currentLayers.terrain) {
            currentLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenTopoMap contributors'
            });
          }
          currentLayers.terrain.addTo(map);
        } else {
          currentLayers.osm.addTo(map);
        }
        
        showToast(`üó∫Ô∏è Switched to ${layerKey} view`, 'success');
      } catch (error) {
        console.error('Error switching map layer:', error);
      }
    }

    function measureDistance() {
      if (!map) return;
      
      try {
        if (measurementMode) {
          // Exit measurement mode
          measurementMode = false;
          if (measurementLine) {
            map.removeLayer(measurementLine);
            measurementLine = null;
          }
          showToast('üìè Measurement mode disabled', 'info');
          return;
        }
        
        measurementMode = true;
        showToast('üìè Click two points to measure distance', 'info');
        
        let firstPoint = null;
        const measureClick = (e) => {
          if (!firstPoint) {
            firstPoint = e.latlng;
            L.marker(firstPoint, {
              icon: L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgZmlsbD0iIzM3OTlmNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
              })
            }).addTo(map);
          } else {
            const secondPoint = e.latlng;
            const distance = firstPoint.distanceTo(secondPoint);
            
            measurementLine = L.polyline([firstPoint, secondPoint], {
              color: '#3b82f6',
              weight: 4,
              dashArray: '8, 12'
            }).addTo(map);
            
            L.marker(secondPoint, {
              icon: L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgZmlsbD0iIzM3OTlmNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
              })
            }).addTo(map);
            
            const midPoint = L.latLng(
              (firstPoint.lat + secondPoint.lat) / 2,
              (firstPoint.lng + secondPoint.lng) / 2
            );
            
            L.popup()
              .setLatLng(midPoint)
              .setContent(`<div style="text-align: center; font-weight: bold;"><strong>Distance:</strong><br>${(distance / 1000).toFixed(2)} km<br><small>${distance.toFixed(0)} meters</small></div>`)
              .openOn(map);
            
            measurementMode = false;
            map.off('click', measureClick);
            showToast(`üìè Distance: ${(distance / 1000).toFixed(2)} km`, 'success');
          }
        };
        
        map.on('click', measureClick);
      } catch (error) {
        console.error('Error in measure distance:', error);
      }
    }

    function addIncidentMarker() {
      if (!map) return;
      
      try {
        const incidentTypes = [
          { name: 'üî• Fire', color: '#ef4444' },
          { name: 'üí• Explosion', color: '#f97316' },
          { name: 'üåä Flood', color: '#3b82f6' },
          { name: 'üèóÔ∏è Collapse', color: '#6b7280' },
          { name: '‚ò£Ô∏è Hazmat', color: '#8b5cf6' },
          { name: 'üöë Medical', color: '#10b981' }
        ];
        
        const popup = L.popup()
          .setLatLng(map.getCenter())
          .setContent(`
            <div style="min-width: 220px; font-family: system-ui;">
              <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.1rem;">Add Incident Marker</h4>
              ${incidentTypes.map(type => `
                <button onclick="createIncidentMarker('${type.name}', '${type.color}')" 
                        style="display: block; width: 100%; margin: 0.5rem 0; padding: 0.75rem; border: none; background: ${type.color}; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s ease;">
                  ${type.name}
                </button>
              `).join('')}
            </div>
          `)
          .openOn(map);
      } catch (error) {
        console.error('Error adding incident marker:', error);
      }
    }

    function createIncidentMarker(type, color) {
      if (!map) return;
      
      try {
        const center = map.getCenter();
        const incidentMarker = L.marker(center, {
          icon: L.icon({
            iconUrl: `data:image/svg+xml;base64,${btoa(`
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="16" r="14" fill="${color}" stroke="white" stroke-width="3"/>
                <text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${type.split(' ')[0]}</text>
              </svg>
            `)}`,
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          }),
          title: type
        }).addTo(map);
        
        incidentMarkers.push(incidentMarker);
        map.closePopup();
        showToast(`Added ${type} marker`, 'success');
      } catch (error) {
        console.error('Error creating incident marker:', error);
      }
    }

    function toggleSatelliteView() {
      satelliteView = !satelliteView;
      switchMapLayer(satelliteView ? 'satellite' : 'osm');
    }

    // Enhanced Resource Finding
    async function findNearbyResources() {
      if (!lastKnownCoordinates.lat || !lastKnownCoordinates.lng) return;
      
      const { lat, lng } = lastKnownCoordinates;
      
      try {
        // Clear existing resource markers
        resourceMarkers.forEach(marker => {
          if (map && map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        });
        resourceMarkers = [];
        
        // Show loading state
        const resourceTypes = ['üöë Hospitals', 'üöí Fire Stations', 'üëÆ Police Stations', '‚õëÔ∏è Emergency Services'];
        resourceTypes.forEach((type, index) => {
          const item = document.querySelectorAll('.resource-item')[index];
          if (item) {
            item.querySelector('.resource-distance').textContent = 'Searching...';
            item.querySelector('.resource-name').textContent = '--';
          }
        });
        
        // Search for different types of emergency resources
        const resourceSearches = [
          searchNearbyPOI(lat, lng, 'hospital'),
          searchNearbyPOI(lat, lng, 'fire_station'),
          searchNearbyPOI(lat, lng, 'police'),
          searchNearbyPOI(lat, lng, 'emergency')
        ];
        
        const results = await Promise.allSettled(resourceSearches);
        
        results.forEach((result, index) => {
          const item = document.querySelectorAll('.resource-item')[index];
          if (result.status === 'fulfilled' && result.value && item) {
            const resource = result.value;
            const distance = calculateDistance(lat, lng, resource.lat, resource.lon);
            
            item.querySelector('.resource-distance').textContent = `${distance.toFixed(1)} km`;
            item.querySelector('.resource-name').textContent = resource.name;
            
            if (map) {
              // Add marker to map
              const resourceMarker = L.marker([resource.lat, resource.lon], {
                icon: L.icon({
                  iconUrl: `data:image/svg+xml;base64,${btoa(`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10" fill="#ef4444" stroke="white" stroke-width="2"/>
                      <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${['üè•', 'üöí', 'üëÆ', '‚õëÔ∏è'][index]}</text>
                    </svg>
                  `)}`,
                  iconSize: [24, 24],
                  iconAnchor: [12, 12]
                }),
                title: `${resource.name} (${distance.toFixed(1)} km)`
              }).addTo(map);
              
              resourceMarkers.push(resourceMarker);
            }
            
            // Make resource item clickable
            item.onclick = () => {
              if (map) {
                map.setView([resource.lat, resource.lon], 16);
                if (resourceMarker) {
                  resourceMarker.openPopup();
                }
              }
            };
          } else if (item) {
            item.querySelector('.resource-distance').textContent = 'Not found';
            item.querySelector('.resource-name').textContent = 'No nearby resources';
          }
        });
        
        // Update location analysis
        updateLocationAnalysis(lat, lng);
        
      } catch (error) {
        console.error('Resource search failed:', error);
        showToast('‚ö†Ô∏è Resource search failed', 'error');
      }
    }

    async function searchNearbyPOI(lat, lng, type) {
      // Using Overpass API for OpenStreetMap data
      const query = `
        [out:json][timeout:10];
        (
          node["amenity"="${type}"](around:10000,${lat},${lng});
          way["amenity"="${type}"](around:10000,${lat},${lng});
          relation["amenity"="${type}"](around:10000,${lat},${lng});
        );
        out center meta;
      `;
      
      try {
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: `data=${encodeURIComponent(query)}`
        });
        
        if (!response.ok) throw new Error('Overpass API error');
        
        const data = await response.json();
        
        if (data.elements && data.elements.length > 0) {
          // Find closest result
          let closest = null;
          let minDistance = Infinity;
          
          data.elements.forEach(element => {
            const elementLat = element.lat || element.center?.lat;
            const elementLon = element.lon || element.center?.lon;
            
            if (elementLat && elementLon) {
              const distance = calculateDistance(lat, lng, elementLat, elementLon);
              if (distance < minDistance) {
                minDistance = distance;
                closest = {
                  name: element.tags?.name || `${type.replace('_', ' ')} facility`,
                  lat: elementLat,
                  lon: elementLon,
                  distance: distance
                };
              }
            }
          });
          
          return closest;
        }
        
        return null;
      } catch (error) {
        console.error(`Search for ${type} failed:`, error);
        return null;
      }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateLocationAnalysis(lat, lng, accuracy = null) {
      try {
        const panel = document.getElementById('mapAnalysisPanel');
        if (panel) {
          panel.classList.add('visible');
          
          // Population density estimation (simplified)
          const populationDensity = estimatePopulationDensity(lat, lng);
          const densityElement = document.getElementById('populationDensity');
          if (densityElement) densityElement.textContent = populationDensity;
          
          // Risk score calculation
          const riskScore = calculateRiskScore(lat, lng, accuracy);
          const riskElement = document.getElementById('riskScore');
          if (riskElement) riskElement.textContent = riskScore;
          
          // Response time estimation
          const responseTime = estimateResponseTime(resourceMarkers.length);
          const timeElement = document.getElementById('responseTime');
          if (timeElement) timeElement.textContent = responseTime;
        }
      } catch (error) {
        console.error('Error updating location analysis:', error);
      }
    }

    function estimatePopulationDensity(lat, lng) {
      // Simplified population density estimation
      const urbanCenters = [
        { lat: 30.2672, lng: -97.7431, density: 'High' }, // Austin
        { lat: 29.7604, lng: -95.3698, density: 'Very High' }, // Houston
        { lat: 32.7767, lng: -96.7970, density: 'High' } // Dallas
      ];
      
      let closestDensity = 'Low';
      let minDistance = Infinity;
      
      urbanCenters.forEach(center => {
        const distance = calculateDistance(lat, lng, center.lat, center.lng);
        if (distance < minDistance) {
          minDistance = distance;
          if (distance < 50) closestDensity = center.density;
          else if (distance < 100) closestDensity = 'Medium';
        }
      });
      
      return closestDensity;
    }

    function calculateRiskScore(lat, lng, accuracy) {
      let score = 1;
      
      // Factor in GPS accuracy
      if (accuracy && accuracy > 100) score += 1;
      else if (accuracy && accuracy > 50) score += 0.5;
      
      // Factor in resource availability
      const resourceCount = resourceMarkers.length;
      if (resourceCount === 0) score += 2;
      else if (resourceCount < 2) score += 1;
      
      // Factor in population density
      const densityElement = document.getElementById('populationDensity');
      const density = densityElement ? densityElement.textContent : 'Low';
      if (density === 'Very High') score += 1;
      else if (density === 'High') score += 0.5;
      
      return `${Math.min(10, score).toFixed(1)}/10`;
    }

    function estimateResponseTime(resourceCount) {
      if (resourceCount >= 3) return '5-10 min';
      else if (resourceCount >= 1) return '10-15 min';
      else return '15+ min';
    }

    // Location Search Functions
    function setupLocationSearch() {
      const searchInput = document.getElementById('location');
      const suggestionsDiv = document.getElementById('searchSuggestions');
      
      if (!searchInput || !suggestionsDiv) return;
      
      searchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (query.length < 3) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        searchTimeout = setTimeout(async () => {
          await searchLocations(query);
        }, 500);
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.style.display = 'none';
        }
      });
    }

    async function searchLocations(query) {
      const suggestionsDiv = document.getElementById('searchSuggestions');
      if (!suggestionsDiv) return;
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
          { headers: { 'User-Agent': 'DisasterResponseApp/1.0' } }
        );
        
        if (!response.ok) throw new Error('Search failed');
        
        const results = await response.json();
        
        if (results.length > 0) {
          suggestionsDiv.innerHTML = results.map(result => `
            <div class="search-suggestion" onclick="selectLocation(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
              <strong>${result.display_name.split(',')[0]}</strong><br>
              <small>${result.display_name}</small>
            </div>
          `).join('');
          
          suggestionsDiv.style.display = 'block';
        } else {
          suggestionsDiv.innerHTML = '<div class="search-suggestion">No results found</div>';
          suggestionsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Location search failed:', error);
        suggestionsDiv.innerHTML = '<div class="search-suggestion">Search failed - try again</div>';
        suggestionsDiv.style.display = 'block';
      }
    }

    function selectLocation(lat, lng, name) {
      try {
        const locationInput = document.getElementById('location');
        const suggestionsDiv = document.getElementById('searchSuggestions');
        
        if (locationInput) locationInput.value = name;
        if (suggestionsDiv) suggestionsDiv.style.display = 'none';
        
        lastKnownCoordinates = { lat: parseFloat(lat), lng: parseFloat(lng) };
        updateMapMarkers(lat, lng);
        updateCoordinateFormats(lat, lng);
        
        const coordinatesInput = document.getElementById('coordinates');
        if (coordinatesInput) coordinatesInput.value = `${lat},${lng}`;
        
        findNearbyResources();
        updateLocationAnalysis(lat, lng);
        renderPreview();
        
        showToast(`üìç Location set: ${name.split(',')[0]}`, 'success');
      } catch (error) {
        console.error('Error selecting location:', error);
      }
    }

    // Utility Functions
    function showToast(message, type = 'info', duration = 4000) {
      try {
        const toast = document.createElement('div');
        const colors = {
          info: 'var(--info-blue)',
          success: 'var(--safe-green)',
          warning: 'var(--warning-yellow)',
          error: 'var(--emergency-red)'
        };
        
        toast.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: ${colors[type] || colors.info};
          color: white;
          padding: 1rem 1.5rem;
          border-radius: var(--border-radius-md);
          box-shadow: var(--shadow-xl);
          z-index: 10000;
          animation: slideInRight 0.4s ease;
          max-width: 350px;
          font-weight: 600;
          font-size: 0.95rem;
          border: 2px solid rgba(255, 255, 255, 0.2);
          backdrop-filter: var(--blur-sm);
          -webkit-backdrop-filter: var(--blur-sm);
        `;
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          if (toast && toast.parentNode) {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 400);
          }
        }, duration);
      } catch (error) {
        console.error('Error showing toast:', error);
      }
    }

    // Form Management Functions
    function getSeverityClass(sev) {
      if (sev >= 8) return "sev-red";
      if (sev >= 5) return "sev-orange";
      if (sev >= 3) return "sev-yellow";
      return "sev-green";
    }

    function updateSeverityBadge() {
      try {
        const severityInput = document.getElementById("severity");
        const badge = document.getElementById("severityBadge");
        
        if (!severityInput || !badge) return;
        
        const val = parseFloat(severityInput.value);
        if (!isNaN(val)) {
          badge.textContent = "SEV-" + val.toFixed(1);
          badge.className = "severity-badge " + getSeverityClass(val);
        } else {
          badge.textContent = "";
          badge.className = "severity-badge";
        }
      } catch (error) {
        console.error('Error updating severity badge:', error);
      }
    }

    function renderChecklist() {
      try {
        const checklistInput = document.getElementById("checklist");
        const container = document.getElementById("checklistDisplay");
        
        if (!checklistInput || !container) return;
        
        const raw = checklistInput.value;
        const items = raw.split(",").map(c => c.trim()).filter(Boolean);
        container.innerHTML = "";

        items.forEach(item => {
          const div = document.createElement("div");
          div.className = "checklist-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";

          const label = document.createElement("div");
          label.className = "checklist-label";
          label.textContent = item;

          const select = document.createElement("select");
          teamMembers.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });

          div.appendChild(checkbox);
          div.appendChild(label);
          div.appendChild(select);
          container.appendChild(div);
        });
      } catch (error) {
        console.error('Error rendering checklist:', error);
      }
    }

    function updateImagePreview() {
      try {
        const fileInput = document.getElementById("image_upload");
        const urlInput = document.getElementById("image_url");
        const preview = document.getElementById("imagePreview");
        
        if (!fileInput || !urlInput || !preview) return;

        if (fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
        } else if (urlInput.value) {
          preview.src = urlInput.value;
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      } catch (error) {
        console.error('Error updating image preview:', error);
      }
    }

    function collectFormData() {
      try {
        const checklistNodes = document.querySelectorAll(".checklist-item");
        const checklistData = Array.from(checklistNodes).map(div => ({
          item: div.querySelector(".checklist-label").textContent,
          completed: div.querySelector("input[type='checkbox']").checked,
          assigned_to: div.querySelector("select").value
        }));

        const reportId = crypto.randomUUID();
        let imageRef = null;

        const fileInput = document.getElementById("image_upload");
        if (fileInput && fileInput.files && fileInput.files[0]) {
          imageRef = `upload://${fileInput.files[0].name}`;
        } else {
          const urlInput = document.getElementById("image_url");
          if (urlInput && urlInput.value) {
            imageRef = urlInput.value;
          }
        }

        const coordinatesInput = document.getElementById("coordinates");
        const coordinatesValue = coordinatesInput ? coordinatesInput.value : "";
        const coordinates = coordinatesValue ? coordinatesValue.split(",").map(Number) : [lastKnownCoordinates.lat, lastKnownCoordinates.lng];

        return {
          id: reportId,
          timestamp: new Date().toISOString(),
          location: document.getElementById("location")?.value || "",
          coordinates: coordinates,
          coordinate_formats: {
            decimal_degrees: document.getElementById("coordDD")?.textContent || "",
            dms: document.getElementById("coordDMS")?.textContent || "",
            utm: document.getElementById("coordUTM")?.textContent || "",
            mgrs: document.getElementById("coordMGRS")?.textContent || ""
          },
          hazards: (document.getElementById("hazards")?.value || "").split(",").map(h => h.trim()).filter(Boolean),
          severity: parseFloat(document.getElementById("severity")?.value) || 0,
          notes: document.getElementById("notes")?.value || "",
          image_url: imageRef,
          checklist: checklistData,
          nearby_resources: nearbyResources,
          location_analysis: {
            population_density: document.getElementById("populationDensity")?.textContent || 'Unknown',
            risk_score: document.getElementById("riskScore")?.textContent || 'Unknown',
            estimated_response_time: document.getElementById("responseTime")?.textContent || 'Unknown'
          },
          gps_data: currentPosition ? {
            accuracy: currentPosition.coords.accuracy,
            timestamp: new Date(currentPosition.timestamp).toISOString(),
            altitude: currentPosition.coords.altitude,
            heading: currentPosition.coords.heading,
            speed: currentPosition.coords.speed
          } : null
        };
      } catch (error) {
        console.error('Error collecting form data:', error);
        return {};
      }
    }

    function renderPreview() {
      try {
        const data = collectFormData();
        const previewElement = document.getElementById("jsonPreview");
        if (previewElement) {
          previewElement.textContent = JSON.stringify(data, null, 2);
        }
      } catch (error) {
        console.error('Error rendering preview:', error);
      }
    }

    // Save Functions
    async function saveOfflineReport() {
    try {
        const data = collectFormData();
        
        // Use the offline recovery system
        if (window.offlineRecovery) {
            await window.offlineRecovery.saveReportOffline(data);
        } else {
            // Fallback to localStorage
            let queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
            queue.push(data);
            localStorage.setItem("sync_queue", JSON.stringify(queue));
        }
        
        showToast("üì¥ Report saved offline! Will sync when connected.", 'success');
        updateQueueDisplay();
        renderPreview();
    } catch (error) {
        console.error('Save offline failed:', error);
        showToast('‚ùå Failed to save report offline. Please try again.', 'error');
    }
}

    async function saveAndSyncReport() {
      if (!navigator.onLine) {
        await saveOfflineReport();
        return;
      }
      
      try {
        const data = collectFormData();
        
        // In a real application, this would send to your server
        console.log('Syncing report:', data);
        showToast('‚úÖ Report uploaded successfully!', 'success');
        
        // Clear form after successful sync
        renderPreview();
        
      } catch (error) {
        console.error('Save and sync failed:', error);
        await saveOfflineReport();
      }
    }

    async function forceSyncQueue() {
    if (window.offlineRecovery) {
        await window.offlineRecovery.attemptFullRecovery();
    } else {
        // Fallback behavior
        const queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
        if (queue.length === 0) {
            showToast("‚úÖ No reports to sync!", 'success');
            return;
        }
        
        if (!navigator.onLine) {
            showToast("‚ùå Cannot sync while offline!", 'error');
            return;
        }
        
        localStorage.removeItem("sync_queue");
        updateQueueDisplay();
        showToast("‚úÖ All reports synced successfully!", 'success');
    }
}

    function updateConnectionStatus() {
      try {
        const statusSpan = document.getElementById('connectionStatus');
        
        if (statusSpan) {
          if (navigator.onLine) {
            statusSpan.innerHTML = '<span style="color: var(--safe-green);">üü¢ Online</span>';
          } else {
            statusSpan.innerHTML = '<span style="color: var(--emergency-red);">üî¥ Offline</span>';
          }
        }
        
        updateQueueDisplay();
      } catch (error) {
        console.error('Error updating connection status:', error);
      }
    }

    function updateQueueDisplay() {
      try {
        const queue = JSON.parse(localStorage.getItem("sync_queue") || "[]");
        const queueCount = document.getElementById('queueCount');
        const queueStatus = document.getElementById('queueStatus');
        
        if (queueCount) queueCount.textContent = queue.length;
        
        if (queueStatus) {
          if (queue.length > 0) {
            queueStatus.style.display = 'inline';
            queueStatus.textContent = `Queue: ${queue.length} reports`;
          } else {
            queueStatus.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error updating queue display:', error);
      }
    }

    // Event Listeners
    window.addEventListener("online", updateConnectionStatus);
    window.addEventListener("offline", updateConnectionStatus);

    // Initialize on load
    window.onload = () => {
      console.log('üöÄ Initializing Enhanced Live Report Builder...');
      
      // Check dependencies first
      if (!checkDependencies()) {
        console.warn('‚ö†Ô∏è Some dependencies missing, continuing with limited functionality');
      }
      
      try {
        // Set default values
        const locationInput = document.getElementById("location");
        if (locationInput) locationInput.value = "Austin, TX";
        
        const coordinatesInput = document.getElementById("coordinates");
        if (coordinatesInput) coordinatesInput.value = "30.2672,-97.7431";
        
        const hazardsInput = document.getElementById("hazards");
        if (hazardsInput) hazardsInput.value = "fire, collapsed structure";
        
        const severityInput = document.getElementById("severity");
        if (severityInput) severityInput.value = "8.5";
        
        const notesInput = document.getElementById("notes");
        if (notesInput) notesInput.value = "Smoke observed, no visible injuries";
        
        const imageUrlInput = document.getElementById("image_url");
        if (imageUrlInput) imageUrlInput.value = "https://via.placeholder.com/300";
        
        const checklistInput = document.getElementById("checklist");
        if (checklistInput) checklistInput.value = "Clear debris, Search for victims";
        
        // Initialize components
        updateSeverityBadge();
        renderChecklist();
        updateImagePreview();
        updateCoordinateFormats(30.2672, -97.7431);
        renderPreview();
        updateConnectionStatus();
        updateQueueDisplay();
        setupLocationSearch();
        
        // Initialize map if Leaflet is available
        if (typeof L !== 'undefined') {
          initMap();
          
          // Initial resource search after a delay
          setTimeout(() => {
            findNearbyResources();
          }, 2000);
        } else {
          console.warn('‚ö†Ô∏è Leaflet not available, map functionality disabled');
          showToast('‚ö†Ô∏è Map functionality unavailable', 'warning');
        }
        
        // Auto-sync every 30 seconds when online
        setInterval(() => {
          if (navigator.onLine) {
            // Auto-sync logic would go here in production
            updateConnectionStatus();
          }
        }, 30000);
        
        console.log('‚úÖ Enhanced Live Report Builder initialized successfully');
        
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        showToast('‚ö†Ô∏è Some features may not work properly', 'warning');
      }
    };

    // Event listeners for form inputs
    inputs.forEach(id => {
      try {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", () => {
            try {
              if (id === "checklist") renderChecklist();
              if (id === "image_url") updateImagePreview();
              if (id === "severity") updateSeverityBadge();
              if (id === "coordinates") {
                const [lat, lng] = document.getElementById("coordinates").value.split(",").map(Number);
                if (!isNaN(lat) && !isNaN(lng)) {
                  lastKnownCoordinates = { lat, lng };
                  updateMapMarkers(lat, lng);
                  updateCoordinateFormats(lat, lng);
                  findNearbyResources();
                }
              }
              renderPreview();
            } catch (error) {
              console.error(`Error handling input for ${id}:`, error);
            }
          });
        }
      } catch (error) {
        console.error(`Error setting up listener for ${id}:`, error);
      }
    });

    // Image upload handler
    try {
      const imageUpload = document.getElementById('image_upload');
      if (imageUpload) {
        imageUpload.addEventListener('change', updateImagePreview);
      }
    } catch (error) {
      console.error('Error setting up image upload handler:', error);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      
      .map-control-btn {
        transition: all var(--transition-normal);
      }
      
      .map-control-btn:active {
        transform: scale(0.95);
      }
      
      .coordinate-value:active {
        transform: scale(0.98);
      }
      
      .resource-item:active {
        transform: scale(0.98);
      }
      
      /* Enhanced button interactions */
      button:active {
        transform: translateY(-1px) scale(0.98);
      }
      
      /* Loading states */
      .loading {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
      }
      
      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);

    console.log('üó∫Ô∏è Enhanced Live Report Builder loaded');
    console.log('üìç GPS controls: High-accuracy, Quick GPS, Manual entry');
    console.log('üóÇÔ∏è Map controls: Layer toggle, Distance measurement, Incident markers');
    console.log('üöë Emergency resources: Automatic proximity detection');
    console.log('üìê Coordinate formats: DD, DMS, UTM, MGRS');
    console.log('üì± Offline capabilities: Report queueing and sync');
  </script>
</body>
</html>