<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Medical Triage Dashboard - Complete System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Enhanced Color System */
            --critical-red: #dc2626;
            --critical-red-light: #fef2f2;
            --critical-red-border: #fecaca;
            --urgent-yellow: #f59e0b;
            --urgent-yellow-light: #fffbeb;
            --urgent-yellow-border: #fed7aa;
            --stable-green: #16a34a;
            --stable-green-light: #f0fdf4;
            --stable-green-border: #bbf7d0;
            --expectant-black: #374151;
            --expectant-light: #f9fafb;
            --expectant-border: #d1d5db;
            
            /* Enhanced AI Colors */
            --ai-purple: #8b5cf6;
            --ai-purple-light: #f3f0ff;
            --ai-purple-border: #c4b5fd;
            
            /* System Colors */
            --info-blue: #3b82f6;
            --info-blue-light: #eff6ff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
            --border-strong: #d1d5db;
            
            /* Enhanced Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
            
            /* Gradients */
            --critical-gradient: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            --ai-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --success-gradient: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            
            /* Animation Variables */
            --animation-fast: 0.15s ease-out;
            --animation-normal: 0.3s ease-out;
            --animation-slow: 0.5s ease-out;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        /* Enhanced Header */
        .header {
            background: var(--critical-gradient);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            border-bottom: 3px solid #b91c1c;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-badge {
            background: rgba(139, 92, 246, 0.9);
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
        }

        .live-indicator {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.625rem 1.25rem;
            border-radius: 25px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse-strong 2s infinite;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        @keyframes pulse-strong {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
        }

        /* Enhanced Command Bar */
        .ai-command-bar {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            background: var(--ai-gradient);
            position: relative;
            border-bottom: 3px solid #7c3aed;
        }

        .command-input-container {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .command-input {
            width: 100%;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            font-size: 1.125rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-xl);
            transition: all var(--animation-normal);
            font-weight: 500;
        }

        .command-input:focus {
            outline: none;
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .command-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--ai-purple);
        }

        .command-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .suggestion-pill {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--animation-fast);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
        }

        .suggestion-pill:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Enhanced Main Container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 2rem;
            min-height: calc(100vh - 250px);
        }

        /* Enhanced Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 2rem 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 2px solid var(--accent-border);
            transition: all var(--animation-normal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-color);
        }

        .stat-red { 
            --accent-color: var(--critical-red); 
            --accent-border: var(--critical-red-border);
        }
        .stat-yellow { 
            --accent-color: var(--urgent-yellow); 
            --accent-border: var(--urgent-yellow-border);
        }
        .stat-green { 
            --accent-color: var(--stable-green); 
            --accent-border: var(--stable-green-border);
        }
        .stat-black { 
            --accent-color: var(--expectant-black); 
            --accent-border: var(--expectant-border);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Enhanced Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            background: var(--ai-gradient);
            color: white;
            border: none;
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-normal);
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1rem;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .action-btn.primary {
            background: var(--critical-gradient);
            font-size: 1.125rem;
            font-weight: 700;
            animation: priority-pulse 3s infinite;
        }

        @keyframes priority-pulse {
            0%, 100% { box-shadow: var(--shadow); }
            50% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.4); }
        }

        .action-btn.primary:hover {
            box-shadow: 0 15px 35px rgba(220, 38, 38, 0.3);
        }

        /* Enhanced Priority Queue */
        .priority-queue-card {
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            flex: 1;
            border: 2px solid var(--border-color);
        }

        .queue-header {
            background: var(--ai-gradient);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #7c3aed;
        }

        .queue-title {
            font-size: 1.375rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .queue-controls {
            display: flex;
            gap: 0.5rem;
        }

        .queue-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.625rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--animation-fast);
            font-size: 1rem;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .queue-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .patient-queue {
            max-height: 650px;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Enhanced Patient Items */
        .patient-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            background: var(--priority-bg);
            border-radius: 16px;
            cursor: pointer;
            transition: all var(--animation-normal);
            border: 2px solid var(--priority-border);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .patient-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .patient-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: white;
            border-color: var(--priority-color);
        }

        .patient-item:hover::before {
            left: 100%;
        }

        .patient-item.red { 
            --priority-color: var(--critical-red); 
            --priority-bg: var(--critical-red-light);
            --priority-border: var(--critical-red-border);
        }
        .patient-item.yellow { 
            --priority-color: var(--urgent-yellow); 
            --priority-bg: var(--urgent-yellow-light);
            --priority-border: var(--urgent-yellow-border);
        }
        .patient-item.green { 
            --priority-color: var(--stable-green); 
            --priority-bg: var(--stable-green-light);
            --priority-border: var(--stable-green-border);
        }
        .patient-item.black { 
            --priority-color: var(--expectant-black); 
            --priority-bg: var(--expectant-light);
            --priority-border: var(--expectant-border);
        }

        .priority-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: white;
            font-size: 1.25rem;
            background: var(--priority-color);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            border: 3px solid white;
        }

        .patient-info {
            flex: 1;
        }

        .patient-name {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .patient-details {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .detail-tag {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-blue);
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .ai-tag {
            background: var(--ai-purple-light);
            color: var(--ai-purple);
            border-color: var(--ai-purple-border);
        }

        .ai-insight {
            background: var(--ai-purple-light);
            color: var(--ai-purple);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            border: 2px solid var(--ai-purple-border);
            font-weight: 500;
        }

        .confidence-score {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .confidence-bar {
            background: #e5e7eb;
            height: 6px;
            border-radius: 3px;
            flex: 1;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--ai-purple);
            transition: width var(--animation-slow);
            border-radius: 3px;
        }

        .patient-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
        }

        /* Enhanced Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: all var(--animation-normal);
        }

        .sidebar-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .sidebar-header {
            background: var(--header-bg, var(--info-blue));
            color: white;
            padding: 1.25rem 1.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 3px solid var(--header-border, #2563eb);
        }

        .sidebar-content {
            padding: 1.5rem;
            max-height: 350px;
            overflow-y: auto;
        }

        /* Enhanced Critical Alerts */
        .critical-alerts .sidebar-header {
            --header-bg: var(--critical-red);
            --header-border: #b91c1c;
        }

        .critical-alert {
            background: linear-gradient(135deg, var(--critical-red-light) 0%, #fef2f2 100%);
            border: 2px solid var(--critical-red-border);
            border-left: 6px solid var(--critical-red);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            cursor: pointer;
            transition: all var(--animation-normal);
            animation: alert-pulse 4s infinite;
        }

        @keyframes alert-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); box-shadow: var(--shadow); }
        }

        .critical-alert:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--critical-red);
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            color: #991b1b;
            margin-bottom: 0.75rem;
            font-size: 1.05rem;
        }

        .ai-prediction {
            background: var(--ai-purple-light);
            border-left: 4px solid var(--ai-purple);
            padding: 0.75rem;
            margin-top: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--ai-purple);
            font-weight: 500;
        }

        /* Map Enhancements */
        #map {
            height: 280px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        /* Enhanced Activity Feed */
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--animation-fast);
            border-radius: 8px;
        }

        .activity-item:hover {
            background: var(--bg-light);
            margin: 0 -1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            transform: translateX(4px);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--info-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 0.25rem;
            box-shadow: var(--shadow-sm);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            margin-bottom: 0.375rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
        }

        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid var(--border-strong);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--animation-fast);
            padding: 0.5rem;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--critical-red);
            background: rgba(220, 38, 38, 0.1);
        }

        /* Enhanced Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all var(--animation-normal);
            background: white;
            font-weight: 500;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 140px;
            right: 20px;
            background: var(--stable-green);
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            z-index: 10001;
            transform: translateX(100%);
            transition: transform var(--animation-normal);
            max-width: 450px;
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--critical-red);
        }

        .notification.warning {
            background: var(--urgent-yellow);
            color: var(--text-primary);
        }

        .notification.ai {
            background: var(--ai-gradient);
        }

        /* Enhanced Loading States */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--ai-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Triage Color Utilities */
        .triage-suggestion {
            padding: 0.625rem 1.25rem;
            border-radius: 20px;
            font-weight: 700;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .triage-red { background: var(--critical-red); }
        .triage-yellow { background: var(--urgent-yellow); }
        .triage-green { background: var(--stable-green); }
        .triage-black { background: var(--expectant-black); }

        /* Enhanced Material Icons */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .sidebar {
                order: -1;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 1.5rem;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .command-suggestions {
                justify-content: flex-start;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .patient-item {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
        }

        /* Focus States for Keyboard Navigation */
        .action-btn:focus,
        .queue-btn:focus,
        .suggestion-pill:focus,
        .patient-item:focus {
            outline: 3px solid var(--ai-purple);
            outline-offset: 2px;
        }

        .command-input:focus {
            outline: 3px solid rgba(139, 92, 246, 0.6);
            outline-offset: 2px;
        }

        /* Enhanced Keyboard Shortcuts Display */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity var(--animation-normal);
            z-index: 1000;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        /* Enhanced Print Styles */
        @media print {
            .header,
            .ai-command-bar,
            .quick-actions,
            .queue-controls,
            .sidebar {
                display: none !important;
            }
            
            .main-container {
                grid-template-columns: 1fr;
                max-width: 100%;
            }
            
            .patient-item {
                break-inside: avoid;
                margin-bottom: 1rem;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 12pt;
            }
        }

        /* AI Analysis Panel Styles */
        .ai-analysis-panel {
            background: rgba(139, 92, 246, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        .ai-analysis-title {
            margin-bottom: 1rem;
            color: var(--ai-purple);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Table Styles for Patient List */
        .patient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .patient-table th,
        .patient-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .patient-table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .patient-table tr:hover {
            background: var(--bg-light);
        }

        /* Staff Assignment Styles */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .staff-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all var(--animation-normal);
        }

        .staff-card:hover {
            border-color: var(--ai-purple);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .staff-card.selected {
            border-color: var(--ai-purple);
            background: var(--ai-purple-light);
        }

        /* Report Generation Styles */
        .report-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .report-header {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Resource Management Styles */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .resource-card {
            background: var(--bg-light);
            padding: 1.25rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            text-align: center;
        }

        .resource-available {
            border-color: var(--stable-green);
        }

        .resource-limited {
            border-color: var(--urgent-yellow);
        }

        .resource-critical {
            border-color: var(--critical-red);
        }
    </style>
</head>
<body>
    <!-- Enhanced Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <span class="material-icons" style="font-size: 2rem;">medical_services</span>
                <span>AI Medical Triage Command Center</span>
                <span class="ai-badge">
                    <span class="material-icons" style="font-size: 1rem;">psychology</span>
                    Gemma 3n Powered
                </span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span class="material-icons" style="font-size: 1rem;">update</span>
                <span>LIVE AI</span>
                <span id="current-time"></span>
            </div>
        </div>
    </header>

    <!-- Enhanced AI Command Bar -->
    <div class="ai-command-bar">
        <div class="command-input-container">
            <span class="material-icons command-icon">psychology</span>
            <input 
                type="text" 
                class="command-input" 
                id="ai-command-input"
                placeholder="Ask AI: 'Show critical cardiac patients' or 'Assign Dr. Evans to John Smith'"
                autocomplete="off"
                aria-label="AI Command Input"
            />
            <div class="command-suggestions">
                <div class="suggestion-pill" onclick="fillCommand('Show all critical patients')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">priority_high</span>
                    Show critical patients
                </div>
                <div class="suggestion-pill" onclick="fillCommand('What resources do we need?')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">inventory</span>
                    Resource requirements
                </div>
                <div class="suggestion-pill" onclick="fillCommand('Who needs immediate attention?')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">emergency</span>
                    Immediate attention
                </div>
                <div class="suggestion-pill" onclick="fillCommand('Update patient status')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">edit</span>
                    Update status
                </div>
                <div class="suggestion-pill" onclick="fillCommand('Edit patient records')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">edit_note</span>
                    Edit patients
                </div>
                <div class="suggestion-pill" onclick="fillCommand('Export PDF report')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">picture_as_pdf</span>
                    Export PDF
                </div>
                <div class="suggestion-pill" onclick="fillCommand('Open staff AI tools')" tabindex="0">
                    <span class="material-icons" style="font-size: 0.9rem;">build</span>
                    Staff AI tools
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Main Container -->
    <div class="main-container">
        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Enhanced Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card stat-red" onclick="filterPatients('red')" tabindex="0">
                    <div class="stat-number" id="critical-count">3</div>
                    <div class="stat-label">
                        <span class="material-icons">emergency</span>
                        <span>CRITICAL</span>
                    </div>
                </div>
                <div class="stat-card stat-yellow" onclick="filterPatients('yellow')" tabindex="0">
                    <div class="stat-number" id="urgent-count">8</div>
                    <div class="stat-label">
                        <span class="material-icons">warning</span>
                        <span>URGENT</span>
                    </div>
                </div>
                <div class="stat-card stat-green" onclick="filterPatients('green')" tabindex="0">
                    <div class="stat-number" id="delayed-count">11</div>
                    <div class="stat-label">
                        <span class="material-icons">schedule</span>
                        <span>DELAYED</span>
                    </div>
                </div>
                <div class="stat-card stat-black" onclick="filterPatients('black')" tabindex="0">
                    <div class="stat-number" id="expectant-count">2</div>
                    <div class="stat-label">
                        <span class="material-icons">person_off</span>
                        <span>EXPECTANT</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Quick Actions -->
            <div class="quick-actions">
                <button class="action-btn primary" onclick="openTriageForm()">
                    <span class="material-icons">emergency</span>
                    <span>URGENT: New Patient Intake</span>
                </button>
                <button class="action-btn" onclick="openStaffAITools()">
                    <span class="material-icons">psychology</span>
                    <span>Staff AI Analysis Tools</span>
                </button>
                <button class="action-btn" onclick="aiTriageSystem.runPredictiveAnalysis()">
                    <span class="material-icons">analytics</span>
                    <span>AI Predictive Analysis</span>
                </button>
            </div>

            <!-- Enhanced Priority Queue -->
            <div class="priority-queue-card">
                <div class="queue-header">
                    <div class="queue-title">
                        <span class="material-icons">view_list</span>
                        <span>AI-Enhanced Priority Queue</span>
                    </div>
                    <div class="queue-controls">
                        <button class="queue-btn" onclick="refreshQueue()" title="Refresh queue">
                            <span class="material-icons">refresh</span>
                        </button>
                        <button class="queue-btn" onclick="sortByAI()" title="AI Sort">
                            <span class="material-icons">psychology</span>
                        </button>
                        <button class="queue-btn" onclick="exportQueue()" title="Export">
                            <span class="material-icons">download</span>
                        </button>
                        <button class="queue-btn" onclick="openPatientList()" title="Patient List">
                            <span class="material-icons">list_alt</span>
                        </button>
                        <button class="queue-btn" onclick="openPatientTracker()" title="Patient Tracker">
                            <span class="material-icons">track_changes</span>
                        </button>
                        <button class="queue-btn" onclick="exportToPDF()" title="Export PDF">
                            <span class="material-icons">picture_as_pdf</span>
                        </button>
                    </div>
                </div>
                <div class="patient-queue" id="patient-queue">
                    <!-- Sample Patient Items -->
                    <div class="patient-item red" onclick="openPatientDetails(1)" tabindex="0">
                        <div class="priority-indicator">1</div>
                        <div class="patient-info">
                            <div class="patient-name">John Smith</div>
                            <div class="patient-details">
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">heart_broken</span>
                                    Chest trauma
                                </span>
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">emergency</span>
                                    RED
                                </span>
                                <span class="detail-tag ai-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">psychology</span>
                                    AI: 92%
                                </span>
                            </div>
                            <div class="ai-insight">
                                <span class="material-icons" style="font-size: 1rem;">psychology</span>
                                Immediate cardiology consult, EKG, chest X-ray
                                <div class="confidence-score">
                                    <span>Confidence:</span>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: 92%"></div>
                                    </div>
                                    <span>92%</span>
                                </div>
                            </div>
                        </div>
                        <div class="patient-time">5m ago</div>
                        <button class="queue-btn" onclick="editPatient(1); event.stopPropagation();" title="Edit Patient" 
                                style="position: absolute; top: 10px; right: 10px;">
                            <span class="material-icons" style="font-size: 1rem;">edit</span>
                        </button>
                    </div>

                    <div class="patient-item yellow" onclick="openPatientDetails(2)" tabindex="0">
                        <div class="priority-indicator">2</div>
                        <div class="patient-info">
                            <div class="patient-name">Maria Garcia</div>
                            <div class="patient-details">
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">healing</span>
                                    Fracture - left arm
                                </span>
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">warning</span>
                                    YELLOW
                                </span>
                                <span class="detail-tag ai-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">psychology</span>
                                    AI: 87%
                                </span>
                            </div>
                            <div class="ai-insight">
                                <span class="material-icons" style="font-size: 1rem;">psychology</span>
                                X-ray, pain management, orthopedic evaluation
                                <div class="confidence-score">
                                    <span>Confidence:</span>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: 87%"></div>
                                    </div>
                                    <span>87%</span>
                                </div>
                            </div>
                        </div>
                        <div class="patient-time">10m ago</div>
                        <button class="queue-btn" onclick="editPatient(2); event.stopPropagation();" title="Edit Patient" 
                                style="position: absolute; top: 10px; right: 10px;">
                            <span class="material-icons" style="font-size: 1rem;">edit</span>
                        </button>
                    </div>

                    <div class="patient-item red" onclick="openPatientDetails(3)" tabindex="0">
                        <div class="priority-indicator">1</div>
                        <div class="patient-info">
                            <div class="patient-name">Robert Wilson</div>
                            <div class="patient-details">
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">favorite</span>
                                    Cardiac event
                                </span>
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">emergency</span>
                                    RED
                                </span>
                                <span class="detail-tag ai-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">psychology</span>
                                    AI: 95%
                                </span>
                            </div>
                            <div class="ai-insight">
                                <span class="material-icons" style="font-size: 1rem;">psychology</span>
                                Immediate cardiac cath lab, aspirin, nitroglycerin
                                <div class="confidence-score">
                                    <span>Confidence:</span>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: 95%"></div>
                                    </div>
                                    <span>95%</span>
                                </div>
                            </div>
                        </div>
                        <div class="patient-time">15m ago</div>
                        <button class="queue-btn" onclick="editPatient(3); event.stopPropagation();" title="Edit Patient" 
                                style="position: absolute; top: 10px; right: 10px;">
                            <span class="material-icons" style="font-size: 1rem;">edit</span>
                        </button>
                    </div>

                    <div class="patient-item green" onclick="openPatientDetails(4)" tabindex="0">
                        <div class="priority-indicator">3</div>
                        <div class="patient-info">
                            <div class="patient-name">Sarah Johnson</div>
                            <div class="patient-details">
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">content_cut</span>
                                    Minor lacerations
                                </span>
                                <span class="detail-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">schedule</span>
                                    GREEN
                                </span>
                                <span class="detail-tag ai-tag">
                                    <span class="material-icons" style="font-size: 0.8rem;">psychology</span>
                                    AI: 89%
                                </span>
                            </div>
                            <div class="ai-insight">
                                <span class="material-icons" style="font-size: 1rem;">psychology</span>
                                Wound cleaning, sutures if needed, tetanus check
                                <div class="confidence-score">
                                    <span>Confidence:</span>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: 89%"></div>
                                    </div>
                                    <span>89%</span>
                                </div>
                            </div>
                        </div>
                        <div class="patient-time">20m ago</div>
                        <button class="queue-btn" onclick="editPatient(4); event.stopPropagation();" title="Edit Patient" 
                                style="position: absolute; top: 10px; right: 10px;">
                            <span class="material-icons" style="font-size: 1rem;">edit</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Sidebar -->
        <div class="sidebar">
            <!-- Enhanced Critical Alerts -->
            <div class="sidebar-card critical-alerts">
                <div class="sidebar-header">
                    <span class="material-icons">emergency</span>
                    <span>AI Critical Alerts</span>
                </div>
                <div class="sidebar-content" id="critical-alerts">
                    <div class="critical-alert" onclick="openPatientDetails(3)" tabindex="0">
                        <div class="alert-header">
                            <span class="material-icons">warning</span>
                            <span>Robert Wilson</span>
                            <span style="font-size: 0.8rem; background: rgba(139, 92, 246, 0.2); padding: 0.25rem 0.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.25rem;">
                                <span class="material-icons" style="font-size: 0.7rem;">psychology</span>
                                AI: 95%
                            </span>
                        </div>
                        <div class="alert-details">
                            Critical patient: Cardiac event - High risk of deterioration
                        </div>
                        <div class="ai-prediction">
                            <span class="material-icons" style="font-size: 0.9rem;">trending_down</span>
                            Heart rate increasing, O2 decreasing - monitor closely
                        </div>
                    </div>

                    <div class="critical-alert" onclick="openPatientDetails(1)" tabindex="0">
                        <div class="alert-header">
                            <span class="material-icons">warning</span>
                            <span>John Smith</span>
                            <span style="font-size: 0.8rem; background: rgba(139, 92, 246, 0.2); padding: 0.25rem 0.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.25rem;">
                                <span class="material-icons" style="font-size: 0.7rem;">psychology</span>
                                AI: 92%
                            </span>
                        </div>
                        <div class="alert-details">
                            Critical patient: Chest trauma - Hypotension detected
                        </div>
                        <div class="ai-prediction">
                            <span class="material-icons" style="font-size: 0.9rem;">monitor_heart</span>
                            High risk of cardiac tamponade - immediate intervention required
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Map -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <span class="material-icons">map</span>
                    <span>Incident Locations</span>
                </div>
                <div class="sidebar-content">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Enhanced Recent Activity -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <span class="material-icons">history</span>
                    <span>Recent Activity</span>
                </div>
                <div class="sidebar-content" id="activity-feed">
                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--ai-purple)">
                            <span class="material-icons" style="font-size: 1rem;">psychology</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">psychology</span>
                                AI Alert: Robert Wilson shows deterioration pattern
                            </div>
                            <div class="activity-time">2m ago</div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--critical-red)">
                            <span class="material-icons" style="font-size: 1rem;">person_add</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">psychology</span>
                                John Smith admitted with chest trauma
                            </div>
                            <div class="activity-time">5m ago</div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--urgent-yellow)">
                            <span class="material-icons" style="font-size: 1rem;">update</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">Maria Garcia vitals updated</div>
                            <div class="activity-time">8m ago</div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--ai-purple)">
                            <span class="material-icons" style="font-size: 1rem;">analytics</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">psychology</span>
                                AI completed resource optimization analysis
                            </div>
                            <div class="activity-time">12m ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Notification -->
    <div class="notification" id="notification"></div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="keyboard-hint" id="keyboard-hint">
        Ctrl+K: Command | Ctrl+N: New Patient | Ctrl+R: Refresh | Ctrl+E: Export | Esc: Close
    </div>

    <!-- AI-Enhanced Triage Form Modal -->
    <div class="modal" id="triage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">psychology</span>
                    AI-Enhanced Emergency Triage Assessment
                </div>
                <button class="close-btn" onclick="closeModal('triage-modal')">&times;</button>
            </div>
            <form id="triage-form" onsubmit="submitTriageForm(event)">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons">person</span>
                            Patient Information
                        </h4>
                        
                        <div class="form-group">
                            <label class="form-label">Patient Name/ID *</label>
                            <input type="text" class="form-input" id="patient-name" required placeholder="Enter patient name or ID">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-input" id="patient-age" min="0" max="120" placeholder="Patient age">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select class="form-select" id="patient-gender">
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Primary Injury/Condition *</label>
                            <input type="text" class="form-input" id="injury-type" required placeholder="Describe primary injury or condition">
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons">medical_services</span>
                            Clinical Assessment
                        </h4>
                        
                        <div class="form-group">
                            <label class="form-label">Consciousness Level *</label>
                            <select class="form-select" id="consciousness" required onchange="updateAIAnalysis()">
                                <option value="">Select consciousness level</option>
                                <option value="alert">Alert & Oriented</option>
                                <option value="verbal">Responds to Verbal</option>
                                <option value="pain">Responds to Pain</option>
                                <option value="unresponsive">Unresponsive</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Breathing Status *</label>
                            <select class="form-select" id="breathing" required onchange="updateAIAnalysis()">
                                <option value="">Select breathing status</option>
                                <option value="normal">Normal</option>
                                <option value="labored">Labored</option>
                                <option value="shallow">Shallow</option>
                                <option value="absent">Absent/Obstructed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Severity *</label>
                            <select class="form-select" id="severity" required onchange="updateAIAnalysis()">
                                <option value="">Select severity</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Triage Color *</label>
                            <select class="form-select" id="triage-color" required>
                                <option value="">AI will suggest...</option>
                                <option value="red">🔴 RED - Immediate</option>
                                <option value="yellow">🟡 YELLOW - Urgent</option>
                                <option value="green">🟢 GREEN - Delayed</option>
                                <option value="black">⚫ BLACK - Expectant</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- AI Real-time Analysis Panel -->
                <div id="ai-analysis-panel" class="ai-analysis-panel">
                    <h4 class="ai-analysis-title">
                        <span class="material-icons">psychology</span>
                        AI Real-Time Analysis
                    </h4>
                    <div id="ai-suggestions">
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            <span class="material-icons" style="font-size: 3rem; opacity: 0.5;">psychology</span>
                            <p>AI analysis will appear as you fill out the form...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Notes -->
                <div class="form-group">
                    <label class="form-label">Additional Notes</label>
                    <textarea class="form-input" id="additional-notes" rows="3" placeholder="Any additional observations or notes..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border-color);">
                    <button type="button" class="action-btn" onclick="closeModal('triage-modal')" style="flex: 1; background: var(--text-secondary);">
                        <span class="material-icons">cancel</span>
                        Cancel
                    </button>
                    <button type="button" class="action-btn" onclick="runAITriage()" style="flex: 1; background: var(--ai-gradient);">
                        <span class="material-icons">psychology</span>
                        AI Analysis
                    </button>
                    <button type="submit" class="action-btn primary" style="flex: 2;">
                        <span class="material-icons">save</span>
                        Submit Triage Assessment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div class="modal" id="patient-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">person</span>
                    Patient Details
                </div>
                <button class="close-btn" onclick="closeModal('patient-modal')">&times;</button>
            </div>
            <div id="patient-details">
                <!-- Patient details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Patient List Modal -->
    <div class="modal" id="patient-list-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">list_alt</span>
                    Complete Patient List
                </div>
                <button class="close-btn" onclick="closeModal('patient-list-modal')">&times;</button>
            </div>
            <div>
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">
                    <input type="text" class="form-input" id="patient-search" placeholder="Search patients..." style="flex: 1;">
                    <select class="form-select" id="filter-status" style="width: 200px;">
                        <option value="">All Status</option>
                        <option value="red">Critical</option>
                        <option value="yellow">Urgent</option>
                        <option value="green">Delayed</option>
                        <option value="black">Expectant</option>
                    </select>
                    <button class="action-btn" onclick="addNewPatient()">
                        <span class="material-icons">person_add</span>
                        Add Patient
                    </button>
                </div>
                
                <table class="patient-table">
                    <thead>
                        <tr>
                            <th>Priority</th>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Condition</th>
                            <th>Triage</th>
                            <th>AI Confidence</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-table-body">
                        <tr onclick="openPatientDetails(1)">
                            <td><span class="priority-indicator" style="width: 30px; height: 30px; font-size: 0.8rem;">1</span></td>
                            <td><strong>John Smith</strong></td>
                            <td>45</td>
                            <td>Chest trauma</td>
                            <td><span class="triage-suggestion triage-red">RED</span></td>
                            <td>92%</td>
                            <td>5m ago</td>
                            <td>
                                <button class="queue-btn" onclick="editPatient(1); event.stopPropagation();">
                                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                                </button>
                            </td>
                        </tr>
                        <tr onclick="openPatientDetails(2)">
                            <td><span class="priority-indicator" style="width: 30px; height: 30px; font-size: 0.8rem; background: var(--urgent-yellow);">2</span></td>
                            <td><strong>Maria Garcia</strong></td>
                            <td>32</td>
                            <td>Fracture - left arm</td>
                            <td><span class="triage-suggestion triage-yellow">YELLOW</span></td>
                            <td>87%</td>
                            <td>10m ago</td>
                            <td>
                                <button class="queue-btn" onclick="editPatient(2); event.stopPropagation();">
                                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                                </button>
                            </td>
                        </tr>
                        <tr onclick="openPatientDetails(3)">
                            <td><span class="priority-indicator" style="width: 30px; height: 30px; font-size: 0.8rem;">1</span></td>
                            <td><strong>Robert Wilson</strong></td>
                            <td>67</td>
                            <td>Cardiac event</td>
                            <td><span class="triage-suggestion triage-red">RED</span></td>
                            <td>95%</td>
                            <td>15m ago</td>
                            <td>
                                <button class="queue-btn" onclick="editPatient(3); event.stopPropagation();">
                                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                                </button>
                            </td>
                        </tr>
                        <tr onclick="openPatientDetails(4)">
                            <td><span class="priority-indicator" style="width: 30px; height: 30px; font-size: 0.8rem; background: var(--stable-green);">3</span></td>
                            <td><strong>Sarah Johnson</strong></td>
                            <td>28</td>
                            <td>Minor lacerations</td>
                            <td><span class="triage-suggestion triage-green">GREEN</span></td>
                            <td>89%</td>
                            <td>20m ago</td>
                            <td>
                                <button class="queue-btn" onclick="editPatient(4); event.stopPropagation();">
                                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Patient Tracker Modal -->
    <div class="modal" id="patient-tracker-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">track_changes</span>
                    Patient Flow Tracker
                </div>
                <button class="close-btn" onclick="closeModal('patient-tracker-modal')">&times;</button>
            </div>
            <div>
                <div class="ai-analysis-panel">
                    <h4 class="ai-analysis-title">
                        <span class="material-icons">analytics</span>
                        Real-Time Flow Analytics
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--critical-red);">12</div>
                            <div>Avg Wait Time (min)</div>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--stable-green);">85%</div>
                            <div>Bed Utilization</div>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--ai-purple);">24</div>
                            <div>Total Patients</div>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--urgent-yellow);">3</div>
                            <div>Critical Alerts</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons">timeline</span>
                        Patient Journey Timeline
                    </h4>
                    <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: var(--critical-red); border-radius: 50%;"></div>
                                <span>Admission</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: var(--urgent-yellow); border-radius: 50%;"></div>
                                <span>Triage</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: var(--info-blue); border-radius: 50%;"></div>
                                <span>Treatment</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: var(--stable-green); border-radius: 50%;"></div>
                                <span>Discharge</span>
                            </div>
                        </div>
                        <div style="text-align: center; color: var(--text-secondary); font-style: italic;">
                            Real-time patient flow visualization coming soon...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff AI Tools Modal -->
    <div class="modal" id="staff-ai-tools-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">psychology</span>
                    Advanced AI Analysis Tools
                </div>
                <button class="close-btn" onclick="closeModal('staff-ai-tools-modal')">&times;</button>
            </div>
            <div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- Predictive Analytics -->
                    <div class="sidebar-card">
                        <div class="sidebar-header" style="background: var(--ai-gradient);">
                            <span class="material-icons">trending_up</span>
                            <span>Predictive Analytics</span>
                        </div>
                        <div class="sidebar-content">
                            <button class="action-btn" onclick="runPredictiveAnalysis()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">analytics</span>
                                Run Surge Prediction
                            </button>
                            <button class="action-btn" onclick="runCapacityAnalysis()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">hotel</span>
                                Capacity Analysis
                            </button>
                            <button class="action-btn" onclick="runResourceOptimization()" style="width: 100%;">
                                <span class="material-icons">tune</span>
                                Resource Optimization
                            </button>
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div class="sidebar-card">
                        <div class="sidebar-header" style="background: var(--critical-gradient);">
                            <span class="material-icons">warning</span>
                            <span>Risk Assessment</span>
                        </div>
                        <div class="sidebar-content">
                            <button class="action-btn" onclick="runDeteriorationRisk()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">trending_down</span>
                                Deterioration Risk
                            </button>
                            <button class="action-btn" onclick="runMortalityRisk()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">favorite</span>
                                Mortality Risk
                            </button>
                            <button class="action-btn" onclick="runComplicationRisk()" style="width: 100%;">
                                <span class="material-icons">healing</span>
                                Complication Risk
                            </button>
                        </div>
                    </div>

                    <!-- Decision Support -->
                    <div class="sidebar-card">
                        <div class="sidebar-header" style="background: var(--success-gradient);">
                            <span class="material-icons">support_agent</span>
                            <span>Decision Support</span>
                        </div>
                        <div class="sidebar-content">
                            <button class="action-btn" onclick="openDiagnosticAI()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">search</span>
                                Diagnostic AI
                            </button>
                            <button class="action-btn" onclick="openTreatmentAI()" style="width: 100%; margin-bottom: 1rem;">
                                <span class="material-icons">medication</span>
                                Treatment AI
                            </button>
                            <button class="action-btn" onclick="openDischargeAI()" style="width: 100%;">
                                <span class="material-icons">exit_to_app</span>
                                Discharge Planning
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="ai-analysis-panel" style="margin-top: 2rem;">
                    <h4 class="ai-analysis-title">
                        <span class="material-icons">insights</span>
                        Current AI Insights
                    </h4>
                    <div id="ai-insights-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(220, 38, 38, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--critical-red);">
                                <strong style="color: var(--critical-red);">High Risk Alert</strong>
                                <p>2 patients showing deterioration patterns</p>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--urgent-yellow);">
                                <strong style="color: var(--urgent-yellow);">Capacity Warning</strong>
                                <p>ICU approaching 85% capacity</p>
                            </div>
                            <div style="background: rgba(22, 163, 74, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--stable-green);">
                                <strong style="color: var(--stable-green);">Optimization</strong>
                                <p>Bed allocation optimized for efficiency</p>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--ai-purple);">
                                <strong style="color: var(--ai-purple);">AI Performance</strong>
                                <p>95% accuracy in triage predictions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Management Modal -->
    <div class="modal" id="resource-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">inventory</span>
                    Resource Management
                </div>
                <button class="close-btn" onclick="closeModal('resource-modal')">&times;</button>
            </div>
            <div>
                <div class="resource-grid">
                    <div class="resource-card resource-available">
                        <span class="material-icons" style="font-size: 2rem; color: var(--stable-green);">hotel</span>
                        <h4>Beds</h4>
                        <div style="font-size: 1.5rem; font-weight: 700;">12/20</div>
                        <div style="color: var(--stable-green);">Available</div>
                    </div>
                    <div class="resource-card resource-limited">
                        <span class="material-icons" style="font-size: 2rem; color: var(--urgent-yellow);">people</span>
                        <h4>Nursing Staff</h4>
                        <div style="font-size: 1.5rem; font-weight: 700;">8/12</div>
                        <div style="color: var(--urgent-yellow);">Limited</div>
                    </div>
                    <div class="resource-card resource-critical">
                        <span class="material-icons" style="font-size: 2rem; color: var(--critical-red);">medical_services</span>
                        <h4>Ventilators</h4>
                        <div style="font-size: 1.5rem; font-weight: 700;">1/3</div>
                        <div style="color: var(--critical-red);">Critical</div>
                    </div>
                    <div class="resource-card resource-available">
                        <span class="material-icons" style="font-size: 2rem; color: var(--stable-green);">medication</span>
                        <h4>Pharmacy</h4>
                        <div style="font-size: 1.5rem; font-weight: 700;">98%</div>
                        <div style="color: var(--stable-green);">Stocked</div>
                    </div>
                </div>

                <div class="ai-analysis-panel" style="margin-top: 2rem;">
                    <h4 class="ai-analysis-title">
                        <span class="material-icons">psychology</span>
                        AI Resource Optimization
                    </h4>
                    <div>
                        <div style="margin-bottom: 1rem;">
                            <strong>Recommendations:</strong>
                        </div>
                        <ul style="padding-left: 1.5rem; line-height: 1.8;">
                            <li>Request additional nursing staff for evening shift</li>
                            <li>Prepare backup ventilator from storage</li>
                            <li>Consider early discharge for stable patients</li>
                            <li>Alert respiratory therapy for ventilator maintenance</li>
                        </ul>
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <strong style="color: var(--ai-purple);">AI Prediction:</strong> 
                            Current resource allocation will support operations for next 4 hours. 
                            Critical resource shortage likely if patient volume increases by >20%.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Assignment Modal -->
    <div class="modal" id="staff-assignment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">person_add</span>
                    Assign Medical Staff
                </div>
                <button class="close-btn" onclick="closeModal('staff-assignment-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Patient</label>
                    <select class="form-select" id="assign-patient">
                        <option value="">Select patient</option>
                        <option value="1">John Smith - Critical</option>
                        <option value="2">Maria Garcia - Urgent</option>
                        <option value="3">Robert Wilson - Critical</option>
                        <option value="4">Sarah Johnson - Delayed</option>
                    </select>
                </div>

                <div class="staff-grid">
                    <div class="staff-card" onclick="selectStaff(this, 'dr-smith')">
                        <span class="material-icons" style="font-size: 2rem; color: var(--info-blue);">person</span>
                        <h4>Dr. Smith</h4>
                        <div>Emergency Medicine</div>
                        <div style="color: var(--stable-green); font-size: 0.9rem;">Available</div>
                    </div>
                    <div class="staff-card" onclick="selectStaff(this, 'dr-johnson')">
                        <span class="material-icons" style="font-size: 2rem; color: var(--info-blue);">person</span>
                        <h4>Dr. Johnson</h4>
                        <div>Cardiology</div>
                        <div style="color: var(--urgent-yellow); font-size: 0.9rem;">Busy</div>
                    </div>
                    <div class="staff-card" onclick="selectStaff(this, 'nurse-garcia')">
                        <span class="material-icons" style="font-size: 2rem; color: var(--ai-purple);">person</span>
                        <h4>Nurse Garcia</h4>
                        <div>ICU Specialist</div>
                        <div style="color: var(--stable-green); font-size: 0.9rem;">Available</div>
                    </div>
                    <div class="staff-card" onclick="selectStaff(this, 'dr-wilson')">
                        <span class="material-icons" style="font-size: 2rem; color: var(--info-blue);">person</span>
                        <h4>Dr. Wilson</h4>
                        <div>Trauma Surgery</div>
                        <div style="color: var(--stable-green); font-size: 0.9rem;">Available</div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button class="action-btn" onclick="closeModal('staff-assignment-modal')" style="flex: 1; background: var(--text-secondary);">
                        <span class="material-icons">cancel</span>
                        Cancel
                    </button>
                    <button class="action-btn primary" onclick="confirmStaffAssignment()" style="flex: 2;">
                        <span class="material-icons">assignment_ind</span>
                        Assign Staff
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Patient Modal -->
    <div class="modal" id="edit-patient-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons" style="margin-right: 0.5rem;">edit</span>
                    Edit Patient Information
                </div>
                <button class="close-btn" onclick="closeModal('edit-patient-modal')">&times;</button>
            </div>
            <div>
                <form id="edit-patient-form" onsubmit="updatePatientInfo(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div>
                            <div class="form-group">
                                <label class="form-label">Patient Name</label>
                                <input type="text" class="form-input" id="edit-patient-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-input" id="edit-patient-age" min="0" max="120">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Condition</label>
                                <input type="text" class="form-input" id="edit-injury-type" required>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label">Triage Color</label>
                                <select class="form-select" id="edit-triage-color" required>
                                    <option value="red">🔴 RED - Critical</option>
                                    <option value="yellow">🟡 YELLOW - Urgent</option>
                                    <option value="green">🟢 GREEN - Delayed</option>
                                    <option value="black">⚫ BLACK - Expectant</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="edit-patient-status">
                                    <option value="waiting">Waiting</option>
                                    <option value="in-treatment">In Treatment</option>
                                    <option value="ready-discharge">Ready for Discharge</option>
                                    <option value="transferred">Transferred</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assigned Staff</label>
                                <select class="form-select" id="edit-assigned-staff">
                                    <option value="">Not assigned</option>
                                    <option value="dr-smith">Dr. Smith</option>
                                    <option value="dr-johnson">Dr. Johnson</option>
                                    <option value="dr-wilson">Dr. Wilson</option>
                                    <option value="nurse-garcia">Nurse Garcia</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-input" id="edit-patient-notes" rows="3"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border-color);">
                        <button type="button" class="action-btn" onclick="closeModal('edit-patient-modal')" style="flex: 1; background: var(--text-secondary);">
                            <span class="material-icons">cancel</span>
                            Cancel
                        </button>
                        <button type="button" class="action-btn" onclick="deletePatient()" style="flex: 1; background: var(--critical-red);">
                            <span class="material-icons">delete</span>
                            Delete
                        </button>
                        <button type="submit" class="action-btn primary" style="flex: 2;">
                            <span class="material-icons">save</span>
                            Update Patient
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Enhanced AI Triage System with Complete Functionality
        class AITriageSystem {
            constructor() {
                this.apiBase = '/api';
                this.wsConnection = null;
                this.aiAnalysisCache = new Map();
                this.lastUpdateTime = new Date();
                this.patients = new Map();
                this.selectedStaff = null;
                this.currentEditingPatient = null;
                this.initializeSystem();
            }

            initializeSystem() {
                this.initializeWebSocket();
                this.setupEventListeners();
                this.startPeriodicUpdates();
                this.initializeKeyboardShortcuts();
                this.loadSampleData();
                console.log('🤖 Enhanced AI Triage System initialized with complete functionality');
            }

            loadSampleData() {
                // Load sample patient data
                this.patients.set(1, {
                    id: 1,
                    name: 'John Smith',
                    age: 45,
                    gender: 'Male',
                    triage_color: 'red',
                    injury: 'Chest trauma',
                    consciousness: 'Verbal',
                    breathing: 'Labored',
                    severity: 'Critical',
                    vitals: { hr: 120, bp: '90/60', rr: 28, temp: '98.6°F', o2: '88%' },
                    ai_confidence: 0.92,
                    timestamp: new Date(Date.now() - 5 * 60000),
                    status: 'waiting',
                    assignedStaff: 'dr-smith',
                    notes: 'Possible cardiac tamponade - monitor closely'
                });

                this.patients.set(2, {
                    id: 2,
                    name: 'Maria Garcia',
                    age: 32,
                    gender: 'Female',
                    triage_color: 'yellow',
                    injury: 'Fracture - left arm',
                    consciousness: 'Alert',
                    breathing: 'Normal',
                    severity: 'Moderate',
                    vitals: { hr: 85, bp: '120/80', rr: 16, temp: '98.2°F', o2: '98%' },
                    ai_confidence: 0.87,
                    timestamp: new Date(Date.now() - 10 * 60000),
                    status: 'in-treatment',
                    assignedStaff: 'nurse-garcia',
                    notes: 'X-ray ordered, pain management administered'
                });

                this.patients.set(3, {
                    id: 3,
                    name: 'Robert Wilson',
                    age: 67,
                    gender: 'Male',
                    triage_color: 'red',
                    injury: 'Cardiac event',
                    consciousness: 'Verbal',
                    breathing: 'Labored',
                    severity: 'Critical',
                    vitals: { hr: 140, bp: '180/110', rr: 24, temp: '99.1°F', o2: '91%' },
                    ai_confidence: 0.95,
                    timestamp: new Date(Date.now() - 15 * 60000),
                    status: 'waiting',
                    assignedStaff: 'dr-johnson',
                    notes: 'STEMI - cardiac cath lab contacted'
                });

                this.patients.set(4, {
                    id: 4,
                    name: 'Sarah Johnson',
                    age: 28,
                    gender: 'Female',
                    triage_color: 'green',
                    injury: 'Minor lacerations',
                    consciousness: 'Alert',
                    breathing: 'Normal',
                    severity: 'Mild',
                    vitals: { hr: 72, bp: '118/76', rr: 14, temp: '98.4°F', o2: '99%' },
                    ai_confidence: 0.89,
                    timestamp: new Date(Date.now() - 20 * 60000),
                    status: 'ready-discharge',
                    assignedStaff: 'nurse-garcia',
                    notes: 'Sutures completed, tetanus up to date'
                });
            }

            initializeKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        this.showKeyboardHints();
                    }
                    
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 'k':
                                e.preventDefault();
                                this.focusCommandInput();
                                break;
                            case 'n':
                                e.preventDefault();
                                openTriageForm();
                                break;
                            case 'r':
                                e.preventDefault();
                                refreshQueue();
                                break;
                            case 'e':
                                e.preventDefault();
                                exportQueue();
                                break;
                            case '/':
                                e.preventDefault();
                                this.toggleKeyboardHints();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        this.hideKeyboardHints();
                        this.closeAllModals();
                    }
                });
            }

            focusCommandInput() {
                const input = document.getElementById('ai-command-input');
                if (input) {
                    input.focus();
                    input.select();
                    this.showNotification('🎯 AI Command ready - Type your request', 'ai');
                }
            }

            showKeyboardHints() {
                const hint = document.getElementById('keyboard-hint');
                if (hint) {
                    hint.classList.add('show');
                    setTimeout(() => hint.classList.remove('show'), 3000);
                }
            }

            hideKeyboardHints() {
                const hint = document.getElementById('keyboard-hint');
                if (hint) {
                    hint.classList.remove('show');
                }
            }

            toggleKeyboardHints() {
                const hint = document.getElementById('keyboard-hint');
                if (hint) {
                    hint.classList.toggle('show');
                }
            }

            closeAllModals() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
            }

            showNotification(message, type = 'success', duration = 3000) {
                const notification = document.getElementById('notification');
                if (!notification) return;

                let icon = '';
                switch(type) {
                    case 'ai':
                        icon = '<span class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">psychology</span>';
                        duration = 5000;
                        break;
                    case 'success':
                        icon = '<span class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">check_circle</span>';
                        break;
                    case 'error':
                        icon = '<span class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">error</span>';
                        duration = 6000;
                        break;
                    case 'warning':
                        icon = '<span class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">warning</span>';
                        duration = 4000;
                        break;
                }

                notification.innerHTML = icon + message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);

                notification.onclick = () => notification.classList.remove('show');
            }

            highlightCriticalPatients() {
                const criticalItems = document.querySelectorAll('.patient-item.red');
                criticalItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.border = '3px solid var(--critical-red)';
                        item.style.boxShadow = '0 0 20px rgba(220, 38, 38, 0.3)';
                        item.style.transform = 'scale(1.02)';
                        
                        if (index === 0) {
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, index * 200);
                });
                
                setTimeout(() => {
                    criticalItems.forEach(item => {
                        item.style.border = '';
                        item.style.boxShadow = '';
                        item.style.transform = '';
                    });
                }, 5000);
            }

            validateTriageForm() {
                const requiredFields = ['patient-name', 'injury-type', 'consciousness', 'breathing', 'severity'];
                const missingFields = [];

                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && (!field.value || field.value.trim() === '')) {
                        missingFields.push(field);
                        field.style.borderColor = 'var(--critical-red)';
                        field.style.boxShadow = '0 0 0 4px rgba(220, 38, 38, 0.1)';
                    } else if (field) {
                        field.style.borderColor = 'var(--stable-green)';
                        field.style.boxShadow = '0 0 0 4px rgba(22, 163, 74, 0.1)';
                    }
                });

                if (missingFields.length > 0) {
                    this.showNotification(`Please fill in ${missingFields.length} required field(s)`, 'error');
                    missingFields[0].focus();
                    return false;
                }
                return true;
            }

            async updateRealtimeAnalysis() {
                const formData = this.getTriageFormData();
                
                if (!formData.consciousness && !formData.breathing && !formData.severity) {
                    return;
                }

                const analysisPanel = document.getElementById('ai-suggestions');
                if (analysisPanel) {
                    analysisPanel.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem; color: var(--ai-purple);">AI analyzing patient data...</p>
                        </div>
                    `;
                }

                try {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    const analysis = this.generateEnhancedAnalysis(formData);
                    this.updateAISuggestionsPanel(analysis);
                    
                } catch (error) {
                    console.error('Real-time analysis failed:', error);
                    this.showNotification('AI analysis temporarily unavailable', 'warning');
                }
            }

            generateEnhancedAnalysis(formData) {
                let priority = 3;
                let confidence = 0.7;
                let recommendations = [];
                let riskFactors = [];
                let urgentAlert = null;
                let prediction = '';
                
                // Enhanced consciousness assessment
                if (formData.consciousness === 'unresponsive') {
                    priority = 1;
                    confidence = 0.95;
                    recommendations.push('Immediate airway assessment', 'IV access', 'Neurological evaluation');
                    riskFactors.push('Airway compromise risk', 'Neurological emergency');
                    urgentAlert = 'Patient unresponsive - requires immediate attention';
                    prediction = 'High risk - immediate intervention required';
                } else if (formData.consciousness === 'pain') {
                    priority = Math.min(priority, 2);
                    recommendations.push('Neurological assessment', 'Pain management');
                    riskFactors.push('Altered mental status');
                    prediction = 'Monitor closely for deterioration';
                } else if (formData.consciousness === 'verbal') {
                    recommendations.push('Continue monitoring');
                    prediction = 'Stable consciousness level';
                }
                
                // Enhanced breathing assessment
                if (formData.breathing === 'absent') {
                    priority = 1;
                    confidence = 0.98;
                    recommendations.push('IMMEDIATE airway management', 'Bag-mask ventilation', 'Intubation preparation');
                    riskFactors.push('Respiratory failure', 'Cardiac arrest risk');
                    urgentAlert = 'Absent breathing - LIFE THREATENING';
                    prediction = 'Critical - immediate airway intervention required';
                } else if (formData.breathing === 'labored') {
                    priority = Math.min(priority, 2);
                    recommendations.push('Oxygen therapy', 'Chest X-ray', 'ABG analysis');
                    riskFactors.push('Respiratory distress', 'Potential respiratory failure');
                    prediction = 'Monitor for respiratory deterioration';
                } else if (formData.breathing === 'shallow') {
                    priority = Math.min(priority, 2);
                    recommendations.push('Oxygen monitoring', 'Respiratory assessment');
                    riskFactors.push('Respiratory compromise');
                }
                
                // Enhanced severity assessment
                if (formData.severity === 'critical') {
                    priority = 1;
                    confidence = Math.max(confidence, 0.9);
                    recommendations.push('ICU consultation', 'Continuous monitoring', 'Specialist evaluation');
                    prediction = 'Critical condition - intensive care required';
                } else if (formData.severity === 'severe') {
                    priority = Math.min(priority, 2);
                    recommendations.push('Specialist consultation', 'Frequent monitoring');
                    prediction = 'Serious condition - close monitoring needed';
                } else if (formData.severity === 'moderate') {
                    priority = Math.min(priority, 3);
                    recommendations.push('Standard monitoring');
                    prediction = 'Stable condition - routine care';
                }

                // Enhanced injury-specific recommendations
                const injury = formData.injury_type?.toLowerCase() || '';
                if (injury.includes('cardiac') || injury.includes('heart') || injury.includes('chest pain')) {
                    priority = Math.min(priority, 1);
                    recommendations.push('EKG', 'Cardiac enzymes', 'Cardiology consult');
                    riskFactors.push('Cardiac event progression');
                } else if (injury.includes('head') || injury.includes('brain') || injury.includes('neurological')) {
                    priority = Math.min(priority, 1);
                    recommendations.push('CT scan', 'Neurology consult', 'Neurological monitoring');
                    riskFactors.push('Intracranial pressure', 'Neurological deterioration');
                } else if (injury.includes('trauma') || injury.includes('accident')) {
                    recommendations.push('X-ray', 'Trauma assessment', 'Pain management');
                    riskFactors.push('Hidden injuries possible');
                }
                
                const triageColors = ['', 'red', 'yellow', 'green', 'black'];
                const riskLevels = ['', 'critical', 'high', 'medium', 'low'];
                
                return {
                    suggested_triage: triageColors[priority],
                    confidence: Math.min(0.99, confidence),
                    recommendations: recommendations.length ? [...new Set(recommendations)] : ['Standard care protocols'],
                    risk_factors: riskFactors.length ? [...new Set(riskFactors)] : ['No significant risk factors identified'],
                    risk_level: riskLevels[priority],
                    urgent_alert: urgentAlert,
                    prediction: prediction || 'Standard monitoring protocols',
                    estimated_wait_time: this.calculateWaitTime(priority),
                    resource_needs: this.calculateResourceNeeds(priority, formData)
                };
            }

            calculateWaitTime(priority) {
                const waitTimes = {
                    1: 'Immediate (0-2 minutes)',
                    2: 'Urgent (15-30 minutes)', 
                    3: 'Standard (1-2 hours)',
                    4: 'Comfort care'
                };
                return waitTimes[priority] || 'Standard (1-2 hours)';
            }

            calculateResourceNeeds(priority, formData) {
                const needs = [];
                
                if (priority === 1) {
                    needs.push('ICU bed', 'Cardiac monitor', 'Specialist on call');
                    if (formData.breathing === 'absent' || formData.breathing === 'labored') {
                        needs.push('Ventilator', 'Respiratory therapist');
                    }
                } else if (priority === 2) {
                    needs.push('Monitor bed', 'Regular nursing');
                } else {
                    needs.push('Standard bed', 'Routine monitoring');
                }
                
                return needs;
            }

            updateAISuggestionsPanel(analysis) {
                const suggestionsPanel = document.getElementById('ai-suggestions');
                if (!suggestionsPanel) return;

                const triageColorClass = this.getTriageColorClass(analysis.suggested_triage);
                const riskIcon = this.getRiskIcon(analysis.risk_level);
                
                suggestionsPanel.innerHTML = `
                    <div style="display: grid; gap: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <strong style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons">psychology</span>
                                AI Suggested Triage:
                            </strong>
                            <span class="triage-suggestion ${triageColorClass}" style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">
                                    ${analysis.suggested_triage === 'red' ? 'emergency' : 
                                      analysis.suggested_triage === 'yellow' ? 'warning' :
                                      analysis.suggested_triage === 'green' ? 'schedule' : 'person_off'}
                                </span>
                                ${analysis.suggested_triage.toUpperCase()}
                            </span>
                            <span style="font-size: 0.9rem; color: var(--ai-purple); display: flex; align-items: center; gap: 0.25rem;">
                                <span class="material-icons" style="font-size: 0.8rem;">analytics</span>
                                Confidence: ${Math.round(analysis.confidence * 100)}%
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                                <strong style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 1rem;">medical_services</span>
                                    Recommended Actions:
                                </strong>
                                <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div style="background: rgba(245, 158, 11, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--urgent-yellow);">
                                <strong style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    ${riskIcon}
                                    Risk Assessment:
                                </strong>
                                <div style="color: ${this.getRiskLevelColor(analysis.risk_level)}; font-weight: 500;">
                                    Risk Level: ${analysis.risk_level.toUpperCase()}
                                </div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${analysis.risk_factors.join(', ')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--ai-purple-light); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--ai-purple);">
                            <strong style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span class="material-icons">insights</span>
                                AI Prediction:
                            </strong>
                            <div>${analysis.prediction}</div>
                            <div style="margin-top: 0.75rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                                <div><strong>Estimated Wait:</strong> ${analysis.estimated_wait_time}</div>
                                <div><strong>Resources Needed:</strong> ${analysis.resource_needs.join(', ')}</div>
                            </div>
                        </div>
                        
                        ${analysis.urgent_alert ? `
                            <div style="background: rgba(220, 38, 38, 0.1); border: 2px solid var(--critical-red); padding: 1.25rem; border-radius: 12px; animation: pulse 2s infinite;">
                                <strong style="display: flex; align-items: center; gap: 0.5rem; color: var(--critical-red); font-size: 1.1rem;">
                                    <span class="material-icons">emergency</span>
                                    URGENT ALERT:
                                </strong>
                                <div style="margin-top: 0.5rem; font-weight: 600;">${analysis.urgent_alert}</div>
                            </div>
                        ` : ''}
                        
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="color: var(--ai-purple);">psychology</span>
                                <strong>AI Status:</strong> Analysis complete
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span><strong>Processing Time:</strong> 1.2s</span>
                                <span><strong>Model:</strong> Gemma 3n</span>
                            </div>
                        </div>
                    </div>
                `;

                // Auto-update triage color if not manually selected
                const triageColorSelect = document.getElementById('triage-color');
                if (triageColorSelect && (triageColorSelect.value === '' || triageColorSelect.selectedIndex === 0)) {
                    triageColorSelect.value = analysis.suggested_triage;
                    triageColorSelect.dispatchEvent(new Event('change'));
                }
            }

            getRiskIcon(riskLevel) {
                const icons = {
                    critical: '<span class="material-icons" style="color: var(--critical-red);">dangerous</span>',
                    high: '<span class="material-icons" style="color: var(--urgent-yellow);">warning</span>',
                    medium: '<span class="material-icons" style="color: var(--info-blue);">info</span>',
                    low: '<span class="material-icons" style="color: var(--stable-green);">check_circle</span>'
                };
                return icons[riskLevel] || icons.medium;
            }

            getRiskLevelColor(level) {
                const colors = {
                    critical: 'var(--critical-red)',
                    high: 'var(--urgent-yellow)',
                    medium: 'var(--info-blue)',
                    low: 'var(--stable-green)'
                };
                return colors[level] || colors.medium;
            }

            getTriageColorClass(color) {
                return `triage-${color}`;
            }

            getTriageFormData() {
                return {
                    name: this.getFieldValue('patient-name'),
                    age: this.getFieldValue('patient-age'),
                    gender: this.getFieldValue('patient-gender'),
                    injury_type: this.getFieldValue('injury-type'),
                    consciousness: this.getFieldValue('consciousness'),
                    breathing: this.getFieldValue('breathing'),
                    severity: this.getFieldValue('severity'),
                    triage_color: this.getFieldValue('triage-color'),
                    notes: this.getFieldValue('additional-notes')
                };
            }

            getFieldValue(fieldId) {
                const field = document.getElementById(fieldId);
                return field ? field.value : '';
            }

            // Enhanced command processing
            async processAICommand(command) {
                if (!command.trim()) return;

                this.showNotification('🧠 Processing AI command...', 'ai');
                
                try {
                    this.showCommandProcessing();
                    
                    setTimeout(() => {
                        const result = this.processCommandLocally(command);
                        this.hideCommandProcessing();
                        this.handleCommandResult(result);
                        this.showNotification(`✅ ${result.response}`, 'ai');
                    }, 1200);
                    
                } catch (error) {
                    console.error('AI command processing failed:', error);
                    this.showNotification('❌ Command processing failed', 'error');
                }
            }

            showCommandProcessing() {
                const input = document.getElementById('ai-command-input');
                if (input) {
                    input.style.background = 'linear-gradient(90deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.2) 50%, rgba(139, 92, 246, 0.1) 100%)';
                    input.style.backgroundSize = '200% 100%';
                    input.style.animation = 'command-processing 1.5s ease-in-out infinite';
                    input.disabled = true;
                }
            }

            hideCommandProcessing() {
                const input = document.getElementById('ai-command-input');
                if (input) {
                    input.style.background = '';
                    input.style.animation = '';
                    input.disabled = false;
                }
            }

            processCommandLocally(command) {
                const lowerCommand = command.toLowerCase();
                
                if (lowerCommand.includes('critical') || lowerCommand.includes('red')) {
                    return {
                        action: 'show_critical_patients',
                        response: 'Highlighting critical patients with enhanced visual indicators'
                    };
                }
                
                if (lowerCommand.includes('cardiac') || lowerCommand.includes('heart')) {
                    return {
                        action: 'show_cardiac_patients',
                        response: 'Found cardiac patients: Robert Wilson, John Smith (chest trauma)'
                    };
                }
                
                if (lowerCommand.includes('resource') || lowerCommand.includes('need')) {
                    return {
                        action: 'show_resources',
                        response: 'Opening comprehensive resource management panel'
                    };
                }

                if (lowerCommand.includes('edit') && lowerCommand.includes('patient')) {
                    return {
                        action: 'edit_patients',  // Change this action name
                        response: 'Opening patient management interface for editing'
                    };
                }

                if (lowerCommand.includes('export') && lowerCommand.includes('pdf')) {
                    return {
                        action: 'export_pdf',
                        response: 'Generating comprehensive PDF report with AI insights'
                    };
                }

                if (lowerCommand.includes('staff') && lowerCommand.includes('tools')) {
                    return {
                        action: 'open_staff_tools',
                        response: 'Opening advanced AI analysis tools'
                    };
                }
                
                return {
                    action: 'general_query',
                    response: 'Command processed. Try "show critical patients", "resource analysis", or "staff tools"'
                };
            }

            handleCommandResult(result) {
                switch (result.action) {
                    case 'show_critical_patients':
                        this.highlightCriticalPatients();
                        break;
                    case 'show_cardiac_patients':
                        this.filterPatientsByType('cardiac');
                        break;
                    case 'show_resources':
                        openModal('resource-modal');
                        break;
                    case 'edit_patients':  // Add this new case
                        openPatientList(); // This opens the patient list where you can edit
                        break;
                    case 'open_patient_list':
                        openPatientList();
                        break;
                    case 'export_pdf':
                        exportToPDF();
                        break;
                    case 'open_staff_tools':
                        openStaffAITools();
                        break;
                    default:
                        console.log('Command result:', result);
                }
            }

            filterPatientsByType(type) {
                const patientItems = document.querySelectorAll('.patient-item');
                let matchCount = 0;
                
                patientItems.forEach((item, index) => {
                    const injury = item.querySelector('.patient-details')?.textContent.toLowerCase() || '';
                    const isMatch = injury.includes(type.toLowerCase());
                    
                    setTimeout(() => {
                        if (isMatch) {
                            matchCount++;
                            item.style.border = '3px solid var(--ai-purple)';
                            item.style.boxShadow = '0 0 20px rgba(139, 92, 246, 0.3)';
                            item.style.transform = 'scale(1.02)';
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            item.style.opacity = '0.4';
                            item.style.transform = 'scale(0.98)';
                        }
                    }, index * 100);
                });
                
                setTimeout(() => {
                    this.showNotification(`Found ${matchCount} patient(s) matching "${type}"`, 'ai');
                }, 500);
                
                setTimeout(() => {
                    patientItems.forEach(item => {
                        item.style.opacity = '1';
                        item.style.transform = 'scale(1)';
                        item.style.border = '';
                        item.style.boxShadow = '';
                    });
                }, 4000);
            }

            // Predictive analysis methods
            runPredictiveAnalysis() {
                this.showNotification('🔮 Running AI predictive surge analysis...', 'ai');
                setTimeout(() => {
                    this.showNotification('📊 Prediction: 40% increase in patient volume expected in next 2 hours', 'ai');
                }, 2000);
            }

            // Initialize WebSocket and other setup methods
            initializeWebSocket() {
                console.log('WebSocket initialized with enhanced UX');
            }

            setupEventListeners() {
                const commandInput = document.getElementById('ai-command-input');
                if (commandInput) {
                    commandInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.processAICommand(commandInput.value);
                            commandInput.value = '';
                        }
                    });

                    commandInput.addEventListener('focus', () => {
                        commandInput.style.transform = 'translateY(-2px)';
                    });

                    commandInput.addEventListener('blur', () => {
                        commandInput.style.transform = '';
                    });
                }

                // Real-time form analysis
                const analysisFields = ['consciousness', 'breathing', 'severity', 'injury-type'];
                analysisFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('change', () => {
                            this.updateRealtimeAnalysis();
                        });
                        field.addEventListener('input', this.debounce(() => {
                            this.updateRealtimeAnalysis();
                        }, 800));
                    }
                });
            }

            startPeriodicUpdates() {
                setInterval(() => {
                    this.updateTimeDisplays();
                }, 30000);

                setInterval(() => {
                    this.checkAISystemHealth();
                }, 300000);
            }

            updateTimeDisplays() {
                const timeElements = document.querySelectorAll('.patient-time, .activity-time');
                timeElements.forEach(element => {
                    const timestamp = element.getAttribute('data-timestamp');
                    if (timestamp) {
                        element.textContent = this.getTimeAgo(new Date(timestamp));
                    }
                });
            }

            checkAISystemHealth() {
                console.log('🤖 AI system health check completed - all systems operational');
            }

            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - new Date(date);
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours}h ago`;
                
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d ago`;
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Patient management methods
            addPatient(patientData) {
                const newId = Math.max(...this.patients.keys()) + 1;
                patientData.id = newId;
                patientData.timestamp = new Date();
                this.patients.set(newId, patientData);
                this.refreshPatientDisplay();
                this.showNotification(`Patient ${patientData.name} added successfully`, 'success');
                return newId;
            }

            updatePatient(patientId, patientData) {
                if (this.patients.has(patientId)) {
                    const existing = this.patients.get(patientId);
                    this.patients.set(patientId, { ...existing, ...patientData });
                    this.refreshPatientDisplay();
                    this.showNotification(`Patient ${patientData.name || existing.name} updated successfully`, 'success');
                }
            }

            deletePatient(patientId) {
                if (this.patients.has(patientId)) {
                    const patient = this.patients.get(patientId);
                    this.patients.delete(patientId);
                    this.refreshPatientDisplay();
                    this.showNotification(`Patient ${patient.name} removed from system`, 'warning');
                }
            }

            refreshPatientDisplay() {
                // Update stats
                this.updateStatistics();
                // Could refresh patient queue display here
            }

            updateStatistics() {
                const stats = {
                    critical: 0,
                    urgent: 0,
                    delayed: 0,
                    expectant: 0
                };

                this.patients.forEach(patient => {
                    switch(patient.triage_color) {
                        case 'red': stats.critical++; break;
                        case 'yellow': stats.urgent++; break;
                        case 'green': stats.delayed++; break;
                        case 'black': stats.expectant++; break;
                    }
                });

                document.getElementById('critical-count').textContent = stats.critical;
                document.getElementById('urgent-count').textContent = stats.urgent;
                document.getElementById('delayed-count').textContent = stats.delayed;
                document.getElementById('expectant-count').textContent = stats.expectant;
            }
        }

        // Enhanced global variables
        let aiTriageSystem;
        let map;

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            aiTriageSystem = new AITriageSystem();
            window.aiTriageSystem = aiTriageSystem;
            
            initializeEnhancedMap();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Add CSS animation for command processing
            const style = document.createElement('style');
            style.textContent = `
                @keyframes command-processing {
                    0% { background-position: 200% 0; }
                    100% { background-position: -200% 0; }
                }
            `;
            document.head.appendChild(style);
            
            console.log('🚀 Enhanced AI Medical Triage Dashboard Loaded');
            
            setTimeout(() => {
                aiTriageSystem.showNotification('🤖 Enhanced AI Medical Triage System Online - Gemma 3n Ready', 'ai');
            }, 1000);
            
            setTimeout(() => {
                aiTriageSystem.showNotification('💡 Try voice commands like "Show critical patients" or use Ctrl+K', 'ai');
            }, 4000);
        });

        // Enhanced global functions
        function openTriageForm() {
            const modal = document.getElementById('triage-modal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    const firstInput = modal.querySelector('input, select');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
            aiTriageSystem.showNotification('🤖 AI-Enhanced Triage Assessment Ready', 'ai');
        }

        function fillCommand(command) {
            const input = document.getElementById('ai-command-input');
            if (input) {
                input.value = command;
                input.focus();
                input.style.background = 'rgba(139, 92, 246, 0.1)';
                setTimeout(() => {
                    input.style.background = '';
                }, 500);
            }
        }

        function filterPatients(color) {
            aiTriageSystem.showNotification(`Filtering patients by ${color.toUpperCase()} triage level`, 'ai');
            const items = document.querySelectorAll('.patient-item');
            let matchCount = 0;
            
            items.forEach((item, index) => {
                setTimeout(() => {
                    if (item.classList.contains(color)) {
                        matchCount++;
                        item.style.opacity = '1';
                        item.style.transform = 'scale(1.02)';
                        item.style.border = '2px solid var(--accent-color)';
                    } else {
                        item.style.opacity = '0.3';
                        item.style.transform = 'scale(0.98)';
                    }
                }, index * 50);
            });
            
            setTimeout(() => {
                aiTriageSystem.showNotification(`${matchCount} ${color.toUpperCase()} patients highlighted`, 'success');
            }, 300);
            
            setTimeout(() => {
                items.forEach(item => {
                    item.style.opacity = '1';
                    item.style.transform = 'scale(1)';
                    item.style.border = '';
                });
            }, 3000);
        }

        function refreshQueue() {
            aiTriageSystem.showNotification('🤖 AI refreshing patient queue with latest insights...', 'ai');
            
            const queue = document.getElementById('patient-queue');
            if (queue) {
                queue.style.opacity = '0.7';
                queue.style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    queue.style.opacity = '1';
                    queue.style.transform = 'scale(1)';
                    aiTriageSystem.showNotification('Patient queue refreshed with enhanced AI insights', 'success');
                }, 1000);
            }
        }

        function initializeEnhancedMap() {
            map = L.map('map').setView([30.2672, -97.7431], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const incidents = [
                { 
                    lat: 30.2672, lng: -97.7431, 
                    severity: 'critical', 
                    description: 'Multi-vehicle accident',
                    aiPrediction: 'High probability of additional casualties',
                    patients: 3,
                    timestamp: '15m ago'
                },
                { 
                    lat: 30.2500, lng: -97.7500, 
                    severity: 'urgent', 
                    description: 'Building collapse',
                    aiPrediction: 'Rescue operations ongoing',
                    patients: 5,
                    timestamp: '32m ago'
                },
                { 
                    lat: 30.2800, lng: -97.7300, 
                    severity: 'delayed', 
                    description: 'Minor injuries',
                    aiPrediction: 'Situation under control',
                    patients: 2,
                    timestamp: '1h ago'
                }
            ];

            incidents.forEach(incident => {
                const colors = {
                    critical: '#dc2626',
                    urgent: '#f59e0b',
                    delayed: '#16a34a'
                };
                
                const icons = {
                    critical: '🚨',
                    urgent: '⚠️',
                    delayed: '💊'
                };
                
                const color = colors[incident.severity];
                const icon = icons[incident.severity];
                
                L.circleMarker([incident.lat, incident.lng], {
                    color: color,
                    radius: 8 + (incident.patients * 2),
                    fillOpacity: 0.8,
                    weight: 3
                }).addTo(map).bindPopup(`
                    <div style="min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: bold; color: ${color};">
                            <span style="font-size: 1.2rem;">${icon}</span>
                            <span>${incident.severity.toUpperCase()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;"><strong>Location:</strong> ${incident.description}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Patients:</strong> ${incident.patients}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Time:</strong> ${incident.timestamp}</div>
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 0.5rem; border-radius: 6px; border-left: 3px solid #8b5cf6; font-size: 0.85rem;">
                            <strong>🤖 AI Analysis:</strong> ${incident.aiPrediction}
                        </div>
                    </div>
                `);
            });
        }

        function updateClock() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString();
            }
        }

        function openPatientDetails(patientId) {
            if (!aiTriageSystem.patients.has(patientId)) return;
            
            const patient = aiTriageSystem.patients.get(patientId);
            const details = document.getElementById('patient-details');
            if (!details) return;
            
            const triageColorStyles = {
                red: { bg: 'var(--critical-red)', color: 'white' },
                yellow: { bg: 'var(--urgent-yellow)', color: 'white' },
                green: { bg: 'var(--stable-green)', color: 'white' },
                black: { bg: 'var(--expectant-black)', color: 'white' }
            };
            
            const style = triageColorStyles[patient.triage_color];
            
            details.innerHTML = `
                <div style="display: grid; gap: 2rem;">
                    <!-- Patient Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--border-strong); padding-bottom: 1.5rem;">
                        <div>
                            <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                <span class="material-icons" style="font-size: 2rem;">person</span>
                                ${patient.name}
                            </h2>
                            <div style="color: var(--text-secondary); font-size: 1.1rem;">
                                ${patient.age} years old • ${patient.gender} • Admitted ${aiTriageSystem.getTimeAgo(patient.timestamp)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span style="background: ${style.bg}; color: ${style.color}; padding: 0.75rem 1.25rem; border-radius: 16px; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons">emergency</span>
                                ${patient.triage_color.toUpperCase()}
                            </span>
                            <span style="background: var(--ai-gradient); color: white; padding: 0.75rem 1.25rem; border-radius: 16px; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons">psychology</span>
                                AI: ${Math.round(patient.ai_confidence * 100)}%
                            </span>
                        </div>
                    </div>
                    
                    <!-- Patient Information Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <!-- Basic Information -->
                        <div style="background: var(--bg-light); padding: 2rem; border-radius: 16px; border: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                                <span class="material-icons">medical_information</span>
                                Clinical Assessment
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Primary Injury:</strong>
                                    <span>${patient.injury}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Consciousness:</strong>
                                    <span>${patient.consciousness}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Breathing:</strong>
                                    <span>${patient.breathing}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Severity:</strong>
                                    <span style="color: ${style.bg}; font-weight: 600;">${patient.severity}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Status:</strong>
                                    <span>${patient.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Assigned Staff:</strong>
                                    <span>${patient.assignedStaff?.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'None'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vital Signs -->
                        <div style="background: var(--bg-light); padding: 2rem; border-radius: 16px; border: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                                <span class="material-icons">monitor_heart</span>
                                Vital Signs
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem;">favorite</span>
                                        <strong>Heart Rate:</strong>
                                    </span>
                                    <span style="font-family: monospace; font-size: 1.1rem; font-weight: 600;">${patient.vitals.hr} bpm</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem;">bloodtype</span>
                                        <strong>Blood Pressure:</strong>
                                    </span>
                                    <span style="font-family: monospace; font-size: 1.1rem; font-weight: 600;">${patient.vitals.bp} mmHg</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem;">air</span>
                                        <strong>Respiratory Rate:</strong>
                                    </span>
                                    <span style="font-family: monospace; font-size: 1.1rem; font-weight: 600;">${patient.vitals.rr} /min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem;">thermostat</span>
                                        <strong>Temperature:</strong>
                                    </span>
                                    <span style="font-family: monospace; font-size: 1.1rem; font-weight: 600;">${patient.vitals.temp}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem;">masks</span>
                                        <strong>Oxygen Sat:</strong>
                                    </span>
                                    <span style="font-family: monospace; font-size: 1.1rem; font-weight: 600; color: ${patient.vitals.o2.includes('8') ? 'var(--critical-red)' : 'var(--stable-green)'};">${patient.vitals.o2}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    ${patient.notes ? `
                        <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons">note</span>
                                Clinical Notes
                            </h4>
                            <p style="line-height: 1.6;">${patient.notes}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 2px solid var(--border-color);">
                        <button onclick="editPatient(${patientId})" style="flex: 1; background: var(--ai-gradient); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span class="material-icons">edit</span>
                            Edit Patient
                        </button>
                        <button onclick="updateVitals(${patientId})" style="flex: 1; background: var(--info-blue); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span class="material-icons">monitor_heart</span>
                            Update Vitals
                        </button>
                        <button onclick="assignStaff(${patientId})" style="flex: 1; background: var(--stable-green); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span class="material-icons">person_add</span>
                            Assign Staff
                        </button>
                    </div>
                </div>
            `;
            
            openModal('patient-modal');
        }

        function editPatient(patientId) {
    if (!patientId || !aiTriageSystem.patients.has(patientId)) {
        // If no specific patient ID, open patient list for selection
        openPatientList();
        aiTriageSystem.showNotification('📋 Select a patient to edit from the list', 'ai');
        return;
    }
    
    const patient = aiTriageSystem.patients.get(patientId);
    aiTriageSystem.currentEditingPatient = patientId;
    
    // Populate edit form with patient data
    document.getElementById('edit-patient-name').value = patient.name;
    document.getElementById('edit-patient-age').value = patient.age;
    document.getElementById('edit-injury-type').value = patient.injury;
    document.getElementById('edit-triage-color').value = patient.triage_color;
    document.getElementById('edit-patient-status').value = patient.status;
    document.getElementById('edit-assigned-staff').value = patient.assignedStaff || '';
    document.getElementById('edit-patient-notes').value = patient.notes || '';
    
    // Close patient details modal if open and show edit modal
    closeModal('patient-modal');
    closeModal('patient-list-modal');
    openModal('edit-patient-modal');
    
    aiTriageSystem.showNotification(`🔧 Editing ${patient.name}`, 'ai');
}

        // Function specifically for the "Edit patients" command
        function editPatients() {
            openPatientList();
            aiTriageSystem.showNotification('🔧 Patient management interface loaded - Select a patient to edit', 'ai');
        }

        function updateVitals(patientId) {
            aiTriageSystem.showNotification(`Opening vitals update for Patient #${patientId}`, 'ai');
        }

        function assignStaff(patientId) {
            // Set the patient in the assignment modal
            document.getElementById('assign-patient').value = patientId;
            openModal('staff-assignment-modal');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                const content = modal.querySelector('.modal-content');
                if (content) {
                    content.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    content.style.opacity = '0';
                    
                    setTimeout(() => {
                        content.style.transform = 'translate(-50%, -50%) scale(1)';
                        content.style.opacity = '1';
                        content.style.transition = 'all 0.3s ease-out';
                    }, 10);
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const content = modal.querySelector('.modal-content');
                if (content) {
                    content.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    content.style.opacity = '0';
                    
                    setTimeout(() => {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }, 200);
                } else {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
        }

        // Enhanced modal functions
        function openPatientList() {
            openModal('patient-list-modal');
            aiTriageSystem.showNotification('📋 Patient list loaded with AI insights', 'ai');
        }

        function openPatientTracker() {
            openModal('patient-tracker-modal');
            aiTriageSystem.showNotification('📊 Patient flow tracker with real-time analytics', 'ai');
        }

        function openStaffAITools() {
            openModal('staff-ai-tools-modal');
            aiTriageSystem.showNotification('🛠️ Advanced AI analysis tools ready', 'ai');
        }

        function exportToPDF() {
            aiTriageSystem.showNotification('📄 Generating comprehensive PDF report with AI insights...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('✅ PDF report generated successfully', 'success');
            }, 2000);
        }

        function exportQueue() {
            aiTriageSystem.showNotification('📤 Exporting patient queue with AI analytics...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('✅ Patient queue exported with AI insights', 'success');
            }, 1500);
        }

        function sortByAI() {
            aiTriageSystem.showNotification('🧠 AI optimizing patient priority order...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('✅ Patient queue optimized based on AI risk assessment', 'success');
            }, 1500);
        }

        // Form submission handlers
        function submitTriageForm(event) {
            event.preventDefault();
            
            if (!aiTriageSystem.validateTriageForm()) {
                return;
            }
            
            const formData = aiTriageSystem.getTriageFormData();
            const patientId = aiTriageSystem.addPatient({
                name: formData.name,
                age: parseInt(formData.age) || 0,
                gender: formData.gender,
                injury: formData.injury_type,
                consciousness: formData.consciousness,
                breathing: formData.breathing,
                severity: formData.severity,
                triage_color: formData.triage_color,
                notes: formData.notes,
                ai_confidence: 0.85,
                vitals: {
                    hr: 0, bp: '0/0', rr: 0, temp: '0°F', o2: '0%'
                },
                status: 'waiting',
                assignedStaff: null
            });
            
            closeModal('triage-modal');
            aiTriageSystem.showNotification(`✅ Patient ${formData.name} successfully triaged and added to queue`, 'success');
            
            // Reset form
            document.getElementById('triage-form').reset();
            document.getElementById('ai-suggestions').innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    <span class="material-icons" style="font-size: 3rem; opacity: 0.5;">psychology</span>
                    <p>AI analysis will appear as you fill out the form...</p>
                </div>
            `;
        }

        function updatePatientInfo(event) {
            event.preventDefault();
            
            const patientId = aiTriageSystem.currentEditingPatient;
            if (!patientId) return;
            
            const formData = {
                name: document.getElementById('edit-patient-name').value,
                age: parseInt(document.getElementById('edit-patient-age').value) || 0,
                injury: document.getElementById('edit-injury-type').value,
                triage_color: document.getElementById('edit-triage-color').value,
                status: document.getElementById('edit-patient-status').value,
                assignedStaff: document.getElementById('edit-assigned-staff').value || null,
                notes: document.getElementById('edit-patient-notes').value
            };
            
            aiTriageSystem.updatePatient(patientId, formData);
            closeModal('edit-patient-modal');
        }

        function deletePatient() {
            const patientId = aiTriageSystem.currentEditingPatient;
            if (!patientId) return;
            
            if (confirm('Are you sure you want to delete this patient from the system?')) {
                aiTriageSystem.deletePatient(patientId);
                closeModal('edit-patient-modal');
            }
        }

        function selectStaff(element, staffId) {
            // Remove selection from other cards
            document.querySelectorAll('.staff-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            element.classList.add('selected');
            aiTriageSystem.selectedStaff = staffId;
        }

        function confirmStaffAssignment() {
            const patientId = document.getElementById('assign-patient').value;
            const staffId = aiTriageSystem.selectedStaff;
            
            if (!patientId || !staffId) {
                aiTriageSystem.showNotification('Please select both patient and staff member', 'error');
                return;
            }
            
            const patient = aiTriageSystem.patients.get(parseInt(patientId));
            if (patient) {
                aiTriageSystem.updatePatient(parseInt(patientId), { assignedStaff: staffId });
                const staffName = staffId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                aiTriageSystem.showNotification(`${staffName} assigned to ${patient.name}`, 'success');
                closeModal('staff-assignment-modal');
                
                // Reset selection
                aiTriageSystem.selectedStaff = null;
                document.querySelectorAll('.staff-card').forEach(card => {
                    card.classList.remove('selected');
                });
            }
        }

        function addNewPatient() {
            closeModal('patient-list-modal');
            openTriageForm();
        }

        // Enhanced real-time analysis functions
        function updateAIAnalysis() {
            if (aiTriageSystem) {
                aiTriageSystem.updateRealtimeAnalysis();
            }
        }

        function runAITriage() {
            aiTriageSystem.showNotification('🤖 Running comprehensive Gemma 3n analysis...', 'ai');
            
            setTimeout(() => {
                updateAIAnalysis();
                aiTriageSystem.showNotification('🧠 AI Analysis Complete: Enhanced insights ready for review', 'ai');
            }, 2500);
        }

        // Advanced AI Tools Functions
        function runPredictiveAnalysis() {
            aiTriageSystem.showNotification('🔮 Running AI predictive surge analysis...', 'ai');
            setTimeout(() => {
                const insights = document.getElementById('ai-insights-content');
                if (insights) {
                    insights.innerHTML += `
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--info-blue); margin-top: 1rem;">
                            <strong style="color: var(--info-blue);">Surge Prediction</strong>
                            <p>40% increase in patient volume expected in next 2 hours. Recommend preparing additional resources.</p>
                        </div>
                    `;
                }
                aiTriageSystem.showNotification('📊 Surge prediction complete: 40% volume increase expected', 'ai');
            }, 2000);
        }

        function runCapacityAnalysis() {
            aiTriageSystem.showNotification('🏥 Analyzing current capacity and utilization...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('📊 Capacity analysis: 85% ICU utilization, recommend discharge planning', 'ai');
            }, 1500);
        }

        function runResourceOptimization() {
            aiTriageSystem.showNotification('⚙️ Optimizing resource allocation with AI...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('✅ Resource optimization complete: Efficiency improved by 15%', 'success');
            }, 2000);
        }

        function runDeteriorationRisk() {
            aiTriageSystem.showNotification('📉 Analyzing patient deterioration patterns...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('⚠️ Risk analysis: 2 patients showing early deterioration signs', 'warning');
            }, 1800);
        }

        function runMortalityRisk() {
            aiTriageSystem.showNotification('💔 Running mortality risk assessment...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('📊 Mortality risk analysis complete: All patients stable risk profile', 'ai');
            }, 2200);
        }

        function runComplicationRisk() {
            aiTriageSystem.showNotification('🔍 Analyzing complication probability...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('📋 Complication analysis: Monitor John Smith for potential complications', 'warning');
            }, 1600);
        }

        function openDiagnosticAI() {
            aiTriageSystem.showNotification('🔬 Opening AI diagnostic support system...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('🤖 Diagnostic AI ready: Upload imaging or lab results for analysis', 'ai');
            }, 1000);
        }

        function openTreatmentAI() {
            aiTriageSystem.showNotification('💊 Loading AI treatment recommendation engine...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('🎯 Treatment AI active: Evidence-based recommendations available', 'ai');
            }, 1200);
        }

        function openDischargeAI() {
            aiTriageSystem.showNotification('🚪 Initializing AI discharge planning system...', 'ai');
            setTimeout(() => {
                aiTriageSystem.showNotification('📋 Discharge AI ready: Optimizing patient flow and bed management', 'ai');
            }, 1400);
        }

        // Search and filter functions
        document.addEventListener('DOMContentLoaded', function() {
            // Patient search functionality
            const searchInput = document.getElementById('patient-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#patient-table-body tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }

            // Status filter functionality
            const statusFilter = document.getElementById('filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const filterValue = this.value;
                    const rows = document.querySelectorAll('#patient-table-body tr');
                    
                    rows.forEach(row => {
                        if (!filterValue) {
                            row.style.display = '';
                        } else {
                            const triageCell = row.querySelector('.triage-suggestion');
                            const hasMatchingTriage = triageCell && triageCell.classList.contains(`triage-${filterValue}`);
                            row.style.display = hasMatchingTriage ? '' : 'none';
                        }
                    });
                });
            }
        });

        console.log('🎨 Enhanced AI Medical Triage Dashboard - Fully Loaded with All Modals');
        console.log('✨ Features: Complete Modal System, Patient Management, Staff Assignment, AI Tools');
        console.log('🚀 Ready for comprehensive medical emergency response');
    </script>
</body>
</html>