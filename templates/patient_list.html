<!DOCTYPE html>
<!-- 
  File: patient_list.html
  Type: Standard HTML Template with Jinja2, CSS, and JavaScript
  Framework: Flask/Jinja2 (NOT React/JSX)
  Language: HTML
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Patient List - Disaster Response Assistant{% endblock %}</title>
</head>
<body>

{% extends "base.html" %}

{% block page_title %}üë• Patient Management Dashboard{% endblock %}
{% block subtitle %}Real-time Patient Queue & Status Monitoring{% endblock %}

{% block header_actions %}
<a href="/" class="btn-link">
  ‚¨ÖÔ∏è Back to Home
</a>
<a href="/triage" class="btn-link btn-success">
  üìù New Triage
</a>
<a href="/triage-dashboard" class="btn-link btn-primary">
  üìä Dashboard
</a>
{% endblock %}

{% block extra_styles %}
<style>
  /* ========================================
     LAYOUT & GRID SYSTEM
     ======================================== */
  .btn-link {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    color: #fff;
    border-radius: 6px;
    text-decoration: none;
    margin-left: 0.5rem;
  }
  
  .btn-link:first-child {
    margin-left: 0;
    background-color: #6b7280;
  }
  
  .btn-success {
    background-color: #16a34a;
  }
  
  .btn-primary {
    background-color: #3b82f6;
  }

  .patient-dashboard {
    max-width: 1600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 2rem;
    align-items: start;
  }

  /* ========================================
     SIDEBAR COMPONENTS
     ======================================== */
  .stats-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    position: sticky;
    top: 2rem;
  }
  
  .stats-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 2px solid #e5e7eb;
  }
  
  .stats-header {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 1.25rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
  }
  
  .stats-content {
    padding: 1.5rem;
  }

  /* Stat Items */
  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .stat-item:last-child {
    border-bottom: none;
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  .stat-value {
    font-weight: bold;
    font-size: 1.2rem;
  }
  
  /* Stat Colors */
  .stat-critical { color: #dc2626; }
  .stat-warning { color: #f59e0b; }
  .stat-success { color: #16a34a; }
  .stat-info { color: #3b82f6; }

  /* Color Breakdown Grid */
  .color-breakdown {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .color-stat {
    text-align: center;
    padding: 1rem;
    border-radius: 12px;
    font-weight: bold;
    color: white;
    transition: transform 0.2s ease;
    cursor: pointer;
  }
  
  .color-stat:hover {
    transform: translateY(-2px);
  }
  
  .color-red { background: #dc2626; }
  .color-yellow { background: #f59e0b; }
  .color-green { background: #16a34a; }
  .color-black { background: #374151; }

  /* ========================================
     FILTERS & SEARCH
     ======================================== */
  .filters-section {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
  }
  
  .filter-group {
    margin-bottom: 1rem;
  }
  
  .filter-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .filter-select, .search-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: border-color 0.2s ease;
  }
  
  .filter-select:focus, .search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .search-container {
    position: relative;
    margin-bottom: 1rem;
  }
  
  .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 1rem;
  }
  
  .search-input {
    padding-left: 2.5rem;
  }
  
  .clear-filters {
    width: 100%;
    padding: 0.75rem;
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: background-color 0.2s ease;
  }
  
  .clear-filters:hover {
    background: #4b5563;
  }

  /* ========================================
     SYNC STATUS INDICATOR
     ======================================== */
  .sync-status {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 1rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
  }
  
  .sync-status.offline {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }
  
  .sync-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ========================================
     MAIN PATIENT CONTAINER
     ======================================== */
  .patients-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 2px solid #e5e7eb;
  }
  
  .patients-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .patients-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  .patients-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.75rem 1.25rem;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .header-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* ========================================
     TABLE CONTROLS
     ======================================== */
  .table-controls {
    padding: 1.5rem 2rem;
    background: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .bulk-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .bulk-select {
    margin-right: 1rem;
  }
  
  .bulk-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
  }
  
  .btn-export {
    background: #16a34a;
    color: white;
  }
  
  .btn-print {
    background: #6b7280;
    color: white;
  }
  
  .btn-bulk {
    background: #f59e0b;
    color: white;
  }

  /* ========================================
     PATIENT TABLE
     ======================================== */
  .patients-list {
    max-height: 75vh;
    overflow-y: auto;
  }
  
  .patient-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .patient-header {
    background: #1e40af;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .patient-header th {
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #1e3a8a;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .patient-header th:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .sortable::after {
    content: " ‚ÜïÔ∏è";
    font-size: 0.7rem;
  }

  /* Patient Rows */
  .patient-row {
    border-bottom: 1px solid #e5e7eb;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .patient-row:hover {
    background: #f8fafc;
    transform: translateX(2px);
  }
  
  .patient-row.critical {
    border-left: 4px solid #dc2626;
    background: rgba(220, 38, 38, 0.02);
  }
  
  .patient-row.selected {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid #3b82f6;
  }
  
  .patient-row td {
    padding: 1rem;
    vertical-align: middle;
  }

  /* ========================================
     PATIENT TABLE COMPONENTS
     ======================================== */
  
  /* Priority Indicator */
  .priority-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 0.9rem;
    margin: 0 auto;
  }
  
  .priority-1 { background: #dc2626; }
  .priority-2 { background: #f59e0b; }
  .priority-3 { background: #16a34a; }
  .priority-4 { background: #374151; }

  /* Patient Info */
  .patient-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .patient-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 1rem;
  }
  
  .patient-id {
    font-size: 0.8rem;
    color: #6b7280;
    font-family: 'Courier New', monospace;
  }
  
  .patient-age {
    font-size: 0.8rem;
    color: #6b7280;
  }

  /* Badges */
  .severity-badge, .status-badge, .triage-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    text-align: center;
    display: inline-block;
  }
  
  .severity-critical, .triage-red {
    background: #dc2626;
    color: white;
  }
  
  .severity-severe, .triage-yellow {
    background: #f59e0b;
    color: white;
  }
  
  .severity-moderate, .triage-green {
    background: #16a34a;
    color: white;
  }
  
  .severity-mild, .triage-black {
    background: #374151;
    color: white;
  }
  
  .status-active {
    background: #fef3c7;
    color: #92400e;
  }
  
  .status-in_treatment {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .status-treated {
    background: #d1fae5;
    color: #065f46;
  }
  
  .status-discharged {
    background: #f3f4f6;
    color: #374151;
  }

  /* Clinician Info */
  .clinician-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .clinician-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
  }

  /* Vitals Display */
  .vitals-display {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.8rem;
  }
  
  .vital-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .vitals-normal { color: #16a34a; }
  .vitals-warning { color: #f59e0b; }
  .vitals-critical { color: #dc2626; }

  /* Time Display */
  .patient-time {
    font-size: 0.8rem;
    color: #6b7280;
    font-family: 'Courier New', monospace;
  }

  /* Alert Indicators */
  .alert-indicators {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .alert-flag {
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: bold;
    text-align: center;
  }
  
  .alert-critical {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
  
  .alert-allergy {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fed7aa;
  }

  /* Patient Actions */
  .patient-actions {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .btn-view {
    background: #3b82f6;
    color: white;
  }
  
  .btn-edit {
    background: #f59e0b;
    color: white;
  }
  
  .btn-message {
    background: #8b5cf6;
    color: white;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
  }

  /* ========================================
     EMPTY STATE
     ======================================== */
  .no-patients {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
  }
  
  .no-patients-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  /* ========================================
     MODALS
     ======================================== */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    backdrop-filter: blur(8px);
  }
  
  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }
  
  .modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1f2937;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    padding: 0.5rem;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .close-btn:hover {
    color: #dc2626;
    background: rgba(220, 38, 38, 0.1);
  }

  /* ========================================
     LOADING STATE
     ======================================== */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: #6b7280;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 1rem;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* ========================================
     ACCESSIBILITY
     ======================================== */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* Focus States */
  .patient-row:focus,
  .action-btn:focus,
  .header-btn:focus {
    outline: 3px solid #3b82f6;
    outline-offset: 2px;
  }

  /* ========================================
     RESPONSIVE DESIGN
     ======================================== */
  @media (max-width: 1400px) {
    .patient-dashboard {
      grid-template-columns: 300px 1fr;
    }
  }
  
  @media (max-width: 1200px) {
    .patient-dashboard {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .stats-sidebar {
      order: 2;
      position: static;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
  }
  
  @media (max-width: 768px) {
    .patients-header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }
    
    .header-actions {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .table-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .patient-table {
      font-size: 0.8rem;
    }
    
    .patient-header th,
    .patient-row td {
      padding: 0.5rem;
    }
  }

  /* ========================================
     PRINT STYLES
     ======================================== */
  @media print {
    .stats-sidebar,
    .header-actions,
    .table-controls,
    .patient-actions {
      display: none !important;
    }
    
    .patient-dashboard {
      grid-template-columns: 1fr;
    }
    
    .patients-container {
      box-shadow: none;
      border: 1px solid #000;
    }
    
    .patients-header {
      background: #000 !important;
      color: #fff !important;
    }
    
    .patient-row {
      break-inside: avoid;
    }
  }

  /* ========================================
     HIGH CONTRAST MODE
     ======================================== */
  @media (prefers-contrast: high) {
    .stats-card,
    .patients-container {
      border: 3px solid #000;
    }
    
    .patient-row:hover {
      background: #000;
      color: #fff;
    }
  }

  /* ========================================
     ANIMATION KEYFRAMES
     ======================================== */
  @keyframes slideIn {
    from { 
      transform: translateX(100%); 
      opacity: 0; 
    }
    to { 
      transform: translateX(0); 
      opacity: 1; 
    }
  }
  
  @keyframes slideOut {
    from { 
      transform: translateX(0); 
      opacity: 1; 
    }
    to { 
      transform: translateX(100%); 
      opacity: 0; 
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="patient-dashboard">
  <!-- Enhanced Stats Sidebar -->
  <div class="stats-sidebar">
    <!-- Sync Status -->
    <div class="sync-status" id="sync-status">
      <div class="sync-indicator"></div>
      <div>
        <div style="font-weight: bold;">System Online</div>
        <div style="font-size: 0.8rem; opacity: 0.9;">Last sync: 30s ago</div>
      </div>
    </div>
    
    <!-- Summary Stats -->
    <div class="stats-card">
      <div class="stats-header">
        <span>üìä</span>
        <span>Patient Summary</span>
      </div>
      <div class="stats-content">
        <div class="stat-item">
          <span class="stat-label">Total Patients</span>
          <span class="stat-value stat-info" id="total-count">{{ total_patients }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Currently Active</span>
          <span class="stat-value stat-warning" id="active-count">{{ active_patients }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Critical Cases</span>
          <span class="stat-value stat-critical" id="critical-count">{{ critical_patients }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">In Treatment</span>
          <span class="stat-value stat-info" id="treatment-count">{{ in_treatment_patients }}</span>
        </div>
      </div>
    </div>
    
    <!-- Triage Color Breakdown -->
    <div class="stats-card">
      <div class="stats-header">
        <span>üè∑Ô∏è</span>
        <span>Triage Colors</span>
      </div>
      <div class="stats-content">
        <div class="color-breakdown">
          <div class="color-stat color-red" data-color="red">
            <div style="font-size: 1.5rem;">{{ color_counts.red }}</div>
            <div style="font-size: 0.8rem;">RED</div>
          </div>
          <div class="color-stat color-yellow" data-color="yellow">
            <div style="font-size: 1.5rem;">{{ color_counts.yellow }}</div>
            <div style="font-size: 0.8rem;">YELLOW</div>
          </div>
          <div class="color-stat color-green" data-color="green">
            <div style="font-size: 1.5rem;">{{ color_counts.green }}</div>
            <div style="font-size: 0.8rem;">GREEN</div>
          </div>
          <div class="color-stat color-black" data-color="black">
            <div style="font-size: 1.5rem;">{{ color_counts.black }}</div>
            <div style="font-size: 0.8rem;">BLACK</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Enhanced Filters -->
    <div class="stats-card">
      <div class="stats-header">
        <span>üîç</span>
        <span>Search & Filters</span>
      </div>
      <div class="stats-content">
        <div class="filters-section">
          <!-- Search Box -->
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input 
              type="text" 
              class="search-input" 
              placeholder="Search by name, ID, or condition..."
              id="search-input"
            >
          </div>
          
          <form method="GET" action="/patient-list" id="filter-form">
            <div class="filter-group">
              <label class="filter-label">Triage Color</label>
              <select name="triage_color" class="filter-select" id="triage-color-select">
                <option value="">All Colors</option>
                <option value="red" {% if filters.triage_color == "red" %}selected{% endif %}>üî¥ Red - Critical</option>
                <option value="yellow" {% if filters.triage_color == "yellow" %}selected{% endif %}>üü° Yellow - Urgent</option>
                <option value="green" {% if filters.triage_color == "green" %}selected{% endif %}>üü¢ Green - Delayed</option>
                <option value="black" {% if filters.triage_color == "black" %}selected{% endif %}>‚ö´ Black - Expectant</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <select name="status" class="filter-select" id="status-select">
                <option value="">All Statuses</option>
                <option value="active" {% if filters.status == "active" %}selected{% endif %}>üü¢ Active</option>
                <option value="in_treatment" {% if filters.status == "in_treatment" %}selected{% endif %}>üîµ In Treatment</option>
                <option value="treated" {% if filters.status == "treated" %}selected{% endif %}>‚úÖ Treated</option>
                <option value="discharged" {% if filters.status == "discharged" %}selected{% endif %}>üì§ Discharged</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Severity</label>
              <select name="severity" class="filter-select" id="severity-select">
                <option value="">All Severities</option>
                <option value="critical" {% if filters.severity == "critical" %}selected{% endif %}>üö® Critical</option>
                <option value="severe" {% if filters.severity == "severe" %}selected{% endif %}>‚ö†Ô∏è Severe</option>
                <option value="moderate" {% if filters.severity == "moderate" %}selected{% endif %}>üü° Moderate</option>
                <option value="mild" {% if filters.severity == "mild" %}selected{% endif %}>üü¢ Mild</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Assigned Clinician</label>
              <select name="clinician" class="filter-select" id="clinician-select">
                <option value="">All Clinicians</option>
                <option value="dr_smith">Dr. Smith</option>
                <option value="dr_jones">Dr. Jones</option>
                <option value="nurse_garcia">Nurse Garcia</option>
                <option value="nurse_wilson">Nurse Wilson</option>
              </select>
            </div>
            
            <button type="button" class="clear-filters" id="clear-filters-btn">
              üóëÔ∏è Clear All Filters
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main Patient List -->
  <div class="patients-container">
    <div class="patients-header">
      <h2 class="patients-title">üë• Patient Management System</h2>
      <div class="header-actions">
        <div class="patients-count" id="patients-count">{{ patients|length }} patients</div>
        <button class="header-btn" id="refresh-btn">
          <span>üîÑ</span>
          <span>Refresh</span>
        </button>
        <button class="header-btn" id="add-patient-btn">
          <span>‚ûï</span>
          <span>Add Patient</span>
        </button>
      </div>
    </div>
    
    <!-- Table Controls -->
    <div class="table-controls">
      <div class="bulk-actions">
        <input type="checkbox" id="select-all" class="bulk-select">
        <label for="select-all" style="margin-right: 1rem; font-weight: 500;">Select All</label>
        <button class="bulk-btn btn-bulk" id="bulk-update-btn" disabled>
          üìù Update Selected
        </button>
        <button class="bulk-btn btn-export" id="export-btn">
          üì§ Export CSV
        </button>
        <button class="bulk-btn btn-print" id="print-btn">
          üñ®Ô∏è Print List
        </button>
      </div>
      
      <div class="view-toggles">
        <button class="bulk-btn" id="critical-toggle" data-view="critical">
          üö® Critical Only
        </button>
        <button class="bulk-btn" id="active-toggle" data-view="active">
          üü¢ Active Only
        </button>
      </div>
    </div>
    
    <div class="patients-list" id="patients-list">
      {% if patients %}
        <table class="patient-table" role="table" aria-label="Patient management table">
          <thead class="patient-header">
            <tr>
              <th><input type="checkbox" id="header-select"></th>
              <th class="sortable" data-sort="priority">Priority</th>
              <th class="sortable" data-sort="name">Patient Info</th>
              <th class="sortable" data-sort="triage">Triage</th>
              <th class="sortable" data-sort="complaint">Complaint & Symptoms</th>
              <th class="sortable" data-sort="clinician">Assigned Clinician</th>
              <th class="sortable" data-sort="vitals">Vitals</th>
              <th class="sortable" data-sort="status">Status</th>
              <th class="sortable" data-sort="time">Time</th>
              <th>Alerts</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="patient-table-body">
            {% for patient in patients %}
              <tr class="patient-row {% if patient.triage_color == 'red' %}critical{% endif %}" 
                  data-patient-id="{{ patient.id }}"
                  data-triage="{{ patient.triage_color }}"
                  data-status="{{ patient.status }}"
                  data-severity="{{ patient.severity }}"
                  tabindex="0"
                  role="button"
                  aria-label="Patient {{ patient.name }}, {{ patient.triage_color }} priority">
                
                <td>
                  <input type="checkbox" class="patient-select" value="{{ patient.id }}">
                </td>
                
                <td>
                  <div class="priority-indicator priority-{{ patient.priority_score }}">
                    {{ patient.priority_score }}
                  </div>
                </td>
                
                <td>
                  <div class="patient-info">
                    <div class="patient-name">{{ patient.name }}</div>
                    <div class="patient-id">ID: P{{ patient.id|string|zfill(4) }}</div>
                    {% if patient.age %}<div class="patient-age">Age: {{ patient.age }}</div>{% endif %}
                  </div>
                </td>
                
                <td>
                  <span class="triage-badge triage-{{ patient.triage_color }}">
                    {% if patient.triage_color == "red" %}üî¥ RED
                    {% elif patient.triage_color == "yellow" %}üü° YELLOW  
                    {% elif patient.triage_color == "green" %}üü¢ GREEN
                    {% elif patient.triage_color == "black" %}‚ö´ BLACK
                    {% endif %}
                  </span>
                </td>
                
                <td>
                  <div>
                    <div style="font-weight: 600;">{{ patient.injury_type }}</div>
                    {% if patient.symptoms %}
                      <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ patient.symptoms|truncate(50) }}
                      </div>
                    {% endif %}
                    <span class="severity-badge severity-{{ patient.severity }}" style="margin-top: 0.25rem; display: inline-block;">
                      {{ patient.severity|upper }}
                    </span>
                  </div>
                </td>
                
                <td>
                  <div class="clinician-info">
                    {% if patient.assigned_clinician %}
                      <div class="clinician-avatar">
                        {{ patient.assigned_clinician[:2]|upper }}
                      </div>
                      <div>
                        <div style="font-weight: 600; font-size: 0.9rem;">{{ patient.assigned_clinician|title }}</div>
                        <div style="font-size: 0.7rem; color: #6b7280;">{{ patient.clinician_role|default("Staff") }}</div>
                      </div>
                    {% else %}
                      <div style="color: #6b7280; font-style: italic;">Unassigned</div>
                    {% endif %}
                  </div>
                </td>
                
                <td>
                  <div class="vitals-display">
                    {% if patient.vitals %}
                      <div class="vital-item">
                        <span>HR:</span>
                        <span class="{% if patient.vitals.hr > 100 %}vitals-warning{% else %}vitals-normal{% endif %}">
                          {{ patient.vitals.hr|default("--") }}
                        </span>
                      </div>
                      <div class="vital-item">
                        <span>BP:</span>
                        <span class="vitals-normal">{{ patient.vitals.bp|default("--/--") }}</span>
                      </div>
                      <div class="vital-item">
                        <span>O‚ÇÇ:</span>
                        <span class="{% if patient.vitals.o2 < 95 %}vitals-critical{% else %}vitals-normal{% endif %}">
                          {{ patient.vitals.o2|default("--") }}%
                        </span>
                      </div>
                      <div class="vital-item">
                        <span>Temp:</span>
                        <span class="vitals-normal">{{ patient.vitals.temp|default("--") }}¬∞F</span>
                      </div>
                    {% else %}
                      <div style="color: #6b7280; font-style: italic;">No vitals</div>
                    {% endif %}
                  </div>
                </td>
                
                <td>
                  <span class="status-badge status-{{ patient.status }}">
                    {% if patient.status == "active" %}üü¢ Active
                    {% elif patient.status == "in_treatment" %}üîµ In Treatment
                    {% elif patient.status == "treated" %}‚úÖ Treated
                    {% elif patient.status == "discharged" %}üì§ Discharged
                    {% else %}{{ patient.status|title }}
                    {% endif %}
                  </span>
                  {% if patient.location %}
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">
                      üìç {{ patient.location }}
                    </div>
                  {% endif %}
                </td>
                
                <td>
                  <div class="patient-time">
                    <div>{{ patient.created_at.strftime('%m/%d') }}</div>
                    <div>{{ patient.created_at.strftime('%H:%M') }}</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">
                      {{ (now() - patient.created_at).total_seconds() // 3600 }}h ago
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="alert-indicators">
                    {% if patient.is_critical_vitals %}
                      <div class="alert-flag alert-critical">! CRITICAL</div>
                    {% endif %}
                    {% if patient.allergies %}
                      <div class="alert-flag alert-allergy">‚ö†Ô∏è ALLERGY</div>
                    {% endif %}
                    {% if patient.special_needs %}
                      <div class="alert-flag alert-special">üìã SPECIAL</div>
                    {% endif %}
                  </div>
                </td>
                
                <td>
                  <div class="patient-actions">
                    <button class="action-btn btn-view" data-patient-id="{{ patient.id }}" data-action="view" title="View Details">
                      <span>üëÅÔ∏è</span>
                    </button>
                    <button class="action-btn btn-edit" data-patient-id="{{ patient.id }}" data-action="edit" title="Edit Patient">
                      <span>‚úèÔ∏è</span>
                    </button>
                    {% if patient.assigned_clinician %}
                      <button class="action-btn btn-message" data-patient-id="{{ patient.id }}" data-clinician="{{ patient.assigned_clinician }}" data-action="message" title="Message Clinician">
                        <span>üí¨</span>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="no-patients">
          <div class="no-patients-icon">üë•</div>
          <h3>No Patients Found</h3>
          <p>No patients match your current filters or search criteria.</p>
          <a href="/triage" style="display: inline-block; margin-top: 1.5rem; padding: 1rem 2rem; background: #16a34a; color: white; text-decoration: none; border-radius: 12px; font-weight: 600;">
            ‚ûï Add First Patient
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Patient Detail Modal -->
<div class="modal" id="patient-detail-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-patient-name">Patient Details</h2>
      <button class="close-btn" id="close-detail-modal">&times;</button>
    </div>
    <div id="patient-detail-content">
      <div class="loading">
        <div class="spinner"></div>
        <span>Loading patient details...</span>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Update Modal -->
<div class="modal" id="bulk-update-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Bulk Update Patients</h2>
      <button class="close-btn" id="close-bulk-modal">&times;</button>
    </div>
    <div>
      <p style="margin-bottom: 1.5rem;">Update <span id="selected-count">0</span> selected patients:</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <label class="filter-label">Status</label>
          <select class="filter-select" id="bulk-status">
            <option value="">-- No Change --</option>
            <option value="active">Active</option>
            <option value="in_treatment">In Treatment</option>
            <option value="treated">Treated</option>
            <option value="discharged">Discharged</option>
          </select>
        </div>
        
        <div>
          <label class="filter-label">Assign Clinician</label>
          <select class="filter-select" id="bulk-clinician">
            <option value="">-- No Change --</option>
            <option value="dr_smith">Dr. Smith</option>
            <option value="dr_jones">Dr. Jones</option>
            <option value="nurse_garcia">Nurse Garcia</option>
            <option value="nurse_wilson">Nurse Wilson</option>
          </select>
        </div>
      </div>
      
      <div style="margin-top: 1rem;">
        <label class="filter-label">Location/Room</label>
        <input type="text" class="search-input" id="bulk-location" placeholder="Enter room or location">
      </div>
      
      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button class="bulk-btn" id="cancel-bulk-btn" style="flex: 1; background: #6b7280;">
          Cancel
        </button>
        <button class="bulk-btn btn-export" id="apply-bulk-btn" style="flex: 2;">
          Apply Updates
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ========================================
// PREVENT LINTER ERRORS - HTML NOT JSX
// ========================================

// Global variables
var selectedPatients = new Set();
var sortDirection = {};
var currentView = 'all';

// Patient Management System
var PatientManager = {
    // Initialize the system
    init: function() {
        this.bindEvents();
        this.updatePatientCounts();
        this.initializeKeyboardShortcuts();
        this.startAutoRefresh();
        this.showNotification('Patient management system loaded successfully', 'success');
    },

    // Bind all event listeners
    bindEvents: function() {
        var self = this;
        
        // Search functionality
        var searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                self.performSearch();
            });
        }

        // Filter dropdowns
        var filterSelects = document.querySelectorAll('.filter-select');
        filterSelects.forEach(function(select) {
            select.addEventListener('change', function() {
                self.applyFilters();
            });
        });

        // Clear filters button
        var clearBtn = document.getElementById('clear-filters-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                self.clearAllFilters();
            });
        }

        // Header buttons
        var refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                self.refreshPatientList();
            });
        }

        var addPatientBtn = document.getElementById('add-patient-btn');
        if (addPatientBtn) {
            addPatientBtn.addEventListener('click', function() {
                self.openAddPatient();
            });
        }

        // Table controls
        var selectAllBtn = document.getElementById('select-all');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('change', function() {
                self.toggleSelectAll();
            });
        }

        var headerSelect = document.getElementById('header-select');
        if (headerSelect) {
            headerSelect.addEventListener('change', function() {
                self.toggleSelectAll();
            });
        }

        var bulkUpdateBtn = document.getElementById('bulk-update-btn');
        if (bulkUpdateBtn) {
            bulkUpdateBtn.addEventListener('click', function() {
                self.bulkUpdateStatus();
            });
        }

        var exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                self.exportSelected();
            });
        }

        var printBtn = document.getElementById('print-btn');
        if (printBtn) {
            printBtn.addEventListener('click', function() {
                self.printPatientList();
            });
        }

        // View toggles
        var viewToggles = document.querySelectorAll('[data-view]');
        viewToggles.forEach(function(toggle) {
            toggle.addEventListener('click', function() {
                var view = this.getAttribute('data-view');
                self.toggleView(view);
            });
        });

        // Color stat filters
        var colorStats = document.querySelectorAll('[data-color]');
        colorStats.forEach(function(stat) {
            stat.addEventListener('click', function() {
                var color = this.getAttribute('data-color');
                self.filterByColor(color);
            });
        });

        // Patient row selection
        var patientSelects = document.querySelectorAll('.patient-select');
        patientSelects.forEach(function(checkbox) {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation();
                self.updateBulkActions();
            });
        });

        // Patient row clicks
        var patientRows = document.querySelectorAll('.patient-row');
        patientRows.forEach(function(row) {
            row.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox' && !e.target.closest('.patient-actions')) {
                    var patientId = this.getAttribute('data-patient-id');
                    self.openPatientDetail(patientId);
                }
            });
        });

        // Action buttons
        var actionBtns = document.querySelectorAll('.action-btn');
        actionBtns.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var action = this.getAttribute('data-action');
                var patientId = this.getAttribute('data-patient-id');
                var clinician = this.getAttribute('data-clinician');
                
                switch(action) {
                    case 'view':
                        self.openPatientDetail(patientId);
                        break;
                    case 'edit':
                        self.editPatient(patientId);
                        break;
                    case 'message':
                        self.messageClinician(clinician, patientId);
                        break;
                }
            });
        });

        // Modal close buttons
        var closeDetailBtn = document.getElementById('close-detail-modal');
        if (closeDetailBtn) {
            closeDetailBtn.addEventListener('click', function() {
                self.closeModal();
            });
        }

        var closeBulkBtn = document.getElementById('close-bulk-modal');
        if (closeBulkBtn) {
            closeBulkBtn.addEventListener('click', function() {
                self.closeBulkModal();
            });
        }

        // Bulk modal buttons
        var cancelBulkBtn = document.getElementById('cancel-bulk-btn');
        if (cancelBulkBtn) {
            cancelBulkBtn.addEventListener('click', function() {
                self.closeBulkModal();
            });
        }

        var applyBulkBtn = document.getElementById('apply-bulk-btn');
        if (applyBulkBtn) {
            applyBulkBtn.addEventListener('click', function() {
                self.applyBulkUpdate();
            });
        }

        // Sort headers
        var sortHeaders = document.querySelectorAll('.sortable');
        sortHeaders.forEach(function(header) {
            header.addEventListener('click', function() {
                var column = this.getAttribute('data-sort');
                self.sortTable(column);
            });
        });

        // Modal background clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                self.closeModal();
                self.closeBulkModal();
            }
        });
    },

    // Search functionality
    performSearch: function() {
        var searchTerm = document.getElementById('search-input').value.toLowerCase();
        var rows = document.querySelectorAll('.patient-row');
        var visibleCount = 0;
        
        rows.forEach(function(row) {
            var text = row.textContent.toLowerCase();
            var isVisible = text.indexOf(searchTerm) !== -1;
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        this.updatePatientCounts(visibleCount);
    },

    // Filter functions
    filterByColor: function(color) {
        var select = document.getElementById('triage-color-select');
        if (select) {
            select.value = color;
            this.applyFilters();
        }
    },

    applyFilters: function() {
        var form = document.getElementById('filter-form');
        if (form) {
            form.submit();
        }
    },

    clearAllFilters: function() {
        var form = document.getElementById('filter-form');
        if (form) {
            var selects = form.querySelectorAll('select');
            selects.forEach(function(select) {
                select.value = '';
            });
        }
        
        var searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.value = '';
        }
        
        this.applyFilters();
    },

    // Sort functionality
    sortTable: function(column) {
        var table = document.querySelector('.patient-table tbody');
        if (!table) return;
        
        var rows = Array.from(table.querySelectorAll('.patient-row'));
        var direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
        sortDirection[column] = direction;
        
        var self = this;
        rows.sort(function(a, b) {
            var aVal, bVal;
            
            switch(column) {
                case 'priority':
                    var aPriority = a.querySelector('.priority-indicator');
                    var bPriority = b.querySelector('.priority-indicator');
                    aVal = aPriority ? parseInt(aPriority.textContent) : 0;
                    bVal = bPriority ? parseInt(bPriority.textContent) : 0;
                    break;
                case 'name':
                    var aName = a.querySelector('.patient-name');
                    var bName = b.querySelector('.patient-name');
                    aVal = aName ? aName.textContent : '';
                    bVal = bName ? bName.textContent : '';
                    break;
                case 'time':
                    aVal = new Date(a.getAttribute('data-timestamp') || 0);
                    bVal = new Date(b.getAttribute('data-timestamp') || 0);
                    break;
                default:
                    var aElement = a.querySelector('[data-sort="' + column + '"]');
                    var bElement = b.querySelector('[data-sort="' + column + '"]');
                    aVal = aElement ? aElement.textContent : '';
                    bVal = bElement ? bElement.textContent : '';
            }
            
            if (direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        rows.forEach(function(row) {
            table.appendChild(row);
        });
        
        this.showNotification('Table sorted by ' + column + ' (' + direction + ')', 'info');
    },

    // Selection functions
    toggleSelectAll: function() {
        var selectAll = document.getElementById('select-all');
        var headerSelect = document.getElementById('header-select');
        var checkboxes = document.querySelectorAll('.patient-select');
        
        var isChecked = selectAll ? selectAll.checked : (headerSelect ? headerSelect.checked : false);
        
        checkboxes.forEach(function(cb) {
            cb.checked = isChecked;
            if (isChecked) {
                selectedPatients.add(cb.value);
            } else {
                selectedPatients.delete(cb.value);
            }
        });
        
        this.updateBulkActions();
    },

    updateBulkActions: function() {
        var checkboxes = document.querySelectorAll('.patient-select:checked');
        var bulkBtn = document.getElementById('bulk-update-btn');
        
        selectedPatients.clear();
        checkboxes.forEach(function(cb) {
            selectedPatients.add(cb.value);
        });
        
        if (bulkBtn) {
            bulkBtn.disabled = selectedPatients.size === 0;
            bulkBtn.textContent = selectedPatients.size > 0 ? 
                'üìù Update Selected (' + selectedPatients.size + ')' : 'üìù Update Selected';
        }
    },

    // View toggles
    toggleView: function(view) {
        var rows = document.querySelectorAll('.patient-row');
        currentView = currentView === view ? 'all' : view;
        
        rows.forEach(function(row) {
            var shouldShow = true;
            
            if (currentView === 'critical') {
                shouldShow = row.classList.contains('critical');
            } else if (currentView === 'active') {
                var statusBadge = row.querySelector('.status-badge');
                var status = statusBadge ? statusBadge.textContent.toLowerCase() : '';
                shouldShow = status.indexOf('active') !== -1 || status.indexOf('treatment') !== -1;
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
        
        // Update toggle button states
        var toggles = document.querySelectorAll('[data-view]');
        toggles.forEach(function(btn) {
            var btnView = btn.getAttribute('data-view');
            btn.style.background = btnView === currentView ? '#dc2626' : '#6b7280';
        });
        
        this.showNotification('Showing ' + currentView + ' patients', 'info');
    },

    // Patient detail functions
    openPatientDetail: function(patientId) {
        var modal = document.getElementById('patient-detail-modal');
        var content = document.getElementById('patient-detail-content');
        
        if (modal) {
            modal.style.display = 'block';
        }
        
        var self = this;
        setTimeout(function() {
            if (content) {
                content.innerHTML = self.generatePatientDetailHTML(patientId);
            }
        }, 500);
    },

    generatePatientDetailHTML: function(patientId) {
        var paddedId = patientId.toString();
        while (paddedId.length < 4) {
            paddedId = '0' + paddedId;
        }
        
        return '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">' +
            '<div>' +
                '<h3 style="margin-bottom: 1rem; color: #1f2937;">Basic Information</h3>' +
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">' +
                    '<p><strong>Patient ID:</strong> P' + paddedId + '</p>' +
                    '<p><strong>Name:</strong> John Doe</p>' +
                    '<p><strong>Age:</strong> 45</p>' +
                    '<p><strong>Gender:</strong> Male</p>' +
                    '<p><strong>Admission:</strong> 2h ago</p>' +
                '</div>' +
                '<h3 style="margin: 1.5rem 0 1rem; color: #1f2937;">Medical History</h3>' +
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">' +
                    '<p><strong>Allergies:</strong> Penicillin</p>' +
                    '<p><strong>Medications:</strong> Lisinopril, Metformin</p>' +
                    '<p><strong>Previous Conditions:</strong> Diabetes, Hypertension</p>' +
                '</div>' +
            '</div>' +
            '<div>' +
                '<h3 style="margin-bottom: 1rem; color: #1f2937;">Current Status</h3>' +
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">' +
                    '<p><strong>Triage:</strong> <span class="triage-badge triage-red">üî¥ RED</span></p>' +
                    '<p><strong>Complaint:</strong> Chest pain</p>' +
                    '<p><strong>Severity:</strong> Critical</p>' +
                    '<p><strong>Location:</strong> Room 203</p>' +
                    '<p><strong>Clinician:</strong> Dr. Smith</p>' +
                '</div>' +
                '<h3 style="margin: 1.5rem 0 1rem; color: #1f2937;">Vital Signs</h3>' +
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">' +
                        '<p><strong>Heart Rate:</strong> 95 bpm</p>' +
                        '<p><strong>Blood Pressure:</strong> 140/90</p>' +
                        '<p><strong>Oxygen:</strong> 92%</p>' +
                        '<p><strong>Temperature:</strong> 98.6¬∞F</p>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<div style="margin-top: 2rem;">' +
            '<h3 style="margin-bottom: 1rem; color: #1f2937;">Treatment Timeline</h3>' +
            '<div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">' +
                '<div style="border-left: 3px solid #3b82f6; padding-left: 1rem; margin-bottom: 1rem;">' +
                    '<strong>15:30</strong> - Patient admitted with chest pain' +
                '</div>' +
                '<div style="border-left: 3px solid #f59e0b; padding-left: 1rem; margin-bottom: 1rem;">' +
                    '<strong>15:45</strong> - EKG performed, abnormal results' +
                '</div>' +
                '<div style="border-left: 3px solid #16a34a; padding-left: 1rem;">' +
                    '<strong>16:00</strong> - Cardiology consulted' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb;">' +
            '<button class="bulk-btn btn-edit" data-patient-edit="' + patientId + '" style="flex: 1;">' +
                '‚úèÔ∏è Edit Patient' +
            '</button>' +
            '<button class="bulk-btn btn-export" data-patient-print="' + patientId + '" style="flex: 1;">' +
                'üñ®Ô∏è Print Details' +
            '</button>' +
            '<button class="bulk-btn btn-message" data-patient-message="' + patientId + '" style="flex: 1;">' +
                'üí¨ Message Team' +
            '</button>' +
        '</div>';
    },

    closeModal: function() {
        var modal = document.getElementById('patient-detail-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    },

    // Bulk operations
    bulkUpdateStatus: function() {
        if (selectedPatients.size === 0) {
            this.showNotification('Please select patients to update', 'warning');
            return;
        }
        
        var selectedCountSpan = document.getElementById('selected-count');
        if (selectedCountSpan) {
            selectedCountSpan.textContent = selectedPatients.size;
        }
        
        var modal = document.getElementById('bulk-update-modal');
        if (modal) {
            modal.style.display = 'block';
        }
    },

    closeBulkModal: function() {
        var modal = document.getElementById('bulk-update-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    },

    applyBulkUpdate: function() {
        var statusSelect = document.getElementById('bulk-status');
        var clinicianSelect = document.getElementById('bulk-clinician');
        var locationInput = document.getElementById('bulk-location');
        
        var status = statusSelect ? statusSelect.value : '';
        var clinician = clinicianSelect ? clinicianSelect.value : '';
        var location = locationInput ? locationInput.value : '';
        
        if (!status && !clinician && !location) {
            this.showNotification('Please select at least one field to update', 'warning');
            return;
        }
        
        this.showNotification('Updated ' + selectedPatients.size + ' patients successfully', 'success');
        this.closeBulkModal();
        
        selectedPatients.clear();
        var checkboxes = document.querySelectorAll('.patient-select');
        checkboxes.forEach(function(cb) {
            cb.checked = false;
        });
        this.updateBulkActions();
    },

    // Export functions
    exportSelected: function() {
        var patients = selectedPatients.size > 0 ? 
            Array.from(selectedPatients) : 
            Array.from(document.querySelectorAll('.patient-row')).map(function(row) {
                return row.getAttribute('data-patient-id');
            });
        
        this.showNotification('Exporting ' + patients.length + ' patients to CSV...', 'info');
        
        var self = this;
        setTimeout(function() {
            self.showNotification('Patient data exported successfully', 'success');
        }, 1000);
    },

    printPatientList: function() {
        window.print();
    },

    printPatientDetail: function(patientId) {
        var paddedId = patientId.toString();
        while (paddedId.length < 4) {
            paddedId = '0' + paddedId;
        }
        
        var printWindow = window.open('', '_blank');
        var content = document.getElementById('patient-detail-content');
        var contentHTML = content ? content.innerHTML : '';
        
        printWindow.document.write(
            '<html>' +
                '<head>' +
                    '<title>Patient Details - P' + paddedId + '</title>' +
                    '<style>' +
                        'body { font-family: Arial, sans-serif; padding: 20px; }' +
                        '.header { border-bottom: 2px solid #000; margin-bottom: 20px; }' +
                        '.section { margin-bottom: 20px; }' +
                        '.vital { display: inline-block; margin-right: 20px; }' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<div class="header">' +
                        '<h1>Patient Medical Record</h1>' +
                        '<p>Generated: ' + new Date().toLocaleString() + '</p>' +
                    '</div>' +
                    contentHTML +
                '</body>' +
            '</html>'
        );
        printWindow.document.close();
        printWindow.print();
    },

    // Utility functions
    editPatient: function(patientId) {
        this.showNotification('Opening edit form for patient ' + patientId + '...', 'info');
    },

    messageClinician: function(clinician, patientId) {
        this.showNotification('Opening message to ' + clinician + ' about patient ' + patientId, 'info');
    },

    refreshPatientList: function() {
        this.showNotification('Refreshing patient list...', 'info');
        var self = this;
        setTimeout(function() {
            location.reload();
        }, 500);
    },

    openAddPatient: function() {
        window.location.href = '/triage';
    },

    updatePatientCounts: function(visibleCount) {
        var total = document.querySelectorAll('.patient-row').length;
        var visible = visibleCount !== null && visibleCount !== undefined ? visibleCount : total;
        
        var countElement = document.getElementById('patients-count');
        if (countElement) {
            countElement.textContent = visible + ' patients';
            if (visible !== total) {
                countElement.textContent += ' (of ' + total + ')';
            }
        }
    },

    // Auto-refresh
    startAutoRefresh: function() {
        var self = this;
        setInterval(function() {
            if (document.visibilityState === 'visible' && selectedPatients.size === 0) {
                self.updateSyncStatus();
            }
        }, 30000);
    },

    updateSyncStatus: function() {
        var syncStatus = document.getElementById('sync-status');
        if (!syncStatus) return;
        
        var isOnline = Math.random() > 0.1;
        
        if (isOnline) {
            syncStatus.className = 'sync-status';
            syncStatus.innerHTML = 
                '<div class="sync-indicator"></div>' +
                '<div>' +
                    '<div style="font-weight: bold;">System Online</div>' +
                    '<div style="font-size: 0.8rem; opacity: 0.9;">Last sync: Just now</div>' +
                '</div>';
        } else {
            syncStatus.className = 'sync-status offline';
            syncStatus.innerHTML = 
                '<div class="sync-indicator"></div>' +
                '<div>' +
                    '<div style="font-weight: bold;">Offline Mode</div>' +
                    '<div style="font-size: 0.8rem; opacity: 0.9;">Will sync when online</div>' +
                '</div>';
        }
    },

    // Keyboard shortcuts
    initializeKeyboardShortcuts: function() {
        var self = this;
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch(e.key.toLowerCase()) {
                case 'f':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        var searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }
                    break;
                case 'a':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        self.toggleSelectAll();
                    }
                    break;
                case 'r':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        self.refreshPatientList();
                    }
                    break;
                case 'escape':
                    self.closeModal();
                    self.closeBulkModal();
                    break;
            }
        });
    },

    // Notification system
    showNotification: function(message, type) {
        type = type || 'info';
        
        var notification = document.createElement('div');
        var bgColor = '#3b82f6'; // default info color
        
        if (type === 'success') bgColor = '#16a34a';
        else if (type === 'warning') bgColor = '#f59e0b';
        else if (type === 'error') bgColor = '#dc2626';
        
        notification.style.cssText = 
            'position: fixed;' +
            'top: 20px;' +
            'right: 20px;' +
            'background: ' + bgColor + ';' +
            'color: white;' +
            'padding: 1rem 1.5rem;' +
            'border-radius: 8px;' +
            'z-index: 10000;' +
            'font-weight: 500;' +
            'box-shadow: 0 10px 25px rgba(0,0,0,0.1);' +
            'animation: slideIn 0.3s ease;';
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(function() {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    PatientManager.init();
    console.log('üè• Enhanced Patient Management System Loaded');
    console.log('Features: Search, Filter, Sort, Bulk Operations, Real-time Updates');
    console.log('Keyboard Shortcuts: Ctrl+F (Search), Ctrl+A (Select All), Ctrl+R (Refresh), Esc (Close)');
});

</script>
{% endblock %}

{% block ai_status %}
<div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-top: 2rem; text-align: center;">
  <div style="font-weight: bold; margin-bottom: 0.5rem; font-size: 1.1rem;">üè• Advanced Patient Management System</div>
  <div style="font-size: 0.9rem; opacity: 0.9; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
    <span>üìä Real-time Updates</span>
    <span>üîç Advanced Search & Filters</span>
    <span>üì§ Bulk Operations</span>
    <span>üìã Comprehensive Records</span>
    <span>‚å®Ô∏è Keyboard Shortcuts</span>
    <span>üñ®Ô∏è Print Ready</span>
  </div>
  <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
    <strong>üöÄ Professional Clinical Interface</strong><br>
    <span style="font-size: 0.85rem;">Designed for rapid patient assessment, comprehensive record management, and seamless clinical workflow integration</span>
  </div>
</div>
{% endblock %}

</body>
</html>