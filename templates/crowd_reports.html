<!-- templates/crowd_reports.html -->
{% extends "base.html" %}

{% block title %}Crowd Reports Viewer - Disaster Response Assistant{% endblock %}
{% block page_title %}üìã Crowd Reports Viewer{% endblock %}
{% block subtitle %}Real-time Community Emergency Reports{% endblock %}

{% block header_actions %}
<a href="/" style="display: inline-block; margin-top: 1rem; padding: 0.5rem 1rem; background-color: #1e40af; color: #fff; border-radius: 6px; text-decoration: none;">
  ‚¨ÖÔ∏è Back to Home
</a>
{% endblock %}

{% block extra_styles %}
<style>
  .crowd-report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  
  .crowd-report-table th,
  .crowd-report-table td {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    text-align: left;
    vertical-align: top;
  }
  
  .crowd-report-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .crowd-report-table tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }
  
  .crowd-report-table tbody tr:hover {
    background-color: #f3f4f6;
  }
  
  .priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .priority-critical { 
    background: #dc2626; 
    animation: pulse 2s infinite;
  }
  .priority-urgent { background: #f59e0b; }
  .priority-medium { background: #3b82f6; }
  .priority-low { background: #10b981; }
  
  .report-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #3b82f6;
  }
  
  .stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #1e40af;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    color: #6b7280;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .message-preview {
    max-width: 300px;
    word-wrap: break-word;
    line-height: 1.4;
  }
  
  .media-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: #f3f4f6;
    border-radius: 4px;
    text-decoration: none;
    color: #374151;
    font-size: 0.8rem;
    transition: background-color 0.2s;
  }
  
  .media-link:hover {
    background: #e5e7eb;
  }
  
  .audio-player {
    width: 120px;
    height: 30px;
  }
  
  .timestamp {
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    color: #6b7280;
  }
  
  .user-badge {
    background: #e0e7ff;
    color: #3730a3;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
  }
  
  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .refresh-button {
    background: #16a34a;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
    margin-left: 1rem;
  }
  
  .refresh-button:hover {
    background: #15803d;
  }
  
  .filters {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .filter-select {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  
  @media (max-width: 768px) {
    .crowd-report-table {
      font-size: 0.8rem;
    }
    
    .crowd-report-table th,
    .crowd-report-table td {
      padding: 0.5rem;
    }
    
    .message-preview {
      max-width: 200px;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="report-stats">
  <div class="stat-card">
    <div class="stat-number">{{ reports|length }}</div>
    <div class="stat-label">Total Reports</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ reports|selectattr('priority', 'equalto', 'critical')|list|length }}</div>
    <div class="stat-label">Critical Alerts</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ reports|selectattr('image_path')|list|length }}</div>
    <div class="stat-label">With Images</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ reports|selectattr('audio_path')|list|length }}</div>
    <div class="stat-label">With Audio</div>
  </div>
</div>

<!-- Filters -->
<form method="get" class="filters">
  <label for="tone">Tone:</label>
  <select name="tone" id="tone" class="filter-select">
    <option value="">All Tones</option>
    <option value="Calm" {% if tone == 'Calm' %}selected{% endif %}>Calm</option>
    <option value="Urgent" {% if tone == 'Urgent' %}selected{% endif %}>Urgent</option>
    <option value="Panic" {% if tone == 'Panic' %}selected{% endif %}>Panic</option>
  </select>

  <label for="escalation">Escalation:</label>
  <select name="escalation" id="escalation" class="filter-select">
    <option value="">All Levels</option>
    <option value="Low" {% if escalation == 'Low' %}selected{% endif %}>Low</option>
    <option value="Medium" {% if escalation == 'Medium' %}selected{% endif %}>Medium</option>
    <option value="High" {% if escalation == 'High' %}selected{% endif %}>High</option>
  </select>

  <input type="text" name="keyword" placeholder="Search messages..." value="{{ keyword or '' }}" class="filter-select" />

  <button type="submit" class="refresh-button">üîç Filter</button>
  <a href="/crowd-reports" class="refresh-button" style="background:#6b7280">‚ôªÔ∏è Reset</a>
</form>

<form method="post" action="/export-reports/pdf" target="_blank" style="margin-top: 0.5rem;">
  <input type="hidden" name="tone" value="{{ tone or '' }}">
  <input type="hidden" name="escalation" value="{{ escalation or '' }}">
  <input type="hidden" name="keyword" value="{{ keyword or '' }}">
  <button type="submit" class="refresh-button" style="background: #1e3a8a;">
    üìÑ Export as PDF
  </button>
</form>

<div class="export-buttons" style="margin-top: 0.5rem;">
  <a href="/export-reports.csv?tone={{ tone }}&escalation={{ escalation }}&keyword={{ keyword }}" class="refresh-button" style="background: #6d28d9;">
    üì§ Export CSV
  </a>
  <a href="/export-reports.json?tone={{ tone }}&escalation={{ escalation }}&keyword={{ keyword }}" class="refresh-button" style="background: #334155;">
    üßæ Export JSON
  </a>
</div>

{% if reports %}
<div style="overflow-x: auto;">
  <table class="crowd-report-table" id="reportsTable">
    <thead>
      <tr>
        <th>üìÑ Message</th>
        <th>üéØ Priority</th>
        <th>üìÜ Timestamp</th>
        <th>üßë User</th>
        <th>üñºÔ∏è Image</th>
        <th>üîä Audio</th>
      </tr>
    </thead>
    <tbody>
      {% for report in reports %}
      <tr data-priority="{{ report.priority }}" data-has-image="{{ 'true' if report.image_path else 'false' }}" data-has-audio="{{ 'true' if report.audio_path else 'false' }}">
        <td>
          <div class="message-preview">
            {{ report.message or '‚Äî' }}
          </div>
        </td>
        <td>
          <span class="priority-badge priority-{{ report.priority }}">
            {% if report.priority == 'critical' %}üö®{% elif report.priority == 'urgent' %}‚ö†Ô∏è{% elif report.priority == 'medium' %}üìä{% else %}üìù{% endif %}
            {{ report.priority.capitalize() }}
          </span>
        </td>
        <td>
          <div class="timestamp">
            {{ report.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
          </div>
        </td>
        <td>
          <span class="user-badge">
            üë§ {{ report.user or 'Anonymous' }}
          </span>
        </td>
        <td>
          {% if report.image_path %}
            <a href="{{ report.image_path }}" target="_blank" class="media-link">
              üñºÔ∏è View Image
            </a>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>
          {% if report.audio_path %}
            <audio controls src="{{ report.audio_path }}" class="audio-player"></audio>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="empty-state">
  <div class="empty-state-icon">üì≠</div>
  <h3>No Reports Yet</h3>
  <p>When community members submit emergency reports, they'll appear here.</p>
  <a href="/" style="display: inline-block; margin-top: 1rem; padding: 0.5rem 1rem; background-color: #1e40af; color: #fff; border-radius: 6px; text-decoration: none;">
    üìù Submit First Report
  </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Real-time filtering functionality
document.addEventListener('DOMContentLoaded', function() {
  const priorityFilter = document.getElementById('priorityFilter');
  const mediaFilter = document.getElementById('mediaFilter');
  const table = document.getElementById('reportsTable');
  
  function filterReports() {
    const selectedPriority = priorityFilter.value;
    const selectedMedia = mediaFilter.value;
    const rows = table ? table.querySelectorAll('tbody tr') : [];
    
    rows.forEach(row => {
      const priority = row.dataset.priority;
      const hasImage = row.dataset.hasImage === 'true';
      const hasAudio = row.dataset.hasAudio === 'true';
      
      let showRow = true;
      
      // Priority filter
      if (selectedPriority && priority !== selectedPriority) {
        showRow = false;
      }
      
      // Media filter
      if (selectedMedia) {
        switch (selectedMedia) {
          case 'image':
            if (!hasImage) showRow = false;
            break;
          case 'audio':
            if (!hasAudio) showRow = false;
            break;
          case 'media':
            if (!hasImage && !hasAudio) showRow = false;
            break;
        }
      }
      
      row.style.display = showRow ? '' : 'none';
    });
  }
  
  if (priorityFilter) priorityFilter.addEventListener('change', filterReports);
  if (mediaFilter) mediaFilter.addEventListener('change', filterReports);
  
  // Auto-refresh every 30 seconds
  setInterval(() => {
    if (navigator.onLine) {
      location.reload();
    }
  }, 30000);
});

// Print functionality
function printReports() {
  window.print();
}

// Export functionality (if needed)
function exportReports() {
  const reports = Array.from(document.querySelectorAll('#reportsTable tbody tr')).map(row => {
    const cells = row.querySelectorAll('td');
    return {
      message: cells[0].textContent.trim(),
      priority: cells[1].textContent.trim(),
      timestamp: cells[2].textContent.trim(),
      user: cells[3].textContent.trim(),
      hasImage: cells[4].textContent.trim() !== '‚Äî',
      hasAudio: cells[5].textContent.trim() !== '‚Äî'
    };
  });
  
  const dataStr = JSON.stringify(reports, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `crowd-reports-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
}
</script>
{% endblock %}

<!-- No AI status needed for this page -->
{% block ai_status %}{% endblock %}
