<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Analytics Dashboard - AI-Powered Emergency Intelligence</title>
    
    <!-- Enhanced CSS Variables and Base Styles -->
    <style>
        :root {
            /* Light theme variables */
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --bg-color-main: #ffffff;
            --bg-color-card: #f8fafc;
            --bg-color-light: #f1f5f9;
            --text-color-base: #1f2937;
            --text-color-light: #6b7280;
            --text-color-dark: #111827;
            --text-color-inverted: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Status colors */
            --color-optimal: #10b981;
            --color-good: #f59e0b;
            --color-warning: #ef4444;
            --color-critical: #dc2626;
            
            /* Prediction confidence colors */
            --confidence-high: #10b981;
            --confidence-medium: #f59e0b;
            --confidence-low: #ef4444;
        }

        [data-theme="dark"] {
            --bg-color-main: #111827;
            --bg-color-card: #1f2937;
            --bg-color-light: #374151;
            --text-color-base: #f9fafb;
            --text-color-light: #d1d5db;
            --text-color-dark: #ffffff;
            --border-color: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color-main);
            color: var(--text-color-base);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: var(--text-color-inverted);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .header-title {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--text-color-inverted);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .forecast-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .summary-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .summary-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: var(--bg-color-card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-controls {
            display: flex;
            gap: 0.5rem;
        }

        .filter-button {
            background: var(--bg-color-light);
            border: 1px solid var(--border-color);
            color: var(--text-color-base);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-button.active {
            background: var(--primary-color);
            color: var(--text-color-inverted);
            border-color: var(--primary-color);
        }

        .filter-button:hover:not(.active) {
            background: var(--bg-color-main);
        }

        .chart-container {
            height: 400px;
            background: var(--bg-color-light);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .surge-prediction {
            display: grid;
            gap: 1rem;
        }

        .surge-item {
            background: var(--bg-color-light);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .surge-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .surge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .surge-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-color-base);
        }

        .confidence-badge {
            background: var(--confidence-high);
            color: var(--text-color-inverted);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .confidence-medium { background: var(--confidence-medium); }
        .confidence-low { background: var(--confidence-low); }

        .surge-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .detail-metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-color-light);
        }

        .scenario-tools {
            grid-column: 1 / -1;
            background: var(--bg-color-card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .scenario-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .scenario-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color-main);
            color: var(--text-color-base);
            font-size: 0.9rem;
        }

        .scenario-button {
            background: var(--primary-color);
            color: var(--text-color-inverted);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .scenario-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .scenario-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .result-card {
            background: var(--bg-color-light);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .alerts-panel {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-radius: 16px;
            padding: 2rem;
            color: #92400e;
            margin-bottom: 2rem;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .alert-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .alert-actions {
            display: flex;
            gap: 0.5rem;
        }

        .alert-action {
            background: #92400e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .alert-action:hover {
            background: #78350f;
        }

        .navigation-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-color-card);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
        }

        .nav-button {
            background: var(--bg-color-light);
            border: 1px solid var(--border-color);
            color: var(--text-color-base);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: var(--primary-color);
            color: var(--text-color-inverted);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .export-panel {
            grid-column: 1 / -1;
            background: var(--bg-color-card);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .export-button {
            background: var(--color-optimal);
            color: var(--text-color-inverted);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin: 1rem 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--text-color-inverted);
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: var(--shadow-md);
        }

        .heat-level-0 { background: #e5e7eb; color: var(--text-color-base); }
        .heat-level-1 { background: #fef3c7; color: #92400e; }
        .heat-level-2 { background: #fed7aa; color: #9a3412; }
        .heat-level-3 { background: #fca5a5; color: #991b1b; }
        .heat-level-4 { background: #f87171; }
        .heat-level-5 { background: #dc2626; }

        .trend-up { color: var(--color-optimal); }
        .trend-down { color: var(--color-critical); }
        .trend-stable { color: var(--color-good); }

        /* Scenario Settings Modal Styles */
        .scenario-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .scenario-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .scenario-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 600px;
            height: 100vh;
            background: var(--bg-color-main);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            z-index: 1001;
        }

        .scenario-modal.active {
            transform: translateX(0);
        }

        .scenario-modal-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .scenario-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scenario-modal-subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .scenario-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .scenario-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .scenario-modal-content {
            padding: 2rem;
        }

        .scenario-section {
            margin-bottom: 2rem;
            background: var(--bg-color-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .scenario-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color-base);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scenario-form-group {
            margin-bottom: 1.5rem;
        }

        .scenario-form-group:last-child {
            margin-bottom: 0;
        }

        .scenario-label {
            display: block;
            font-weight: 600;
            color: var(--text-color-base);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .scenario-input,
        .scenario-select,
        .scenario-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color-main);
            color: var(--text-color-base);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .scenario-input:focus,
        .scenario-select:focus,
        .scenario-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .scenario-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .scenario-slider-container {
            margin: 1rem 0;
        }

        .scenario-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-color-light);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .scenario-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .scenario-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .scenario-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-color-light);
            margin-top: 0.5rem;
        }

        .scenario-slider-value {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .scenario-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .scenario-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-color-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-checkbox-item:hover {
            background: var(--bg-color-card);
        }

        .scenario-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        .scenario-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .scenario-preset {
            background: var(--bg-color-light);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .scenario-preset:hover,
        .scenario-preset.selected {
            border-color: var(--primary-color);
            background: rgba(139, 92, 246, 0.1);
        }

        .scenario-preset-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--text-color-base);
        }

        .scenario-preset-desc {
            font-size: 0.8rem;
            color: var(--text-color-light);
        }

        .scenario-results-preview {
            background: var(--bg-color-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .scenario-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .scenario-result-metric {
            text-align: center;
            padding: 1rem;
            background: var(--bg-color-main);
            border-radius: 8px;
        }

        .scenario-result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .scenario-result-label {
            font-size: 0.8rem;
            color: var(--text-color-light);
            margin-top: 0.25rem;
        }

        .scenario-modal-actions {
            background: var(--bg-color-card);
            padding: 1.5rem 2rem;
            position: sticky;
            bottom: 0;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .scenario-action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .scenario-action-btn.secondary {
            background: var(--bg-color-light);
            color: var(--text-color-base);
            border: 1px solid var(--border-color);
        }

        .scenario-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-color-dark);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .forecast-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .scenario-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .navigation-bar {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }

            .scenario-modal {
                width: 100%;
                right: 0;
            }

            .scenario-preset-grid,
            .scenario-checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .critical-alert {
            animation: pulse-alert 2s infinite;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header with Forecast Summary -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="header-title">🔮 Predictive Analytics Command Center</h1>
                <div class="header-controls">
                    <button class="control-button" onclick="toggleTheme()">🌓 Theme</button>
                    <button class="control-button" onclick="refreshData()">🔄 Refresh</button>
                    <button class="control-button" onclick="exportReport()">📊 Export</button>
                </div>
            </div>
            
            <div class="forecast-summary" id="forecastSummary">
                <div class="summary-card">
                    <div class="summary-value" id="nextSurgeTime">4.2h</div>
                    <div class="summary-label">Next Predicted Surge</div>
                    <div class="summary-trend trend-up">↗ High Confidence</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="resourceShortfall">3</div>
                    <div class="summary-label">Resource Shortfalls (24h)</div>
                    <div class="summary-trend trend-down">↘ Manageable</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="hotspotCount">7</div>
                    <div class="summary-label">Active Hotspots</div>
                    <div class="summary-trend trend-stable">→ Monitoring</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="confidenceScore">94%</div>
                    <div class="summary-label">Model Confidence</div>
                    <div class="summary-trend trend-up">↗ +2% vs yesterday</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="main-grid">
            <!-- Surge Prediction & Trends Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">📈 Surge Predictions & Trends</h2>
                    <div class="panel-controls">
                        <button class="filter-button active" onclick="setTimeHorizon('1h')">1H</button>
                        <button class="filter-button" onclick="setTimeHorizon('4h')">4H</button>
                        <button class="filter-button" onclick="setTimeHorizon('24h')">24H</button>
                        <button class="filter-button" onclick="setTimeHorizon('72h')">72H</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas class="chart-canvas" id="surgeChart"></canvas>
                </div>
                
                <!-- 24-Hour Heatmap -->
                <h3 style="margin: 1rem 0 0.5rem 0;">24-Hour Activity Heatmap</h3>
                <div class="heatmap-grid" id="activityHeatmap"></div>
            </div>

            <!-- Resource Demand & Alerts Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">⚠️ Resource Demands & Alerts</h2>
                </div>
                
                <div class="surge-prediction" id="resourceAlerts">
                    <div class="surge-item critical-alert">
                        <div class="surge-header">
                            <div class="surge-title">🚨 ER Bed Shortage</div>
                            <div class="confidence-badge confidence-high">96%</div>
                        </div>
                        <p>Critical shortage predicted in 6 hours</p>
                        <div class="surge-details">
                            <div class="detail-metric">
                                <div class="metric-value">15</div>
                                <div class="metric-label">Beds Short</div>
                            </div>
                            <div class="detail-metric">
                                <div class="metric-value">18:00</div>
                                <div class="metric-label">Peak Time</div>
                            </div>
                        </div>
                    </div>

                    <div class="surge-item">
                        <div class="surge-header">
                            <div class="surge-title">🚑 EMS Surge - North Sector</div>
                            <div class="confidence-badge confidence-medium">84%</div>
                        </div>
                        <p>Traffic incident cluster expected during rush hour</p>
                        <div class="surge-details">
                            <div class="detail-metric">
                                <div class="metric-value">+40%</div>
                                <div class="metric-label">Call Volume</div>
                            </div>
                            <div class="detail-metric">
                                <div class="metric-value">17:30</div>
                                <div class="metric-label">Start Time</div>
                            </div>
                        </div>
                    </div>

                    <div class="surge-item">
                        <div class="surge-header">
                            <div class="surge-title">🔥 Fire Risk Elevation</div>
                            <div class="confidence-badge confidence-high">92%</div>
                        </div>
                        <p>Weather conditions increase fire probability</p>
                        <div class="surge-details">
                            <div class="detail-metric">
                                <div class="metric-value">High</div>
                                <div class="metric-label">Risk Level</div>
                            </div>
                            <div class="detail-metric">
                                <div class="metric-value">14:00</div>
                                <div class="metric-label">Peak Risk</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scenario Simulation Tools -->
        <div class="scenario-tools">
            <div class="scenario-header">
                <h2 class="panel-title">🎯 Scenario Simulation & What-If Analysis</h2>
                <div class="scenario-controls">
                    <select class="scenario-input" id="scenarioType">
                        <option value="surge">Patient Surge</option>
                        <option value="disaster">Natural Disaster</option>
                        <option value="pandemic">Pandemic Wave</option>
                        <option value="staffing">Staff Shortage</option>
                    </select>
                    <input type="number" class="scenario-input" id="scenarioMagnitude" placeholder="Magnitude %" value="150">
                    <button class="scenario-button" onclick="runScenario()">🔄 Run Simulation</button>
                    <button class="scenario-button" onclick="resetScenario()">↺ Reset</button>
                </div>
            </div>

            <div class="scenario-results" id="scenarioResults">
                <div class="result-card">
                    <h3>📊 Impact Assessment</h3>
                    <div class="detail-metric">
                        <div class="metric-value" id="impactBeds">+25</div>
                        <div class="metric-label">Additional Beds Needed</div>
                    </div>
                </div>
                <div class="result-card">
                    <h3>⏱️ Timeline</h3>
                    <div class="detail-metric">
                        <div class="metric-value" id="impactDuration">4-6h</div>
                        <div class="metric-label">Expected Duration</div>
                    </div>
                </div>
                <div class="result-card">
                    <h3>👥 Staffing Impact</h3>
                    <div class="detail-metric">
                        <div class="metric-value" id="impactStaff">+12</div>
                        <div class="metric-label">Additional Staff Needed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations & Alerts -->
        <div class="alerts-panel">
            <h2 style="margin-bottom: 1rem; color: #92400e;">🤖 AI Recommendations & Critical Alerts</h2>
            
            <div class="alert-item">
                <div class="alert-content">
                    <div class="alert-title">Immediate: Reassign Ambulance Units</div>
                    <div class="alert-description">Deploy 2 additional ambulances to North Sector by 17:00 to prevent response delays</div>
                </div>
                <div class="alert-actions">
                    <button class="alert-action" onclick="implementRecommendation('ambulance-deploy')">Deploy</button>
                    <button class="alert-action" onclick="viewDetails('ambulance-analysis')">Details</button>
                </div>
            </div>

            <div class="alert-item">
                <div class="alert-content">
                    <div class="alert-title">Planning: Night Shift Reinforcement</div>
                    <div class="alert-description">Medical surge predicted - request 4 additional nurses for tonight's shift</div>
                </div>
                <div class="alert-actions">
                    <button class="alert-action" onclick="implementRecommendation('staff-request')">Request</button>
                    <button class="alert-action" onclick="scheduleAlert('night-shift')">Schedule</button>
                </div>
            </div>

            <div class="alert-item">
                <div class="alert-content">
                    <div class="alert-title">Anomaly: Unusual Pediatric Pattern</div>
                    <div class="alert-description">Statistical outlier detected in District 3 - investigate potential cause</div>
                </div>
                <div class="alert-actions">
                    <button class="alert-action" onclick="investigate('pediatric-anomaly')">Investigate</button>
                    <button class="alert-action" onclick="alertStaff('district-3')">Alert Staff</button>
                </div>
            </div>
        </div>

        <!-- Data Export & Sharing -->
        <div class="export-panel">
            <h2>📄 Data Export & Executive Briefing</h2>
            <p>Generate reports and summaries for stakeholders and decision makers</p>
            <div class="export-buttons">
                <button class="export-button" onclick="generateExecutiveBrief()">
                    📋 Executive Brief
                </button>
                <button class="export-button" onclick="exportData('csv')">
                    📊 Export CSV Data
                </button>
                <button class="export-button" onclick="exportData('pdf')">
                    📄 PDF Report
                </button>
                <button class="export-button" onclick="shareAnalysis()">
                    📤 Share Analysis
                </button>
            </div>
        </div>

        <!-- Navigation Shortcuts -->
        <div class="navigation-bar">
            <a href="/crisis-command-center" class="nav-button">
                🎯 Command Center
            </a>
            <a href="/map-reports" class="nav-button">
                🗺️ Map Reports
            </a>
            <a href="/real-time-resource-optimizer" class="nav-button">
                ⚙️ Resource Optimizer
            </a>
            <a href="/report-archive" class="nav-button">
                📚 Historical Archive
            </a>
            <button class="nav-button" onclick="openScenarioSettings()">
                🔧 Scenario Settings
            </button>
        </div>
    </div>

    <!-- Scenario Settings Modal -->
    <div class="scenario-modal-overlay" id="scenarioModalOverlay" onclick="closeScenarioSettings()">
        <div class="scenario-modal" id="scenarioModal" onclick="event.stopPropagation()">
            <div class="scenario-modal-header">
                <h2 class="scenario-modal-title">🔧 Scenario Settings & Configuration</h2>
                <p class="scenario-modal-subtitle">Configure and simulate crisis scenarios for predictive planning</p>
                <button class="scenario-close-btn" onclick="closeScenarioSettings()">×</button>
            </div>

            <div class="scenario-modal-content">
                <!-- Quick Presets Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">⚡ Quick Preset Templates</h3>
                    <div class="scenario-preset-grid">
                        <div class="scenario-preset" onclick="selectPreset('storm-surge')">
                            <div class="scenario-preset-title">🌪️ Storm Surge</div>
                            <div class="scenario-preset-desc">Major weather event with flooding and power outages</div>
                        </div>
                        <div class="scenario-preset" onclick="selectPreset('mass-casualty')">
                            <div class="scenario-preset-title">🚨 Mass Casualty</div>
                            <div class="scenario-preset-desc">Large-scale incident requiring immediate surge response</div>
                        </div>
                        <div class="scenario-preset" onclick="selectPreset('pandemic-wave')">
                            <div class="scenario-preset-title">🦠 Pandemic Wave</div>
                            <div class="scenario-preset-desc">Infectious disease surge with isolation requirements</div>
                        </div>
                        <div class="scenario-preset" onclick="selectPreset('cyber-attack')">
                            <div class="scenario-preset-title">💻 Cyber Attack</div>
                            <div class="scenario-preset-desc">IT system disruption affecting operations</div>
                        </div>
                        <div class="scenario-preset" onclick="selectPreset('staff-shortage')">
                            <div class="scenario-preset-title">👥 Staff Shortage</div>
                            <div class="scenario-preset-desc">Critical staffing deficit during peak demand</div>
                        </div>
                        <div class="scenario-preset" onclick="selectPreset('custom')">
                            <div class="scenario-preset-title">🎯 Custom Scenario</div>
                            <div class="scenario-preset-desc">Build your own scenario from scratch</div>
                        </div>
                    </div>
                </div>

                <!-- Scenario Parameters Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">📋 Scenario Parameters</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Scenario Name</label>
                        <input type="text" class="scenario-input" id="scenarioName" placeholder="Enter scenario name for reference">
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Description</label>
                        <textarea class="scenario-textarea" id="scenarioDescription" placeholder="Detailed description of the scenario conditions and assumptions"></textarea>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Scenario Type</label>
                        <select class="scenario-select" id="scenarioTypeDetailed">
                            <option value="mass-casualty">Mass Casualty Event</option>
                            <option value="severe-weather">Severe Weather Emergency</option>
                            <option value="outbreak">Disease Outbreak</option>
                            <option value="resource-shortage">Resource Shortage</option>
                            <option value="infrastructure">Infrastructure Failure</option>
                            <option value="cyber-security">Cyber Security Incident</option>
                            <option value="chemical-hazmat">Chemical/HAZMAT Incident</option>
                            <option value="custom">Custom Scenario</option>
                        </select>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Time Window <span class="tooltip" data-tooltip="Duration of the scenario simulation">ℹ️</span></label>
                        <select class="scenario-select" id="timeWindow">
                            <option value="6h">Next 6 Hours</option>
                            <option value="12h">Next 12 Hours</option>
                            <option value="24h" selected>Next 24 Hours</option>
                            <option value="48h">Next 48 Hours</option>
                            <option value="72h">Next 3 Days</option>
                            <option value="1w">Next Week</option>
                        </select>
                    </div>
                </div>

                <!-- Event Frequency & Intensity Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">📊 Event Frequency & Intensity</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Incident Rate Increase <span class="scenario-slider-value" id="incidentRateValue">+50%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="incidentRate" min="0" max="300" value="50" oninput="updateSliderValue('incidentRate', this.value)">
                            <div class="scenario-slider-labels">
                                <span>Baseline</span>
                                <span>+100%</span>
                                <span>+200%</span>
                                <span>+300%</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Severity Distribution <span class="scenario-slider-value" id="severityValue">Moderate</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="severity" min="1" max="5" value="3" oninput="updateSeverityValue(this.value)">
                            <div class="scenario-slider-labels">
                                <span>Minor</span>
                                <span>Moderate</span>
                                <span>Major</span>
                                <span>Critical</span>
                                <span>Catastrophic</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Event Frequency Pattern</label>
                        <select class="scenario-select" id="frequencyPattern">
                            <option value="constant">Constant Rate</option>
                            <option value="peak-hours">Peak During Rush Hours</option>
                            <option value="random-bursts">Random Burst Events</option>
                            <option value="escalating">Escalating Over Time</option>
                            <option value="de-escalating">De-escalating Over Time</option>
                        </select>
                    </div>
                </div>

                <!-- Location & Region Filters Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">📍 Location & Region Filters</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Affected Regions</label>
                        <div class="scenario-checkbox-group">
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="north-sector" checked>
                                <span>North Sector</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="south-sector">
                                <span>South Sector</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="east-sector">
                                <span>East Sector</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="west-sector">
                                <span>West Sector</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="downtown">
                                <span>Downtown Core</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="suburbs">
                                <span>Suburban Areas</span>
                            </label>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Hospital/Facility Focus</label>
                        <div class="scenario-checkbox-group">
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="general-hospital" checked>
                                <span>General Hospital</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="trauma-center">
                                <span>Trauma Center</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="pediatric-hospital">
                                <span>Pediatric Hospital</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="specialty-clinics">
                                <span>Specialty Clinics</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Resource Variables Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">🏥 Resource Variables</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Available Beds <span class="scenario-slider-value" id="bedsValue">85%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="availableBeds" min="0" max="100" value="85" oninput="updateSliderValue('beds', this.value)">
                            <div class="scenario-slider-labels">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Staff Availability <span class="scenario-slider-value" id="staffValue">90%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="staffAvailability" min="0" max="100" value="90" oninput="updateSliderValue('staff', this.value)">
                            <div class="scenario-slider-labels">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Vehicle Fleet <span class="scenario-slider-value" id="vehicleValue">80%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="vehicleFleet" min="0" max="100" value="80" oninput="updateSliderValue('vehicle', this.value)">
                            <div class="scenario-slider-labels">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Supply Levels <span class="scenario-slider-value" id="supplyValue">75%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="supplyLevels" min="0" max="100" value="75" oninput="updateSliderValue('supply', this.value)">
                            <div class="scenario-slider-labels">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- External Factors Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">🌡️ External Factors & Modifiers</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Weather Impact</label>
                        <select class="scenario-select" id="weatherImpact">
                            <option value="none">Normal Conditions</option>
                            <option value="minor">Minor Weather Impact</option>
                            <option value="moderate">Moderate Storm</option>
                            <option value="severe">Severe Weather Event</option>
                            <option value="extreme">Extreme Weather Emergency</option>
                        </select>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Infrastructure Status</label>
                        <div class="scenario-checkbox-group">
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="power-outage">
                                <span>Power Outages</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="comm-disruption">
                                <span>Communication Disruption</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="transport-issues">
                                <span>Transportation Issues</span>
                            </label>
                            <label class="scenario-checkbox-item">
                                <input type="checkbox" class="scenario-checkbox" value="water-shortage">
                                <span>Water System Problems</span>
                            </label>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Population Factors</label>
                        <select class="scenario-select" id="populationFactors">
                            <option value="normal">Normal Population Density</option>
                            <option value="event">Special Event (Increased Population)</option>
                            <option value="evacuation">Evacuation in Progress</option>
                            <option value="shelter">Mass Sheltering Active</option>
                        </select>
                    </div>
                </div>

                <!-- Simulation Controls Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">⚙️ Simulation Controls</h3>
                    
                    <div class="scenario-form-group">
                        <label class="scenario-label">Model Selection</label>
                        <select class="scenario-select" id="modelSelection">
                            <option value="default">Default Predictive Model</option>
                            <option value="accelerated">Accelerated Timeline Model</option>
                            <option value="detailed">High Detail Analysis</option>
                            <option value="worst-case">Worst Case Scenario</option>
                            <option value="monte-carlo">Monte Carlo Simulation</option>
                        </select>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Confidence Level <span class="scenario-slider-value" id="confidenceValue">95%</span></label>
                        <div class="scenario-slider-container">
                            <input type="range" class="scenario-slider" id="confidenceLevel" min="80" max="99" value="95" oninput="updateSliderValue('confidence', this.value)">
                            <div class="scenario-slider-labels">
                                <span>80%</span>
                                <span>90%</span>
                                <span>95%</span>
                                <span>99%</span>
                            </div>
                        </div>
                    </div>

                    <div class="scenario-form-group">
                        <label class="scenario-label">Baseline Comparison</label>
                        <select class="scenario-select" id="baselineComparison">
                            <option value="current">Current Conditions</option>
                            <option value="historical">Historical Average</option>
                            <option value="seasonal">Seasonal Baseline</option>
                            <option value="saved-scenario">Saved Scenario</option>
                        </select>
                    </div>
                </div>

                <!-- Results Preview Section -->
                <div class="scenario-section">
                    <h3 class="scenario-section-title">📊 Results Preview</h3>
                    <div class="scenario-results-preview">
                        <p>Run simulation to see projected outcomes and resource impacts</p>
                        <div class="scenario-results-grid" id="previewResults" style="display: none;">
                            <div class="scenario-result-metric">
                                <div class="scenario-result-value" id="previewBeds">+45</div>
                                <div class="scenario-result-label">Additional Beds Needed</div>
                            </div>
                            <div class="scenario-result-metric">
                                <div class="scenario-result-value" id="previewStaff">+28</div>
                                <div class="scenario-result-label">Additional Staff Required</div>
                            </div>
                            <div class="scenario-result-metric">
                                <div class="scenario-result-value" id="previewVehicles">+8</div>
                                <div class="scenario-result-label">Additional Vehicles</div>
                            </div>
                            <div class="scenario-result-metric">
                                <div class="scenario-result-value" id="previewDuration">12-18h</div>
                                <div class="scenario-result-label">Expected Duration</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="scenario-modal-actions">
                <button class="scenario-action-btn secondary" onclick="resetScenarioSettings()">Reset</button>
                <button class="scenario-action-btn secondary" onclick="saveScenario()">Save Scenario</button>
                <button class="scenario-action-btn primary" onclick="runAdvancedScenario()">Run Simulation</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Predictive Analytics Engine
        class EnhancedPredictiveAnalytics {
            constructor() {
                this.currentTimeHorizon = '4h';
                this.lastUpdate = new Date();
                this.updateInterval = null;
                this.chartContext = null;
                
                // Enhanced data structures
                this.forecastData = {
                    '1h': this.generateHourlyData(1),
                    '4h': this.generateHourlyData(4),
                    '24h': this.generateHourlyData(24),
                    '72h': this.generateHourlyData(72)
                };
                
                this.surgeMetrics = {
                    nextSurgeTime: 4.2,
                    resourceShortfall: 3,
                    hotspotCount: 7,
                    confidenceScore: 94
                };
                
                this.scenarios = {
                    surge: { baseImpact: 1.5, duration: '4-6h', staffMultiplier: 1.3 },
                    disaster: { baseImpact: 3.0, duration: '12-48h', staffMultiplier: 2.5 },
                    pandemic: { baseImpact: 2.2, duration: '2-8w', staffMultiplier: 1.8 },
                    staffing: { baseImpact: 0.8, duration: '1-3d', staffMultiplier: 0.7 }
                };

                this.scenarioPresets = {
                    'storm-surge': {
                        name: 'Major Storm Surge Response',
                        type: 'severe-weather',
                        description: 'Category 3+ storm with flooding, power outages, and infrastructure damage',
                        incidentRate: 180,
                        severity: 4,
                        resources: { beds: 60, staff: 70, vehicles: 50, supplies: 40 },
                        factors: ['power-outage', 'comm-disruption', 'transport-issues']
                    },
                    'mass-casualty': {
                        name: 'Mass Casualty Incident',
                        type: 'mass-casualty',
                        description: 'Large-scale incident requiring immediate surge capacity activation',
                        incidentRate: 250,
                        severity: 5,
                        resources: { beds: 30, staff: 50, vehicles: 60, supplies: 70 },
                        factors: []
                    },
                    'pandemic-wave': {
                        name: 'Pandemic Surge Wave',
                        type: 'outbreak',
                        description: 'Infectious disease surge requiring isolation and specialized care',
                        incidentRate: 120,
                        severity: 3,
                        resources: { beds: 40, staff: 60, vehicles: 85, supplies: 30 },
                        factors: ['comm-disruption']
                    },
                    'cyber-attack': {
                        name: 'Cyber Security Incident',
                        type: 'cyber-security',
                        description: 'IT systems compromised affecting hospital operations',
                        incidentRate: 80,
                        severity: 2,
                        resources: { beds: 90, staff: 80, vehicles: 95, supplies: 85 },
                        factors: ['comm-disruption']
                    },
                    'staff-shortage': {
                        name: 'Critical Staff Shortage',
                        type: 'resource-shortage',
                        description: 'Significant staffing deficit during peak demand period',
                        incidentRate: 110,
                        severity: 3,
                        resources: { beds: 85, staff: 40, vehicles: 90, supplies: 90 },
                        factors: []
                    }
                };
                
                this.init();
            }

            init() {
                this.initializeCharts();
                this.generateHeatmap();
                this.updateDashboard();
                this.startRealTimeUpdates();
                console.log('🔮 Enhanced Predictive Analytics initialized');
            }

            generateHourlyData(hours) {
                const data = [];
                const now = new Date();
                for (let i = 0; i < hours; i++) {
                    const time = new Date(now.getTime() + i * 60 * 60 * 1000);
                    const baseLoad = 50 + Math.sin(i * 0.5) * 20;
                    const surge = Math.random() > 0.7 ? Math.random() * 40 : 0;
                    data.push({
                        time: time,
                        predicted: Math.max(0, baseLoad + surge + (Math.random() - 0.5) * 10),
                        confidence: 85 + Math.random() * 15,
                        capacity: 100
                    });
                }
                return data;
            }

            initializeCharts() {
                const canvas = document.getElementById('surgeChart');
                if (!canvas) return;
                
                this.chartContext = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                this.drawSurgeChart();
            }

            drawSurgeChart() {
                if (!this.chartContext) return;
                
                const ctx = this.chartContext;
                const canvas = ctx.canvas;
                const width = canvas.width;
                const height = canvas.height;
                
                ctx.clearRect(0, 0, width, height);
                
                // Draw background
                ctx.fillStyle = '#f8fafc';
                ctx.fillRect(0, 0, width, height);
                
                // Draw grid
                this.drawGrid(ctx, width, height);
                
                // Draw capacity line
                this.drawCapacityLine(ctx, width, height);
                
                // Draw prediction data
                this.drawPredictionLine(ctx, width, height);
                
                // Draw surge indicators
                this.drawSurgeIndicators(ctx, width, height);
                
                // Draw legend
                this.drawLegend(ctx, width, height);
            }

            drawGrid(ctx, width, height) {
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                
                // Vertical lines (time intervals)
                const data = this.forecastData[this.currentTimeHorizon];
                const timeStep = width / Math.max(data.length - 1, 1);
                
                for (let i = 0; i < data.length; i++) {
                    const x = i * timeStep;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                    
                    // Time labels
                    if (i % Math.ceil(data.length / 6) === 0) {
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '10px sans-serif';
                        const timeLabel = this.formatTimeLabel(data[i].time);
                        ctx.fillText(timeLabel, x + 2, height - 5);
                    }
                }
                
                // Horizontal lines (capacity levels)
                for (let i = 0; i <= 5; i++) {
                    const y = (height / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                    
                    // Capacity labels
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '10px sans-serif';
                    const capacity = Math.round(120 - (i * 24));
                    ctx.fillText(`${capacity}%`, 5, y + 12);
                }
            }

            drawCapacityLine(ctx, width, height) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                
                const capacityY = height * 0.2; // 100% capacity line
                ctx.beginPath();
                ctx.moveTo(0, capacityY);
                ctx.lineTo(width, capacityY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Capacity label
                ctx.fillStyle = '#dc2626';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText('100% Capacity', width - 100, capacityY - 5);
            }

            drawPredictionLine(ctx, width, height) {
                const data = this.forecastData[this.currentTimeHorizon];
                const timeStep = width / Math.max(data.length - 1, 1);
                
                // Confidence area
                ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
                ctx.beginPath();
                data.forEach((point, i) => {
                    const x = i * timeStep;
                    const y = height - (point.predicted / 120) * height;
                    const confidenceMargin = (100 - point.confidence) / 100 * 30;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y - confidenceMargin);
                    } else {
                        ctx.lineTo(x, y - confidenceMargin);
                    }
                });
                
                for (let i = data.length - 1; i >= 0; i--) {
                    const x = i * timeStep;
                    const y = height - (data[i].predicted / 120) * height;
                    const confidenceMargin = (100 - data[i].confidence) / 100 * 30;
                    ctx.lineTo(x, y + confidenceMargin);
                }
                ctx.closePath();
                ctx.fill();
                
                // Main prediction line
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                data.forEach((point, i) => {
                    const x = i * timeStep;
                    const y = height - (point.predicted / 120) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Data points
                ctx.fillStyle = '#8b5cf6';
                data.forEach((point, i) => {
                    const x = i * timeStep;
                    const y = height - (point.predicted / 120) * height;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }

            drawSurgeIndicators(ctx, width, height) {
                const data = this.forecastData[this.currentTimeHorizon];
                const timeStep = width / Math.max(data.length - 1, 1);
                
                data.forEach((point, i) => {
                    if (point.predicted > 100) { // Surge indicator
                        const x = i * timeStep;
                        const y = height - (point.predicted / 120) * height;
                        
                        // Surge warning triangle
                        ctx.fillStyle = '#ef4444';
                        ctx.beginPath();
                        ctx.moveTo(x, y - 10);
                        ctx.lineTo(x - 6, y + 2);
                        ctx.lineTo(x + 6, y + 2);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Warning symbol
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 8px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('!', x, y - 2);
                        ctx.textAlign = 'left';
                    }
                });
            }

            drawLegend(ctx, width, height) {
                const legendItems = [
                    { color: '#8b5cf6', label: 'Predicted Demand', type: 'line' },
                    { color: '#dc2626', label: '100% Capacity', type: 'dashed' },
                    { color: '#ef4444', label: 'Surge Alert', type: 'triangle' },
                    { color: 'rgba(139, 92, 246, 0.1)', label: 'Confidence Range', type: 'area' }
                ];
                
                const legendX = 20;
                let legendY = 30;
                
                legendItems.forEach((item, i) => {
                    const y = legendY + (i * 20);
                    
                    if (item.type === 'line') {
                        ctx.strokeStyle = item.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(legendX, y);
                        ctx.lineTo(legendX + 15, y);
                        ctx.stroke();
                    } else if (item.type === 'dashed') {
                        ctx.strokeStyle = item.color;
                        ctx.lineWidth = 2;
                        ctx.setLineDash([3, 3]);
                        ctx.beginPath();
                        ctx.moveTo(legendX, y);
                        ctx.lineTo(legendX + 15, y);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    } else if (item.type === 'triangle') {
                        ctx.fillStyle = item.color;
                        ctx.beginPath();
                        ctx.moveTo(legendX + 7, y - 5);
                        ctx.lineTo(legendX + 2, y + 3);
                        ctx.lineTo(legendX + 12, y + 3);
                        ctx.closePath();
                        ctx.fill();
                    } else if (item.type === 'area') {
                        ctx.fillStyle = item.color;
                        ctx.fillRect(legendX, y - 3, 15, 6);
                    }
                    
                    ctx.fillStyle = '#374151';
                    ctx.font = '11px sans-serif';
                    ctx.fillText(item.label, legendX + 20, y + 3);
                });
            }

            generateHeatmap() {
                const heatmapContainer = document.getElementById('activityHeatmap');
                if (!heatmapContainer) return;
                
                heatmapContainer.innerHTML = '';
                
                for (let hour = 0; hour < 24; hour++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    // Generate activity level (0-5)
                    let activityLevel = 0;
                    if (hour >= 6 && hour <= 9) activityLevel = 3; // Morning rush
                    else if (hour >= 17 && hour <= 20) activityLevel = 4; // Evening rush
                    else if (hour >= 10 && hour <= 16) activityLevel = 2; // Day activity
                    else if (hour >= 21 && hour <= 23) activityLevel = 1; // Evening
                    else activityLevel = 0; // Night
                    
                    // Add some randomness
                    activityLevel += Math.floor(Math.random() * 2);
                    activityLevel = Math.min(5, Math.max(0, activityLevel));
                    
                    cell.classList.add(`heat-level-${activityLevel}`);
                    cell.textContent = hour.toString().padStart(2, '0');
                    cell.title = `${hour}:00 - Activity Level: ${activityLevel}/5`;
                    
                    cell.addEventListener('click', () => {
                        this.showHourDetails(hour, activityLevel);
                    });
                    
                    heatmapContainer.appendChild(cell);
                }
            }

            updateDashboard() {
                // Update forecast summary
                document.getElementById('nextSurgeTime').textContent = `${this.surgeMetrics.nextSurgeTime.toFixed(1)}h`;
                document.getElementById('resourceShortfall').textContent = this.surgeMetrics.resourceShortfall;
                document.getElementById('hotspotCount').textContent = this.surgeMetrics.hotspotCount;
                document.getElementById('confidenceScore').textContent = `${this.surgeMetrics.confidenceScore.toFixed(0)}%`;
                
                // Simulate some data updates
                this.surgeMetrics.nextSurgeTime += (Math.random() - 0.5) * 0.2;
                this.surgeMetrics.resourceShortfall += Math.floor((Math.random() - 0.5) * 2);
                this.surgeMetrics.hotspotCount += Math.floor((Math.random() - 0.5) * 2);
                this.surgeMetrics.confidenceScore += (Math.random() - 0.5) * 2;
                
                // Keep values in reasonable ranges
                this.surgeMetrics.nextSurgeTime = Math.max(0.5, Math.min(72, this.surgeMetrics.nextSurgeTime));
                this.surgeMetrics.resourceShortfall = Math.max(0, Math.min(10, this.surgeMetrics.resourceShortfall));
                this.surgeMetrics.hotspotCount = Math.max(0, Math.min(15, this.surgeMetrics.hotspotCount));
                this.surgeMetrics.confidenceScore = Math.max(75, Math.min(99, this.surgeMetrics.confidenceScore));
            }

            startRealTimeUpdates() {
                this.updateInterval = setInterval(() => {
                    this.updateDashboard();
                    this.updateForecastData();
                    this.drawSurgeChart();
                }, 15000); // Update every 15 seconds
            }

            updateForecastData() {
                // Shift data and add new predictions
                Object.keys(this.forecastData).forEach(timeHorizon => {
                    const data = this.forecastData[timeHorizon];
                    const hours = parseInt(timeHorizon);
                    
                    // Remove first element and add new one at the end
                    data.shift();
                    const lastTime = data[data.length - 1].time;
                    const newTime = new Date(lastTime.getTime() + 60 * 60 * 1000);
                    
                    const baseLoad = 50 + Math.sin(data.length * 0.5) * 20;
                    const surge = Math.random() > 0.8 ? Math.random() * 40 : 0;
                    
                    data.push({
                        time: newTime,
                        predicted: Math.max(0, baseLoad + surge + (Math.random() - 0.5) * 10),
                        confidence: 85 + Math.random() * 15,
                        capacity: 100
                    });
                });
            }

            formatTimeLabel(date) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            showHourDetails(hour, activityLevel) {
                const activityTypes = ['Very Low', 'Low', 'Moderate', 'High', 'Very High', 'Critical'];
                alert(`Hour ${hour}:00 Activity Details\n\nActivity Level: ${activityTypes[activityLevel]}\nPredicted Incidents: ${3 + activityLevel * 2}\nResource Utilization: ${20 + activityLevel * 15}%\nRecommendation: ${activityLevel > 3 ? 'Increase staffing' : 'Standard operations'}`);
            }
        }

        // Scenario Settings Functions
        function openScenarioSettings() {
            document.getElementById('scenarioModalOverlay').classList.add('active');
            document.getElementById('scenarioModal').classList.add('active');
        }

        function closeScenarioSettings() {
            document.getElementById('scenarioModalOverlay').classList.remove('active');
            document.getElementById('scenarioModal').classList.remove('active');
        }

        function selectPreset(presetId) {
            // Remove previous selections
            document.querySelectorAll('.scenario-preset').forEach(preset => {
                preset.classList.remove('selected');
            });
            
            // Select current preset
            event.target.closest('.scenario-preset').classList.add('selected');
            
            // Load preset data if available
            if (analytics.scenarioPresets[presetId]) {
                const preset = analytics.scenarioPresets[presetId];
                document.getElementById('scenarioName').value = preset.name;
                document.getElementById('scenarioDescription').value = preset.description;
                document.getElementById('scenarioTypeDetailed').value = preset.type;
                document.getElementById('incidentRate').value = preset.incidentRate;
                document.getElementById('severity').value = preset.severity;
                
                // Update resource sliders
                document.getElementById('availableBeds').value = preset.resources.beds;
                document.getElementById('staffAvailability').value = preset.resources.staff;
                document.getElementById('vehicleFleet').value = preset.resources.vehicles;
                document.getElementById('supplyLevels').value = preset.resources.supplies;
                
                // Update all slider values
                updateSliderValue('incidentRate', preset.incidentRate);
                updateSeverityValue(preset.severity);
                updateSliderValue('beds', preset.resources.beds);
                updateSliderValue('staff', preset.resources.staff);
                updateSliderValue('vehicle', preset.resources.vehicles);
                updateSliderValue('supply', preset.resources.supplies);
                
                // Check appropriate infrastructure factors
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = preset.factors.includes(checkbox.value);
                });
            }
        }

        function updateSliderValue(type, value) {
            const valueMap = {
                'incidentRate': `+${value}%`,
                'beds': `${value}%`,
                'staff': `${value}%`,
                'vehicle': `${value}%`,
                'supply': `${value}%`,
                'confidence': `${value}%`
            };
            
            const element = document.getElementById(`${type}Value`);
            if (element) {
                element.textContent = valueMap[type] || `${value}%`;
            }
        }

        function updateSeverityValue(value) {
            const severityMap = {
                1: 'Minor',
                2: 'Low',
                3: 'Moderate',
                4: 'Major',
                5: 'Critical'
            };
            document.getElementById('severityValue').textContent = severityMap[value] || 'Moderate';
        }

        function runAdvancedScenario() {
            // Collect all form data
            const scenarioData = {
                name: document.getElementById('scenarioName').value,
                description: document.getElementById('scenarioDescription').value,
                type: document.getElementById('scenarioTypeDetailed').value,
                timeWindow: document.getElementById('timeWindow').value,
                incidentRate: document.getElementById('incidentRate').value,
                severity: document.getElementById('severity').value,
                frequencyPattern: document.getElementById('frequencyPattern').value,
                weatherImpact: document.getElementById('weatherImpact').value,
                populationFactors: document.getElementById('populationFactors').value,
                modelSelection: document.getElementById('modelSelection').value,
                confidenceLevel: document.getElementById('confidenceLevel').value,
                baselineComparison: document.getElementById('baselineComparison').value,
                resources: {
                    beds: document.getElementById('availableBeds').value,
                    staff: document.getElementById('staffAvailability').value,
                    vehicles: document.getElementById('vehicleFleet').value,
                    supplies: document.getElementById('supplyLevels').value
                }
            };
            
            // Calculate impacts based on scenario data
            const baseImpact = parseInt(scenarioData.incidentRate) / 100;
            const severityMultiplier = parseInt(scenarioData.severity) / 3;
            const resourceConstraint = Math.min(
                scenarioData.resources.beds,
                scenarioData.resources.staff,
                scenarioData.resources.vehicles,
                scenarioData.resources.supplies
            ) / 100;
            
            const bedsNeeded = Math.round(25 * baseImpact * severityMultiplier / resourceConstraint);
            const staffNeeded = Math.round(15 * baseImpact * severityMultiplier);
            const vehiclesNeeded = Math.round(5 * baseImpact * severityMultiplier);
            
            // Duration calculation
            const durationHours = Math.round(6 + (baseImpact * severityMultiplier * 8));
            const duration = durationHours > 24 ? `${Math.round(durationHours/24)}d` : `${durationHours}h`;
            
            // Update preview results
            document.getElementById('previewBeds').textContent = `+${bedsNeeded}`;
            document.getElementById('previewStaff').textContent = `+${staffNeeded}`;
            document.getElementById('previewVehicles').textContent = `+${vehiclesNeeded}`;
            document.getElementById('previewDuration').textContent = duration;
            
            // Show results
            document.getElementById('previewResults').style.display = 'grid';
            
            // Update main dashboard scenario results
            document.getElementById('impactBeds').textContent = `+${bedsNeeded}`;
            document.getElementById('impactStaff').textContent = `+${staffNeeded}`;
            document.getElementById('impactDuration').textContent = duration;
            
            console.log('Advanced scenario simulation completed:', scenarioData);
            
            // Show success message
            alert(`Scenario "${scenarioData.name}" simulation completed!\n\nKey Results:\n• Additional beds needed: ${bedsNeeded}\n• Additional staff required: ${staffNeeded}\n• Expected duration: ${duration}\n\nResults have been applied to the main dashboard.`);
        }

        function saveScenario() {
            const scenarioName = document.getElementById('scenarioName').value || 'Unnamed Scenario';
            const savedScenarios = JSON.parse(localStorage.getItem('savedScenarios') || '[]');
            
            const scenarioData = {
                id: Date.now(),
                name: scenarioName,
                description: document.getElementById('scenarioDescription').value,
                type: document.getElementById('scenarioTypeDetailed').value,
                savedAt: new Date().toISOString(),
                // Include all other scenario parameters
            };
            
            savedScenarios.push(scenarioData);
            localStorage.setItem('savedScenarios', JSON.stringify(savedScenarios));
            
            alert(`Scenario "${scenarioName}" saved successfully!`);
        }

        function resetScenarioSettings() {
            // Reset all form fields to defaults
            document.getElementById('scenarioName').value = '';
            document.getElementById('scenarioDescription').value = '';
            document.getElementById('scenarioTypeDetailed').value = 'mass-casualty';
            document.getElementById('timeWindow').value = '24h';
            document.getElementById('incidentRate').value = '50';
            document.getElementById('severity').value = '3';
            document.getElementById('frequencyPattern').value = 'constant';
            document.getElementById('weatherImpact').value = 'none';
            document.getElementById('populationFactors').value = 'normal';
            document.getElementById('modelSelection').value = 'default';
            document.getElementById('confidenceLevel').value = '95';
            document.getElementById('baselineComparison').value = 'current';
            
            // Reset resource sliders
            document.getElementById('availableBeds').value = '85';
            document.getElementById('staffAvailability').value = '90';
            document.getElementById('vehicleFleet').value = '80';
            document.getElementById('supplyLevels').value = '75';
            
            // Update slider displays
            updateSliderValue('incidentRate', 50);
            updateSeverityValue(3);
            updateSliderValue('beds', 85);
            updateSliderValue('staff', 90);
            updateSliderValue('vehicle', 80);
            updateSliderValue('supply', 75);
            updateSliderValue('confidence', 95);
            
            // Uncheck all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Remove preset selections
            document.querySelectorAll('.scenario-preset').forEach(preset => {
                preset.classList.remove('selected');
            });
            
            // Hide results
            document.getElementById('previewResults').style.display = 'none';
        }

        // Global functions for UI interactions
        function setTimeHorizon(horizon) {
            analytics.currentTimeHorizon = horizon;
            
            // Update active button
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            analytics.drawSurgeChart();
            console.log(`Time horizon set to: ${horizon}`);
        }

        function runScenario() {
            const scenarioType = document.getElementById('scenarioType').value;
            const magnitude = document.getElementById('scenarioMagnitude').value;
            
            const scenario = analytics.scenarios[scenarioType];
            const impactMultiplier = (magnitude / 100) * scenario.baseImpact;
            
            // Calculate impacts
            const bedsNeeded = Math.round(25 * impactMultiplier);
            const staffNeeded = Math.round(12 * scenario.staffMultiplier * impactMultiplier);
            
            // Update results
            document.getElementById('impactBeds').textContent = `+${bedsNeeded}`;
            document.getElementById('impactDuration').textContent = scenario.duration;
            document.getElementById('impactStaff').textContent = `+${staffNeeded}`;
            
            console.log(`Scenario simulation: ${scenarioType} at ${magnitude}% magnitude`);
        }

        function resetScenario() {
            document.getElementById('scenarioMagnitude').value = '150';
            document.getElementById('impactBeds').textContent = '+25';
            document.getElementById('impactDuration').textContent = '4-6h';
            document.getElementById('impactStaff').textContent = '+12';
        }

        function implementRecommendation(type) {
            const recommendations = {
                'ambulance-deploy': 'Ambulance deployment order sent to dispatch. ETA to North Sector: 15 minutes.',
                'staff-request': 'Staff request submitted to HR. Additional nurses will be contacted for night shift.',
            };
            
            alert(`Action Implemented\n\n${recommendations[type] || 'Recommendation has been processed.'}`);
        }

        function investigate(type) {
            const investigations = {
                'pediatric-anomaly': 'Investigation initiated. Alerts sent to District 3 supervisors and epidemiology team.'
            };
            
            alert(`Investigation Started\n\n${investigations[type] || 'Investigation team has been notified.'}`);
        }

        function alertStaff(location) {
            alert(`Staff Alert Sent\n\nAll relevant personnel in ${location} have been notified of the anomaly and asked to monitor for unusual patterns.`);
        }

        function scheduleAlert(type) {
            alert(`Alert Scheduled\n\nAutomatic reminder set for ${type}. Relevant staff will be notified 2 hours before shift change.`);
        }

        function viewDetails(type) {
            alert(`Detailed Analysis\n\nOpening detailed analysis view for ${type}. This would typically open a specialized dashboard with comprehensive data.`);
        }

        function generateExecutiveBrief() {
            const briefContent = `EXECUTIVE BRIEF - PREDICTIVE ANALYTICS SUMMARY
Generated: ${new Date().toLocaleString()}

KEY METRICS:
• Next Predicted Surge: ${analytics.surgeMetrics.nextSurgeTime.toFixed(1)} hours
• Resource Shortfalls (24h): ${analytics.surgeMetrics.resourceShortfall}
• Active Hotspots: ${analytics.surgeMetrics.hotspotCount}
• Model Confidence: ${analytics.surgeMetrics.confidenceScore.toFixed(0)}%

CRITICAL ALERTS:
• ER bed shortage predicted in 6 hours (96% confidence)
• EMS surge expected in North Sector during rush hour (84% confidence)
• Fire risk elevation due to weather conditions (92% confidence)

IMMEDIATE ACTIONS REQUIRED:
• Deploy 2 additional ambulances to North Sector by 17:00
• Request 4 additional nurses for night shift
• Investigate pediatric anomaly in District 3

RESOURCE RECOMMENDATIONS:
• Increase ER capacity preparation
• Pre-position fire units in high-risk areas
• Activate backup staffing protocols

This brief provides decision-makers with essential information for proactive emergency management.`;

            // Create downloadable file
            const blob = new Blob([briefContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `executive-brief-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('Executive brief generated and downloaded');
        }

        function exportData(format) {
            if (format === 'csv') {
                const csvData = `Time,Predicted_Demand,Confidence,Capacity\n` +
                    analytics.forecastData[analytics.currentTimeHorizon]
                        .map(d => `${d.time.toISOString()},${d.predicted.toFixed(1)},${d.confidence.toFixed(1)},${d.capacity}`)
                        .join('\n');
                
                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `predictive-data-${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                alert('PDF Export\n\nPDF generation would be implemented here using a library like jsPDF to create comprehensive reports with charts and analysis.');
            }
        }

        function shareAnalysis() {
            if (navigator.share) {
                navigator.share({
                    title: 'Predictive Analytics Report',
                    text: `Current surge prediction: ${analytics.surgeMetrics.nextSurgeTime.toFixed(1)}h, Confidence: ${analytics.surgeMetrics.confidenceScore.toFixed(0)}%`,
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                const shareText = `Predictive Analytics Summary:\nNext surge: ${analytics.surgeMetrics.nextSurgeTime.toFixed(1)}h\nConfidence: ${analytics.surgeMetrics.confidenceScore.toFixed(0)}%\nActive hotspots: ${analytics.surgeMetrics.hotspotCount}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Analysis summary copied to clipboard!');
                });
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            
            // Redraw charts with new theme
            if (analytics && analytics.chartContext) {
                analytics.drawSurgeChart();
            }
        }

        function refreshData() {
            if (analytics) {
                analytics.updateForecastData();
                analytics.updateDashboard();
                analytics.drawSurgeChart();
                analytics.generateHeatmap();
            }
            console.log('Data refreshed');
        }

        function exportReport() {
            generateExecutiveBrief();
        }

        // Initialize the enhanced analytics system
        let analytics;
        document.addEventListener('DOMContentLoaded', () => {
            analytics = new EnhancedPredictiveAnalytics();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (analytics && analytics.updateInterval) {
                clearInterval(analytics.updateInterval);
            }
        });
    </script>
</body>
</html>