<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìÑ Crowd Reports Viewer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f8f9fa;
    }
    h1 {
      color: #333;
    }
    .controls {
      margin-bottom: 1.5rem;
    }
    label {
      margin-right: 0.5rem;
    }
    select, input {
      margin-right: 1rem;
      padding: 4px 6px;
    }
    #report-count {
      margin-top: -10px;
      margin-bottom: 1rem;
      font-style: italic;
      color: #666;
    }
    .report-card {
      background: #fff;
      border-left: 6px solid #ccc;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
      transition: transform 0.2s ease;
    }
    .report-card:hover {
      transform: scale(1.01);
    }
    .badge {
      font-weight: bold;
      padding: 3px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    .badge.Critical { background: #ff4d4f; color: white; }
    .badge.High { background: #fa8c16; color: white; }
    .badge.Moderate { background: #faad14; color: white; }
    .badge.Low { background: #52c41a; color: white; }
    .badge.Urgent { background: #f5222d; color: white; }
    .badge.Helpless { background: #722ed1; color: white; }
    mark {
      background-color: yellow;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üìÑ Crowd Reports Viewer</h1>

  <div class="controls">
    <label for="tone-filter">Tone:</label>
    <select id="tone-filter">
      <option value="">All</option>
      <option value="Urgent">Urgent</option>
      <option value="Frantic">Frantic</option>
      <option value="Helpless">Helpless</option>
      <option value="Descriptive">Descriptive</option>
    </select>

    <label for="escalation-filter">Escalation:</label>
    <select id="escalation-filter">
      <option value="">All</option>
      <option value="Critical">Critical</option>
      <option value="High">High</option>
      <option value="Moderate">Moderate</option>
      <option value="Low">Low</option>
    </select>

    <label for="sort-order">Sort by:</label>
    <select id="sort-order">
      <option value="desc">Newest First</option>
      <option value="asc">Oldest First</option>
    </select>

    <label for="keyword-search">Search:</label>
    <input type="text" id="keyword-search" placeholder="e.g. shelter, fire, flood">
  </div>

  <p id="report-count"></p>

  <div id="reports-container">
    {% for report in reports %}
      <div class="report-card"
           data-tone="{{ report.tone }}"
           data-escalation="{{ report.escalation }}"
           data-message="{{ report.message | lower }}">
        <p><strong class="message-text">{{ report.message }}</strong></p>
        <p>User: <em>{{ report.user }}</em></p>
        <p>üïí {{ report.timestamp }}</p>
        <p>
          Tone:
          <span class="badge {{ report.tone }}">{{ report.tone }}</span>
          Escalation:
          <span class="badge {{ report.escalation }}">
            {% if report.escalation == "Critical" %} üö®
            {% elif report.escalation == "High" %} ‚ö†Ô∏è
            {% endif %}
            {{ report.escalation }}
          </span>
        </p>
      </div>
    {% endfor %}
  </div>

  <script>
    const toneFilter = document.getElementById("tone-filter");
    const escalationFilter = document.getElementById("escalation-filter");
    const sortOrder = document.getElementById("sort-order");
    const keywordInput = document.getElementById("keyword-search");
    const reportCount = document.getElementById("report-count");
    const container = document.getElementById("reports-container");

    function highlightText(text, keyword) {
      if (!keyword) return text;
      const regex = new RegExp(`(${keyword})`, "gi");
      return text.replace(regex, "<mark>$1</mark>");
    }

    function applyFiltersAndSort() {
      const tone = toneFilter.value;
      const escalation = escalationFilter.value;
      const keyword = keywordInput.value.toLowerCase();
      const order = sortOrder.value;

      const cards = Array.from(container.querySelectorAll(".report-card"));

      // Filter
      const filtered = cards.filter(card => {
        const matchesTone = !tone || card.dataset.tone === tone;
        const matchesEscalation = !escalation || card.dataset.escalation === escalation;
        const matchesKeyword = !keyword || card.dataset.message.includes(keyword);
        return matchesTone && matchesEscalation && matchesKeyword;
      });

      // Sort
      filtered.sort((a, b) => {
        const dateA = new Date(a.querySelector("p:nth-child(3)").textContent.slice(2));
        const dateB = new Date(b.querySelector("p:nth-child(3)").textContent.slice(2));
        return order === "asc" ? dateA - dateB : dateB - dateA;
      });

      // Clear and re-render
      container.innerHTML = "";
      filtered.forEach(card => {
        const msgElem = card.querySelector(".message-text");
        msgElem.innerHTML = highlightText(card.dataset.message, keyword);
        container.appendChild(card);
      });

      reportCount.textContent = `${filtered.length} report(s) shown`;
    }

    toneFilter.addEventListener("change", applyFiltersAndSort);
    escalationFilter.addEventListener("change", applyFiltersAndSort);
    sortOrder.addEventListener("change", applyFiltersAndSort);
    keywordInput.addEventListener("input", applyFiltersAndSort);

    window.addEventListener("DOMContentLoaded", applyFiltersAndSort);

    // Optional auto-refresh (disabled by default)
    // setInterval(applyFiltersAndSort, 15000);
  </script>
</body>
</html>