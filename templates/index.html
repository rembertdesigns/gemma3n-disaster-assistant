<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Disaster Response & Recovery Assistant</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">🆘</div>
      <div>
        <h1 class="title">Disaster Response & Recovery Assistant</h1>
        <p class="subtitle">AI-Powered Emergency Analysis & Support</p>
      </div>
      <div class="controls">
        <button id="toggleThemeBtn">🌓 Toggle Theme</button>
        <button id="contrastToggleBtn" aria-label="Toggle high contrast mode">♿ High Contrast</button>
        <div class="status-bar">
          <div class="status-indicator status-offline">
            <div class="status-dot"></div>
            Offline Ready
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="main-card">
      <form id="analysisForm" method="post" action="/analyze" enctype="multipart/form-data">
        <div class="form-section">
          <label for="report_text">📝 Situation Description (Optional):</label>
          <textarea name="report_text" id="report_text" rows="4"
            placeholder="Ex: Building collapse near 5th Ave..."
            aria-label="Type or paste a description of the emergency"
          ></textarea>
          <label for="audioUpload">🎙️ Upload Voice Note</label>
          <input type="file" name="audio" id="audioUpload" accept=".wav,.mp3,.m4a"
            aria-describedby="voiceNoteHelp" />
          <small id="voiceNoteHelp">Upload a voice file describing the situation</small>
          
          <button type="button" id="recordBtn" aria-label="Start or stop recording voice report">
            🎤 Start Recording
          </button>          
        </div>

        <div class="form-section">
          <label>📍 Priority Level:</label>
          <div class="priority-selector">
            <label><input type="radio" name="priority" value="critical" />🔴 Critical</label>
            <label><input type="radio" name="priority" value="urgent" checked />🟠 Urgent</label>
            <label><input type="radio" name="priority" value="medium" />🟡 Medium</label>
            <label><input type="radio" name="priority" value="low" />🟢 Low</label>
          </div>
        </div>

        <div class="form-section">
          <label>📎 Upload Evidence:</label>
          <input type="file" name="file" accept=".jpg,.jpeg,.png" />
          <input type="file" name="audio" id="audioUpload" accept=".wav,.mp3,.m4a" />
        </div>

        <div class="form-section">
          <label>🎙️ Voice Report:</label>
          <button type="button" id="recordBtn">🎤 Start Recording</button>
          <span id="recordStatus">Idle</span>
          <audio id="playback" controls style="display:none;"></audio>
        </div>

        <button type="submit" id="analyzeBtn">🔍 Analyze Situation</button>
        <form id="pdfForm" method="post" action="/export-pdf">
          <input type="hidden" name="report_text" id="hiddenReportText">
          <button type="submit" class="analyze-button" style="margin-top: 1rem;">🖨️ Export as PDF</button>
        </form>        
      </form>
    </div>

    {% if result %}
    <div class="result-card" id="resultCard">
      <h2>📊 AI Situation Assessment</h2>
      {% if result.error %}
        <p><strong>Error:</strong> {{ result.error }}</p>
      {% else %}
        <p><strong>Type:</strong> {{ result.type|capitalize }}</p>
        {% if result.type == 'image' %}
          <p><strong>Detected:</strong> {{ result.damage_detected }}</p>
          <p><strong>Confidence:</strong> {{ result.confidence * 100 }}%</p>
          <p><strong>Suggested Action:</strong> {{ result.suggested_action }}</p>
        {% elif result.type == 'text' %}
          <p><strong>Response:</strong> {{ result.output }}</p>
        {% endif %}
      {% endif %}
    </div>
    <script>document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });</script>
    {% endif %}
  </div>

  <footer class="footer">
    <p>🔒 Privacy-First | ⚙️ Works Offline | ⚡ AI-Powered</p>
  </footer>

  <script>
    // Theme toggle
    const themeBtn = document.getElementById('toggleThemeBtn');
    themeBtn.addEventListener('click', () => {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  
    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
  
    // High contrast mode toggle
    const contrastBtn = document.getElementById("contrastToggleBtn");
    contrastBtn.addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute('data-contrast');
      const next = current === 'high' ? 'normal' : 'high';
      html.setAttribute('data-contrast', next);
      localStorage.setItem('contrast', next);
    });
  
    // Load saved contrast setting
    const savedContrast = localStorage.getItem('contrast');
    if (savedContrast) document.documentElement.setAttribute('data-contrast', savedContrast);
  
    // Voice recording
    const recordBtn = document.getElementById('recordBtn');
    const recordStatus = document.getElementById('recordStatus');
    const audioUpload = document.getElementById('audioUpload');
    const playback = document.getElementById('playback');
  
    let mediaRecorder;
    let audioChunks = [];
  
    recordBtn.addEventListener('click', async () => {
      if (recordBtn.textContent.includes("Stop")) {
        mediaRecorder.stop();
        recordBtn.textContent = "🎤 Start Recording";
        recordStatus.textContent = "Processing...";
      } else {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
  
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const file = new File([blob], "voice_input.webm", { type: 'audio/webm' });
  
          const dt = new DataTransfer();
          dt.items.add(file);
          audioUpload.files = dt.files;
  
          playback.src = URL.createObjectURL(blob);
          playback.style.display = 'block';
          recordStatus.textContent = "Recorded";
        };
  
        mediaRecorder.start();
        recordBtn.textContent = "⏹ Stop Recording";
        recordStatus.textContent = "Recording...";
      }
    });
  
    // Offline indicator
    function updateConnectionStatus() {
      const indicator = document.querySelector('.status-indicator');
      if (navigator.onLine) {
        indicator.innerHTML = '<div class="status-dot"></div>Online + Offline Ready';
        indicator.className = 'status-indicator status-online';
      } else {
        indicator.innerHTML = '<div class="status-dot"></div>Offline Mode Active';
        indicator.className = 'status-indicator status-offline';
      }
    }
  
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    updateConnectionStatus();
  
    // PDF form transfer
    document.getElementById("pdfForm").addEventListener("submit", function(e) {
      const report = document.getElementById("report_text").value;
      document.getElementById("hiddenReportText").value = report;
    });
  </script>  
</body>
</html>