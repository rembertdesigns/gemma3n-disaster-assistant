<!-- templates/home.html -->
{% extends "base.html" %}

{% block title %}Citizen Portal - Emergency Response Assistant{% endblock %}
{% block page_title %}🆘 Emergency Response Assistant{% endblock %}
{% block subtitle %}AI-powered emergency reporting for citizens{% endblock %}

{% block header_actions %}
<nav class="nav-links">
    <button class="nav-btn active" onclick="portal.goToStep(0)">🏠 Home</button>
    <button class="nav-btn emergency" onclick="portal.goToStep(2)">🚨 Report</button>
    <button class="nav-btn" onclick="portal.goToStep(3)">🎤 Voice</button>
    <button class="nav-btn" onclick="portal.goToStep(4)">📋 Track</button>
    
    <!-- Additional Navigation -->
    <a href="/onboarding.html" class="nav-btn">🎓 How It Works</a>
    <a href="/offline.html" class="nav-btn">📴 Offline Mode</a>
    
    <!-- New Accessibility & Language Options -->
    <button class="nav-btn" onclick="portal.toggleAccessibilityMode()" title="Accessibility Options">♿</button>
    <button class="nav-btn" onclick="portal.showLanguageSelector()" title="Language Selection">🌐</button>
</nav>
{% endblock %}

{% block extra_css %}
    {{ super() }}
    <!-- Portal-specific CSS -->
    <link rel="stylesheet" href="/static/css/portal.css" />
{% endblock %}

{% block content %}
<!-- Language Selection Modal -->
<div class="language-modal" id="languageModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>🌐 Select Language / Seleccionar idioma</h3>
            <button class="modal-close" onclick="portal.hideLanguageSelector()">&times;</button>
        </div>
        <div class="language-grid">
            <button class="language-option" onclick="portal.setLanguage('en')" data-lang="en">
                <span class="flag">🇺🇸</span>
                <span class="language-name">English</span>
            </button>
            <button class="language-option" onclick="portal.setLanguage('es')" data-lang="es">
                <span class="flag">🇪🇸</span>
                <span class="language-name">Español</span>
            </button>
            <button class="language-option" onclick="portal.setLanguage('fr')" data-lang="fr">
                <span class="flag">🇫🇷</span>
                <span class="language-name">Français</span>
            </button>
            <button class="language-option" onclick="portal.setLanguage('zh')" data-lang="zh">
                <span class="flag">🇨🇳</span>
                <span class="language-name">中文</span>
            </button>
            <button class="language-option" onclick="portal.setLanguage('ar')" data-lang="ar">
                <span class="flag">🇸🇦</span>
                <span class="language-name">العربية</span>
            </button>
            <button class="language-option" onclick="portal.setLanguage('ru')" data-lang="ru">
                <span class="flag">🇷🇺</span>
                <span class="language-name">Русский</span>
            </button>
        </div>
    </div>
</div>

<!-- Accessibility Settings Panel -->
<div class="accessibility-panel" id="accessibilityPanel" style="display: none;">
    <div class="panel-content">
        <div class="panel-header">
            <h3>♿ Accessibility Settings</h3>
            <button class="panel-close" onclick="portal.hideAccessibilityPanel()">&times;</button>
        </div>
        <div class="accessibility-options">
            <div class="accessibility-option">
                <label class="switch">
                    <input type="checkbox" id="highContrastMode" onchange="portal.toggleHighContrast()">
                    <span class="slider"></span>
                </label>
                <span class="option-label">High Contrast Mode</span>
            </div>
            <div class="accessibility-option">
                <label class="switch">
                    <input type="checkbox" id="largeTextMode" onchange="portal.toggleLargeText()">
                    <span class="slider"></span>
                </label>
                <span class="option-label">Large Text</span>
            </div>
            <div class="accessibility-option">
                <label class="switch">
                    <input type="checkbox" id="screenReaderMode" onchange="portal.toggleScreenReader()">
                    <span class="slider"></span>
                </label>
                <span class="option-label">Screen Reader Optimized</span>
            </div>
            <div class="accessibility-option">
                <label class="switch">
                    <input type="checkbox" id="reduceMotion" onchange="portal.toggleReduceMotion()">
                    <span class="slider"></span>
                </label>
                <span class="option-label">Reduce Motion</span>
            </div>
            <div class="accessibility-option">
                <label class="switch">
                    <input type="checkbox" id="colorBlindMode" onchange="portal.toggleColorBlindMode()">
                    <span class="slider"></span>
                </label>
                <span class="option-label">Color-Blind Friendly</span>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Alert Banner (managed by JS) -->
<div class="alert-banner" id="localAlerts">
    <div class="alert-content">
        <span class="alert-icon">⚠️</span>
        <span class="alert-text" id="alertText"></span>
        <button class="alert-close" onclick="this.parentElement.parentElement.style.display='none'" aria-label="Close alert">&times;</button>
    </div>
</div>

<div class="main-content">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="steps">
            <div class="progress-line">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step active" data-step="0">
                <div class="step-number">1</div>
                <div class="step-label">Setup Profile</div>
            </div>
            <div class="step" data-step="1">
                <div class="step-number">2</div>
                <div class="step-label">Welcome</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">3</div>
                <div class="step-label">Report</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">4</div>
                <div class="step-label">Voice</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">5</div>
                <div class="step-label">Track</div>
            </div>
        </div>
    </div>

    <!-- AI Confidence Meter (Available for all steps) -->
    <div class="ai-confidence-meter" id="aiConfidence">
        <div class="confidence-header">
            <span>🤖 AI Analysis Confidence</span>
            <span id="confidenceScore">--%</span>
        </div>
        <div class="confidence-bar">
            <div class="confidence-fill" id="confidenceFill"></div>
        </div>
    </div>

    <!-- === STEP 0: SETUP EMERGENCY PROFILE (ENHANCED WITH NEW FEATURES) === -->
    <div class="content-section active" id="step-0">
        <div class="step-header">
            <div class="setup-icon">🛠️</div>
            <h1 class="setup-title">Setup Your Emergency Profile</h1>
            <p class="setup-subtitle">Granting permissions and configuring your profile helps us provide faster and more accurate assistance during emergencies.</p>
        </div>
        
        <!-- Priority Setup Explanation -->
        <div class="setup-explanation">
            <div class="explanation-grid">
                <div class="explanation-card priority-high">
                    <span class="explanation-icon">⚡</span>
                    <h3>Why Setup First?</h3>
                    <p>During emergencies, every second counts. Pre-configuring your permissions ensures instant access to location, camera, and voice features when you need them most.</p>
                </div>
                
                <div class="explanation-card priority-medium">
                    <span class="explanation-icon">🔒</span>
                    <h3>Privacy & Security</h3>
                    <p>All data stays on your device first. We only access permissions when you actively submit a report, and you can revoke access anytime.</p>
                </div>
                
                <!-- New Accessibility Card -->
                <div class="explanation-card priority-medium">
                    <span class="explanation-icon">♿</span>
                    <h3>Accessibility First</h3>
                    <p>Full support for screen readers, high contrast modes, large text, and other accessibility features to ensure everyone can access emergency services.</p>
                </div>
                
                <!-- New Safety Card -->
                <div class="explanation-card priority-high">
                    <span class="explanation-icon">🔇</span>
                    <h3>Discreet Mode Available</h3>
                    <p>Silent reporting options for dangerous situations where making noise or being obvious could increase risk to your safety.</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Permission Setup Grid -->
        <div class="permissions-setup-grid">
            <div class="permission-setup-card priority-critical" id="locationSetupCard">
                <div class="permission-header">
                    <div class="permission-icon">📍</div>
                    <div class="permission-info">
                        <h3 class="permission-title">Location Access</h3>
                        <div class="priority-badge critical">Critical</div>
                    </div>
                </div>
                <p class="permission-description">Helps responders find you quickly during emergencies. Essential for accurate emergency response.</p>
                <div class="permission-benefits">
                    <div class="benefit-item">✓ Automatic GPS coordinates</div>
                    <div class="benefit-item">✓ Faster emergency response</div>
                    <div class="benefit-item">✓ Works offline</div>
                </div>
                <button class="btn btn-primary btn-permission" onclick="portal.requestLocationSetup(this)" id="locationSetupBtn">
                    Enable GPS Access
                </button>
                <div class="permission-status" id="locationSetupStatus">Not configured</div>
            </div>

            <div class="permission-setup-card priority-high" id="cameraSetupCard">
                <div class="permission-header">
                    <div class="permission-icon">📷</div>
                    <div class="permission-info">
                        <h3 class="permission-title">Camera Access</h3>
                        <div class="priority-badge high">High Priority</div>
                    </div>
                </div>
                <p class="permission-description">Allows you to attach photo evidence to emergency reports for better situation assessment.</p>
                <div class="permission-benefits">
                    <div class="benefit-item">✓ Visual evidence capture</div>
                    <div class="benefit-item">✓ AI photo analysis</div>
                    <div class="benefit-item">✓ Better emergency assessment</div>
                </div>
                <button class="btn btn-primary btn-permission" onclick="portal.requestCameraSetup(this)" id="cameraSetupBtn">
                    Enable Camera Access
                </button>
                <div class="permission-status" id="cameraSetupStatus">Not configured</div>
            </div>

            <div class="permission-setup-card priority-high" id="voiceSetupCard">
                <div class="permission-header">
                    <div class="permission-icon">🎤</div>
                    <div class="permission-info">
                        <h3 class="permission-title">Microphone Access</h3>
                        <div class="priority-badge high">High Priority</div>
                    </div>
                </div>
                <p class="permission-description">Enables hands-free voice reporting when you can't type or see your screen clearly.</p>
                <div class="permission-benefits">
                    <div class="benefit-item">✓ Hands-free reporting</div>
                    <div class="benefit-item">✓ Voice-to-text transcription</div>
                    <div class="benefit-item">✓ AI emotion analysis</div>
                </div>
                <button class="btn btn-primary btn-permission" onclick="portal.requestMicrophoneSetup(this)" id="voiceSetupBtn">
                    Enable Voice Access
                </button>
                <div class="permission-status" id="voiceSetupStatus">Not configured</div>
            </div>

            <div class="permission-setup-card priority-medium" id="notificationsSetupCard">
                <div class="permission-header">
                    <div class="permission-icon">🔔</div>
                    <div class="permission-info">
                        <h3 class="permission-title">Notifications</h3>
                        <div class="priority-badge medium">Recommended</div>
                    </div>
                </div>
                <p class="permission-description">Receive updates on your reports and local emergency alerts from authorities.</p>
                <div class="permission-benefits">
                    <div class="benefit-item">✓ Report status updates</div>
                    <div class="benefit-item">✓ Local emergency alerts</div>
                    <div class="benefit-item">✓ System notifications</div>
                </div>
                <button class="btn btn-primary btn-permission" onclick="portal.requestNotificationsSetup(this)" id="notificationsSetupBtn">
                    Enable Notifications
                </button>
                <div class="permission-status" id="notificationsSetupStatus">Not configured</div>
            </div>
        </div>

        <!-- New Emergency Profile Section -->
        <div class="emergency-profile-section">
            <h3>📋 Emergency Profile (Optional but Recommended)</h3>
            <p>Pre-fill medical information and emergency contacts for faster reporting and response.</p>
            
            <div class="profile-grid">
                <div class="profile-card" onclick="portal.setupMedicalInfo()">
                    <div class="profile-icon">🏥</div>
                    <h4>Medical Information</h4>
                    <p>Allergies, medications, medical conditions</p>
                    <div class="profile-status" id="medicalInfoStatus">Not configured</div>
                </div>
                
                <div class="profile-card" onclick="portal.setupEmergencyContacts()">
                    <div class="profile-icon">📞</div>
                    <h4>Emergency Contacts</h4>
                    <p>Family, friends, doctors to notify</p>
                    <div class="profile-status" id="emergencyContactsStatus">Not configured</div>
                </div>
                
                <div class="profile-card" onclick="portal.setupLanguagePreference()">
                    <div class="profile-icon">🌐</div>
                    <h4>Language Preference</h4>
                    <p>Primary language for emergency communication</p>
                    <div class="profile-status" id="languageStatus">English (Default)</div>
                </div>
            </div>
        </div>

        <!-- Setup Progress Indicator -->
        <div class="setup-progress" id="setupProgress">
            <div class="progress-header">
                <h3>🎯 Setup Progress</h3>
                <span class="progress-counter" id="progressCounter">0 of 4 permissions configured</span>
            </div>
            <div class="progress-bar-setup">
                <div class="progress-fill-setup" id="progressFillSetup" style="width: 0%"></div>
            </div>
            <div class="setup-status" id="setupStatus">
                <span class="status-text">Configure permissions to get started</span>
            </div>
        </div>

        <!-- Quick Emergency Override -->
        <div class="emergency-override">
            <h3>🚨 Emergency? Skip Setup</h3>
            <p>If you're in an active emergency situation, you can skip setup and report immediately.</p>
            <div class="override-buttons">
                <button class="btn btn-secondary emergency" onclick="portal.emergencySkipSetup()">
                    🚨 Emergency - Skip Setup
                </button>
                <button class="btn btn-outline discreet" onclick="portal.activateDiscreetMode()">
                    🔇 Discreet Emergency Mode
                </button>
            </div>
        </div>
        
        <div class="navigation-buttons">
            <div class="skip-section">
                <button class="btn btn-outline" onclick="portal.skipSetup()">Skip Setup for Now</button>
            </div>
            <button class="btn btn-success btn-large" onclick="portal.completeSetup()" id="completeSetupBtn" disabled>
                Continue to Platform 🚀
            </button>
        </div>
    </div>

    <!-- === STEP 1: ENHANCED WELCOME/OVERVIEW === -->
    <div class="content-section" id="step-1">
        <div class="welcome-hero">
            <div class="hero-icon">🆘</div>
            <h1 class="hero-title">Emergency Response Assistant</h1>
            <p class="hero-subtitle">Your direct line to AI-powered emergency support.</p>
            
            <div class="hero-badges">
                <div class="badge">✅ Setup Complete</div>
                <div class="badge">🚀 Ready to Use</div>
                <div class="badge">📱 Offline Capable</div>
                <div class="badge">♿ Accessible</div>
                <div class="badge">🌐 Multi-Language</div>
            </div>
        </div>
        
        <!-- Enhanced Features Grid with New Options -->
        <div class="features-grid">
            <div class="feature-card emergency-priority" onclick="portal.goToStep(2)">
                <span class="feature-icon">📱</span>
                <h3 class="feature-title">Submit Report</h3>
                <p class="feature-description">Send details with text, photos, and location.</p>
                <div class="feature-hint">Click to start reporting →</div>
            </div>
            
            <div class="feature-card voice-enabled" onclick="portal.goToStep(3)">
                <span class="feature-icon">🎤</span>
                <h3 class="feature-title">Voice Reporting</h3>
                <p class="feature-description">Hands-free reporting using AI voice analysis.</p>
                <div class="feature-hint">Perfect for urgent situations →</div>
            </div>
            
            <!-- New Discreet Mode Feature -->
            <div class="feature-card discreet-mode" onclick="portal.activateDiscreetMode()">
                <span class="feature-icon">🔇</span>
                <h3 class="feature-title">Discreet Mode</h3>
                <p class="feature-description">Silent reporting for dangerous situations.</p>
                <div class="feature-hint">No sound, minimal visual cues →</div>
            </div>
            
            <!-- Enhanced Accessibility Feature -->
            <div class="feature-card accessibility" onclick="portal.showAccessibilityOptions()">
                <span class="feature-icon">♿</span>
                <h3 class="feature-title">Accessibility Tools</h3>
                <p class="feature-description">Screen reader, high contrast, large text support.</p>
                <div class="feature-hint">Configure accessibility settings →</div>
            </div>
            
            <div class="feature-card risk-prediction" onclick="portal.showRiskPrediction()">
                <span class="feature-icon">🔮</span>
                <h3 class="feature-title">Risk Prediction</h3>
                <p class="feature-description">AI-powered local hazard forecasting.</p>
                <div class="feature-hint">View local risk assessment →</div>
            </div>
            
            <div class="feature-card tracking" onclick="portal.goToStep(4)">
                <span class="feature-icon">📊</span>
                <h3 class="feature-title">Track My Reports</h3>
                <p class="feature-description">Monitor your submissions and get updates.</p>
                <div class="feature-hint">View submission history →</div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-item">
                <span class="stat-number" id="responseTime">< 2 min</span>
                <span class="stat-label">Avg Response Time</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="reportsProcessed">1,247</span>
                <span class="stat-label">Reports Processed</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="aiAccuracy">94%</span>
                <span class="stat-label">AI Accuracy</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="onlineUsers">156</span>
                <span class="stat-label">Active Users</span>
            </div>
        </div>
        
        <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="portal.goToStep(0)">← Modify Setup</button>
            <button class="btn btn-primary btn-large" onclick="portal.goToStep(2)">Start Reporting 📱</button>
        </div>
    </div>

    <!-- === STEP 2: ENHANCED REPORT FORM === -->
    <div class="content-section" id="step-2">
        <h2>📱 Submit Emergency Report</h2>
        <p>Choose a method and provide details. AI will analyze your input in real-time.</p>
        
        <!-- Discreet Mode Indicator -->
        <div class="discreet-indicator" id="discreetIndicator" style="display: none;">
            <span class="discreet-icon">🔇</span>
            <span class="discreet-text">Discreet Mode Active - Silent operation</span>
            <button class="discreet-exit" onclick="portal.exitDiscreetMode()">Exit</button>
        </div>
        
        <div class="report-method-selector">
            <div class="method-card selected" data-method="text" onclick="portal.selectMethod(this, 'text')">
                <span class="method-icon">📝</span>
                <h3 class="method-title">Text Report</h3>
                <p class="method-description">Type your details.</p>
                <div class="method-features">
                    <span class="feature-tag">Fast</span>
                    <span class="feature-tag">Detailed</span>
                </div>
            </div>
            <div class="method-card" data-method="photo" onclick="portal.selectMethod(this, 'photo')">
                <span class="method-icon">📸</span>
                <h3 class="method-title">Photo Evidence</h3>
                <p class="method-description">Upload an image.</p>
                <div class="method-features">
                    <span class="feature-tag">Visual</span>
                    <span class="feature-tag">AI Analysis</span>
                </div>
            </div>
            <div class="method-card" data-method="location" onclick="portal.selectMethod(this, 'location')">
                <span class="method-icon">📍</span>
                <h3 class="method-title">Location Only</h3>
                <p class="method-description">Pin a location on a map.</p>
                <div class="method-features">
                    <span class="feature-tag">Quick</span>
                    <span class="feature-tag">GPS</span>
                </div>
            </div>
            <!-- New Discreet Method -->
            <div class="method-card discreet-card" data-method="discreet" onclick="portal.selectMethod(this, 'discreet')">
                <span class="method-icon">🔇</span>
                <h3 class="method-title">Discreet Report</h3>
                <p class="method-description">Silent, minimal UI.</p>
                <div class="method-features">
                    <span class="feature-tag">Silent</span>
                    <span class="feature-tag">Safe</span>
                </div>
            </div>
        </div>
        
        <form id="emergencyReportForm" autocomplete="off" class="form-container">
            <!-- Form fields are added dynamically by JS -->
        </form>
        
        <!-- Real-time AI Analysis Display -->
        <div class="realtime-analysis" id="realtimeAnalysis" style="display: none;">
            <div class="analysis-header">
                <span>🧠</span>
                <span>AI Real-time Analysis</span>
            </div>
            <div class="analysis-content">
                <div class="analysis-item">
                    <span class="analysis-label">Severity Level:</span>
                    <span class="analysis-value" id="severityLevel">Analyzing...</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Response Type:</span>
                    <span class="analysis-value" id="responseType">Analyzing...</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Estimated ETA:</span>
                    <span class="analysis-value" id="estimatedETA">Analyzing...</span>
                </div>
            </div>
        </div>
        
        <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="portal.goToStep(1)">← Back to Overview</button>
            <button class="btn btn-success btn-large" onclick="portal.submitReport()">📤 Submit Report</button>
        </div>
    </div>

    <!-- === STEP 3: ENHANCED VOICE REPORTING === -->
    <div class="content-section" id="step-3">
        <h2>🎤 Voice Emergency Reporter</h2>
        <p>Tap the button and speak clearly. AI will transcribe and analyze your report.</p>
        
        <!-- Language Selection for Voice -->
        <div class="voice-language-selector">
            <label for="voiceLanguage">🌐 Voice Language:</label>
            <select id="voiceLanguage" onchange="portal.setVoiceLanguage(this.value)">
                <option value="en-US">English (US)</option>
                <option value="es-ES">Español</option>
                <option value="fr-FR">Français</option>
                <option value="zh-CN">中文</option>
                <option value="ar-SA">العربية</option>
                <option value="ru-RU">Русский</option>
            </select>
        </div>
        
        <div class="voice-interface">
            <button class="record-button" id="recordButton" onclick="portal.toggleRecording()">🎤</button>
            <div class="voice-status" id="voiceStatus">Tap to start voice recording</div>
            <div class="transcript-box" id="transcriptBox">
                <div class="transcript-placeholder">Your voice transcript will appear here...</div>
            </div>
        </div>
        
        <div class="voice-analysis" id="voiceAnalysis" style="display: none;">
            <h3 class="analysis-title">🧠 AI Voice Analysis Results</h3>
            <div class="analysis-grid">
                <div class="analysis-card">
                    <span class="feature-icon">⚡</span>
                    <h4>Urgency Level</h4>
                    <p class="analysis-result" id="urgencyLevel">Analyzing...</p>
                </div>
                <div class="analysis-card">
                    <span class="feature-icon">😰</span>
                    <h4>Emotion Detected</h4>
                    <p class="analysis-result" id="emotionLevel">Analyzing...</p>
                </div>
                <div class="analysis-card">
                    <span class="feature-icon">📍</span>
                    <h4>Location Mentioned</h4>
                    <p class="analysis-result" id="detectedLocation">Analyzing...</p>
                </div>
                <div class="analysis-card">
                    <span class="feature-icon">💡</span>
                    <h4>AI Recommendation</h4>
                    <p class="analysis-result" id="aiRecommendation">Analyzing...</p>
                </div>
            </div>
        </div>
        
        <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="portal.goToStep(2)">← Back to Text Report</button>
            <button class="btn btn-success btn-large" id="submitVoiceReport" onclick="portal.submitVoiceReport()" disabled>📤 Submit Voice Report</button>
        </div>
    </div>

    <!-- === STEP 4: TRACK REPORTS === -->
    <div class="content-section" id="step-4">
        <div class="reports-dashboard">
            <h2>📋 My Emergency Reports</h2>
            <p>Track the status of your submitted reports and view community updates.</p>
            
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">📝</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalReports">0</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⏳</div>
                    <div class="stat-content">
                        <div class="stat-number" id="pendingReports">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-content">
                        <div class="stat-number" id="resolvedReports">0</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚡</div>
                    <div class="stat-content">
                        <div class="stat-number" id="avgResponseTime">--</div>
                        <div class="stat-label">Avg Response</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="reports-filters">
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" class="filter-select">
                    <option value="all">All Reports</option>
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="typeFilter">Type:</label>
                <select id="typeFilter" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="text">Text Reports</option>
                    <option value="voice">Voice Reports</option>
                    <option value="photo">Photo Reports</option>
                    <option value="discreet">Discreet Reports</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Date:</label>
                <select id="dateFilter" class="filter-select">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
        </div>
        
        <div class="reports-grid" id="reportsGrid">
            <!-- Reports will be populated dynamically -->
        </div>
        
        <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="portal.goToStep(1)">← Back to Overview</button>
            <button class="btn btn-primary btn-large" onclick="portal.goToStep(2)">📱 Submit New Report</button>
        </div>
    </div>
</div>

<!-- Enhanced Emergency Floating Action Button with Discreet Option -->
<div class="emergency-actions">
    <button class="emergency-fab" onclick="portal.quickEmergency()" title="Quick Emergency Report">🚨</button>
    <button class="discreet-fab" onclick="portal.activateDiscreetMode()" title="Discreet Emergency Mode" style="display: none;">🔇</button>
</div>

<!-- Discreet Mode Overlay -->
<div class="discreet-overlay" id="discreetOverlay" style="display: none;">
    <div class="discreet-content">
        <div class="discreet-header">
            <span class="discreet-title">🔇 Discreet Emergency Mode</span>
            <button class="discreet-close" onclick="portal.exitDiscreetMode()">×</button>
        </div>
        <div class="discreet-body">
            <p>This mode provides silent emergency reporting for dangerous situations.</p>
            <div class="discreet-options">
                <button class="discreet-option" onclick="portal.quickTextReport()">
                    <span class="option-icon">📝</span>
                    <span class="option-text">Quick Text</span>
                </button>
                <button class="discreet-option" onclick="portal.locationOnlyReport()">
                    <span class="option-icon">📍</span>
                    <span class="option-text">Location Only</span>
                </button>
                <button class="discreet-option" onclick="portal.presetEmergency('help')">
                    <span class="option-icon">🆘</span>
                    <span class="option-text">Send Help</span>
                </button>
                <button class="discreet-option" onclick="portal.presetEmergency('medical')">
                    <span class="option-icon">🏥</span>
                    <span class="option-text">Medical</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/js/portal.js"></script>
    
    <!-- Enhanced Portal Functions for New Features -->
    <script>
    // Language Support
    portal.currentLanguage = 'en';
    portal.translations = {
        en: {
            emergency: 'Emergency',
            help: 'Help',
            medical: 'Medical Emergency',
            location: 'Location',
            description: 'Description'
        },
        es: {
            emergency: 'Emergencia',
            help: 'Ayuda',
            medical: 'Emergencia Médica',
            location: 'Ubicación',
            description: 'Descripción'
        },
        fr: {
            emergency: 'Urgence',
            help: 'Aide',
            medical: 'Urgence Médicale',
            location: 'Emplacement',
            description: 'Description'
        }
        // Add more languages as needed
    };

    // Accessibility Functions
    portal.accessibilityMode = {
        highContrast: false,
        largeText: false,
        screenReader: false,
        reduceMotion: false,
        colorBlind: false
    };

    // Language Functions
    portal.showLanguageSelector = function() {
        document.getElementById('languageModal').style.display = 'flex';
    };

    portal.hideLanguageSelector = function() {
        document.getElementById('languageModal').style.display = 'none';
    };

    portal.setLanguage = function(langCode) {
        portal.currentLanguage = langCode;
        localStorage.setItem('preferredLanguage', langCode);
        portal.hideLanguageSelector();
        
        // Update UI with selected language
        portal.updateUILanguage();
        portal.showNotification(`Language changed to ${langCode.toUpperCase()}`, 'success');
    };

    portal.updateUILanguage = function() {
        // This would update all text elements based on the selected language
        // Implementation depends on your i18n strategy
        document.getElementById('languageStatus').textContent = portal.currentLanguage.toUpperCase() + ' Selected';
    };

    // Accessibility Functions
    portal.toggleAccessibilityMode = function() {
        const panel = document.getElementById('accessibilityPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    };

    portal.hideAccessibilityPanel = function() {
        document.getElementById('accessibilityPanel').style.display = 'none';
    };

    portal.toggleHighContrast = function() {
        portal.accessibilityMode.highContrast = !portal.accessibilityMode.highContrast;
        document.body.classList.toggle('high-contrast', portal.accessibilityMode.highContrast);
        localStorage.setItem('accessibilityMode', JSON.stringify(portal.accessibilityMode));
    };

    portal.toggleLargeText = function() {
        portal.accessibilityMode.largeText = !portal.accessibilityMode.largeText;
        document.body.classList.toggle('large-text', portal.accessibilityMode.largeText);
        localStorage.setItem('accessibilityMode', JSON.stringify(portal.accessibilityMode));
    };

    portal.toggleScreenReader = function() {
        portal.accessibilityMode.screenReader = !portal.accessibilityMode.screenReader;
        document.body.classList.toggle('screen-reader-optimized', portal.accessibilityMode.screenReader);
        localStorage.setItem('accessibilityMode', JSON.stringify(portal.accessibilityMode));
    };

    portal.toggleReduceMotion = function() {
        portal.accessibilityMode.reduceMotion = !portal.accessibilityMode.reduceMotion;
        document.body.classList.toggle('reduce-motion', portal.accessibilityMode.reduceMotion);
        localStorage.setItem('accessibilityMode', JSON.stringify(portal.accessibilityMode));
    };

    portal.toggleColorBlindMode = function() {
        portal.accessibilityMode.colorBlind = !portal.accessibilityMode.colorBlind;
        document.body.classList.toggle('color-blind-friendly', portal.accessibilityMode.colorBlind);
        localStorage.setItem('accessibilityMode', JSON.stringify(portal.accessibilityMode));
    };

    // Discreet Mode Functions
    portal.discreetMode = false;

    portal.activateDiscreetMode = function() {
        portal.discreetMode = true;
        document.body.classList.add('discreet-mode');
        document.getElementById('discreetOverlay').style.display = 'flex';
        document.getElementById('discreetIndicator').style.display = 'flex';
        
        // Disable all sounds and vibrations
        portal.silentMode = true;
        
        portal.showNotification('🔇 Discreet mode activated', 'info', 2000);
    };

    portal.exitDiscreetMode = function() {
        portal.discreetMode = false;
        document.body.classList.remove('discreet-mode');
        document.getElementById('discreetOverlay').style.display = 'none';
        document.getElementById('discreetIndicator').style.display = 'none';
        
        portal.silentMode = false;
        
        portal.showNotification('Discreet mode deactivated', 'info', 2000);
    };

    portal.quickTextReport = function() {
        portal.exitDiscreetMode();
        portal.goToStep(2);
        portal.selectMethod(document.querySelector('[data-method="discreet"]'), 'discreet');
    };

    portal.locationOnlyReport = function() {
        if (portal.userLocation) {
            const reportData = {
                method: 'discreet',
                type: 'location-only',
                location: portal.userLocation,
                timestamp: new Date().toISOString(),
                id: Date.now(),
                status: 'submitted'
            };
            
            const existingReports = JSON.parse(localStorage.getItem('userReports') || '[]');
            existingReports.push(reportData);
            localStorage.setItem('userReports', JSON.stringify(existingReports));
            
            portal.exitDiscreetMode();
            portal.showNotification('📍 Location-only emergency report sent', 'success');
        } else {
            portal.showNotification('❌ Location not available', 'error');
        }
    };

    portal.presetEmergency = function(type) {
        const presets = {
            'help': 'Emergency assistance needed immediately',
            'medical': 'Medical emergency requiring immediate response'
        };
        
        const reportData = {
            method: 'discreet',
            type: type,
            description: presets[type],
            location: portal.userLocation,
            timestamp: new Date().toISOString(),
            id: Date.now(),
            status: 'submitted'
        };
        
        const existingReports = JSON.parse(localStorage.getItem('userReports') || '[]');
        existingReports.push(reportData);
        localStorage.setItem('userReports', JSON.stringify(existingReports));
        
        portal.exitDiscreetMode();
        portal.showNotification(`🚨 ${type} emergency report sent`, 'success');
    };

    // Emergency Profile Functions
    portal.setupMedicalInfo = function() {
        portal.showNotification('🏥 Medical information setup - Feature coming soon!', 'info');
    };

    portal.setupEmergencyContacts = function() {
        portal.showNotification('📞 Emergency contacts setup - Feature coming soon!', 'info');
    };

    portal.setupLanguagePreference = function() {
        portal.showLanguageSelector();
    };

    portal.showAccessibilityOptions = function() {
        portal.toggleAccessibilityMode();
    };

    portal.setVoiceLanguage = function(language) {
        portal.voiceLanguage = language;
        localStorage.setItem('voiceLanguage', language);
        portal.showNotification(`🌐 Voice language set to ${language}`, 'success', 2000);
    };

    // Enhanced showNotification for discreet mode
    const originalShowNotification = portal.showNotification;
    portal.showNotification = function(message, type = 'info', duration = 4000) {
        if (portal.discreetMode && portal.silentMode) {
            // In discreet mode, show minimal visual feedback only
            const discreetFeedback = document.createElement('div');
            discreetFeedback.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                width: 10px;
                height: 10px;
                background: ${type === 'success' ? '#22c55e' : '#3b82f6'};
                border-radius: 50%;
                z-index: 10001;
                opacity: 0.7;
            `;
            document.body.appendChild(discreetFeedback);
            
            setTimeout(() => {
                if (discreetFeedback.parentNode) {
                    discreetFeedback.parentNode.removeChild(discreetFeedback);
                }
            }, 1000);
        } else {
            originalShowNotification.call(this, message, type, duration);
        }
    };

    // Load saved preferences on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load accessibility preferences
        const savedAccessibility = localStorage.getItem('accessibilityMode');
        if (savedAccessibility) {
            portal.accessibilityMode = JSON.parse(savedAccessibility);
            
            // Apply saved accessibility settings
            if (portal.accessibilityMode.highContrast) {
                document.body.classList.add('high-contrast');
                document.getElementById('highContrastMode').checked = true;
            }
            if (portal.accessibilityMode.largeText) {
                document.body.classList.add('large-text');
                document.getElementById('largeTextMode').checked = true;
            }
            if (portal.accessibilityMode.screenReader) {
                document.body.classList.add('screen-reader-optimized');
                document.getElementById('screenReaderMode').checked = true;
            }
            if (portal.accessibilityMode.reduceMotion) {
                document.body.classList.add('reduce-motion');
                document.getElementById('reduceMotion').checked = true;
            }
            if (portal.accessibilityMode.colorBlind) {
                document.body.classList.add('color-blind-friendly');
                document.getElementById('colorBlindMode').checked = true;
            }
        }

        // Load language preference
        const savedLanguage = localStorage.getItem('preferredLanguage');
        if (savedLanguage) {
            portal.currentLanguage = savedLanguage;
            portal.updateUILanguage();
        }

        // Load voice language preference
        const savedVoiceLanguage = localStorage.getItem('voiceLanguage');
        if (savedVoiceLanguage) {
            document.getElementById('voiceLanguage').value = savedVoiceLanguage;
            portal.voiceLanguage = savedVoiceLanguage;
        }
    });
    </script>
    
    <!-- Add CSS for new features -->
    <style>
    /* Language Modal Styles */
    .language-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-light);
        padding-bottom: 1rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .language-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        border: 2px solid var(--border-light);
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .language-option:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .flag {
        font-size: 1.5rem;
    }

    .language-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    /* Accessibility Panel Styles */
    .accessibility-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        border: 2px solid var(--border-light);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        width: 300px;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
        padding-bottom: 0.75rem;
    }

    .accessibility-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--grey-300);
        transition: 0.4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    /* Emergency Profile Styles */
    .emergency-profile-section {
        margin: 2rem 0;
        padding: 2rem;
        background: var(--bg-secondary);
        border-radius: 16px;
        border: 1px solid var(--border-light);
    }

    .profile-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .profile-card {
        background: white;
        border: 2px solid var(--border-light);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .profile-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .profile-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }

    .profile-status {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
        font-style: italic;
    }

    /* Discreet Mode Styles */
    .discreet-indicator {
        background: var(--grey-800);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .discreet-fab {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--grey-700);
        color: white;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        transition: all 0.2s;
        position: fixed;
        bottom: 100px;
        right: 32px;
        z-index: 999;
    }

    .discreet-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .discreet-content {
        background: var(--grey-900);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
    }

    .discreet-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .discreet-option {
        background: var(--grey-800);
        border: 1px solid var(--grey-600);
        border-radius: 12px;
        padding: 1rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .discreet-option:hover {
        background: var(--grey-700);
        transform: scale(1.05);
    }

    .option-icon {
        font-size: 1.5rem;
    }

    .option-text {
        font-size: 0.875rem;
        font-weight: 600;
    }

    /* Feature card variants */
    .feature-card.discreet-mode {
        border-left: 4px solid var(--grey-600);
    }

    .feature-card.accessibility {
        border-left: 4px solid #7c3aed;
    }

    .method-card.discreet-card {
        background: linear-gradient(135deg, var(--grey-50) 0%, var(--grey-100) 100%);
        border-left: 4px solid var(--grey-600);
    }

    /* Voice language selector */
    .voice-language-selector {
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* Accessibility mode styles */
    body.high-contrast {
        filter: contrast(150%);
    }

    body.large-text {
        font-size: 1.2em;
    }

    body.reduce-motion * {
        animation-duration: 0.001ms !important;
        transition-duration: 0.001ms !important;
    }

    body.color-blind-friendly {
        --primary: #0066cc;
        --secondary: #cc6600;
        --success: #006600;
    }

    body.discreet-mode {
        --primary: var(--grey-700);
        --secondary: var(--grey-800);
    }

    body.discreet-mode .emergency-fab {
        display: none;
    }

    body.discreet-mode .discreet-fab {
        display: flex;
    }

    /* Screen reader optimizations */
    body.screen-reader-optimized .feature-hint,
    body.screen-reader-optimized .form-text {
        position: static;
        width: auto;
        height: auto;
        overflow: visible;
        clip: auto;
    }

    body.screen-reader-optimized *:focus {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
    }
    </style>
{% endblock %}