<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3n Emergency Command Center - AI-Powered Disaster Response</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css" />
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary-color: #6b7280;
            --color-critical: #dc2626;
            --color-warning: #f59e0b;
            --color-good: #f59e0b;
            --color-optimal: #16a34a;
            --bg-color-base: #ffffff;
            --bg-color-card: #ffffff;
            --bg-color-light: #f8fafc;
            --text-color-base: #1f2937;
            --text-color-light: #6b7280;
            --text-color-inverted: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --gemma-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --ai-accent: #8b5cf6;
        }

        [data-theme="dark"] {
            --bg-color-base: #1f2937;
            --bg-color-card: #374151;
            --bg-color-light: #4b5563;
            --text-color-base: #f9fafb;
            --text-color-light: #d1d5db;
            --border-color: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color-base);
            color: var(--text-color-base);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Gemma 3n Status Indicator */
        .gemma-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: var(--gemma-gradient);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: gemmaGlow 3s ease-in-out infinite;
        }

        @keyframes gemmaGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.6); }
        }

        .gemma-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .gemma-indicator.loading {
            background: #f59e0b;
            animation: blink 1s infinite;
        }

        .gemma-indicator.error {
            background: #dc2626;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Header */
        .main-header {
            background: linear-gradient(135deg, var(--color-critical) 0%, #991b1b 100%);
            color: var(--text-color-inverted);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
        }

        .header-info h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .header-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-level {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-weight: bold;
            animation: pulse-alert 2s infinite;
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            color: var(--text-color-inverted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Navigation */
        .main-nav {
            position: fixed;
            top: 80px;
            left: 0;
            width: 280px;
            height: calc(100vh - 80px);
            background: var(--bg-color-card);
            border-right: 1px solid var(--border-color);
            z-index: 999;
            overflow-y: auto;
            padding: 1rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--text-color-light);
            margin-bottom: 0.5rem;
            padding: 0 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: var(--bg-color-light);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: var(--text-color-inverted);
        }

        .nav-item.ai-powered {
            background: var(--gemma-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .nav-item.ai-powered::after {
            content: 'üß† Gemma 3n';
            position: absolute;
            top: -2px;
            right: -2px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--ai-accent);
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0 8px 0 8px;
            font-weight: bold;
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            margin-top: 80px;
            padding: 2rem;
            min-height: calc(100vh - 80px);
        }

        .dashboard-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .dashboard-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI Context Panel */
        .ai-context-panel {
            background: var(--gemma-gradient);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .ai-context-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .context-title {
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .context-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            position: relative;
            z-index: 1;
        }

        .context-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .context-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .context-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Context Window Visualization */
        .context-window {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
            z-index: 1;
        }

        .context-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            animation: contextPulse 2s infinite;
        }

        @keyframes contextPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .context-sources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .context-source {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
            font-size: 0.7rem;
        }

        /* Enhanced Panels */
        .panel {
            background: var(--bg-color-card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .panel.ai-enhanced {
            border: 2px solid var(--ai-accent);
            position: relative;
            overflow: hidden;
        }

        .panel.ai-enhanced::before {
            content: 'üß† AI Enhanced';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--ai-accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* AI Insights Panel */
        .ai-insights {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid var(--ai-accent);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .insights-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--ai-accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--ai-accent);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .insight-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .insight-title {
            font-weight: bold;
            color: var(--text-color-base);
        }

        .confidence-badge {
            background: var(--ai-accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .insight-description {
            color: var(--text-color-base);
            margin-bottom: 0.5rem;
        }

        .insight-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .insight-action {
            background: #e0e7ff;
            color: var(--ai-accent);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .insight-action:hover {
            background: var(--ai-accent);
            color: white;
        }

        /* Real-time Analysis */
        .realtime-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .analysis-card {
            background: var(--bg-color-card);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .analysis-card.processing {
            border-color: var(--ai-accent);
            animation: processingPulse 2s infinite;
        }

        @keyframes processingPulse {
            0%, 100% { border-color: var(--ai-accent); }
            50% { border-color: #c084fc; }
        }

        .analysis-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-optimal);
        }

        .status-indicator.processing {
            background: var(--color-warning);
            animation: blink 1s infinite;
        }

        /* Command Grid */
        .command-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-color-card);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.ai-enhanced {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-color: var(--ai-accent);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-value.ai-value {
            color: var(--ai-accent);
        }

        .stat-label {
            color: var(--text-color-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: bold;
        }

        .trend-up { color: var(--color-optimal); }
        .trend-down { color: var(--color-critical); }
        .trend-stable { color: var(--color-warning); }

        /* Processing Status */
        .processing-status {
            background: linear-gradient(135deg, var(--ai-accent) 0%, #7c3aed 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .processing-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: scan 2s infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .processing-text {
            position: relative;
            z-index: 1;
            font-weight: bold;
        }

        /* Map Styles */
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #mainMap {
            height: 100%;
            width: 100%;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-color-inverted);
        }

        .btn-ai {
            background: var(--ai-accent);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-ai:hover::before {
            left: 100%;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-nav {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .main-nav.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .command-grid {
                grid-template-columns: 1fr;
            }

            .gemma-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .context-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Additional AI-specific styles */
        .ai-model-status {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid var(--ai-accent);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .model-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .model-indicator .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-optimal);
        }

        .model-indicator .status-dot.loading {
            background: var(--color-warning);
            animation: pulse 1s infinite;
        }

        .token-usage {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-color-light);
        }

        .token-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .token-fill {
            height: 100%;
            background: var(--ai-accent);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Gemma 3n Status Indicator -->
    <div class="gemma-status" id="gemmaStatus">
        <div class="gemma-indicator" id="gemmaIndicator"></div>
        <span id="gemmaStatusText">Initializing Gemma 3n...</span>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">üß†</div>
                <div class="header-info">
                    <h1>Gemma 3n Emergency Operations Center</h1>
                    <p>AI-powered disaster response with 128K context awareness</p>
                </div>
            </div>
            
            <div class="header-right">
                <div class="alert-level">
                    <span>‚ö†Ô∏è</span>
                    <span>ALERT LEVEL 3</span>
                </div>
                
                <div class="header-controls">
                    <button class="header-btn" onclick="toggleTheme()">üåì</button>
                    <button class="header-btn" onclick="toggleNav()">‚ò∞</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav" id="mainNav">
        <div class="nav-section">
            <div class="nav-title">AI Command & Control</div>
            <div class="nav-item active ai-powered" onclick="showSection('ai-command')">
                <div class="nav-icon">üß†</div>
                <div>AI Command Center</div>
            </div>
            <div class="nav-item ai-powered" onclick="showSection('context-intelligence')">
                <div class="nav-icon">üîÆ</div>
                <div>Context Intelligence</div>
            </div>
            <div class="nav-item ai-powered" onclick="showSection('predictive-analysis')">
                <div class="nav-icon">üìä</div>
                <div>Predictive Analysis</div>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Operations</div>
            <div class="nav-item" onclick="showSection('live-map')">
                <div class="nav-icon">üó∫Ô∏è</div>
                <div>Live Map</div>
            </div>
            <div class="nav-item" onclick="showSection('incidents')">
                <div class="nav-icon">üö®</div>
                <div>Active Incidents</div>
            </div>
            <div class="nav-item" onclick="showSection('resources')">
                <div class="nav-icon">üöí</div>
                <div>Resource Management</div>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Data & Reports</div>
            <div class="nav-item" onclick="showSection('reports')">
                <div class="nav-icon">üìã</div>
                <div>Crowd Reports</div>
            </div>
            <div class="nav-item" onclick="showSection('analytics')">
                <div class="nav-icon">üìà</div>
                <div>Analytics</div>
            </div>
            <div class="nav-item" onclick="showSection('archive')">
                <div class="nav-icon">üìö</div>
                <div>Archive</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- AI Command Center Section -->
        <div id="ai-command" class="dashboard-section active">
            <!-- Gemma 3n Context Intelligence Panel -->
            <div class="ai-context-panel">
                <div class="context-header">
                    <div class="context-title">
                        <span>üß†</span>
                        Gemma 3n Context Intelligence
                    </div>
                    <div style="opacity: 0.9;">128K Token Context Window</div>
                </div>
                
                <div class="context-window">
                    <div class="context-progress">
                        <span style="font-weight: bold;">Context Usage:</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="contextProgressFill" style="width: 0%"></div>
                        </div>
                        <span id="contextUsageText">0% (0/128K tokens)</span>
                    </div>
                    
                    <div class="context-sources">
                        <div class="context-source">
                            <div>üìä Reports</div>
                            <div id="contextReports">0</div>
                        </div>
                        <div class="context-source">
                            <div>üå§Ô∏è Weather</div>
                            <div id="contextWeather">Loading</div>
                        </div>
                        <div class="context-source">
                            <div>üó∫Ô∏è Location</div>
                            <div id="contextLocation">GPS</div>
                        </div>
                        <div class="context-source">
                            <div>üèóÔ∏è Infrastructure</div>
                            <div id="contextInfra">Online</div>
                        </div>
                        <div class="context-source">
                            <div>üë• Population</div>
                            <div id="contextPop">Census</div>
                        </div>
                        <div class="context-source">
                            <div>üì± Social</div>
                            <div id="contextSocial">Feeds</div>
                        </div>
                    </div>
                </div>
                
                <div class="context-stats">
                    <div class="context-stat">
                        <div class="context-value" id="aiAccuracy">94.7%</div>
                        <div class="context-label">AI Accuracy</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="processingSpeed">1.2s</div>
                        <div class="context-label">Avg Processing</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="modelsActive">7</div>
                        <div class="context-label">Active Models</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="insights">23</div>
                        <div class="context-label">AI Insights</div>
                    </div>
                </div>
            </div>

            <!-- Real-time AI Processing Status -->
            <div class="processing-status" id="processingStatus" style="display: none;">
                <div class="processing-text" id="processingText">
                    üß† Gemma 3n processing 47 emergency reports with 128K context...
                </div>
            </div>

            <!-- AI Model Status -->
            <div class="ai-model-status">
                <div class="model-indicator">
                    <div class="status-dot" id="edgeAiDot"></div>
                    <strong>Edge AI Engine:</strong>
                    <span id="edgeAiStatus">Initializing...</span>
                </div>
                <div class="token-usage">
                    <span>Token Usage:</span>
                    <div class="token-bar">
                        <div class="token-fill" id="tokenFill" style="width: 0%"></div>
                    </div>
                    <span id="tokenCount">0 / 128K</span>
                </div>
            </div>

            <!-- Enhanced Stats Grid with AI Metrics -->
            <div class="stats-grid">
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value" id="aiProcessedReports">127</div>
                    <div class="stat-label">AI Processed Reports</div>
                    <div class="stat-trend trend-up">‚Üó +15 this hour</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">7</div>
                    <div class="stat-label">Active Incidents</div>
                    <div class="stat-trend trend-down">‚Üò -2 from yesterday</div>
                </div>
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value" id="riskScore">7.2</div>
                    <div class="stat-label">AI Risk Score</div>
                    <div class="stat-trend trend-stable">‚Üí Stable</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">45</div>
                    <div class="stat-label">Units Deployed</div>
                    <div class="stat-trend trend-stable">‚Üí Optimal</div>
                </div>
            </div>

            <!-- AI-Generated Insights -->
            <div class="ai-insights">
                <div class="insights-header">
                    <div class="insights-title">
                        <span>üß†</span>
                        Gemma 3n Real-time Insights
                    </div>
                    <button class="btn btn-ai" onclick="refreshAIInsights()">
                        üîÑ Refresh Analysis
                    </button>
                </div>
                
                <div id="aiInsightsList">
                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">üî• Fire Risk Elevation Detected</div>
                            <div class="confidence-badge">92% Confidence</div>
                        </div>
                        <div class="insight-description">
                            AI analysis of weather patterns, historical data, and current conditions indicates elevated fire risk in downtown area between 2:00 PM - 6:00 PM today. Wind speed increasing to 25 mph with low humidity (18%).
                        </div>
                        <div class="insight-actions">
                            <span class="insight-action" onclick="implementRecommendation('fire-risk-deploy-units')">üöí Deploy Units</span>
                            <span class="insight-action" onclick="viewInsightDetails('fire-risk')">üìä View Analysis</span>
                            <span class="insight-action" onclick="alertStakeholders('fire-risk')">üì¢ Alert Agencies</span>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">üöó Traffic Incident Prediction</div>
                            <div class="confidence-badge">85% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Machine learning model predicts 67% higher accident probability on Highway 101 northbound during evening rush (5:00-7:00 PM) due to weather conditions and historical patterns.
                        </div>
                        <div class="insight-actions">
                            <span class="insight-action" onclick="implementRecommendation('traffic-position-units')">üöì Position Units</span>
                            <span class="insight-action" onclick="alertTraffic('highway-101')">üö¶ Traffic Alert</span>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">üè• Medical Volume Surge</div>
                            <div class="confidence-badge">78% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Heat wave correlation analysis shows 34% increase in respiratory emergencies likely over next 3 days. Current air quality index: 127 (Unhealthy for Sensitive Groups).
                        </div>
                        <div class="insight-actions">
                            <span class="insight-action" onclick="prepareResources('medical-surge')">üöë Prep Resources</span>
                            <span class="insight-action" onclick="activateCooling()">‚ùÑÔ∏è Cooling Centers</span>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">üìç Resource Optimization</div>
                            <div class="confidence-badge">96% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Geospatial analysis indicates 23% response time improvement possible by relocating Ambulance 7 from Station C to Station 12 during peak hours (3:00-8:00 PM).
                        </div>
                        <div class="insight-actions">
                            <span class="insight-action" onclick="optimizeResources()">üéØ Implement</span>
                            <span class="insight-action" onclick="viewOptimization()">üìà View Impact</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Analysis Cards -->
            <div class="realtime-analysis">
                <div class="analysis-card" id="imageAnalysisCard">
                    <div class="analysis-status">
                        <div class="status-indicator" id="imageStatusDot"></div>
                        <strong>Image Analysis</strong>
                    </div>
                    <div>Processing: <span id="imageQueue">0</span> images</div>
                    <div>Hazards detected: <span id="hazardsDetected">3</span></div>
                    <div>Accuracy: <span id="imageAccuracy">97.3%</span></div>
                </div>

                <div class="analysis-card" id="textAnalysisCard">
                    <div class="analysis-status">
                        <div class="status-indicator" id="textStatusDot"></div>
                        <strong>Sentiment Analysis</strong>
                    </div>
                    <div>Processing: <span id="textQueue">0</span> reports</div>
                    <div>Panic level: <span id="panicLevel">Moderate</span></div>
                    <div>Accuracy: <span id="textAccuracy">94.2%</span></div>
                </div>

                <div class="analysis-card" id="locationAnalysisCard">
                    <div class="analysis-status">
                        <div class="status-indicator" id="locationStatusDot"></div>
                        <strong>Location Intelligence</strong>
                    </div>
                    <div>GPS reports: <span id="gpsReports">47</span></div>
                    <div>Risk areas: <span id="riskAreas">12</span></div>
                    <div>Accuracy: <span id="locationAccuracy">89.1%</span></div>
                </div>

                <div class="analysis-card" id="predictionCard">
                    <div class="analysis-status">
                        <div class="status-indicator" id="predictionStatusDot"></div>
                        <strong>Predictive Models</strong>
                    </div>
                    <div>Forecasts: <span id="activeForecast">8</span> active</div>
                    <div>Next event: <span id="nextEvent">2:15 PM</span></div>
                    <div>Confidence: <span id="predictionConfidence">87%</span></div>
                </div>
            </div>

            <!-- Traditional Command Grid -->
            <div class="command-grid">
                <div class="panel ai-enhanced">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>üó∫Ô∏è</span>
                            AI-Enhanced Situation Map
                        </div>
                        <div>
                            <button class="btn btn-ai" onclick="runAIMapAnalysis()">üß† AI Analysis</button>
                        </div>
                    </div>
                    <div class="map-container">
                        <div id="mainMap"></div>
                    </div>
                </div>

                <div class="panel ai-enhanced">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>üö®</span>
                            AI-Prioritized Incidents
                        </div>
                        <div>
                            <button class="btn btn-ai" onclick="reprioritizeIncidents()">üéØ Re-prioritize</button>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;" data-incidents-container>
                        <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid #dc2626; cursor: pointer;" onclick="viewIncident(1)">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold;">üî• Structure Fire - Oak Street</div>
                                <div style="font-size: 0.8rem; color: var(--text-color-light);">AI Priority: 9.7/10</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                Multi-story residential. AI detected: structural damage, smoke patterns, 15+ people in building via thermal analysis.
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="background: #dc2626; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">CRITICAL</span>
                                <span style="background: #16a34a; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">COMMAND EST.</span>
                            </div>
                        </div>

                        <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid #f59e0b; cursor: pointer;" onclick="viewIncident(2)">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold;">üöó MVA Highway 101</div>
                                <div style="font-size: 0.8rem; color: var(--text-color-light);">AI Priority: 7.3/10</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                Multi-vehicle accident. AI analysis: 3 vehicles, likely injuries, traffic backup 2.1 miles.
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="background: #f59e0b; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">HIGH</span>
                                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">EN ROUTE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Intelligence Section -->
        <div id="context-intelligence" class="dashboard-section">
            <div class="ai-context-panel">
                <div class="context-header">
                    <div class="context-title">
                        <span>üîÆ</span>
                        Deep Context Analysis Engine
                    </div>
                    <button class="btn btn-ai" onclick="runDeepContextAnalysis()">
                        üß† Analyze All Context
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                    <div>
                        <h4 style="color: white; margin-bottom: 1rem;">üóÇÔ∏è Data Sources Loaded</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üìä Emergency Reports</span>
                                    <span>2,847 items (12.3 MB)</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üå§Ô∏è Weather Data</span>
                                    <span>1,203 points (4.7 MB)</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üèóÔ∏è Infrastructure</span>
                                    <span>891 facilities (2.1 MB)</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üë• Population Data</span>
                                    <span>67 districts (8.9 MB)</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üì± Social Media</span>
                                    <span>15,432 posts (18.2 MB)</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>üìö Historical Data</span>
                                    <span>5 years (156 MB)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: white; margin-bottom: 1rem;">‚ö° Processing Statistics</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Tokens Processed</span>
                                    <span id="tokensProcessed">0 / 128K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Patterns Found</span>
                                    <span id="patternsFound">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Correlations</span>
                                    <span id="correlationsFound">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Processing Speed</span>
                                    <span id="processingSpeedStat">0 tokens/sec</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Context Utilization</span>
                                    <span id="contextUtilization">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deep Analysis Results -->
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üîç</span>
                        Gemma 3n Deep Analysis Results
                    </div>
                    <button class="btn btn-ai" onclick="exportContextAnalysis()">üìÑ Export Report</button>
                </div>
                
                <div id="deepAnalysisResults">
                    <div style="text-align: center; padding: 3rem; color: var(--text-color-light);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üß†</div>
                        <div style="font-size: 1.2rem; margin-bottom: 1rem;">Ready for Deep Context Analysis</div>
                        <div>Click "Analyze All Context" to process all data sources with Gemma 3n's 128K context window</div>
                        <button class="btn btn-ai" style="margin-top: 1.5rem;" onclick="runDeepContextAnalysis()">
                            üöÄ Start Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictive Analysis Section -->
        <div id="predictive-analysis" class="dashboard-section">
            <div class="ai-context-panel">
                <div class="context-header">
                    <div class="context-title">
                        <span>üìä</span>
                        Predictive Emergency Intelligence
                    </div>
                    <div style="opacity: 0.9;">AI-powered forecasting and risk assessment</div>
                </div>
                
                <div class="context-stats">
                    <div class="context-stat">
                        <div class="context-value">94.7%</div>
                        <div class="context-label">Prediction Accuracy</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value">7.2</div>
                        <div class="context-label">Current Risk Score</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value">23</div>
                        <div class="context-label">Predicted Incidents (24h)</div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value">87%</div>
                        <div class="context-label">Model Confidence</div>
                    </div>
                </div>
            </div>

            <!-- Prediction Timeline -->
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>‚è∞</span>
                        AI Forecast Timeline
                    </div>
                    <div>
                        <button class="btn btn-ai" onclick="updateForecasts()">üîÑ Update Forecasts</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="viewForecastDetails('fire-risk')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî•</div>
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">Today 2:00 PM</div>
                        <div style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">Fire Risk Peak</div>
                        <div style="font-size: 0.8rem; color: var(--text-color-light); margin-top: 0.5rem;">92% Confidence</div>
                    </div>
                    
                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="viewForecastDetails('traffic-surge')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöó</div>
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">Today 5:30 PM</div>
                        <div style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">Traffic Surge</div>
                        <div style="font-size: 0.8rem; color: var(--text-color-light); margin-top: 0.5rem;">85% Confidence</div>
                    </div>
                    
                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="viewForecastDetails('medical-volume')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üè•</div>
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">Tomorrow 10:00 AM</div>
                        <div style="background: #16a34a; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">Medical +20%</div>
                        <div style="font-size: 0.8rem; color: var(--text-color-light); margin-top: 0.5rem;">78% Confidence</div>
                    </div>
                    
                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer;" onclick="viewForecastDetails('low-activity')">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìâ</div>
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">Tomorrow 8:00 PM</div>
                        <div style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">Low Activity</div>
                        <div style="font-size: 0.8rem; color: var(--text-color-light); margin-top: 0.5rem;">89% Confidence</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Map Section -->
        <div id="live-map" class="dashboard-section">
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üó∫Ô∏è</span>
                        AI-Enhanced Live Emergency Map
                    </div>
                    <div>
                        <button class="btn btn-ai" onclick="runMapAI()">üß† AI Analysis</button>
                        <button class="btn btn-primary" onclick="exportMapData()">üìä Export Data</button>
                    </div>
                </div>
                <div style="height: 600px; background: var(--bg-color-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color);">
                    <div style="text-align: center; color: var(--text-color-light);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">AI-Enhanced Interactive Emergency Map</div>
                        <div>Real-time analysis, predictive hotspots, and intelligent clustering</div>
                        <button class="btn btn-ai" style="margin-top: 1rem;" onclick="initializeAIMap()">
                            üöÄ Load AI Map
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Section -->
        <div id="resources" class="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value">96%</div>
                    <div class="stat-label">AI Optimization Score</div>
                    <div class="stat-trend trend-up">‚Üó +3% this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">87</div>
                    <div class="stat-label">Total Units</div>
                    <div class="stat-trend trend-stable">‚Üí Full Fleet</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">54</div>
                    <div class="stat-label">Currently Deployed</div>
                    <div class="stat-trend trend-up">‚Üó High Activity</div>
                </div>
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value">4.2min</div>
                    <div class="stat-label">AI-Optimized Response</div>
                    <div class="stat-trend trend-down">‚Üò -1.3min improvement</div>
                </div>
            </div>

            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üöí</span>
                        AI-Optimized Resource Management
                    </div>
                    <div>
                        <button class="btn btn-ai" onclick="optimizeAllResources()">üéØ AI Optimize</button>
                        <button class="btn btn-primary" onclick="requestMutualAid()">üìû Mutual Aid</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; text-align: center; transition: all 0.3s ease; cursor: pointer;" onclick="viewResourceDetails('fire')">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem;">12</div>
                        <div style="color: var(--text-color-light); font-size: 0.9rem; margin-bottom: 0.5rem;">Fire Engines</div>
                        <div style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">8 Deployed</div>
                        <div style="font-size: 0.7rem; color: var(--ai-accent); margin-top: 0.5rem;">üß† AI: 92% optimal</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other sections -->
        <div id="reports" class="dashboard-section">
            <div style="text-align: center; padding: 4rem; color: var(--text-color-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <div style="font-size: 1.5rem;">Crowd Reports Section</div>
                <div>AI-enhanced report processing and analysis</div>
            </div>
        </div>

        <div id="analytics" class="dashboard-section">
            <div style="text-align: center; padding: 4rem; color: var(--text-color-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div>
                <div style="font-size: 1.5rem;">Analytics Dashboard</div>
                <div>Advanced AI-powered analytics and insights</div>
            </div>
        </div>

        <div id="incidents" class="dashboard-section">
            <div style="text-align: center; padding: 4rem; color: var(--text-color-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üö®</div>
                <div style="font-size: 1.5rem;">Incident Management</div>
                <div>AI-prioritized incident response and coordination</div>
            </div>
        </div>

        <div id="archive" class="dashboard-section">
            <div style="text-align: center; padding: 4rem; color: var(--text-color-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <div style="font-size: 1.5rem;">Historical Archive</div>
                <div>AI-powered search and pattern analysis</div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Enhanced Gemma 3n AI Engine with API Integration -->
    <script>
        // Enhanced GemmaEnhancedAI class with API connectivity and WebSocket support
        class GemmaEnhancedAI {
            constructor() {
                this.isGemmaReady = false;
                this.contextTokens = 0;
                this.maxTokens = 128000;
                this.apiBaseUrl = ''; // Use relative URLs for same domain
                this.wsConnection = null;
                this.processingQueue = [];
                this.insights = [];
                this.models = {
                    emergency: null,
                    prediction: null,
                    context: null
                };
                
                // Performance tracking
                this.performance = {
                    totalProcessed: 0,
                    averageLatency: 0,
                    accuracy: 94.7,
                    contextUtilization: 0
                };
                
                // Real-time data streams
                this.dataStreams = {
                    reports: [],
                    weather: null,
                    location: null,
                    infrastructure: null,
                    population: null,
                    social: []
                };
                
                // Initialize WebSocket for real-time updates
                this.initializeWebSocket();
                
                console.log('üß† Gemma 3n Enhanced AI with API integration initializing...');
            }

            // NEW: Initialize WebSocket connection for real-time updates
            initializeWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/crisis-command`;
                    
                    this.wsConnection = new WebSocket(wsUrl);
                    
                    this.wsConnection.onopen = () => {
                        console.log('üîå Crisis Command WebSocket connected');
                    };
                    
                    this.wsConnection.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleRealTimeUpdate(data);
                    };
                    
                    this.wsConnection.onclose = () => {
                        console.log('üîå Crisis Command WebSocket disconnected - attempting reconnect...');
                        setTimeout(() => this.initializeWebSocket(), 5000);
                    };
                } catch (error) {
                    console.warn('WebSocket connection failed:', error);
                }
            }

            // NEW: Handle real-time updates from WebSocket
            handleRealTimeUpdate(data) {
                if (data.type === 'crisis_update') {
                    this.updateContextUsageFromAPI(data.data.context_utilization);
                    this.updateProcessingQueues(data.data.processing_queue);
                    this.updateAIPerformance(data.data.ai_performance);
                    
                    // Handle system alerts
                    if (data.data.system_alerts && data.data.system_alerts.length > 0) {
                        this.displaySystemAlert(data.data.system_alerts[0]);
                    }
                }
            }

            // NEW: Fetch real context utilization from API
            async updateContextUsageFromAPI(utilizationPercent = null) {
                try {
                    if (utilizationPercent === null) {
                        const response = await fetch('/api/gemma-context-status');
                        const data = await response.json();
                        
                        if (data.success) {
                            utilizationPercent = data.context_status.utilization_percent;
                            this.contextTokens = data.context_status.tokens_used;
                            
                            // Update sources display
                            this.updateElement('contextReports', data.context_status.sources.emergency_reports);
                            this.updateElement('contextWeather', 'Active');
                            this.updateElement('contextInfra', data.context_status.sources.infrastructure);
                            this.updateElement('contextPop', data.context_status.sources.population_data);
                            this.updateElement('contextSocial', data.context_status.sources.social_feeds);
                        }
                    }
                    
                    // Update progress bar
                    this.updateElement('contextProgressFill', null, `width: ${utilizationPercent}%`);
                    this.updateElement('contextUsageText', `${utilizationPercent}% (${this.formatNumber(this.contextTokens)}/128K tokens)`);
                    this.updateElement('contextUtilization', `${utilizationPercent}%`);
                    
                } catch (error) {
                    console.error('Failed to fetch context status:', error);
                    // Fallback to simulated data
                    this.updateContextUsage();
                }
            }

            // NEW: Fetch real AI insights from backend
            async generateInitialInsights() {
                try {
                    this.showProcessingStatus('üß† Fetching real-time AI insights...');
                    
                    const response = await fetch('/api/ai-insights?refresh=true');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.insights = data.insights.map(insight => ({
                            id: insight.id,
                            type: insight.type,
                            title: insight.title,
                            confidence: Math.round(insight.confidence * 100),
                            description: insight.description,
                            recommendations: insight.recommendations,
                            priority: insight.priority
                        }));
                        
                        this.updateInsightsDisplay();
                        
                        // Update performance stats
                        this.updateElement('aiAccuracy', data.context_utilization || '94.7%');
                        this.updateElement('processingSpeed', data.processing_time || '1.2s');
                    }
                    
                } catch (error) {
                    console.error('Failed to fetch AI insights:', error);
                    // Fall back to simulated insights
                    await this.generateSimulatedInsights();
                } finally {
                    this.hideProcessingStatus();
                }
            }

            // NEW: Fetch crisis dashboard data
            async loadCrisisDashboardData() {
                try {
                    const response = await fetch('/api/crisis-dashboard-data');
                    const data = await response.json();
                    
                    if (data.success) {
                        const dashboard = data.dashboard_data;
                        
                        // Update statistics
                        this.updateElement('aiProcessedReports', dashboard.statistics.ai_processed_reports);
                        this.updateElement('riskScore', dashboard.statistics.ai_risk_score);
                        
                        // Update AI metrics display
                        if (dashboard.ai_metrics) {
                            this.updateElement('aiAccuracy', `${dashboard.ai_metrics.accuracy}%`);
                            this.updateElement('processingSpeed', `${dashboard.ai_metrics.processing_speed}s`);
                            this.updateElement('modelsActive', dashboard.ai_metrics.models_active);
                            this.updateElement('insights', dashboard.ai_metrics.insights_generated);
                        }
                        
                        // Update real-time analysis from API data
                        if (dashboard.real_time_analysis) {
                            this.updateAnalysisFromAPI(dashboard.real_time_analysis);
                        }
                    }
                    
                } catch (error) {
                    console.error('Failed to load crisis dashboard data:', error);
                    // Fallback to simulated data
                    this.loadSimulatedDashboardData();
                }
            }

            // NEW: Update analysis cards with real API data
            updateAnalysisFromAPI(analysisData) {
                if (analysisData.image_analysis) {
                    this.updateAnalysisCard('imageAnalysisCard', {
                        queue: analysisData.image_analysis.queue,
                        hazards: analysisData.image_analysis.hazards_detected,
                        accuracy: analysisData.image_analysis.accuracy
                    });
                }
                
                if (analysisData.text_analysis) {
                    this.updateAnalysisCard('textAnalysisCard', {
                        queue: analysisData.text_analysis.queue,
                        panicLevel: analysisData.text_analysis.panic_level,
                        accuracy: analysisData.text_analysis.accuracy
                    });
                }
                
                if (analysisData.location_intelligence) {
                    this.updateAnalysisCard('locationAnalysisCard', {
                        gpsReports: analysisData.location_intelligence.gps_reports,
                        riskAreas: analysisData.location_intelligence.risk_areas,
                        accuracy: analysisData.location_intelligence.accuracy
                    });
                }
                
                if (analysisData.predictive_models) {
                    this.updateAnalysisCard('predictionCard', {
                        forecasts: analysisData.predictive_models.active_forecasts,
                        nextEvent: analysisData.predictive_models.next_predicted_event,
                        confidence: analysisData.predictive_models.confidence
                    });
                }
            }

            // NEW: Run deep context analysis via API
            async runDeepContextAnalysis() {
                try {
                    this.showProcessingStatus('üß† Running comprehensive context analysis...');
                    
                    const response = await fetch('/api/run-deep-context-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'analysis_type=comprehensive'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const results = data.analysis_results;
                        
                        // Update processing statistics
                        this.updateElement('patternsFound', results.patterns_identified);
                        this.updateElement('correlationsFound', results.cross_correlations);
                        this.updateElement('contextUtilization', results.context_window_utilization);
                        
                        // Display comprehensive results
                        this.displayDeepAnalysisResults(results);
                    }
                    
                } catch (error) {
                    console.error('Deep context analysis failed:', error);
                    // Fallback to simulated analysis
                    await this.runSimulatedDeepAnalysis();
                } finally {
                    this.hideProcessingStatus();
                }
            }

            // NEW: Display deep analysis results from API
            displayDeepAnalysisResults(results) {
                const resultsContainer = document.getElementById('deepAnalysisResults');
                
                resultsContainer.innerHTML = `
                    <div style="padding: 2rem;">
                        <h3 style="color: var(--ai-accent); margin-bottom: 1rem;">
                            üß† Gemma 3n Deep Analysis Complete
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--ai-accent);">${results.patterns_identified}</div>
                                <div>Patterns Identified</div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--ai-accent);">${results.cross_correlations}</div>
                                <div>Cross-Correlations</div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--ai-accent);">${results.predictions_generated}</div>
                                <div>Predictions Generated</div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--color-critical);">${results.anomalies_detected}</div>
                                <div>Anomalies Detected</div>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4>üîç Key Findings:</h4>
                            <ul style="margin-top: 0.5rem;">
                                ${results.key_findings.map(finding => `<li>${finding}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 8px;">
                            <h4>üìä Data Processed:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                                <div>üìä Reports: <strong>${results.data_processed.emergency_reports}</strong></div>
                                <div>üè• Patients: <strong>${results.data_processed.patient_records}</strong></div>
                                <div>üë• Crowd Reports: <strong>${results.data_processed.crowd_reports}</strong></div>
                                <div>üå§Ô∏è Weather Points: <strong>${results.data_processed.weather_points}</strong></div>
                                <div>üèóÔ∏è Infrastructure: <strong>${results.data_processed.infrastructure_facilities}</strong></div>
                                <div>üì± Social Posts: <strong>${results.data_processed.social_media_posts}</strong></div>
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 6px;">
                                <strong>Context Utilization:</strong> ${results.context_window_utilization} | 
                                <strong>Processing Time:</strong> ${results.processing_time} | 
                                <strong>Confidence:</strong> ${results.confidence_score}%
                            </div>
                        </div>
                    </div>
                `;
            }

            // NEW: Fetch AI-prioritized incidents
            async loadPrioritizedIncidents() {
                try {
                    const response = await fetch('/api/ai-prioritized-incidents');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayPrioritizedIncidents(data.prioritized_incidents);
                    }
                    
                } catch (error) {
                    console.error('Failed to load prioritized incidents:', error);
                    // Keep existing incident display
                }
            }

            // NEW: Display real incidents from API
            displayPrioritizedIncidents(incidents) {
                const container = document.querySelector('[data-incidents-container]');
                if (!container) return;
                
                container.innerHTML = incidents.slice(0, 5).map(incident => {
                    const priorityColor = incident.ai_priority_score >= 8 ? '#dc2626' : 
                                         incident.ai_priority_score >= 6 ? '#f59e0b' : '#16a34a';
                    const priorityText = incident.ai_priority_score >= 8 ? 'CRITICAL' : 
                                       incident.ai_priority_score >= 6 ? 'HIGH' : 'MEDIUM';
                    
                    return `
                        <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${priorityColor}; cursor: pointer;" onclick="viewIncident(${incident.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold;">${incident.title}</div>
                                <div style="font-size: 0.8rem; color: var(--text-color-light);">AI Priority: ${incident.ai_priority_score}/10</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                ${incident.description.length > 150 ? incident.description.substring(0, 150) + '...' : incident.description}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="background: ${priorityColor}; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">${priorityText}</span>
                                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">${incident.status.toUpperCase()}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // NEW: Handle recommendation implementation via API
            async implementRecommendationViaAPI(recommendationId, actionType) {
                try {
                    const response = await fetch('/api/implement-recommendation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `recommendation_id=${encodeURIComponent(recommendationId)}&action_type=${encodeURIComponent(actionType)}&confirmation=true`
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(`‚úÖ ${data.implementation_result.action_taken}\n\nEstimated Impact: ${data.implementation_result.estimated_impact}`);
                        
                        // Refresh insights after implementation
                        await this.generateInitialInsights();
                    } else {
                        alert(`‚ùå Implementation failed: ${data.error}`);
                    }
                    
                } catch (error) {
                    console.error('Failed to implement recommendation:', error);
                    alert('‚ùå Failed to implement recommendation. Please try again.');
                }
            }

            // Enhanced initialize method with API calls
            async initialize() {
                try {
                    this.updateGemmaStatus('loading', 'Connecting to Gemma 3n API...');
                    
                    // Load real data from APIs
                    await Promise.all([
                        this.updateContextUsageFromAPI(),
                        this.loadCrisisDashboardData(),
                        this.generateInitialInsights(),
                        this.loadPrioritizedIncidents()
                    ]);
                    
                    // Start real-time processing
                    this.startRealTimeProcessing();
                    
                    this.isGemmaReady = true;
                    this.updateGemmaStatus('ready', 'Gemma 3n operational - Connected to live data');
                    
                    console.log('üöÄ Gemma 3n Enhanced AI with API integration fully operational');
                    
                } catch (error) {
                    console.error('‚ùå Gemma 3n API initialization failed:', error);
                    this.updateGemmaStatus('error', 'API connection failed - Using simulated data');
                    
                    // Fallback to simulated data
                    await this.initializeWithSimulatedData();
                }
            }

            // Enhanced real-time processing with API polling
            startRealTimeProcessing() {
                // Poll for updates every 30 seconds
                setInterval(async () => {
                    await this.updateContextUsageFromAPI();
                    await this.loadCrisisDashboardData();
                }, 30000);
                
                // Update processing indicators more frequently
                setInterval(() => {
                    if (!this.wsConnection || this.wsConnection.readyState !== WebSocket.OPEN) {
                        this.updateProcessingIndicators();
                    }
                }, 5000);
            }

            // Fallback methods for when API is not available
            async initializeWithSimulatedData() {
                // Initialize data streams with simulated data
                await this.initializeDataStreams();
                
                // Generate simulated insights
                await this.generateSimulatedInsights();
                
                // Start simulated real-time processing
                this.startSimulatedRealTimeProcessing();
                
                this.isGemmaReady = true;
                this.updateGemmaStatus('ready', 'Gemma 3n operational - Simulated mode');
            }

            async initializeDataStreams() {
                // Simulate loading various data sources
                this.dataStreams.reports = await this.loadEmergencyReports();
                this.dataStreams.weather = await this.loadWeatherData();
                this.dataStreams.infrastructure = await this.loadInfrastructureData();
                this.dataStreams.population = await this.loadPopulationData();
                this.dataStreams.social = await this.loadSocialMediaFeeds();
                
                // Calculate initial context usage
                this.updateContextUsage();
                
                console.log('üìä Data streams initialized:', this.dataStreams);
            }

            async loadEmergencyReports() {
                // Simulate loading emergency reports
                const reports = [];
                for (let i = 0; i < 127; i++) {
                    reports.push({
                        id: i + 1,
                        timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000),
                        type: ['fire', 'medical', 'traffic', 'weather', 'infrastructure'][Math.floor(Math.random() * 5)],
                        severity: Math.floor(Math.random() * 10) + 1,
                        location: [34.05 + (Math.random() - 0.5) * 0.1, -118.25 + (Math.random() - 0.5) * 0.1],
                        description: `Emergency incident ${i + 1}`,
                        tokens: Math.floor(Math.random() * 200) + 50
                    });
                }
                return reports;
            }

            async loadWeatherData() {
                return {
                    current: {
                        temperature: 85,
                        humidity: 18,
                        windSpeed: 25,
                        airQuality: 127
                    },
                    forecast: {
                        fireRisk: 'high',
                        precipitation: 0,
                        alerts: ['Heat Advisory', 'Wind Advisory']
                    },
                    tokens: 1500
                };
            }

            async loadInfrastructureData() {
                return {
                    facilities: 891,
                    powerGrid: 'stable',
                    communications: 'operational',
                    transportation: 'congested',
                    tokens: 2100
                };
            }

            async loadPopulationData() {
                return {
                    districts: 67,
                    totalPopulation: 1250000,
                    densityMap: 'loaded',
                    vulnerablePopulations: 45000,
                    tokens: 8900
                };
            }

            async loadSocialMediaFeeds() {
                return {
                    posts: 15432,
                    emergencyMentions: 234,
                    sentiment: 'concerned',
                    trendingTopics: ['fire', 'evacuation', 'traffic'],
                    tokens: 18200
                };
            }

            updateContextUsage() {
                let totalTokens = 0;
                
                // Calculate tokens from each data stream
                totalTokens += this.dataStreams.reports.reduce((sum, report) => sum + report.tokens, 0);
                totalTokens += this.dataStreams.weather?.tokens || 0;
                totalTokens += this.dataStreams.infrastructure?.tokens || 0;
                totalTokens += this.dataStreams.population?.tokens || 0;
                totalTokens += this.dataStreams.social?.tokens || 0;
                
                this.contextTokens = totalTokens;
                const percentage = Math.min(100, (totalTokens / this.maxTokens) * 100);
                
                // Update UI
                this.updateElement('contextProgressFill', null, `width: ${percentage}%`);
                this.updateElement('contextUsageText', `${percentage.toFixed(1)}% (${this.formatNumber(totalTokens)}/128K tokens)`);
                this.updateElement('tokensProcessed', `${this.formatNumber(totalTokens)} / 128K`);
                this.updateElement('contextUtilization', `${percentage.toFixed(1)}%`);
                
                // Update individual source counts
                this.updateElement('contextReports', this.dataStreams.reports.length);
                this.updateElement('contextWeather', 'Active');
                this.updateElement('contextLocation', 'GPS Active');
                this.updateElement('contextInfra', '891 facilities');
                this.updateElement('contextPop', '67 districts');
                this.updateElement('contextSocial', '15.4K posts');
            }

            async generateSimulatedInsights() {
                this.showProcessingStatus('üß† Generating AI insights from 128K context...');
                
                await this.delay(3000);
                
                // Simulate AI-generated insights
                this.insights = [
                    {
                        id: 1,
                        type: 'fire_risk',
                        title: 'Fire Risk Elevation Detected',
                        confidence: 92,
                        description: 'AI analysis of weather patterns, historical data, and current conditions indicates elevated fire risk in downtown area between 2:00 PM - 6:00 PM today.',
                        recommendations: ['Deploy fire units', 'Issue public alert', 'Monitor weather'],
                        priority: 'critical'
                    },
                    {
                        id: 2,
                        type: 'traffic_prediction',
                        title: 'Traffic Incident Prediction',
                        confidence: 85,
                        description: 'Machine learning model predicts 67% higher accident probability on Highway 101 during evening rush hour.',
                        recommendations: ['Position traffic units', 'Issue traffic alert'],
                        priority: 'high'
                    },
                    {
                        id: 3,
                        type: 'medical_surge',
                        title: 'Medical Volume Surge',
                        confidence: 78,
                        description: 'Heat wave correlation analysis shows 34% increase in respiratory emergencies likely over next 3 days.',
                        recommendations: ['Prepare resources', 'Activate cooling centers'],
                        priority: 'medium'
                    }
                ];
                
                this.hideProcessingStatus();
                this.updateInsightsDisplay();
                
                // Update performance metrics
                this.performance.totalProcessed += this.dataStreams.reports.length;
                this.updatePerformanceDisplay();
            }

            startSimulatedRealTimeProcessing() {
                // Simulate real-time data processing
                setInterval(() => {
                    this.processRealTimeData();
                }, 5000);
                
                // Update processing indicators
                setInterval(() => {
                    this.updateProcessingIndicators();
                }, 2000);
            }

            async processRealTimeData() {
                // Simulate processing new emergency reports
                const newReports = Math.floor(Math.random() * 3);
                if (newReports > 0) {
                    for (let i = 0; i < newReports; i++) {
                        const report = {
                            id: this.dataStreams.reports.length + 1,
                            timestamp: new Date(),
                            type: ['fire', 'medical', 'traffic'][Math.floor(Math.random() * 3)],
                            severity: Math.floor(Math.random() * 10) + 1,
                            location: [34.05 + (Math.random() - 0.5) * 0.1, -118.25 + (Math.random() - 0.5) * 0.1],
                            description: `New emergency incident`,
                            tokens: Math.floor(Math.random() * 200) + 50
                        };
                        
                        this.dataStreams.reports.push(report);
                        
                        // Process with AI if significant
                        if (report.severity >= 7) {
                            await this.processHighSeverityReport(report);
                        }
                    }
                    
                    this.updateContextUsage();
                    this.performance.totalProcessed += newReports;
                    this.updatePerformanceDisplay();
                }
            }

            async processHighSeverityReport(report) {
                // Simulate AI processing of high-severity report
                this.showProcessingStatus(`üß† Processing high-severity ${report.type} report...`);
                
                await this.delay(1500);
                
                // Generate new insight
                const insight = {
                    id: Date.now(),
                    type: report.type,
                    title: `High-Severity ${report.type.charAt(0).toUpperCase() + report.type.slice(1)} Alert`,
                    confidence: 85 + Math.floor(Math.random() * 10),
                    description: `AI detected high-severity ${report.type} incident requiring immediate attention.`,
                    recommendations: ['Dispatch emergency units', 'Establish command', 'Monitor situation'],
                    priority: 'critical',
                    fresh: true
                };
                
                this.insights.unshift(insight);
                this.updateInsightsDisplay();
                this.hideProcessingStatus();
            }

            updateProcessingIndicators() {
                // Update real-time analysis cards
                this.updateAnalysisCard('imageAnalysisCard', {
                    queue: Math.floor(Math.random() * 5),
                    hazards: 3 + Math.floor(Math.random() * 3),
                    accuracy: 97.3 + (Math.random() - 0.5) * 0.4
                });
                
                this.updateAnalysisCard('textAnalysisCard', {
                    queue: Math.floor(Math.random() * 8),
                    panicLevel: ['Calm', 'Concerned', 'Elevated', 'Critical'][Math.floor(Math.random() * 4)],
                    accuracy: 94.2 + (Math.random() - 0.5) * 0.6
                });
                
                this.updateAnalysisCard('locationAnalysisCard', {
                    gpsReports: this.dataStreams.reports.length,
                    riskAreas: 12 + Math.floor(Math.random() * 3),
                    accuracy: 89.1 + (Math.random() - 0.5) * 0.8
                });
                
                this.updateAnalysisCard('predictionCard', {
                    forecasts: 8,
                    nextEvent: '2:15 PM',
                    confidence: 87 + Math.floor(Math.random() * 8)
                });
            }

            updateAnalysisCard(cardId, data) {
                const card = document.getElementById(cardId);
                if (!card) return;
                
                const statusDot = card.querySelector('.status-indicator');
                if (statusDot) {
                    statusDot.className = 'status-indicator';
                    if (Math.random() > 0.8) {
                        statusDot.classList.add('processing');
                    }
                }
                
                // Update specific data based on card type
                if (data.queue !== undefined) {
                    this.updateElement(cardId === 'imageAnalysisCard' ? 'imageQueue' : 'textQueue', data.queue);
                }
                if (data.hazards) this.updateElement('hazardsDetected', data.hazards);
                if (data.accuracy) {
                    const accuracyId = cardId === 'imageAnalysisCard' ? 'imageAccuracy' : 
                                     cardId === 'textAnalysisCard' ? 'textAccuracy' : 'locationAccuracy';
                    this.updateElement(accuracyId, `${data.accuracy.toFixed(1)}%`);
                }
                if (data.panicLevel) this.updateElement('panicLevel', data.panicLevel);
                if (data.gpsReports) this.updateElement('gpsReports', data.gpsReports);
                if (data.riskAreas) this.updateElement('riskAreas', data.riskAreas);
                if (data.forecasts) this.updateElement('activeForecast', data.forecasts);
                if (data.nextEvent) this.updateElement('nextEvent', data.nextEvent);
                if (data.confidence) this.updateElement('predictionConfidence', `${data.confidence}%`);
            }

            updateInsightsDisplay() {
                const container = document.getElementById('aiInsightsList');
                if (!container) return;
                
                container.innerHTML = this.insights.slice(0, 4).map(insight => `
                    <div class="insight-item ${insight.fresh ? 'processing' : ''}">
                        <div class="insight-header">
                            <div class="insight-title">${this.getInsightIcon(insight.type)} ${insight.title}</div>
                            <div class="confidence-badge">${insight.confidence}% Confidence</div>
                        </div>
                        <div class="insight-description">${insight.description}</div>
                        <div class="insight-actions">
                            ${insight.recommendations.map(rec => 
                                `<span class="insight-action" onclick="implementRecommendation('${insight.id}-${rec.replace(/\s+/g, '-').toLowerCase()}')">${rec}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
                
                // Remove fresh flag after display
                this.insights.forEach(insight => delete insight.fresh);
            }

            updatePerformanceDisplay() {
                this.updateElement('aiProcessedReports', this.performance.totalProcessed);
                this.updateElement('aiAccuracy', `${this.performance.accuracy.toFixed(1)}%`);
                this.updateElement('processingSpeed', `${(1.2 + Math.random() * 0.6).toFixed(1)}s`);
                this.updateElement('modelsActive', '7');
                this.updateElement('insights', this.insights.length);
            }

            getInsightIcon(type) {
                const icons = {
                    fire_risk: 'üî•',
                    traffic_prediction: 'üöó',
                    medical_surge: 'üè•',
                    weather_alert: 'üå©Ô∏è',
                    infrastructure: 'üèóÔ∏è',
                    security: 'üîí'
                };
                return icons[type] || '‚ö†Ô∏è';
            }

            showProcessingStatus(message) {
                const status = document.getElementById('processingStatus');
                const text = document.getElementById('processingText');
                if (status && text) {
                    text.textContent = message;
                    status.style.display = 'block';
                }
            }

            hideProcessingStatus() {
                const status = document.getElementById('processingStatus');
                if (status) {
                    status.style.display = 'none';
                }
            }

            updateGemmaStatus(status, message) {
                const indicator = document.getElementById('gemmaIndicator');
                const text = document.getElementById('gemmaStatusText');
                
                if (indicator) {
                    indicator.className = 'gemma-indicator';
                    if (status === 'loading') indicator.classList.add('loading');
                    if (status === 'error') indicator.classList.add('error');
                }
                
                if (text) {
                    text.textContent = message;
                }
                
                // Update Edge AI status if available
                if (window.EdgeAIMonitor) {
                    window.EdgeAIMonitor.updateAIStatus(status, message);
                }
            }

            updateElement(id, content, style) {
                const element = document.getElementById(id);
                if (element) {
                    if (content !== null && content !== undefined) element.textContent = content;
                    if (style) element.style.cssText += style;
                }
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Simulated deep analysis for fallback
            async runSimulatedDeepAnalysis() {
                const results = {
                    patterns_identified: 23,
                    cross_correlations: 15,
                    predictions_generated: 8,
                    anomalies_detected: 3,
                    key_findings: [
                        'üî• Fire risk correlation with wind patterns: 94% accuracy',
                        'üöó Traffic incident prediction improved by 23% with weather data',
                        'üè• Medical emergency volume correlates with air quality (r=0.78)',
                        'üìç Geographic clustering reveals 3 high-risk zones',
                        '‚è∞ Temporal patterns show peak incident times: 2-4 PM, 6-8 PM'
                    ],
                    data_processed: {
                        emergency_reports: 2847,
                        patient_records: 1203,
                        crowd_reports: 891,
                        weather_points: 1203,
                        infrastructure_facilities: 891,
                        social_media_posts: 15432
                    },
                    context_window_utilization: '67.3%',
                    processing_time: '4.2s',
                    confidence_score: 94
                };

                this.displayDeepAnalysisResults(results);
                this.updateElement('patternsFound', results.patterns_identified);
                this.updateElement('correlationsFound', results.cross_correlations);
            }

            // Public methods for UI interactions
            async refreshAIInsights() {
                this.showProcessingStatus('üîÑ Refreshing AI insights...');
                await this.delay(2000);
                
                // Try API first, fallback to simulated
                try {
                    await this.generateInitialInsights();
                } catch (error) {
                    await this.generateSimulatedInsights();
                }
            }
        }

        // Global dashboard state
        const Dashboard = {
            currentSection: 'ai-command',
            gemmaAI: null,
            
            async initialize() {
                // Initialize Gemma Enhanced AI
                this.gemmaAI = new GemmaEnhancedAI();
                await this.gemmaAI.initialize();
                
                // Initialize Edge AI Monitor if available
                if (window.EdgeAIMonitor) {
                    await window.EdgeAIMonitor.initialize();
                }
                
                console.log('üöÄ Dashboard fully initialized with Gemma 3n');
            },

            // Enhanced refresh function that uses API
            async refreshData() {
                if (this.gemmaAI) {
                    await Promise.all([
                        this.gemmaAI.updateContextUsageFromAPI(),
                        this.gemmaAI.loadCrisisDashboardData(),
                        this.gemmaAI.generateInitialInsights(),
                        this.gemmaAI.loadPrioritizedIncidents()
                    ]);
                }
            }
        };

        // Navigation functions
        function showSection(sectionId) {
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            Dashboard.currentSection = sectionId;
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function toggleNav() {
            const nav = document.getElementById('mainNav');
            nav.classList.toggle('open');
        }

        // Enhanced AI interaction functions with API support
        async function runDeepContextAnalysis() {
            if (Dashboard.gemmaAI) {
                await Dashboard.gemmaAI.runDeepContextAnalysis();
            }
        }

        async function refreshAIInsights() {
            if (Dashboard.gemmaAI) {
                await Dashboard.gemmaAI.refreshAIInsights();
            }
        }

        // Enhanced global functions that interact with the API
        async function implementRecommendation(recommendationId) {
            const actionType = recommendationId.split('-').slice(1).join(' ');
            
            if (Dashboard.gemmaAI && Dashboard.gemmaAI.implementRecommendationViaAPI) {
                await Dashboard.gemmaAI.implementRecommendationViaAPI(recommendationId, actionType);
            } else {
                // Fallback to original behavior
                console.log('Implementing recommendation:', recommendationId);
                alert(`üéØ Implementing recommendation: ${actionType}\n\nThis would trigger the appropriate emergency response protocols.`);
            }
        }

        function viewIncident(incidentId) {
            // Enhanced to show more details
            window.open(`/admin?incident=${incidentId}`, '_blank');
        }

        function viewInsightDetails(insightId) {
            console.log('Viewing insight details:', insightId);
            alert(`üìä Detailed analysis for: ${insightId}\n\nThis would open a comprehensive analysis report with supporting data, confidence intervals, and historical comparisons.`);
        }

        // Additional interaction functions
        function alertStakeholders(alertType) {
            alert(`üì¢ Stakeholder alert sent for: ${alertType}\n\nNotifications sent to relevant agencies and emergency contacts.`);
        }

        function alertTraffic(location) {
            alert(`üö¶ Traffic alert issued for: ${location}\n\nWarning broadcast on traffic systems and mobile apps.`);
        }

        function prepareResources(resourceType) {
            alert(`üöë Resource preparation initiated for: ${resourceType}\n\nUnits are being positioned and supplies checked.`);
        }

        function activateCooling() {
            alert(`‚ùÑÔ∏è Cooling centers activated\n\nPublic cooling facilities opened and transportation arranged.`);
        }

        function optimizeResources() {
            alert(`üéØ Resource optimization implemented\n\nUnits repositioned for optimal response times.`);
        }

        function viewOptimization() {
            alert(`üìà Optimization impact analysis\n\nShowing projected response time improvements and coverage areas.`);
        }

        function runAIMapAnalysis() {
            alert(`üß† AI Map Analysis initiated\n\nAnalyzing spatial patterns, hotspots, and risk zones.`);
        }

        function reprioritizeIncidents() {
            alert(`üéØ AI re-prioritization complete\n\nIncidents ranked by severity, resources, and predicted impact.`);
        }

        function updateForecasts() {
            alert(`üîÑ Forecast models updated\n\nLatest data integrated into predictive algorithms.`);
        }

        function viewForecastDetails(forecastType) {
            alert(`üìä Detailed forecast for: ${forecastType}\n\nShowing probability distributions, confidence intervals, and recommended actions.`);
        }

        function exportContextAnalysis() {
            alert(`üìÑ Context analysis report exported\n\nComprehensive report generated with all findings and recommendations.`);
        }

        function runMapAI() {
            alert(`üß† AI map analysis running\n\nProcessing geographic data for pattern recognition and risk assessment.`);
        }

        function exportMapData() {
            alert(`üìä Map data exported\n\nIncident locations, resource positions, and risk zones exported to spreadsheet.`);
        }

        function initializeAIMap() {
            alert(`üöÄ AI-Enhanced map loading\n\nInitializing interactive map with real-time AI analysis capabilities.`);
        }

        function optimizeAllResources() {
            alert(`üéØ Full resource optimization initiated\n\nAI analyzing all units and suggesting optimal positioning.`);
        }

        function requestMutualAid() {
            alert(`üìû Mutual aid request sent\n\nCoordinating with neighboring jurisdictions for additional resources.`);
        }

        function viewResourceDetails(resourceType) {
            alert(`üöí ${resourceType} resource details\n\nShowing unit status, locations, and availability.`);
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (Dashboard.refreshData) {
                Dashboard.refreshData();
            }
        }, 300000);

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Set initial theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Initialize dashboard
            await Dashboard.initialize();
            
            console.log('üß† Gemma 3n Enhanced Emergency Operations Center fully operational');
        });

        // Handle responsive navigation
        window.addEventListener('resize', () => {
            if (window.innerWidth > 1024) {
                document.getElementById('mainNav').classList.remove('open');
            }
        });

        // Export functions for global access
        window.showSection = showSection;
        window.toggleTheme = toggleTheme;
        window.toggleNav = toggleNav;
        window.runDeepContextAnalysis = runDeepContextAnalysis;
        window.refreshAIInsights = refreshAIInsights;
        window.implementRecommendation = implementRecommendation;
        window.viewInsightDetails = viewInsightDetails;
        window.viewIncident = viewIncident;
        window.alertStakeholders = alertStakeholders;
        window.alertTraffic = alertTraffic;
        window.prepareResources = prepareResources;
        window.activateCooling = activateCooling;
        window.optimizeResources = optimizeResources;
        window.viewOptimization = viewOptimization;
        window.runAIMapAnalysis = runAIMapAnalysis;
        window.reprioritizeIncidents = reprioritizeIncidents;
        window.updateForecasts = updateForecasts;
        window.viewForecastDetails = viewForecastDetails;
        window.exportContextAnalysis = exportContextAnalysis;
        window.runMapAI = runMapAI;
        window.exportMapData = exportMapData;
        window.initializeAIMap = initializeAIMap;
        window.optimizeAllResources = optimizeAllResources;
        window.requestMutualAid = requestMutualAid;
        window.viewResourceDetails = viewResourceDetails;
    </script>
</body>
</html>