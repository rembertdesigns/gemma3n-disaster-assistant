<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3n Emergency Command Center - AI-Powered Disaster Response</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css" />
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary-color: #6b7280;
            --color-critical: #dc2626;
            --color-warning: #f59e0b;
            --color-good: #f59e0b;
            --color-optimal: #16a34a;
            --bg-color-base: #ffffff;
            --bg-color-card: #ffffff;
            --bg-color-light: #f8fafc;
            --text-color-base: #1f2937;
            --text-color-light: #6b7280;
            --text-color-inverted: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gemma-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --ai-accent: #8b5cf6;
            --critical-glow: 0 0 20px rgba(220, 38, 38, 0.3);
            --warning-glow: 0 0 15px rgba(245, 158, 11, 0.3);
            --success-glow: 0 0 15px rgba(22, 163, 74, 0.3);
        }

        [data-theme="dark"] {
            --bg-color-base: #1f2937;
            --bg-color-card: #374151;
            --bg-color-light: #4b5563;
            --text-color-base: #f9fafb;
            --text-color-light: #d1d5db;
            --border-color: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color-base);
            color: var(--text-color-base);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Enhanced Gemma 3n Status Indicator */
        .gemma-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: var(--gemma-gradient);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: gemmaGlow 3s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes gemmaGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.6); }
        }

        .gemma-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .gemma-indicator.loading {
            background: #f59e0b;
            animation: blink 1s infinite;
        }

        .gemma-indicator.error {
            background: #dc2626;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Enhanced Header with Better Contrast */
        .main-header {
            background: linear-gradient(135deg, var(--color-critical) 0%, #991b1b 100%);
            color: var(--text-color-inverted);
            padding: 1.2rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-info h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
            font-weight: 900;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .header-info p {
            opacity: 0.95;
            font-size: 1rem;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Enhanced Alert Level with Better Visibility */
        .alert-level {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 25px;
            font-weight: 900;
            font-size: 1.1rem;
            animation: pulse-alert 2s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--critical-glow);
        }

        @keyframes pulse-alert {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: var(--critical-glow);
            }
            50% { 
                opacity: 0.9; 
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
            }
        }

        .alert-level .alert-icon {
            font-size: 1.3rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-3px); }
            60% { transform: translateY(-1px); }
        }

        .header-controls {
            display: flex;
            gap: 0.75rem;
        }

        .header-btn {
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: var(--text-color-inverted);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }

        /* Enhanced Navigation */
        .main-nav {
            position: fixed;
            top: 85px;
            left: 0;
            width: 300px;
            height: calc(100vh - 85px);
            background: var(--bg-color-card);
            border-right: 2px solid var(--border-color);
            z-index: 999;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .nav-section {
            margin-bottom: 2.5rem;
        }

        .nav-title {
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--text-color-light);
            margin-bottom: 1rem;
            padding: 0 0.75rem;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-color-light);
            transform: translateX(3px);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: var(--text-color-inverted);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-dark);
        }

        .nav-item.ai-powered {
            background: var(--gemma-gradient);
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .nav-item.ai-powered::after {
            content: '🧠 Gemma 3n';
            position: absolute;
            top: -3px;
            right: -3px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--ai-accent);
            font-size: 0.65rem;
            padding: 0.3rem 0.5rem;
            border-radius: 0 10px 0 10px;
            font-weight: 900;
            text-shadow: none;
        }

        .nav-icon {
            font-size: 1.4rem;
            width: 24px;
            text-align: center;
        }

        /* Enhanced Main Content */
        .main-content {
            margin-left: 300px;
            margin-top: 85px;
            padding: 2.5rem;
            min-height: calc(100vh - 85px);
        }

        .dashboard-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .dashboard-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced AI Context Panel with Better Visual Hierarchy */
        .ai-context-panel {
            background: var(--gemma-gradient);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .ai-context-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
            animation: shimmer 4s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .context-title {
            font-size: 1.6rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .context-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 600;
        }

        /* Enhanced Context Stats with Better Contrast */
        .context-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .context-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .context-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .context-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .context-label {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 600;
        }

        /* Enhanced Live Data Indicators */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .last-updated {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-color-light);
            margin-top: 0.5rem;
        }

        .last-updated.stale {
            color: var(--color-warning);
        }

        .last-updated.error {
            color: var(--color-critical);
        }

        /* Enhanced Panel Headers with Help Icons */
        .panel {
            background: var(--bg-color-card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            position: relative;
            margin-bottom: 2rem;
        }

        .panel.critical {
            border-color: var(--color-critical);
            box-shadow: var(--critical-glow);
        }

        .panel.warning {
            border-color: var(--color-warning);
            box-shadow: var(--warning-glow);
        }

        .panel.ai-enhanced {
            border-color: var(--ai-accent);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .panel.ai-enhanced::before {
            content: '🧠 AI Enhanced';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--ai-accent);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 900;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--border-color);
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color-base);
        }

        .panel-title-icon {
            font-size: 1.6rem;
        }

        /* Enhanced Help System */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--ai-accent);
            color: white;
            font-size: 0.8rem;
            font-weight: 900;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .help-icon:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .tooltip {
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            max-width: 250px;
            white-space: normal;
            text-align: center;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .help-icon:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Enhanced Critical Alerts Section */
        .critical-alerts {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 3px solid var(--color-critical);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .critical-alerts::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--color-critical);
            animation: criticalPulse 2s infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            background: var(--color-critical);
            color: white;
            border-radius: 50%;
            font-weight: 900;
            font-size: 1.1rem;
            margin-right: 0.75rem;
            animation: bounce 2s infinite;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-color-card);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card.ai-enhanced {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-color: var(--ai-accent);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .stat-card.critical {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: var(--color-critical);
            box-shadow: var(--critical-glow);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-value.ai-value {
            color: var(--ai-accent);
        }

        .stat-value.critical-value {
            color: var(--color-critical);
        }

        .stat-label {
            color: var(--text-color-base);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-trend {
            font-size: 0.9rem;
            margin-top: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .trend-up { color: var(--color-optimal); }
        .trend-down { color: var(--color-critical); }
        .trend-stable { color: var(--color-warning); }

        /* Enhanced Insight Items */
        .insight-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--ai-accent);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
        }

        .insight-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .insight-item.critical {
            border-left-color: var(--color-critical);
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }

        .insight-item.warning {
            border-left-color: var(--color-warning);
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .insight-title {
            font-weight: 900;
            color: var(--text-color-base);
            font-size: 1.1rem;
        }

        .confidence-badge {
            background: var(--ai-accent);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 900;
            box-shadow: var(--shadow-sm);
        }

        .confidence-badge.high {
            background: var(--color-optimal);
        }

        .confidence-badge.critical {
            background: var(--color-critical);
        }

        /* Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-color-inverted);
            border: 2px solid var(--primary-dark);
        }

        .btn-critical {
            background: var(--color-critical);
            color: white;
            border: 2px solid #991b1b;
            box-shadow: var(--critical-glow);
        }

        .btn-ai {
            background: var(--ai-accent);
            color: white;
            position: relative;
            overflow: hidden;
            border: 2px solid #7c3aed;
        }

        .btn-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-ai:hover::before {
            left: 100%;
        }

        /* Enhanced Processing Status */
        .processing-status {
            background: linear-gradient(135deg, var(--ai-accent) 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .processing-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: scan 2.5s infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .processing-text {
            position: relative;
            z-index: 1;
            font-weight: 900;
            font-size: 1.1rem;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 1024px) {
            .main-nav {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .main-nav.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .gemma-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .context-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .panel {
                padding: 1.5rem;
            }
        }

        /* Alert Animations */
        @keyframes urgentFlash {
            0%, 50%, 100% { background-color: var(--color-critical); }
            25%, 75% { background-color: #991b1b; }
        }

        .urgent-alert {
            animation: urgentFlash 2s infinite;
        }

        /* Live Data Stream Indicators */
        .data-stream-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-color-light);
        }

        .stream-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--color-optimal);
            animation: pulse 1.5s infinite;
        }

        .stream-dot.warning {
            background: var(--color-warning);
        }

        .stream-dot.error {
            background: var(--color-critical);
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Enhanced Gemma 3n Status Indicator -->
    <div class="gemma-status" id="gemmaStatus" onclick="showSystemStatus()">
        <div class="gemma-indicator" id="gemmaIndicator"></div>
        <span id="gemmaStatusText">Initializing Gemma 3n...</span>
        <div class="live-indicator">
            <div class="live-dot"></div>
            <span>LIVE</span>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">🧠</div>
                <div class="header-info">
                    <h1>Gemma 3n Emergency Operations Center</h1>
                    <p>AI-powered disaster response with 128K context awareness</p>
                </div>
            </div>
            
            <div class="header-right">
                <div class="alert-level">
                    <span class="alert-icon">⚠️</span>
                    <span>ALERT LEVEL 3</span>
                    <div class="help-icon">
                        ?
                        <div class="tooltip">Current threat level based on active incidents, weather conditions, and AI risk assessment</div>
                    </div>
                </div>
                
                <div class="header-controls">
                    <button class="header-btn" onclick="toggleTheme()">🌓</button>
                    <button class="header-btn" onclick="toggleNav()">☰</button>
                    <button class="header-btn" onclick="showHelp()">❓</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav" id="mainNav">
        <div class="nav-section">
            <div class="nav-title">AI Command & Control</div>
            <div class="nav-item active ai-powered" onclick="showSection('ai-command')">
                <div class="nav-icon">🧠</div>
                <div>AI Command Center</div>
            </div>
            <div class="nav-item ai-powered" onclick="showSection('context-intelligence')">
                <div class="nav-icon">🔮</div>
                <div>Context Intelligence</div>
            </div>
            <div class="nav-item ai-powered" onclick="showSection('predictive-analysis')">
                <div class="nav-icon">📊</div>
                <div>Predictive Analysis</div>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Operations</div>
            <div class="nav-item" onclick="showSection('live-map')">
                <div class="nav-icon">🗺️</div>
                <div>Live Map</div>
            </div>
            <div class="nav-item" onclick="showSection('incidents')">
                <div class="nav-icon">🚨</div>
                <div>Active Incidents</div>
                <div class="alert-count">7</div>
            </div>
            <div class="nav-item" onclick="showSection('resources')">
                <div class="nav-icon">🚒</div>
                <div>Resource Management</div>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Data & Reports</div>
            <div class="nav-item" onclick="showSection('reports')">
                <div class="nav-icon">📋</div>
                <div>Crowd Reports</div>
            </div>
            <div class="nav-item" onclick="showSection('analytics')">
                <div class="nav-icon">📈</div>
                <div>Analytics</div>
            </div>
            <div class="nav-item" onclick="showSection('archive')">
                <div class="nav-icon">📚</div>
                <div>Archive</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- AI Command Center Section -->
        <div id="ai-command" class="dashboard-section active">
            <!-- Critical Alerts Section -->
            <div class="critical-alerts">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <div class="alert-count">3</div>
                        <h3 style="color: var(--color-critical); font-weight: 900; font-size: 1.3rem;">CRITICAL ALERTS REQUIRING IMMEDIATE ATTENTION</h3>
                        <div class="help-icon">
                            ?
                            <div class="tooltip">High-priority incidents identified by AI that require immediate commander response</div>
                        </div>
                    </div>
                    <div class="last-updated">
                        <div class="stream-dot"></div>
                        <span>Updated 23 seconds ago</span>
                    </div>
                </div>
                <div style="display: grid; gap: 1rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--color-critical);">
                        <strong>⚠️ STRUCTURE FIRE - Expanding to adjacent buildings</strong>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Oak Street - AI detected structural failure risk in 12 minutes</div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Gemma 3n Context Intelligence Panel -->
            <div class="ai-context-panel">
                <div class="context-header">
                    <div>
                        <div class="context-title">
                            <span>🧠</span>
                            Gemma 3n Context Intelligence
                            <div class="help-icon">
                                ?
                                <div class="tooltip">AI system processing emergency data across 128K token context window for comprehensive situational awareness</div>
                            </div>
                        </div>
                        <div class="context-subtitle">128K Token Context Window</div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>PROCESSING LIVE DATA</span>
                    </div>
                </div>
                
                <div class="context-window">
                    <div class="context-progress">
                        <span style="font-weight: bold;">Context Usage:</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="contextProgressFill" style="width: 0%"></div>
                        </div>
                        <span id="contextUsageText">0% (0/128K tokens)</span>
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Shows how much of the AI's context window is being used to process emergency data</div>
                        </div>
                    </div>
                    
                    <div class="context-sources">
                        <div class="context-source">
                            <div>📊 Reports</div>
                            <div id="contextReports">0</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot"></div>
                                <span>live</span>
                            </div>
                        </div>
                        <div class="context-source">
                            <div>🌤️ Weather</div>
                            <div id="contextWeather">Loading</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot"></div>
                                <span>live</span>
                            </div>
                        </div>
                        <div class="context-source">
                            <div>🗺️ Location</div>
                            <div id="contextLocation">GPS</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot"></div>
                                <span>live</span>
                            </div>
                        </div>
                        <div class="context-source">
                            <div>🏗️ Infrastructure</div>
                            <div id="contextInfra">Online</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot"></div>
                                <span>live</span>
                            </div>
                        </div>
                        <div class="context-source">
                            <div>👥 Population</div>
                            <div id="contextPop">Census</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot warning"></div>
                                <span>delayed</span>
                            </div>
                        </div>
                        <div class="context-source">
                            <div>📱 Social</div>
                            <div id="contextSocial">Feeds</div>
                            <div class="data-stream-indicator">
                                <div class="stream-dot"></div>
                                <span>live</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="context-stats">
                    <div class="context-stat">
                        <div class="context-value" id="aiAccuracy">94.7%</div>
                        <div class="context-label">AI Accuracy</div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Updated 15s ago</span>
                        </div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="processingSpeed">1.2s</div>
                        <div class="context-label">Avg Processing</div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Real-time</span>
                        </div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="modelsActive">7</div>
                        <div class="context-label">Active Models</div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>All operational</span>
                        </div>
                    </div>
                    <div class="context-stat">
                        <div class="context-value" id="insights">23</div>
                        <div class="context-label">AI Insights</div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Updated 8s ago</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time AI Processing Status -->
            <div class="processing-status" id="processingStatus" style="display: none;">
                <div class="processing-text" id="processingText">
                    🧠 Gemma 3n processing 47 emergency reports with 128K context...
                </div>
            </div>

            <!-- Enhanced Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value" id="aiProcessedReports">127</div>
                    <div class="stat-label">AI Processed Reports</div>
                    <div class="stat-trend trend-up">↗ +15 this hour</div>
                    <div class="last-updated">
                        <div class="stream-dot"></div>
                        <span>Updated 12s ago</span>
                    </div>
                </div>
                <div class="stat-card critical">
                    <div class="stat-value critical-value">7</div>
                    <div class="stat-label">Active Incidents</div>
                    <div class="stat-trend trend-down">↘ -2 from yesterday</div>
                    <div class="last-updated">
                        <div class="stream-dot"></div>
                        <span>Updated 5s ago</span>
                    </div>
                </div>
                <div class="stat-card ai-enhanced">
                    <div class="stat-value ai-value" id="riskScore">7.2</div>
                    <div class="stat-label">AI Risk Score</div>
                    <div class="stat-trend trend-stable">→ Stable</div>
                    <div class="last-updated">
                        <div class="stream-dot"></div>
                        <span>Updated 3s ago</span>
                    </div>
                    <div class="help-icon" style="position: absolute; top: 10px; right: 10px;">
                        ?
                        <div class="tooltip">Composite risk score from 1-10 based on current incidents, weather, and predictive models</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">45</div>
                    <div class="stat-label">Units Deployed</div>
                    <div class="stat-trend trend-stable">→ Optimal</div>
                    <div class="last-updated">
                        <div class="stream-dot"></div>
                        <span>Updated 18s ago</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced AI-Generated Insights -->
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">🧠</span>
                        Gemma 3n Real-time Insights
                        <div class="help-icon">
                            ?
                            <div class="tooltip">AI-generated insights from analyzing all emergency data sources for pattern recognition and predictions</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>ANALYZING</span>
                        </div>
                        <button class="btn btn-ai" onclick="refreshAIInsights()">
                            🔄 Refresh Analysis
                        </button>
                    </div>
                </div>
                
                <div id="aiInsightsList">
                    <div class="insight-item critical">
                        <div class="insight-header">
                            <div class="insight-title">🔥 Fire Risk Elevation Detected</div>
                            <div class="confidence-badge critical">92% Confidence</div>
                        </div>
                        <div class="insight-description">
                            AI analysis of weather patterns, historical data, and current conditions indicates elevated fire risk in downtown area between 2:00 PM - 6:00 PM today. Wind speed increasing to 25 mph with low humidity (18%).
                        </div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Generated 45 seconds ago</span>
                        </div>
                        <div class="insight-actions" style="margin-top: 1rem;">
                            <button class="btn btn-critical" onclick="implementRecommendation('fire-risk-deploy-units')">🚒 Deploy Units</button>
                            <button class="btn btn-primary" onclick="viewInsightDetails('fire-risk')">📊 View Analysis</button>
                            <button class="btn btn-primary" onclick="alertStakeholders('fire-risk')">📢 Alert Agencies</button>
                        </div>
                    </div>

                    <div class="insight-item warning">
                        <div class="insight-header">
                            <div class="insight-title">🚗 Traffic Incident Prediction</div>
                            <div class="confidence-badge">85% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Machine learning model predicts 67% higher accident probability on Highway 101 northbound during evening rush (5:00-7:00 PM) due to weather conditions and historical patterns.
                        </div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Generated 2 minutes ago</span>
                        </div>
                        <div class="insight-actions" style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="implementRecommendation('traffic-position-units')">🚓 Position Units</button>
                            <button class="btn btn-primary" onclick="alertTraffic('highway-101')">🚦 Traffic Alert</button>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">🏥 Medical Volume Surge</div>
                            <div class="confidence-badge">78% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Heat wave correlation analysis shows 34% increase in respiratory emergencies likely over next 3 days. Current air quality index: 127 (Unhealthy for Sensitive Groups).
                        </div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Generated 4 minutes ago</span>
                        </div>
                        <div class="insight-actions" style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="prepareResources('medical-surge')">🚑 Prep Resources</button>
                            <button class="btn btn-primary" onclick="activateCooling()">❄️ Cooling Centers</button>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-header">
                            <div class="insight-title">📍 Resource Optimization</div>
                            <div class="confidence-badge high">96% Confidence</div>
                        </div>
                        <div class="insight-description">
                            Geospatial analysis indicates 23% response time improvement possible by relocating Ambulance 7 from Station C to Station 12 during peak hours (3:00-8:00 PM).
                        </div>
                        <div class="last-updated">
                            <div class="stream-dot"></div>
                            <span>Generated 6 minutes ago</span>
                        </div>
                        <div class="insight-actions" style="margin-top: 1rem;">
                            <button class="btn btn-ai" onclick="optimizeResources()">🎯 Implement</button>
                            <button class="btn btn-primary" onclick="viewOptimization()">📈 View Impact</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Command Grid -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 3rem; margin-bottom: 3rem;">
                <div class="panel ai-enhanced">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon">🗺️</span>
                            AI-Enhanced Situation Map
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Interactive map with AI-powered incident clustering and predictive risk zones</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span>LIVE MAP</span>
                            </div>
                            <button class="btn btn-ai" onclick="runAIMapAnalysis()">🧠 AI Analysis</button>
                        </div>
                    </div>
                    <div style="height: 400px; background: var(--bg-color-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color);">
                        <div style="text-align: center; color: var(--text-color-light);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🗺️</div>
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">AI-Enhanced Interactive Map</div>
                            <div>Real-time incidents, predictive hotspots, resource positions</div>
                        </div>
                    </div>
                </div>

                <div class="panel ai-enhanced critical">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon">🚨</span>
                            AI-Prioritized Incidents
                            <div class="help-icon">
                                ?
                                <div class="tooltip">Incidents automatically prioritized by AI based on severity, resources needed, and potential impact</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span>LIVE FEED</span>
                            </div>
                            <button class="btn btn-ai" onclick="reprioritizeIncidents()">🎯 Re-prioritize</button>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;" data-incidents-container>
                        <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid #dc2626; cursor: pointer;" onclick="viewIncident(1)">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold;">🔥 Structure Fire - Oak Street</div>
                                <div style="font-size: 0.8rem; color: var(--text-color-light);">AI Priority: 9.7/10</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                Multi-story residential. AI detected: structural damage, smoke patterns, 15+ people in building via thermal analysis.
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="background: #dc2626; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">CRITICAL</span>
                                <span style="background: #16a34a; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">COMMAND EST.</span>
                            </div>
                            <div class="last-updated">
                                <div class="stream-dot"></div>
                                <span>Updated 8 seconds ago</span>
                            </div>
                        </div>

                        <div style="background: var(--bg-color-light); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid #f59e0b; cursor: pointer;" onclick="viewIncident(2)">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold;">🚗 MVA Highway 101</div>
                                <div style="font-size: 0.8rem; color: var(--text-color-light);">AI Priority: 7.3/10</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                Multi-vehicle accident. AI analysis: 3 vehicles, likely injuries, traffic backup 2.1 miles.
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="background: #f59e0b; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">HIGH</span>
                                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.6rem; border-radius: 16px; font-size: 0.75rem; font-weight: bold;">EN ROUTE</span>
                            </div>
                            <div class="last-updated">
                                <div class="stream-dot"></div>
                                <span>Updated 32 seconds ago</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other sections remain the same structure but with enhanced visual hierarchy -->
        <div id="context-intelligence" class="dashboard-section">
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">🔮</span>
                        Deep Context Analysis Engine
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Advanced AI analysis across all data sources to identify patterns and correlations</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>PROCESSING</span>
                        </div>
                        <button class="btn btn-ai" onclick="runDeepContextAnalysis()">
                            🧠 Analyze All Context
                        </button>
                    </div>
                </div>
                
                <div id="deepAnalysisResults">
                    <div style="text-align: center; padding: 3rem; color: var(--text-color-light);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🧠</div>
                        <div style="font-size: 1.2rem; margin-bottom: 1rem;">Ready for Deep Context Analysis</div>
                        <div>Click "Analyze All Context" to process all data sources with Gemma 3n's 128K context window</div>
                        <button class="btn btn-ai" style="margin-top: 1.5rem;" onclick="runDeepContextAnalysis()">
                            🚀 Start Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remaining sections with similar enhancements -->
        <div id="predictive-analysis" class="dashboard-section">
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">📊</span>
                        Predictive Emergency Intelligence
                        <div class="help-icon">
                            ?
                            <div class="tooltip">AI forecasting system predicting future incidents based on historical patterns and current conditions</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>FORECASTING</span>
                    </div>
                </div>
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                    <div style="font-size: 1.5rem;">Predictive Analysis Dashboard</div>
                    <div>AI-powered forecasting and risk assessment</div>
                </div>
            </div>
        </div>

        <div id="live-map" class="dashboard-section">
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">🗺️</span>
                        AI-Enhanced Live Emergency Map
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Interactive emergency map with real-time incident tracking and AI-powered analysis</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>LIVE MAP</span>
                    </div>
                </div>
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🗺️</div>
                    <div style="font-size: 1.5rem;">Live Emergency Map</div>
                    <div>Real-time incident tracking and resource deployment</div>
                </div>
            </div>
        </div>

        <div id="resources" class="dashboard-section">
            <div class="panel ai-enhanced">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">🚒</span>
                        AI-Optimized Resource Management
                        <div class="help-icon">
                            ?
                            <div class="tooltip">AI-powered resource allocation and deployment optimization for maximum efficiency</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>OPTIMIZING</span>
                    </div>
                </div>
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🚒</div>
                    <div style="font-size: 1.5rem;">Resource Management</div>
                    <div>AI-optimized deployment and allocation</div>
                </div>
            </div>
        </div>

        <!-- Remaining sections -->
        <div id="reports" class="dashboard-section">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">📋</span>
                        Crowd Reports
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Citizen-reported incidents processed and verified by AI systems</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>PROCESSING</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics" class="dashboard-section">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">📈</span>
                        Analytics Dashboard
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Advanced AI-powered analytics and insights from historical and real-time data</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>ANALYZING</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="incidents" class="dashboard-section">
            <div class="panel critical">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">🚨</span>
                        Incident Management
                        <div class="help-icon">
                            ?
                            <div class="tooltip">Real-time incident tracking with AI-powered prioritization and resource coordination</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="alert-count">7</div>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>ACTIVE INCIDENTS</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="archive" class="dashboard-section">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="panel-title-icon">📚</span>
                        Historical Archive
                        <div class="help-icon">
                            ?
                            <div class="tooltip">AI-powered search and pattern analysis of historical emergency data</div>
                        </div>
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot warning"></div>
                        <span>INDEXING</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Enhanced Gemma 3n AI Engine with Improved UX Features -->
    <script>
        // Enhanced GemmaEnhancedAI class with better user experience features
        class GemmaEnhancedAI {
            constructor() {
                this.isGemmaReady = false;
                this.contextTokens = 0;
                this.maxTokens = 128000;
                this.apiBaseUrl = '';
                this.wsConnection = null;
                this.processingQueue = [];
                this.insights = [];
                this.lastUpdateTimes = {};
                this.dataStreams = {
                    reports: [],
                    weather: null,
                    location: null,
                    infrastructure: null,
                    population: null,
                    social: []
                };
                
                // Enhanced performance tracking
                this.performance = {
                    totalProcessed: 0,
                    averageLatency: 0,
                    accuracy: 94.7,
                    contextUtilization: 0
                };
                
                console.log('🧠 Enhanced Gemma 3n AI with improved UX initializing...');
                this.initializeRealTimeUpdates();
            }

            // Initialize real-time update system
            initializeRealTimeUpdates() {
                // Update timestamps every second
                setInterval(() => {
                    this.updateAllTimestamps();
                }, 1000);

                // Simulate data stream status changes
                setInterval(() => {
                    this.updateDataStreamStatus();
                }, 3000);

                // Update processing indicators
                setInterval(() => {
                    this.updateProcessingIndicators();
                }, 2000);
            }

            // Enhanced initialize with better error handling and user feedback
            async initialize() {
                try {
                    this.updateGemmaStatus('loading', 'Connecting to Gemma 3n systems...');
                    
                    // Simulate initialization steps with user feedback
                    await this.initializeWithProgress();
                    
                    this.isGemmaReady = true;
                    this.updateGemmaStatus('ready', 'Gemma 3n fully operational - All systems online');
                    
                    console.log('🚀 Enhanced Gemma 3n AI fully operational with improved UX');
                    
                } catch (error) {
                    console.error('❌ Gemma 3n initialization failed:', error);
                    this.updateGemmaStatus('error', 'System error - Operating in degraded mode');
                    await this.initializeWithSimulatedData();
                }
            }

            // Initialize with progress feedback
            async initializeWithProgress() {
                const steps = [
                    { message: 'Loading emergency data streams...', delay: 1000 },
                    { message: 'Initializing AI models...', delay: 1500 },
                    { message: 'Establishing context window...', delay: 800 },
                    { message: 'Connecting to live data feeds...', delay: 1200 },
                    { message: 'Running system diagnostics...', delay: 900 },
                    { message: 'Calibrating prediction algorithms...', delay: 1100 }
                ];

                for (const step of steps) {
                    this.updateGemmaStatus('loading', step.message);
                    await this.delay(step.delay);
                }

                // Initialize data streams
                await this.initializeDataStreams();
                
                // Generate initial insights
                await this.generateInitialInsights();
                
                // Start real-time processing
                this.startRealTimeProcessing();
            }

            // Enhanced data stream initialization
            async initializeDataStreams() {
                this.showProcessingStatus('🔄 Loading data streams...');
                
                // Load each data stream with progress
                this.dataStreams.reports = await this.loadEmergencyReports();
                this.lastUpdateTimes.reports = Date.now();
                
                this.dataStreams.weather = await this.loadWeatherData();
                this.lastUpdateTimes.weather = Date.now();
                
                this.dataStreams.infrastructure = await this.loadInfrastructureData();
                this.lastUpdateTimes.infrastructure = Date.now();
                
                this.dataStreams.population = await this.loadPopulationData();
                this.lastUpdateTimes.population = Date.now() - 120000; // Simulate delayed data
                
                this.dataStreams.social = await this.loadSocialMediaFeeds();
                this.lastUpdateTimes.social = Date.now();
                
                // Update context usage
                this.updateContextUsage();
                
                this.hideProcessingStatus();
                console.log('📊 All data streams initialized with timestamps');
            }

            // Enhanced context usage display
            updateContextUsage() {
                let totalTokens = 0;
                
                // Calculate tokens from each data stream
                totalTokens += this.dataStreams.reports.reduce((sum, report) => sum + report.tokens, 0);
                totalTokens += this.dataStreams.weather?.tokens || 0;
                totalTokens += this.dataStreams.infrastructure?.tokens || 0;
                totalTokens += this.dataStreams.population?.tokens || 0;
                totalTokens += this.dataStreams.social?.tokens || 0;
                
                this.contextTokens = totalTokens;
                const percentage = Math.min(100, (totalTokens / this.maxTokens) * 100);
                
                // Enhanced UI updates with better formatting
                this.updateElement('contextProgressFill', null, `width: ${percentage}%`);
                this.updateElement('contextUsageText', `${percentage.toFixed(1)}% (${this.formatNumber(totalTokens)}/128K tokens)`);
                this.updateElement('tokensProcessed', `${this.formatNumber(totalTokens)} / 128K`);
                this.updateElement('contextUtilization', `${percentage.toFixed(1)}%`);
                
                // Update individual source counts with enhanced formatting
                this.updateElement('contextReports', this.formatNumber(this.dataStreams.reports.length));
                this.updateElement('contextWeather', 'Active');
                this.updateElement('contextLocation', 'GPS Active');
                this.updateElement('contextInfra', `${this.dataStreams.infrastructure?.facilities || 891} facilities`);
                this.updateElement('contextPop', `${this.dataStreams.population?.districts || 67} districts`);
                this.updateElement('contextSocial', `${this.formatNumber(this.dataStreams.social?.posts || 15400)} posts`);
            }

            // Update all timestamp displays
            updateAllTimestamps() {
                const now = Date.now();
                
                // Update last updated displays throughout the interface
                Object.keys(this.lastUpdateTimes).forEach(key => {
                    const timeDiff = now - this.lastUpdateTimes[key];
                    const timeString = this.formatTimeAgo(timeDiff);
                    
                    // Update corresponding UI elements
                    const elements = document.querySelectorAll(`[data-update-${key}]`);
                    elements.forEach(el => {
                        el.textContent = `Updated ${timeString}`;
                        
                        // Add warning classes for stale data
                        el.className = 'last-updated';
                        if (timeDiff > 60000) el.classList.add('stale'); // Over 1 minute
                        if (timeDiff > 300000) el.classList.add('error'); // Over 5 minutes
                    });
                });

                // Update general timestamps
                this.updateTimestampElements();
            }

            // Update timestamp elements with relative time
            updateTimestampElements() {
                const elements = document.querySelectorAll('.last-updated span');
                elements.forEach(el => {
                    if (el.textContent.includes('Updated') && el.textContent.includes('ago')) {
                        // Update existing timestamps
                        const match = el.textContent.match(/Updated (\d+)/);
                        if (match) {
                            const seconds = parseInt(match[1]) + 1;
                            el.textContent = `Updated ${seconds}s ago`;
                        }
                    }
                });
            }

            // Update data stream status indicators
            updateDataStreamStatus() {
                const streams = document.querySelectorAll('.data-stream-indicator .stream-dot');
                streams.forEach((dot, index) => {
                    // Randomly simulate status changes
                    if (Math.random() > 0.9) {
                        dot.className = 'stream-dot';
                        if (Math.random() > 0.8) {
                            dot.classList.add('warning');
                        } else if (Math.random() > 0.95) {
                            dot.classList.add('error');
                        }
                    }
                });
            }

            // Enhanced insights generation with better visual feedback
            async generateInitialInsights() {
                this.showProcessingStatus('🧠 Analyzing 128K context for critical insights...');
                
                // Simulate progressive insight generation
                const insightSteps = [
                    'Analyzing weather patterns and fire risk...',
                    'Processing traffic flow predictions...',
                    'Correlating medical emergency patterns...',
                    'Optimizing resource deployment...',
                    'Generating recommendations...'
                ];

                for (const step of insightSteps) {
                    this.updateProcessingStatus(step);
                    await this.delay(800);
                }
                
                // Generate enhanced insights with timestamps
                this.insights = [
                    {
                        id: 1,
                        type: 'fire_risk',
                        title: 'Fire Risk Elevation Detected',
                        confidence: 92,
                        description: 'AI analysis of weather patterns, historical data, and current conditions indicates elevated fire risk in downtown area between 2:00 PM - 6:00 PM today. Wind speed increasing to 25 mph with low humidity (18%).',
                        recommendations: ['Deploy fire units', 'Issue public alert', 'Monitor weather'],
                        priority: 'critical',
                        timestamp: Date.now(),
                        fresh: true
                    },
                    {
                        id: 2,
                        type: 'traffic_prediction',
                        title: 'Traffic Incident Prediction',
                        confidence: 85,
                        description: 'Machine learning model predicts 67% higher accident probability on Highway 101 during evening rush hour due to weather conditions and historical patterns.',
                        recommendations: ['Position traffic units', 'Issue traffic alert'],
                        priority: 'high',
                        timestamp: Date.now() - 120000
                    },
                    {
                        id: 3,
                        type: 'medical_surge',
                        title: 'Medical Volume Surge',
                        confidence: 78,
                        description: 'Heat wave correlation analysis shows 34% increase in respiratory emergencies likely over next 3 days. Current air quality index: 127 (Unhealthy for Sensitive Groups).',
                        recommendations: ['Prepare resources', 'Activate cooling centers'],
                        priority: 'medium',
                        timestamp: Date.now() - 240000
                    },
                    {
                        id: 4,
                        type: 'resource_optimization',
                        title: 'Resource Optimization',
                        confidence: 96,
                        description: 'Geospatial analysis indicates 23% response time improvement possible by relocating Ambulance 7 from Station C to Station 12 during peak hours (3:00-8:00 PM).',
                        recommendations: ['Implement optimization', 'View impact analysis'],
                        priority: 'medium',
                        timestamp: Date.now() - 360000
                    }
                ];
                
                this.hideProcessingStatus();
                this.updateInsightsDisplay();
                this.updatePerformanceDisplay();
            }

            // Enhanced insights display with timestamps and priority styling
            updateInsightsDisplay() {
                const container = document.getElementById('aiInsightsList');
                if (!container) return;
                
                container.innerHTML = this.insights.slice(0, 4).map(insight => {
                    const priorityClass = insight.priority === 'critical' ? 'critical' : 
                                         insight.priority === 'high' ? 'warning' : '';
                    const confidenceClass = insight.confidence >= 90 ? 'critical' : 
                                           insight.confidence >= 80 ? 'high' : '';
                    const timeAgo = this.formatTimeAgo(Date.now() - insight.timestamp);
                    
                    return `
                        <div class="insight-item ${priorityClass} ${insight.fresh ? 'processing' : ''}">
                            <div class="insight-header">
                                <div class="insight-title">${this.getInsightIcon(insight.type)} ${insight.title}</div>
                                <div class="confidence-badge ${confidenceClass}">${insight.confidence}% Confidence</div>
                            </div>
                            <div class="insight-description">${insight.description}</div>
                            <div class="last-updated">
                                <div class="stream-dot"></div>
                                <span>Generated ${timeAgo}</span>
                            </div>
                            <div class="insight-actions" style="margin-top: 1rem;">
                                ${insight.recommendations.map(rec => {
                                    const btnClass = insight.priority === 'critical' ? 'btn-critical' : 'btn-primary';
                                    return `<button class="btn ${btnClass}" onclick="implementRecommendation('${insight.id}-${rec.replace(/\s+/g, '-').toLowerCase()}')">${this.getActionIcon(rec)} ${rec}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Remove fresh flag after display
                this.insights.forEach(insight => delete insight.fresh);
            }

            // Get appropriate action icons
            getActionIcon(action) {
                const icons = {
                    'Deploy fire units': '🚒',
                    'Issue public alert': '📢',
                    'Monitor weather': '🌤️',
                    'Position traffic units': '🚓',
                    'Issue traffic alert': '🚦',
                    'Prepare resources': '🚑',
                    'Activate cooling centers': '❄️',
                    'Implement optimization': '🎯',
                    'View impact analysis': '📈'
                };
                return icons[action] || '⚡';
            }

            // Enhanced processing status updates
            updateProcessingStatus(message) {
                const textElement = document.getElementById('processingText');
                if (textElement) {
                    textElement.textContent = `🧠 ${message}`;
                }
            }

            // Format time differences into human-readable strings
            formatTimeAgo(timeDiff) {
                const seconds = Math.floor(timeDiff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                if (seconds < 60) return `${seconds}s ago`;
                if (minutes < 60) return `${minutes}m ago`;
                return `${hours}h ago`;
            }

            // Enhanced performance display
            updatePerformanceDisplay() {
                this.updateElement('aiProcessedReports', this.formatNumber(this.performance.totalProcessed));
                this.updateElement('aiAccuracy', `${this.performance.accuracy.toFixed(1)}%`);
                this.updateElement('processingSpeed', `${(1.2 + Math.random() * 0.6).toFixed(1)}s`);
                this.updateElement('modelsActive', '7');
                this.updateElement('insights', this.insights.length);
                
                // Update risk score with dynamic calculation
                const riskScore = this.calculateRiskScore();
                this.updateElement('riskScore', riskScore.toFixed(1));
            }

            // Calculate dynamic risk score based on current conditions
            calculateRiskScore() {
                let baseRisk = 5.0;
                
                // Increase risk based on critical insights
                const criticalInsights = this.insights.filter(i => i.priority === 'critical').length;
                baseRisk += criticalInsights * 1.5;
                
                // Weather factor
                if (this.dataStreams.weather?.current?.windSpeed > 20) baseRisk += 0.8;
                if (this.dataStreams.weather?.current?.humidity < 20) baseRisk += 0.5;
                
                // Time-based factor (higher risk during peak hours)
                const hour = new Date().getHours();
                if (hour >= 14 && hour <= 18) baseRisk += 0.4; // Peak incident hours
                
                return Math.min(10.0, Math.max(1.0, baseRisk));
            }

            // Enhanced status updates with better visual feedback
            updateGemmaStatus(status, message) {
                const indicator = document.getElementById('gemmaIndicator');
                const text = document.getElementById('gemmaStatusText');
                
                if (indicator) {
                    indicator.className = 'gemma-indicator';
                    if (status === 'loading') indicator.classList.add('loading');
                    if (status === 'error') indicator.classList.add('error');
                }
                
                if (text) {
                    text.textContent = message;
                }
                
                // Update overall system status display
                this.updateSystemStatusDisplay(status, message);
            }

            // Update system status display
            updateSystemStatusDisplay(status, message) {
                // Update any system status panels
                const statusElements = document.querySelectorAll('[data-system-status]');
                statusElements.forEach(el => {
                    el.textContent = message;
                    el.className = `system-status ${status}`;
                });
            }

            // Simulate data loading methods (enhanced with progress)
            async loadEmergencyReports() {
                const reports = [];
                for (let i = 0; i < 127; i++) {
                    reports.push({
                        id: i + 1,
                        timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000),
                        type: ['fire', 'medical', 'traffic', 'weather', 'infrastructure'][Math.floor(Math.random() * 5)],
                        severity: Math.floor(Math.random() * 10) + 1,
                        location: [34.05 + (Math.random() - 0.5) * 0.1, -118.25 + (Math.random() - 0.5) * 0.1],
                        description: `Emergency incident ${i + 1}`,
                        tokens: Math.floor(Math.random() * 200) + 50
                    });
                }
                return reports;
            }

            async loadWeatherData() {
                return {
                    current: {
                        temperature: 85,
                        humidity: 18,
                        windSpeed: 25,
                        airQuality: 127
                    },
                    forecast: {
                        fireRisk: 'high',
                        precipitation: 0,
                        alerts: ['Heat Advisory', 'Wind Advisory']
                    },
                    tokens: 1500
                };
            }

            async loadInfrastructureData() {
                return {
                    facilities: 891,
                    powerGrid: 'stable',
                    communications: 'operational',
                    transportation: 'congested',
                    tokens: 2100
                };
            }

            async loadPopulationData() {
                return {
                    districts: 67,
                    totalPopulation: 1250000,
                    densityMap: 'loaded',
                    vulnerablePopulations: 45000,
                    tokens: 8900
                };
            }

            async loadSocialMediaFeeds() {
                return {
                    posts: 15432,
                    emergencyMentions: 234,
                    sentiment: 'concerned',
                    trendingTopics: ['fire', 'evacuation', 'traffic'],
                    tokens: 18200
                };
            }

            // Enhanced real-time processing
            startRealTimeProcessing() {
                // Process new data every 5 seconds
                setInterval(() => {
                    this.processRealTimeData();
                }, 5000);
                
                // Update processing indicators every 2 seconds
                setInterval(() => {
                    this.updateProcessingIndicators();
                }, 2000);
                
                // Update performance metrics every 10 seconds
                setInterval(() => {
                    this.updatePerformanceDisplay();
                }, 10000);
            }

            // Process real-time data with better feedback
            async processRealTimeData() {
                const newReports = Math.floor(Math.random() * 3);
                if (newReports > 0) {
                    for (let i = 0; i < newReports; i++) {
                        const report = {
                            id: this.dataStreams.reports.length + 1,
                            timestamp: new Date(),
                            type: ['fire', 'medical', 'traffic'][Math.floor(Math.random() * 3)],
                            severity: Math.floor(Math.random() * 10) + 1,
                            location: [34.05 + (Math.random() - 0.5) * 0.1, -118.25 + (Math.random() - 0.5) * 0.1],
                            description: `New emergency incident`,
                            tokens: Math.floor(Math.random() * 200) + 50
                        };
                        
                        this.dataStreams.reports.push(report);
                        
                        // Update last update time
                        this.lastUpdateTimes.reports = Date.now();
                        
                        // Process with AI if significant
                        if (report.severity >= 7) {
                            await this.processHighSeverityReport(report);
                        }
                    }
                    
                    this.updateContextUsage();
                    this.performance.totalProcessed += newReports;
                }
            }

            // Enhanced processing indicators
            updateProcessingIndicators() {
                // Update analysis cards with realistic data and timestamps
                this.updateAnalysisCard('imageAnalysisCard', {
                    queue: Math.floor(Math.random() * 5),
                    hazards: 3 + Math.floor(Math.random() * 3),
                    accuracy: 97.3 + (Math.random() - 0.5) * 0.4
                });
                
                this.updateAnalysisCard('textAnalysisCard', {
                    queue: Math.floor(Math.random() * 8),
                    panicLevel: ['Calm', 'Concerned', 'Elevated', 'Critical'][Math.floor(Math.random() * 4)],
                    accuracy: 94.2 + (Math.random() - 0.5) * 0.6
                });
                
                this.updateAnalysisCard('locationAnalysisCard', {
                    gpsReports: this.dataStreams.reports.length,
                    riskAreas: 12 + Math.floor(Math.random() * 3),
                    accuracy: 89.1 + (Math.random() - 0.5) * 0.8
                });
                
                this.updateAnalysisCard('predictionCard', {
                    forecasts: 8,
                    nextEvent: '2:15 PM',
                    confidence: 87 + Math.floor(Math.random() * 8)
                });
            }

            // Enhanced update analysis card method
            updateAnalysisCard(cardId, data) {
                const card = document.getElementById(cardId);
                if (!card) return;
                
                const statusDot = card.querySelector('.status-indicator');
                if (statusDot) {
                    statusDot.className = 'status-indicator';
                    if (Math.random() > 0.8) {
                        statusDot.classList.add('processing');
                    }
                }
                
                // Update specific data with enhanced formatting
                if (data.queue !== undefined) {
                    const queueId = cardId === 'imageAnalysisCard' ? 'imageQueue' : 'textQueue';
                    this.updateElement(queueId, data.queue);
                }
                if (data.hazards) this.updateElement('hazardsDetected', data.hazards);
                if (data.accuracy) {
                    const accuracyId = cardId === 'imageAnalysisCard' ? 'imageAccuracy' : 
                                     cardId === 'textAnalysisCard' ? 'textAccuracy' : 'locationAccuracy';
                    this.updateElement(accuracyId, `${data.accuracy.toFixed(1)}%`);
                }
                if (data.panicLevel) this.updateElement('panicLevel', data.panicLevel);
                if (data.gpsReports) this.updateElement('gpsReports', data.gpsReports);
                if (data.riskAreas) this.updateElement('riskAreas', data.riskAreas);
                if (data.forecasts) this.updateElement('activeForecast', data.forecasts);
                if (data.nextEvent) this.updateElement('nextEvent', data.nextEvent);
                if (data.confidence) this.updateElement('predictionConfidence', `${data.confidence}%`);
            }

            // Utility methods
            getInsightIcon(type) {
                const icons = {
                    fire_risk: '🔥',
                    traffic_prediction: '🚗',
                    medical_surge: '🏥',
                    resource_optimization: '📍',
                    weather_alert: '🌩️',
                    infrastructure: '🏗️',
                    security: '🔒'
                };
                return icons[type] || '⚠️';
            }

            showProcessingStatus(message) {
                const status = document.getElementById('processingStatus');
                const text = document.getElementById('processingText');
                if (status && text) {
                    text.textContent = message;
                    status.style.display = 'block';
                }
            }

            hideProcessingStatus() {
                const status = document.getElementById('processingStatus');
                if (status) {
                    status.style.display = 'none';
                }
            }

            updateElement(id, content, style) {
                const element = document.getElementById(id);
                if (element) {
                    if (content !== null && content !== undefined) element.textContent = content;
                    if (style) element.style.cssText += style;
                }
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num?.toString() || '0';
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Public methods for enhanced UI interactions
            async refreshAIInsights() {
                this.showProcessingStatus('🔄 Refreshing AI insights with latest data...');
                await this.delay(2000);
                await this.generateInitialInsights();
            }

            async runDeepContextAnalysis() {
                this.showProcessingStatus('🧠 Running comprehensive context analysis...');
                await this.delay(3000);
                
                // Generate analysis results
                const results = {
                    patterns_identified: 23 + Math.floor(Math.random() * 10),
                    cross_correlations: 15 + Math.floor(Math.random() * 8),
                    predictions_generated: 8 + Math.floor(Math.random() * 5),
                    anomalies_detected: 3 + Math.floor(Math.random() * 4),
                    key_findings: [
                        '🔥 Fire risk correlation with wind patterns: 94% accuracy',
                        '🚗 Traffic incident prediction improved by 23% with weather data',
                        '🏥 Medical emergency volume correlates with air quality (r=0.78)',
                        '📍 Geographic clustering reveals 3 high-risk zones',
                        '⏰ Temporal patterns show peak incident times: 2-4 PM, 6-8 PM'
                    ],
                    processing_time: '4.2s',
                    confidence_score: 94 + Math.floor(Math.random() * 6)
                };

                this.displayDeepAnalysisResults(results);
                this.hideProcessingStatus();
            }

            displayDeepAnalysisResults(results) {
                const container = document.getElementById('deepAnalysisResults');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="padding: 2rem;">
                        <h3 style="color: var(--ai-accent); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            🧠 Gemma 3n Deep Analysis Complete
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span>COMPLETED</span>
                            </div>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 12px; text-align: center; border: 2px solid var(--ai-accent);">
                                <div style="font-size: 2.5rem; font-weight: 900; color: var(--ai-accent); margin-bottom: 0.5rem;">${results.patterns_identified}</div>
                                <div style="font-weight: 700;">Patterns Identified</div>
                                <div class="last-updated">
                                    <div class="stream-dot"></div>
                                    <span>Just completed</span>
                                </div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 12px; text-align: center; border: 2px solid var(--color-optimal);">
                                <div style="font-size: 2.5rem; font-weight: 900; color: var(--color-optimal); margin-bottom: 0.5rem;">${results.cross_correlations}</div>
                                <div style="font-weight: 700;">Cross-Correlations</div>
                                <div class="last-updated">
                                    <div class="stream-dot"></div>
                                    <span>Just completed</span>
                                </div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 12px; text-align: center; border: 2px solid var(--color-warning);">
                                <div style="font-size: 2.5rem; font-weight: 900; color: var(--color-warning); margin-bottom: 0.5rem;">${results.predictions_generated}</div>
                                <div style="font-weight: 700;">Predictions Generated</div>
                                <div class="last-updated">
                                    <div class="stream-dot"></div>
                                    <span>Just completed</span>
                                </div>
                            </div>
                            <div style="background: var(--bg-color-light); padding: 1.5rem; border-radius: 12px; text-align: center; border: 2px solid var(--color-critical);">
                                <div style="font-size: 2.5rem; font-weight: 900; color: var(--color-critical); margin-bottom: 0.5rem;">${results.anomalies_detected}</div>
                                <div style="font-weight: 700;">Anomalies Detected</div>
                                <div class="last-updated">
                                    <div class="stream-dot"></div>
                                    <span>Just completed</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid var(--ai-accent);">
                            <h4 style="color: var(--ai-accent); font-weight: 900; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                🔍 Key Findings
                                <div class="help-icon">
                                    ?
                                    <div class="tooltip">Critical insights discovered through comprehensive data analysis</div>
                                </div>
                            </h4>
                            <ul style="margin-top: 0.5rem; list-style: none; padding: 0;">
                                ${results.key_findings.map(finding => `
                                    <li style="background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border-left: 4px solid var(--ai-accent); font-weight: 600;">
                                        ${finding}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div style="background: var(--bg-color-light); padding: 2rem; border-radius: 12px; border: 2px solid var(--border-color);">
                            <h4 style="font-weight: 900; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                📊 Analysis Summary
                                <div class="help-icon">
                                    ?
                                    <div class="tooltip">Performance metrics and data processing statistics</div>
                                </div>
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--ai-accent);">128K</div>
                                    <div style="font-weight: 600;">Context Window Used</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--color-optimal);">${results.processing_time}</div>
                                    <div style="font-weight: 600;">Processing Time</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--color-warning);">${results.confidence_score}%</div>
                                    <div style="font-weight: 600;">Overall Confidence</div>
                                </div>
                            </div>
                            <div style="margin-top: 2rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid var(--ai-accent);">
                                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                                    <div style="font-weight: 700; color: var(--ai-accent);">Analysis Status: Complete</div>
                                    <div class="last-updated">
                                        <div class="stream-dot"></div>
                                        <span>Completed just now</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-ai" onclick="exportContextAnalysis()" style="margin-right: 1rem;">
                                📄 Export Full Report
                            </button>
                            <button class="btn btn-primary" onclick="runDeepContextAnalysis()">
                                🔄 Re-run Analysis
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Enhanced Dashboard object with improved UX features
        const Dashboard = {
            currentSection: 'ai-command',
            gemmaAI: null,
            helpSystem: null,
            
            async initialize() {
                // Initialize Enhanced Gemma AI
                this.gemmaAI = new GemmaEnhancedAI();
                await this.gemmaAI.initialize();
                
                // Initialize help system
                this.initializeHelpSystem();
                
                // Initialize advanced features
                this.initializeAdvancedFeatures();
                
                console.log('🚀 Enhanced Dashboard fully operational with improved UX');
            },

            initializeHelpSystem() {
                // Add keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F1' || (e.key === '?' && e.shiftKey)) {
                        e.preventDefault();
                        this.showHelp();
                    }
                    if (e.key === 'Escape') {
                        this.hideAllModals();
                    }
                });

                // Initialize tooltips with enhanced positioning
                this.initializeTooltips();
                
                console.log('💡 Help system initialized');
            },

            initializeTooltips() {
                // Enhanced tooltip positioning for better UX
                const tooltips = document.querySelectorAll('.help-icon');
                tooltips.forEach(icon => {
                    icon.addEventListener('mouseenter', (e) => {
                        const tooltip = icon.querySelector('.tooltip');
                        if (tooltip) {
                            // Dynamic positioning based on screen edges
                            const rect = icon.getBoundingClientRect();
                            const tooltipRect = tooltip.getBoundingClientRect();
                            
                            if (rect.right + tooltipRect.width > window.innerWidth) {
                                tooltip.style.left = 'auto';
                                tooltip.style.right = '50%';
                                tooltip.style.transform = 'translateX(50%)';
                            }
                            
                            if (rect.top - tooltipRect.height < 0) {
                                tooltip.style.bottom = 'auto';
                                tooltip.style.top = '130%';
                            }
                        }
                    });
                });
            },

            initializeAdvancedFeatures() {
                // Auto-save user preferences
                this.loadUserPreferences();
                
                // Initialize real-time notifications
                this.initializeNotifications();
                
                // Initialize accessibility features
                this.initializeAccessibility();
                
                // Initialize performance monitoring
                this.initializePerformanceMonitoring();
            },

            loadUserPreferences() {
                const prefs = localStorage.getItem('crisis-dashboard-prefs');
                if (prefs) {
                    const preferences = JSON.parse(prefs);
                    if (preferences.theme) {
                        document.documentElement.setAttribute('data-theme', preferences.theme);
                    }
                    if (preferences.lastSection) {
                        this.showSection(preferences.lastSection);
                    }
                }
            },

            saveUserPreferences() {
                const preferences = {
                    theme: document.documentElement.getAttribute('data-theme'),
                    lastSection: this.currentSection,
                    timestamp: Date.now()
                };
                localStorage.setItem('crisis-dashboard-prefs', JSON.stringify(preferences));
            },

            initializeNotifications() {
                // Request notification permission for critical alerts
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            },

            initializeAccessibility() {
                // Add keyboard navigation for critical elements
                document.addEventListener('keydown', (e) => {
                    if (e.altKey && e.key >= '1' && e.key <= '9') {
                        const sectionIndex = parseInt(e.key) - 1;
                        const sections = ['ai-command', 'context-intelligence', 'predictive-analysis', 'live-map', 'incidents', 'resources', 'reports', 'analytics', 'archive'];
                        if (sections[sectionIndex]) {
                            this.showSection(sections[sectionIndex]);
                        }
                    }
                });

                // Announce section changes for screen readers
                this.announceToScreenReader('Crisis Command Dashboard loaded and ready');
            },

            initializePerformanceMonitoring() {
                // Monitor page performance and show warnings if needed
                if ('performance' in window) {
                    const observer = new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            if (entry.entryType === 'measure' && entry.duration > 1000) {
                                console.warn(`Performance warning: ${entry.name} took ${entry.duration}ms`);
                            }
                        }
                    });
                    observer.observe({ entryTypes: ['measure'] });
                }
            },

            announceToScreenReader(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.style.position = 'absolute';
                announcement.style.left = '-10000px';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            },

            showSection(sectionId) {
                // Enhanced section switching with better feedback
                performance.mark('section-switch-start');
                
                document.querySelectorAll('.dashboard-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    
                    // Update navigation
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    const activeNavItem = document.querySelector(`[onclick*="${sectionId}"]`);
                    if (activeNavItem) {
                        activeNavItem.classList.add('active');
                    }
                    
                    this.currentSection = sectionId;
                    this.saveUserPreferences();
                    
                    // Announce to screen readers
                    const sectionTitle = targetSection.querySelector('.panel-title')?.textContent || sectionId;
                    this.announceToScreenReader(`Switched to ${sectionTitle} section`);
                }
                
                performance.mark('section-switch-end');
                performance.measure('section-switch', 'section-switch-start', 'section-switch-end');
            },

            showHelp() {
                const helpModal = this.createHelpModal();
                document.body.appendChild(helpModal);
                helpModal.style.display = 'flex';
            },

            createHelpModal() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                `;
                
                modal.innerHTML = `
                    <div style="background: var(--bg-color-card); border-radius: 16px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto; margin: 2rem; box-shadow: var(--shadow-xl);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem;">
                            <h2 style="color: var(--ai-accent); font-weight: 900; font-size: 1.5rem;">🧠 Crisis Command Center Help</h2>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-light);">✕</button>
                        </div>
                        
                        <div style="display: grid; gap: 2rem;">
                            <div>
                                <h3 style="color: var(--primary-color); font-weight: 900; margin-bottom: 1rem;">🎯 Key Features</h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px;">
                                        <strong>AI Context Intelligence:</strong> Gemma 3n processes up to 128K tokens of emergency data for comprehensive situational awareness
                                    </div>
                                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px;">
                                        <strong>Risk Scoring:</strong> AI calculates real-time risk scores (1-10) based on incidents, weather, and predictive models
                                    </div>
                                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px;">
                                        <strong>Resource Optimization:</strong> AI suggests optimal unit positioning for fastest response times
                                    </div>
                                    <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px;">
                                        <strong>Predictive Analysis:</strong> Machine learning forecasts incidents based on patterns and conditions
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--color-critical); font-weight: 900; margin-bottom: 1rem;">⚡ Keyboard Shortcuts</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-family: monospace;">
                                    <div>F1 or Shift+?</div><div>Show this help</div>
                                    <div>Alt+1-9</div><div>Switch sections</div>
                                    <div>Escape</div><div>Close modals</div>
                                    <div>Ctrl+R</div><div>Refresh data</div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--color-optimal); font-weight: 900; margin-bottom: 1rem;">📊 Data Indicators</h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div class="live-indicator"><div class="live-dot"></div><span>LIVE</span></div>
                                        <span>Real-time data streaming</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div class="live-indicator"><div class="live-dot warning" style="background: var(--color-warning);"></div><span>DELAYED</span></div>
                                        <span>Data update delayed</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div class="live-indicator"><div class="live-dot error" style="background: var(--color-critical);"></div><span>ERROR</span></div>
                                        <span>Data source unavailable</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--color-warning); font-weight: 900; margin-bottom: 1rem;">🔔 Alert Levels</h3>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="background: var(--color-critical); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: bold; font-size: 0.8rem;">CRITICAL</span>
                                        <span>Immediate commander action required</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="background: var(--color-warning); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: bold; font-size: 0.8rem;">HIGH</span>
                                        <span>Priority response needed</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="background: var(--color-optimal); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: bold; font-size: 0.8rem;">NORMAL</span>
                                        <span>Standard processing</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border-color);">
                            <button class="btn btn-ai" onclick="this.closest('div').parentElement.remove()">
                                ✓ Got it, thanks!
                            </button>
                        </div>
                    </div>
                `;
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                return modal;
            },

            hideAllModals() {
                document.querySelectorAll('[style*="z-index: 10001"]').forEach(modal => {
                    modal.remove();
                });
            },

            showSystemStatus() {
                // Enhanced system status modal
                const statusModal = this.createSystemStatusModal();
                document.body.appendChild(statusModal);
                statusModal.style.display = 'flex';
            },

            createSystemStatusModal() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                `;
                
                const systemData = {
                    status: 'operational',
                    uptime: '99.7%',
                    dataStreams: 6,
                    processedToday: 1247,
                    aiModels: 7,
                    lastBackup: '2 minutes ago'
                };
                
                modal.innerHTML = `
                    <div style="background: var(--bg-color-card); border-radius: 16px; padding: 2rem; max-width: 600px; margin: 2rem; box-shadow: var(--shadow-xl);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="color: var(--ai-accent); font-weight: 900;">🧠 Gemma 3n System Status</h2>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
                        </div>
                        
                        <div style="display: grid; gap: 1.5rem;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--color-optimal);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--color-optimal); animation: pulse 2s infinite;"></div>
                                    <h3 style="color: var(--color-optimal); font-weight: 900; margin: 0;">System Operational</h3>
                                </div>
                                <div>All AI systems functioning normally with real-time data processing</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--ai-accent);">${systemData.uptime}</div>
                                    <div>System Uptime</div>
                                </div>
                                <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--color-optimal);">${systemData.dataStreams}/6</div>
                                    <div>Data Streams Active</div>
                                </div>
                                <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary-color);">${systemData.processedToday}</div>
                                    <div>Reports Processed Today</div>
                                </div>
                                <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 900; color: var(--ai-accent);">${systemData.aiModels}/7</div>
                                    <div>AI Models Online</div>
                                </div>
                            </div>
                            
                            <div style="background: var(--bg-color-light); padding: 1rem; border-radius: 8px;">
                                <strong>Last Data Backup:</strong> ${systemData.lastBackup}
                                <br>
                                <strong>Context Window Usage:</strong> 67.3% (86.5K/128K tokens)
                                <br>
                                <strong>Network Latency:</strong> 23ms average
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">
                                ✓ Close Status
                            </button>
                        </div>
                    </div>
                `;
                
                return modal;
            },

            async refreshData() {
                if (this.gemmaAI) {
                    this.gemmaAI.showProcessingStatus('🔄 Refreshing all data streams...');
                    
                    try {
                        await Promise.all([
                            this.gemmaAI.updateContextUsage(),
                            this.gemmaAI.generateInitialInsights(),
                            this.gemmaAI.updatePerformanceDisplay()
                        ]);
                        
                        // Show success notification
                        this.showNotification('✅ Data refresh complete', 'success');
                    } catch (error) {
                        this.showNotification('❌ Data refresh failed', 'error');
                    } finally {
                        this.gemmaAI.hideProcessingStatus();
                    }
                }
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const colors = {
                    success: 'var(--color-optimal)',
                    error: 'var(--color-critical)',
                    warning: 'var(--color-warning)',
                    info: 'var(--primary-color)'
                };
                
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${colors[type]};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    font-weight: 700;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    box-shadow: var(--shadow-lg);
                `;
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                
                // Send browser notification for critical alerts
                if (type === 'error' && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification('Crisis Command Alert', {
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
            }
        };

        // Enhanced Global Functions with Better UX
        function showSection(sectionId) {
            Dashboard.showSection(sectionId);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            Dashboard.saveUserPreferences();
            
            // Announce theme change
            Dashboard.announceToScreenReader(`Switched to ${newTheme} theme`);
        }

        function toggleNav() {
            const nav = document.getElementById('mainNav');
            nav.classList.toggle('open');
            
            // Update aria attributes for accessibility
            const isOpen = nav.classList.contains('open');
            nav.setAttribute('aria-expanded', isOpen);
        }

        function showHelp() {
            Dashboard.showHelp();
        }

        function showSystemStatus() {
            Dashboard.showSystemStatus();
        }

        // Enhanced AI interaction functions
        async function runDeepContextAnalysis() {
            if (Dashboard.gemmaAI) {
                await Dashboard.gemmaAI.runDeepContextAnalysis();
            }
        }

        async function refreshAIInsights() {
            if (Dashboard.gemmaAI) {
                await Dashboard.gemmaAI.refreshAIInsights();
            }
        }

        async function implementRecommendation(recommendationId) {
            const actionType = recommendationId.split('-').slice(1).join(' ');
            
            // Show confirmation dialog for critical actions
            const isConfirmed = confirm(`⚠️ Confirm Action: ${actionType}\n\nThis will trigger emergency response protocols. Continue?`);
            if (!isConfirmed) return;
            
            // Show processing feedback
            Dashboard.gemmaAI?.showProcessingStatus(`⚡ Implementing: ${actionType}...`);
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            Dashboard.gemmaAI?.hideProcessingStatus();
            Dashboard.showNotification(`✅ Successfully implemented: ${actionType}`, 'success');
            
            // Log action for audit trail
            console.log(`Action implemented: ${recommendationId} at ${new Date().toISOString()}`);
        }

        function viewIncident(incidentId) {
            Dashboard.showNotification(`📊 Loading incident details: #${incidentId}`, 'info');
            // Enhanced to show more details in a modal
            setTimeout(() => {
                alert(`🚨 INCIDENT #${incidentId} DETAILS\n\n` +
                      `Status: Active\n` +
                      `Priority: Critical\n` +
                      `Units Assigned: 3\n` +
                      `Estimated Resolution: 45 minutes\n\n` +
                      `This would normally open a detailed incident management interface.`);
            }, 500);
        }

        function viewInsightDetails(insightId) {
            Dashboard.showNotification(`🔍 Loading insight analysis: ${insightId}`, 'info');
            setTimeout(() => {
                alert(`📊 DETAILED ANALYSIS: ${insightId}\n\n` +
                      `Confidence Interval: 87-96%\n` +
                      `Data Sources: Weather, Historical, Social\n` +
                      `Risk Factors: Wind speed, Humidity, Time of day\n` +
                      `Recommendations: Deploy 2 units to high-risk zones\n\n` +
                      `This would show comprehensive supporting data and visualizations.`);
            }, 500);
        }

        // Additional enhanced interaction functions
        function alertStakeholders(alertType) {
            Dashboard.showNotification(`📢 Stakeholder alerts sent for: ${alertType}`, 'success');
        }

        function alertTraffic(location) {
            Dashboard.showNotification(`🚦 Traffic alert issued for: ${location}`, 'success');
        }

        function prepareResources(resourceType) {
            Dashboard.showNotification(`🚑 Resources prepared for: ${resourceType}`, 'success');
        }

        function activateCooling() {
            Dashboard.showNotification(`❄️ Cooling centers activated`, 'success');
        }

        function optimizeResources() {
            Dashboard.showNotification(`🎯 Resource optimization implemented`, 'success');
        }

        function viewOptimization() {
            Dashboard.showNotification(`📈 Loading optimization analysis`, 'info');
        }

        function runAIMapAnalysis() {
            Dashboard.gemmaAI?.showProcessingStatus('🧠 Running AI map analysis...');
            setTimeout(() => {
                Dashboard.gemmaAI?.hideProcessingStatus();
                Dashboard.showNotification('🗺️ AI map analysis complete', 'success');
            }, 3000);
        }

        function reprioritizeIncidents() {
            Dashboard.gemmaAI?.showProcessingStatus('🎯 AI re-prioritizing incidents...');
            setTimeout(() => {
                Dashboard.gemmaAI?.hideProcessingStatus();
                Dashboard.showNotification('✅ Incidents re-prioritized by AI', 'success');
            }, 2000);
        }

        function updateForecasts() {
            Dashboard.gemmaAI?.showProcessingStatus('🔄 Updating forecast models...');
            setTimeout(() => {
                Dashboard.gemmaAI?.hideProcessingStatus();
                Dashboard.showNotification('📊 Forecasts updated with latest data', 'success');
            }, 2500);
        }

        function viewForecastDetails(forecastType) {
            Dashboard.showNotification(`📊 Loading forecast: ${forecastType}`, 'info');
        }

        function exportContextAnalysis() {
            Dashboard.showNotification('📄 Exporting context analysis report...', 'info');
            setTimeout(() => {
                Dashboard.showNotification('✅ Report exported successfully', 'success');
            }, 1500);
        }

        function runMapAI() {
            runAIMapAnalysis();
        }

        function exportMapData() {
            Dashboard.showNotification('📊 Exporting map data...', 'info');
            setTimeout(() => {
                Dashboard.showNotification('✅ Map data exported', 'success');
            }, 1000);
        }

        function initializeAIMap() {
            Dashboard.gemmaAI?.showProcessingStatus('🚀 Loading AI-enhanced map...');
            setTimeout(() => {
                Dashboard.gemmaAI?.hideProcessingStatus();
                Dashboard.showNotification('🗺️ AI map initialized', 'success');
            }, 3000);
        }

        function optimizeAllResources() {
            Dashboard.gemmaAI?.showProcessingStatus('🎯 Running full resource optimization...');
            setTimeout(() => {
                Dashboard.gemmaAI?.hideProcessingStatus();
                Dashboard.showNotification('✅ All resources optimized', 'success');
            }, 4000);
        }

        function requestMutualAid() {
            Dashboard.showNotification('📞 Mutual aid request sent', 'success');
        }

        function viewResourceDetails(resourceType) {
            Dashboard.showNotification(`🚒 Loading ${resourceType} details`, 'info');
        }

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                Dashboard.refreshData();
            }
        });

        // Auto-refresh system with user notification
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                Dashboard.refreshData();
            }, 300000); // 5 minutes
            
            Dashboard.showNotification('🔄 Auto-refresh enabled (5 min intervals)', 'info');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                Dashboard.showNotification('⏸️ Auto-refresh disabled', 'info');
            }
        }

        // Enhanced error handling
        window.addEventListener('error', (e) => {
            console.error('Dashboard error:', e.error);
            Dashboard.showNotification('⚠️ System error detected - check console', 'error');
        });

        // Enhanced page visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Dashboard hidden - reducing update frequency');
            } else {
                console.log('Dashboard visible - resuming normal updates');
                Dashboard.refreshData();
            }
        });

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Set initial theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--gemma-gradient);
                color: white;
                padding: 2rem 3rem;
                border-radius: 16px;
                font-weight: 900;
                font-size: 1.2rem;
                z-index: 10000;
                box-shadow: var(--shadow-xl);
            `;
            loadingIndicator.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🧠</div>
                    <div>Initializing Gemma 3n Crisis Command Center...</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">Enhanced UX with real-time AI intelligence</div>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
            
            try {
                // Initialize enhanced dashboard
                await Dashboard.initialize();
                
                // Start auto-refresh
                startAutoRefresh();
                
                // Remove loading indicator
                loadingIndicator.remove();
                
                // Show success notification
                Dashboard.showNotification('🚀 Crisis Command Center fully operational', 'success');
                
                console.log('🧠 Enhanced Gemma 3n Crisis Command Center fully operational with improved UX');
                
            } catch (error) {
                console.error('Dashboard initialization failed:', error);
                loadingIndicator.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <div>Initialization failed - operating in degraded mode</div>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; color: var(--color-critical); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        });

        // Handle responsive navigation
        window.addEventListener('resize', () => {
            if (window.innerWidth > 1024) {
                document.getElementById('mainNav').classList.remove('open');
            }
        });

        // Add CSS animations for notifications
        const animationCSS = document.createElement('style');
        animationCSS.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(animationCSS);

        // Export enhanced functions for global access
        window.showSection = showSection;
        window.toggleTheme = toggleTheme;
        window.toggleNav = toggleNav;
        window.showHelp = showHelp;
        window.showSystemStatus = showSystemStatus;
        window.runDeepContextAnalysis = runDeepContextAnalysis;
        window.refreshAIInsights = refreshAIInsights;
        window.implementRecommendation = implementRecommendation;
        window.viewInsightDetails = viewInsightDetails;
        window.viewIncident = viewIncident;
        window.alertStakeholders = alertStakeholders;
        window.alertTraffic = alertTraffic;
        window.prepareResources = prepareResources;
        window.activateCooling = activateCooling;
        window.optimizeResources = optimizeResources;
        window.viewOptimization = viewOptimization;
        window.runAIMapAnalysis = runAIMapAnalysis;
        window.reprioritizeIncidents = reprioritizeIncidents;
        window.updateForecasts = updateForecasts;
        window.viewForecastDetails = viewForecastDetails;
        window.exportContextAnalysis = exportContextAnalysis;
        window.runMapAI = runMapAI;
        window.exportMapData = exportMapData;
        window.initializeAIMap = initializeAIMap;
        window.optimizeAllResources = optimizeAllResources;
        window.requestMutualAid = requestMutualAid;
        window.viewResourceDetails = viewResourceDetails;
        
        // Enhanced global utilities
        window.Dashboard = Dashboard;
        window.startAutoRefresh = startAutoRefresh;
        window.stopAutoRefresh = stopAutoRefresh;
    </script>
</body>
</html>