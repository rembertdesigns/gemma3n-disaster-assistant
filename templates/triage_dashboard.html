{% extends "base.html" %}

{% block title %}Triage Dashboard - Disaster Response Assistant{% endblock %}
{% block page_title %}üìä Emergency Triage Dashboard{% endblock %}
{% block subtitle %}Real-time Patient Management & Critical Alert System{% endblock %}

{% block header_actions %}
<a href="/" class="btn btn-secondary-outline">‚¨ÖÔ∏è Back to Home</a>
<a href="/triage-form" class="btn btn-primary">üìù New Triage</a>
<a href="/patient-list" class="btn btn-info">üë• Patient List</a>
<button onclick="triageDashboard.openShiftHandover()" class="btn btn-info">üìã Shift Handover</button>
<button onclick="triageDashboard.openRealTimeChat()" class="btn btn-success">üí¨ Real-Time Chat</button>
{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    /*
    Enhanced Triage Dashboard Styles
    ---------------------------------
    This stylesheet contains all specific styles for the triage_dashboard.html template.
    It inherits variables from the base styles.css file.
    */

    /* Layout */
    .dashboard-layout {
        max-width: 1800px;
        margin: 0 auto;
        padding: 1.5rem;
    }
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .operations-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
        align-items: start;
    }
    .main-column { 
        grid-column: span 12; 
        display: flex; 
        flex-direction: column; 
        gap: 1.5rem; 
    }
    .sidebar-column { 
        grid-column: span 12; 
        display: flex; 
        flex-direction: column; 
        gap: 1.5rem; 
    }

    /* Responsive columns for larger screens */
    @media (min-width: 1024px) {
        .main-column { grid-column: span 8; }
        .sidebar-column { grid-column: span 4; }
    }

    /* Cards */
    .dashboard-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    .card-header {
        background: var(--header-bg, linear-gradient(135deg, #1e40af 0%, #3b82f6 100%));
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border-bottom: 1px solid transparent;
    }
    .card-title { font-size: 1.1rem; font-weight: bold; margin: 0; }
    .card-content { padding: 1.5rem; flex-grow: 1; }

    /* Stat Cards */
    .stat-card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--border-color); position: relative; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--accent-color); }
    .stat-content { padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; }
    .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: var(--accent-color); flex-shrink: 0; }
    .stat-details h3 { margin: 0; font-size: 2rem; font-weight: bold; color: var(--text-color-dark, var(--text-primary)); }
    .stat-details p { margin: 0.25rem 0 0 0; color: var(--text-color-light, var(--text-secondary)); font-size: 0.9rem; }
    .stat-total { --accent-color: var(--color-blue, #3b82f6); }
    .stat-active { --accent-color: var(--color-yellow, #f59e0b); }
    .stat-today { --accent-color: var(--color-green, #16a34a); }
    .stat-critical { --accent-color: var(--color-red, #dc2626); }

    /* Priority Queue */
    .priority-queue { max-height: 500px; overflow-y: auto; }
    .queue-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; cursor: pointer; }
    .queue-item:hover { background: var(--bg-hover, #f3f4f6); }
    .queue-priority { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.8rem; flex-shrink: 0; }
    .priority-1 { background: var(--color-red, #dc2626); }
    .priority-2 { background: var(--color-yellow, #f59e0b); }
    .priority-3 { background: var(--color-green, #16a34a); }
    .priority-4 { background: var(--color-black, #374151); }
    .queue-details { flex: 1; }
    .queue-name { font-weight: 600; color: var(--text-color-dark, var(--text-primary)); }
    .queue-info { font-size: 0.8rem; color: var(--text-color-light, var(--text-secondary)); }
    .queue-time { font-size: 0.7rem; color: var(--text-color-faded, #9ca3af); }

    /* AI Co-Pilot & Scenario Trainer */
    .tool-card textarea { width: 100%; min-height: 100px; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); font-family: inherit; margin-bottom: 1rem; }
    .tool-card select { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 1rem; }
    .ai-feedback { background: rgba(0,0,0,0.05); border-left: 4px solid #16a34a; padding: 1rem; margin-top: 1rem; border-radius: 4px; font-size: 0.9rem; white-space: pre-wrap; }
    .scenario-checklist { list-style-type: none; padding-left: 0; }
    .scenario-checklist li { padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
    
    /* Modals */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border-radius: 20px; padding: 2rem; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; }
    .modal-close { background: none; border: none; font-size: 2rem; cursor: pointer; }

    @media (max-width: 1024px) {
        .operations-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card stat-total"><div class="stat-content"><div class="stat-icon">üë•</div><div class="stat-details"><h3 id="total-patients">...</h3><p>Total Patients</p></div></div></div>
        <div class="stat-card stat-active"><div class="stat-content"><div class="stat-icon">üü°</div><div class="stat-details"><h3 id="active-patients">...</h3><p>Currently Active</p></div></div></div>
        <div class="stat-card stat-today"><div class="stat-content"><div class="stat-icon">üìÖ</div><div class="stat-details"><h3 id="patients-today">...</h3><p>Admitted Today</p></div></div></div>
        <div class="stat-card stat-critical"><div class="stat-content"><div class="stat-icon">üö®</div><div class="stat-details"><h3 id="critical-alerts-count">...</h3><p>Critical Alerts</p></div></div></div>
    </div>

    <!-- Main Operations Grid -->
    <div class="operations-grid">
        <!-- Main Column -->
        <div class="main-column">
            <!-- Priority Queue -->
            <div class="dashboard-card">
                <div class="card-header"><span class="card-icon">üìã</span><h3 class="card-title">Priority Queue</h3></div>
                <div class="card-content priority-queue" id="priority-queue-list">
                    <!-- Patient items will be dynamically inserted here -->
                    <div class="empty-state"><div class="empty-icon">üìã</div><p>No active patients in the queue.</p></div>
                </div>
            </div>
            <!-- AI Report Assistant -->
            <div class="tool-card">
                <span class="tool-icon">ü§ñ</span>
                <h3 class="tool-title">Offline Report Assistant</h3>
                <p class="tool-description">Draft a report here to get on-device AI feedback for clarity and completeness.</p>
                <textarea id="draft-input" placeholder="Describe the emergency..."></textarea>
                <button class="action-button primary" onclick="triageDashboard.runOfflineAnalysis()">Analyze Draft</button>
                <div class="ai-feedback" id="draft-feedback" style="display:none;"></div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="sidebar-column">
            <!-- Critical AI Alerts -->
            <div class="dashboard-card">
                <div class="card-header" style="background: var(--color-red);"><span class="card-icon">üö®</span><h3 class="card-title">Critical AI Alerts</h3></div>
                <div class="card-content" id="critical-alerts-list">
                    <div class="empty-state"><p>No critical alerts at this time.</p></div>
                </div>
            </div>
            <!-- Emergency Scenario Trainer -->
            <div class="tool-card">
                <span class="tool-icon">üìñ</span>
                <h3 class="tool-title">Emergency Scenario Trainer</h3>
                <p class="tool-description">Get AI-powered guidance for common emergency situations.</p>
                <select id="scenario-select" class="form-input" onchange="triageDashboard.startScenario()">
                    <option value="">-- Select a Scenario --</option>
                    <option value="power_outage">Power Outage</option>
                    <option value="flooding">Minor Flooding</option>
                    <option value="earthquake">After an Earthquake</option>
                </select>
                <div class="ai-feedback" id="scenario-steps" style="display:none;"></div>
            </div>
            <!-- Intelligent Sync Queue -->
            <div class="tool-card">
                <span class="tool-icon">üì§</span>
                <h3 class="tool-title">Intelligent Sync Queue</h3>
                <p class="tool-description">Reports saved offline, analyzed by on-device AI, and ready to sync.</p>
                <div id="sync-queue-list"><p>Sync queue is empty.</p></div>
                <button class="action-button success" onclick="triageDashboard.syncNow()" style="margin-top: 1rem;">Sync Now</button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="shift-handover-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>üìã Shift Handover Log</h2><button class="modal-close" onclick="triageDashboard.closeModal('shift-handover-modal')">&times;</button></div>
        <!-- Handover content -->
    </div>
</div>
<div id="chat-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>üí¨ Real-Time Staff Chat</h2><button class="modal-close" onclick="triageDashboard.closeModal('chat-modal')">&times;</button></div>
        <!-- Chat content -->
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    "use strict";

    const triageDashboard = {};

    // --- Mock Data ---
    const mockPatients = [
        { id: 1, name: 'John Smith', injury: 'Chest trauma', severity: 'critical', triage_color: 'red', priority_score: 1, timestamp: new Date(Date.now() - 5 * 60000) },
        { id: 2, name: 'Robert Wilson', injury: 'Cardiac event', severity: 'urgent', triage_color: 'red', priority_score: 1, timestamp: new Date(Date.now() - 10 * 60000) },
        { id: 3, name: 'Maria Garcia', injury: 'Arm fracture', severity: 'moderate', triage_color: 'yellow', priority_score: 2, timestamp: new Date(Date.now() - 15 * 60000) },
        { id: 4, name: 'Sarah Johnson', injury: 'Minor lacerations', severity: 'mild', triage_color: 'green', priority_score: 3, timestamp: new Date(Date.now() - 21 * 60000) },
    ];
    const mockAlerts = [
        { patient: mockPatients[0], prediction: 'Low oxygen saturation, Critical condition' },
        { patient: mockPatients[1], prediction: 'Elevated heart rate, potential cardiac event' },
    ];

    // --- UI Update Functions ---
    function updateDashboardStats() {
        document.getElementById('total-patients').textContent = mockPatients.length;
        document.getElementById('active-patients').textContent = mockPatients.filter(p => p.status !== 'discharged').length;
        document.getElementById('patients-today').textContent = mockPatients.length; // Simplified for demo
        document.getElementById('critical-alerts-count').textContent = mockAlerts.length;
    }

    function populatePriorityQueue() {
        const queueList = document.getElementById('priority-queue-list');
        queueList.innerHTML = mockPatients.sort((a, b) => a.priority_score - b.priority_score).map(p => `
            <div class="queue-item" onclick="alert('Viewing patient ${p.id}')">
                <div class="queue-priority priority-${p.priority_score}">${p.priority_score}</div>
                <div class="queue-details">
                    <div class="queue-name">${p.name}</div>
                    <div class="queue-info">
                        <span>${p.injury}</span><span>-</span><span>${p.severity}</span>
                    </div>
                </div>
                <div class="queue-time">${new Date(p.timestamp).toLocaleTimeString()}</div>
            </div>
        `).join('');
    }

    function populateCriticalAlerts() {
        const alertsList = document.getElementById('critical-alerts-list');
        alertsList.innerHTML = mockAlerts.map(alert => `
            <div class="alert-item" onclick="alert('Viewing alert for ${alert.patient.name}')">
                <div class="alert-header"><span>‚ö†Ô∏è</span><span>${alert.patient.name}</span></div>
                <div class="alert-details">${alert.prediction}</div>
            </div>
        `).join('');
    }

    // --- Modal Functions ---
    triageDashboard.openShiftHandover = () => document.getElementById('shift-handover-modal').style.display = 'block';
    triageDashboard.openRealTimeChat = () => document.getElementById('chat-modal').style.display = 'block';
    triageDashboard.closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

    // --- AI Tool Functions ---
    triageDashboard.runOfflineAnalysis = function() {
        const draftInput = document.getElementById('draft-input');
        const feedbackPanel = document.getElementById('draft-feedback');
        if (!draftInput.value.trim()) {
            feedbackPanel.textContent = "Please enter a description to analyze.";
            feedbackPanel.style.display = 'block';
            return;
        }
        feedbackPanel.textContent = "üß† Analyzing draft with on-device AI...";
        feedbackPanel.style.display = 'block';
        setTimeout(() => {
            let feedback = "‚úÖ Report looks clear.\n";
            if (!draftInput.value.match(/\d+/g)) feedback += "üí° Consider adding numbers (e.g., people involved, address).\n";
            if (!draftInput.value.toLowerCase().includes('street' || 'road' || 'ave')) feedback += "üí° A specific street name would be helpful.\n";
            feedbackPanel.innerHTML = `<strong>AI Feedback:</strong><br>${feedback.replace(/\n/g, '<br>')}`;
        }, 1500);
    };

    triageDashboard.startScenario = function() {
        const scenario = document.getElementById('scenario-select').value;
        const stepsPanel = document.getElementById('scenario-steps');
        if (!scenario) {
            stepsPanel.style.display = 'none';
            return;
        }
        let steps = "<li>No guidance for this scenario.</li>";
        if (scenario === 'power_outage') steps = `<li>1. Find a flashlight.</li><li>2. Check if neighbors have power.</li><li>3. Report to utility if possible.</li>`;
        if (scenario === 'flooding') steps = `<li>1. Move to higher ground.</li><li>2. Do not walk or drive through floodwaters.</li>`;
        if (scenario === 'earthquake') steps = `<li>1. Drop, Cover, and Hold On.</li><li>2. Check for injuries after shaking.</li>`;
        stepsPanel.innerHTML = `<strong>Guidance for ${scenario.replace('_', ' ')}:</strong><ul class="scenario-checklist">${steps}</ul>`;
        stepsPanel.style.display = 'block';
    };

    triageDashboard.syncNow = () => alert("Syncing offline reports...");

    // --- P2P (Placeholder) ---
    triageDashboard.handleManualSignal = () => alert("Connecting to peer...");

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboardStats();
        populatePriorityQueue();
        populateCriticalAlerts();
        window.triageDashboard = triageDashboard;
    });
})();
</script>
{% endblock %}
